<!== Adding "Fork me on Github" ribbon ==>
<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>fractalshades.postproc &mdash; Fractalshades 1.1.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/rtd_dark.css?v=e3debd14" />
      <link rel="stylesheet" type="text/css" href="../../_static/math.css?v=7fc59cab" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css?v=61a4c737" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css?v=f4aeca0c" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=58fbf978"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link href="../../_static/ribbon.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Fractalshades
              <img src="../../_static/logo3.jpg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.1.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../getting_started.html#installing">Installing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../getting_started.html#installing-gmp-mpfr-mpc-windows-users">Installing GMP / MPFR / MPC: Windows users</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../getting_started.html#installing-gmp-mpfr-mpc-unix-linux-users">Installing GMP / MPFR / MPC: Unix / Linux users</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../getting_started.html#installing-gmp-mpfr-mpc-mac-users">Installing GMP / MPFR / MPC: Mac users</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../getting_started.html#a-5-minutes-guide-to-fractalshades">A 5-minutes guide to fractalshades</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../getting_started.html#graphical-user-interface">Graphical user interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../getting_started.html#finding-areas-of-interest">Finding areas of interest</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../getting_started.html#unskewing-streched-areas">Unskewing streched areas</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../math.html">Mathematical background</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../math.html#zoom-level-and-native-floating-point-precision">Zoom level and native floating-point precision</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../math.html#perturbation-theory">Perturbation Theory</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../math.html#avoiding-loss-of-precision">Avoiding loss of precision</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../math.html#billinear-approximations">Billinear approximations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../math.html#extended-range-floating-points">Extended range floating points</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../math.html#finding-minibrots">Finding minibrots</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../math.html#going-further-a-few-references">Going further: a few references</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../examples/index.html">Gallery</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../examples/index.html#batch-mode-gallery">Batch mode gallery</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/index.html#colormaps-template-gallery">Colormaps template gallery</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/index.html#gui-mode-arbitrary-precision-implementations">GUI-mode: arbitrary precision implementations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/index.html#gui-mode-standard-implementation-examples">GUI-mode: standard implementation examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/index.html#lighting-examples-gallery">Lighting examples gallery</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/index.html#projections">Projections</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../examples/batch_mode/index.html">Batch mode gallery</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../examples/batch_mode/01-full_basic.html">01 - Full Mandelbrot basic example</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../examples/batch_mode/02-bulb_fieldlines1.html">02 - Bulb fieldlines example “tint_or_shade”</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../examples/batch_mode/03-bulb_fieldlines2.html">03 - Bulb fieldlines example “twinfield”</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../examples/batch_mode/04-seahorse_shaded.html">04 - Seahorse shaded example</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../examples/batch_mode/05-seahorse_shaded_colored.html">05 - Seahorse shaded and colored example</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../examples/batch_mode/06-seahorse_interior.html">06 - Seahorse interior example</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../examples/batch_mode/07-seahorse_DEM.html">07 - Seahorse DEM example</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../examples/batch_mode/08-run_perturb_DEM.html">08 - DEM example with perturbation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../examples/batch_mode/09-run_flake_DEM.html">09 - A deeper DEM example</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../examples/batch_mode/10-double_embedded_julia.html">10 - Double embedded Julia set</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../examples/batch_mode/11-run_perturbdeep.html">11- Ultra-deep embedded Julia set</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../examples/batch_mode/12-burning_ship_deep.html">12 - Burning Ship deep zoom</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../examples/batch_mode/13-burning_ship.html">13 - Burning ship DEM</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../examples/batch_mode/14-burning_ship-deeper_DEM.html">14 - Burning ship deeper DEM</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../examples/batch_mode/15-burning_ship-deepJulia_DEM.html">15 - Burning Ship ultra-deep embedded Julia set</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../examples/batch_mode/16-tetration_spring.html">16 - Tetration (power tower) zoom: “Spring”</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../examples/batch_mode/17-perpendicular_burning_ship_DEM.html">17 - “Perpendicular” Burning Ship</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../examples/batch_mode/18-perpendicular_burning_ship_glynn.html">18 - “Perpendicular” Burning Ship: hidden Glynn spiral</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../examples/batch_mode/19-perpendicular_burning_ship_Koch.html">19 - “Perpendicular” Burning Ship: hidden Koch snowflakes</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../examples/batch_mode/20-perpendicular_burning_ship_Sierpinski.html">20 - “Perpendicular” Burning Ship: hidden Sierpinski carpets</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../examples/batch_mode/21-perpendicular_burning_ship_trees.html">21 - “Perpendicular” Burning Ship: tree structures</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../examples/batch_mode/22-shark_fin_deep.html">22 - “Shark Fin” escape-time fractal</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../examples/batch_mode/23-deep_min.html">23 - A deep mini</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../examples/colormaps/index.html">Colormaps template gallery</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../examples/colormaps/plot_cmaps.html">Colormaps: available templates</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../examples/interactive_deepzoom/index.html">GUI-mode: arbitrary precision implementations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../examples/interactive_deepzoom/D01_run_interactive.html">D01 - Mandelbrot arbitrary-precision explorer</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../examples/interactive_deepzoom/D02_run_BS_interactive.html">D02 - Burning Ship arbitrary-precision explorer</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../examples/interactive_deepzoom/D03_run_interactive_Mn.html">D03 - Mandelbrot arbitrary-precision explorer</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../examples/interactive_standard/index.html">GUI-mode: standard implementation examples</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../examples/interactive_standard/S01_run_interactive_shallow.html">S01 - Mandelbrot explorer - Standard precision</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../examples/interactive_standard/S02_run_BS_shallow.html">S02 - Burning ship explorer - Standard precision</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../examples/interactive_standard/S03_run_interactive_Mn_shallow.html">S03 - Mandelbrot power n explorer - Standard precision</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../examples/interactive_standard/S04_run_collatz.html">S04 - Collatz explorer - Standard precision</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../examples/interactive_standard/S05_run_power_tower_shallow.html">S05 - Tetration fractal explorer - Standard precision</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../examples/lighting/index.html">Lighting examples gallery</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../examples/lighting/plot_lighting.html">Ligthings: available effects</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../examples/projections/index.html">Projections</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../examples/projections/P01-feigenbaum_expmap.html">P01 - Exponential mapping: Feigenbaum point</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../examples/projections/P02-inversion.html">P02 - Inversion of the Mandelbrot set</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../examples/projections/P03-Elephant_valley_moebius.html">P03 - Moebius mapping: Elephant and Seahorse valleys</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../examples/projections/P04-deep_expmap.html">P04 - Exponential mapping for deep zoom</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../API.html">Application Programming Interface</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../API/settings.html">Application-level settings</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../API/settings.html#fractalshades.settings.enable_multithreading"><code class="docutils literal notranslate"><span class="pre">enable_multithreading</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../API/settings.html#fractalshades.settings.skip_calc"><code class="docutils literal notranslate"><span class="pre">skip_calc</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../API/settings.html#fractalshades.settings.newton_zoom_level"><code class="docutils literal notranslate"><span class="pre">newton_zoom_level</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../API/settings.html#fractalshades.settings.no_newton"><code class="docutils literal notranslate"><span class="pre">no_newton</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../API/settings.html#fractalshades.settings.inspect_calc"><code class="docutils literal notranslate"><span class="pre">inspect_calc</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../API/settings.html#fractalshades.settings.chunk_size"><code class="docutils literal notranslate"><span class="pre">chunk_size</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../API/settings.html#fractalshades.settings.verbosity"><code class="docutils literal notranslate"><span class="pre">verbosity</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../API/settings.html#fractalshades.settings.postproc_dtype"><code class="docutils literal notranslate"><span class="pre">postproc_dtype</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../API/settings.html#fractalshades.settings.log_directory"><code class="docutils literal notranslate"><span class="pre">log_directory</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../API/settings.html#fractalshades.settings.disable_decompression_size_check"><code class="docutils literal notranslate"><span class="pre">disable_decompression_size_check()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../API/settings.html#fractalshades.settings.BLA_compression"><code class="docutils literal notranslate"><span class="pre">BLA_compression</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../API/settings.html#fractalshades.settings.GUI_image_Mblimit"><code class="docutils literal notranslate"><span class="pre">GUI_image_Mblimit</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../API/core.html">Core components</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../API/core.html#fractalshades.Fractal"><code class="docutils literal notranslate"><span class="pre">Fractal</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../API/core.html#fractalshades.Fractal.__init__"><code class="docutils literal notranslate"><span class="pre">Fractal.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../API/core.html#fractalshades.Fractal.clean_up"><code class="docutils literal notranslate"><span class="pre">Fractal.clean_up()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../API/core.html#fractalshades.Fractal.zoom"><code class="docutils literal notranslate"><span class="pre">Fractal.zoom()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../API/core.html#fractalshades.PerturbationFractal"><code class="docutils literal notranslate"><span class="pre">PerturbationFractal</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../API/core.html#fractalshades.PerturbationFractal.__init__"><code class="docutils literal notranslate"><span class="pre">PerturbationFractal.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../API/core.html#fractalshades.PerturbationFractal.zoom"><code class="docutils literal notranslate"><span class="pre">PerturbationFractal.zoom()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../API/core.html#fractalshades.Fractal_plotter"><code class="docutils literal notranslate"><span class="pre">Fractal_plotter</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../API/core.html#fractalshades.Fractal_plotter.__init__"><code class="docutils literal notranslate"><span class="pre">Fractal_plotter.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../API/core.html#fractalshades.Fractal_plotter.add_layer"><code class="docutils literal notranslate"><span class="pre">Fractal_plotter.add_layer()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../API/core.html#fractalshades.Fractal_plotter.plot"><code class="docutils literal notranslate"><span class="pre">Fractal_plotter.plot()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../API/core.html#fractalshades.Fractal_plotter.save_db"><code class="docutils literal notranslate"><span class="pre">Fractal_plotter.save_db()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../API/core.html#fractalshades.zoom_options"><code class="docutils literal notranslate"><span class="pre">zoom_options()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../API/core.html#fractalshades.calc_options"><code class="docutils literal notranslate"><span class="pre">calc_options()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../API/core.html#fractalshades.interactive_options"><code class="docutils literal notranslate"><span class="pre">interactive_options()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../API/projection.html">Projections</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../API/projection.html#fractalshades.projection.Projection"><code class="docutils literal notranslate"><span class="pre">Projection</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../API/projection.html#fractalshades.projection.Projection.__init__"><code class="docutils literal notranslate"><span class="pre">Projection.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../API/projection.html#fractalshades.projection.Cartesian"><code class="docutils literal notranslate"><span class="pre">Cartesian</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../API/projection.html#fractalshades.projection.Cartesian.__init__"><code class="docutils literal notranslate"><span class="pre">Cartesian.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../API/projection.html#fractalshades.projection.Expmap"><code class="docutils literal notranslate"><span class="pre">Expmap</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../API/projection.html#fractalshades.projection.Expmap.__init__"><code class="docutils literal notranslate"><span class="pre">Expmap.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../API/projection.html#fractalshades.projection.Generic_mapping"><code class="docutils literal notranslate"><span class="pre">Generic_mapping</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../API/projection.html#fractalshades.projection.Generic_mapping.__init__"><code class="docutils literal notranslate"><span class="pre">Generic_mapping.__init__()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../API/arbitrary_models.html">Fractal models: Arbitrary-precision implementations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../API/arbitrary_models.html#fractalshades.models.Perturbation_mandelbrot"><code class="docutils literal notranslate"><span class="pre">Perturbation_mandelbrot</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../API/arbitrary_models.html#fractalshades.models.Perturbation_mandelbrot.__init__"><code class="docutils literal notranslate"><span class="pre">Perturbation_mandelbrot.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../API/arbitrary_models.html#fractalshades.models.Perturbation_mandelbrot.calc_std_div"><code class="docutils literal notranslate"><span class="pre">Perturbation_mandelbrot.calc_std_div()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../API/arbitrary_models.html#fractalshades.models.Perturbation_mandelbrot_N"><code class="docutils literal notranslate"><span class="pre">Perturbation_mandelbrot_N</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../API/arbitrary_models.html#fractalshades.models.Perturbation_mandelbrot_N.__init__"><code class="docutils literal notranslate"><span class="pre">Perturbation_mandelbrot_N.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../API/arbitrary_models.html#fractalshades.models.Perturbation_mandelbrot_N.calc_std_div"><code class="docutils literal notranslate"><span class="pre">Perturbation_mandelbrot_N.calc_std_div()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../API/arbitrary_models.html#fractalshades.models.Perturbation_burning_ship"><code class="docutils literal notranslate"><span class="pre">Perturbation_burning_ship</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../API/arbitrary_models.html#fractalshades.models.Perturbation_burning_ship.__init__"><code class="docutils literal notranslate"><span class="pre">Perturbation_burning_ship.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../API/arbitrary_models.html#fractalshades.models.Perturbation_burning_ship.calc_std_div"><code class="docutils literal notranslate"><span class="pre">Perturbation_burning_ship.calc_std_div()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../API/standard_models.html">Fractal models: Standard-precision implementations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../API/standard_models.html#fractalshades.models.Mandelbrot"><code class="docutils literal notranslate"><span class="pre">Mandelbrot</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../API/standard_models.html#fractalshades.models.Mandelbrot.__init__"><code class="docutils literal notranslate"><span class="pre">Mandelbrot.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../API/standard_models.html#fractalshades.models.Mandelbrot.calc_std_div"><code class="docutils literal notranslate"><span class="pre">Mandelbrot.calc_std_div()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../API/standard_models.html#fractalshades.models.Mandelbrot.newton_calc"><code class="docutils literal notranslate"><span class="pre">Mandelbrot.newton_calc()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../API/standard_models.html#fractalshades.models.Mandelbrot_N"><code class="docutils literal notranslate"><span class="pre">Mandelbrot_N</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../API/standard_models.html#fractalshades.models.Mandelbrot_N.__init__"><code class="docutils literal notranslate"><span class="pre">Mandelbrot_N.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../API/standard_models.html#fractalshades.models.Mandelbrot_N.calc_std_div"><code class="docutils literal notranslate"><span class="pre">Mandelbrot_N.calc_std_div()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../API/standard_models.html#fractalshades.models.Mandelbrot_N.newton_calc"><code class="docutils literal notranslate"><span class="pre">Mandelbrot_N.newton_calc()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../API/standard_models.html#fractalshades.models.Burning_ship"><code class="docutils literal notranslate"><span class="pre">Burning_ship</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../API/standard_models.html#fractalshades.models.Burning_ship.__init__"><code class="docutils literal notranslate"><span class="pre">Burning_ship.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../API/standard_models.html#fractalshades.models.Burning_ship.calc_std_div"><code class="docutils literal notranslate"><span class="pre">Burning_ship.calc_std_div()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../API/standard_models.html#fractalshades.models.Power_tower"><code class="docutils literal notranslate"><span class="pre">Power_tower</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../API/standard_models.html#fractalshades.models.Power_tower.__init__"><code class="docutils literal notranslate"><span class="pre">Power_tower.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../API/standard_models.html#fractalshades.models.Power_tower.newton_calc"><code class="docutils literal notranslate"><span class="pre">Power_tower.newton_calc()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../API/standard_models.html#fractalshades.models.Collatz"><code class="docutils literal notranslate"><span class="pre">Collatz</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../API/standard_models.html#fractalshades.models.Collatz.__init__"><code class="docutils literal notranslate"><span class="pre">Collatz.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../API/standard_models.html#fractalshades.models.Collatz.base_calc"><code class="docutils literal notranslate"><span class="pre">Collatz.base_calc()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../API/postproc.html">Postprocessing fields</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../API/postproc.html#fractalshades.postproc.Postproc_batch"><code class="docutils literal notranslate"><span class="pre">Postproc_batch</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../API/postproc.html#fractalshades.postproc.Postproc_batch.__init__"><code class="docutils literal notranslate"><span class="pre">Postproc_batch.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../API/postproc.html#fractalshades.postproc.Postproc_batch.add_postproc"><code class="docutils literal notranslate"><span class="pre">Postproc_batch.add_postproc()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../API/postproc.html#fractalshades.postproc.Postproc"><code class="docutils literal notranslate"><span class="pre">Postproc</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../API/postproc.html#fractalshades.postproc.Raw_pp"><code class="docutils literal notranslate"><span class="pre">Raw_pp</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../API/postproc.html#fractalshades.postproc.Raw_pp.__init__"><code class="docutils literal notranslate"><span class="pre">Raw_pp.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../API/postproc.html#fractalshades.postproc.Continuous_iter_pp"><code class="docutils literal notranslate"><span class="pre">Continuous_iter_pp</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../API/postproc.html#fractalshades.postproc.Continuous_iter_pp.__init__"><code class="docutils literal notranslate"><span class="pre">Continuous_iter_pp.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../API/postproc.html#fractalshades.postproc.Fieldlines_pp"><code class="docutils literal notranslate"><span class="pre">Fieldlines_pp</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../API/postproc.html#fractalshades.postproc.Fieldlines_pp.__init__"><code class="docutils literal notranslate"><span class="pre">Fieldlines_pp.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../API/postproc.html#fractalshades.postproc.DEM_pp"><code class="docutils literal notranslate"><span class="pre">DEM_pp</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../API/postproc.html#fractalshades.postproc.DEM_pp.__init__"><code class="docutils literal notranslate"><span class="pre">DEM_pp.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../API/postproc.html#fractalshades.postproc.DEM_normal_pp"><code class="docutils literal notranslate"><span class="pre">DEM_normal_pp</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../API/postproc.html#fractalshades.postproc.DEM_normal_pp.__init__"><code class="docutils literal notranslate"><span class="pre">DEM_normal_pp.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../API/postproc.html#fractalshades.postproc.Attr_pp"><code class="docutils literal notranslate"><span class="pre">Attr_pp</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../API/postproc.html#fractalshades.postproc.Attr_pp.__init__"><code class="docutils literal notranslate"><span class="pre">Attr_pp.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../API/postproc.html#fractalshades.postproc.Attr_normal_pp"><code class="docutils literal notranslate"><span class="pre">Attr_normal_pp</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../API/postproc.html#fractalshades.postproc.Attr_normal_pp.__init__"><code class="docutils literal notranslate"><span class="pre">Attr_normal_pp.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../API/postproc.html#fractalshades.postproc.Fractal_array"><code class="docutils literal notranslate"><span class="pre">Fractal_array</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../API/postproc.html#fractalshades.postproc.Fractal_array.__init__"><code class="docutils literal notranslate"><span class="pre">Fractal_array.__init__()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../API/layers.html">Image layers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../API/layers.html#fractalshades.colors.layers.Virtual_layer"><code class="docutils literal notranslate"><span class="pre">Virtual_layer</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../API/layers.html#fractalshades.colors.layers.Virtual_layer.__init__"><code class="docutils literal notranslate"><span class="pre">Virtual_layer.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../API/layers.html#fractalshades.colors.layers.Virtual_layer.set_mask"><code class="docutils literal notranslate"><span class="pre">Virtual_layer.set_mask()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../API/layers.html#fractalshades.colors.layers.Bool_layer"><code class="docutils literal notranslate"><span class="pre">Bool_layer</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../API/layers.html#fractalshades.colors.layers.Bool_layer.__init__"><code class="docutils literal notranslate"><span class="pre">Bool_layer.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../API/layers.html#fractalshades.colors.layers.Color_layer"><code class="docutils literal notranslate"><span class="pre">Color_layer</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../API/layers.html#fractalshades.colors.layers.Color_layer.__init__"><code class="docutils literal notranslate"><span class="pre">Color_layer.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../API/layers.html#fractalshades.colors.layers.Color_layer.overlay"><code class="docutils literal notranslate"><span class="pre">Color_layer.overlay()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../API/layers.html#fractalshades.colors.layers.Color_layer.set_mask"><code class="docutils literal notranslate"><span class="pre">Color_layer.set_mask()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../API/layers.html#fractalshades.colors.layers.Color_layer.set_twin_field"><code class="docutils literal notranslate"><span class="pre">Color_layer.set_twin_field()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../API/layers.html#fractalshades.colors.layers.Color_layer.shade"><code class="docutils literal notranslate"><span class="pre">Color_layer.shade()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../API/layers.html#fractalshades.colors.layers.Normal_map_layer"><code class="docutils literal notranslate"><span class="pre">Normal_map_layer</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../API/layers.html#fractalshades.colors.layers.Normal_map_layer.__init__"><code class="docutils literal notranslate"><span class="pre">Normal_map_layer.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../API/layers.html#fractalshades.colors.layers.Normal_map_layer.set_mask"><code class="docutils literal notranslate"><span class="pre">Normal_map_layer.set_mask()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../API/layers.html#fractalshades.colors.layers.Grey_layer"><code class="docutils literal notranslate"><span class="pre">Grey_layer</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../API/layers.html#fractalshades.colors.layers.Grey_layer.__init__"><code class="docutils literal notranslate"><span class="pre">Grey_layer.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../API/layers.html#fractalshades.colors.layers.Grey_layer.set_mask"><code class="docutils literal notranslate"><span class="pre">Grey_layer.set_mask()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../API/layers.html#fractalshades.colors.layers.Disp_layer"><code class="docutils literal notranslate"><span class="pre">Disp_layer</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../API/layers.html#fractalshades.colors.layers.Disp_layer.__init__"><code class="docutils literal notranslate"><span class="pre">Disp_layer.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../API/layers.html#fractalshades.colors.layers.Disp_layer.set_mask"><code class="docutils literal notranslate"><span class="pre">Disp_layer.set_mask()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../API/layers.html#fractalshades.colors.layers.Blinn_lighting"><code class="docutils literal notranslate"><span class="pre">Blinn_lighting</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../API/layers.html#fractalshades.colors.layers.Blinn_lighting.__init__"><code class="docutils literal notranslate"><span class="pre">Blinn_lighting.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../API/layers.html#fractalshades.colors.layers.Blinn_lighting.add_light_source"><code class="docutils literal notranslate"><span class="pre">Blinn_lighting.add_light_source()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../API/layers.html#fractalshades.colors.layers.Overlay_mode"><code class="docutils literal notranslate"><span class="pre">Overlay_mode</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../API/layers.html#fractalshades.colors.layers.Overlay_mode.__init__"><code class="docutils literal notranslate"><span class="pre">Overlay_mode.__init__()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../API/colors.html">Color mapping</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../API/colors.html#fractalshades.colors.Fractal_colormap"><code class="docutils literal notranslate"><span class="pre">Fractal_colormap</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../API/colors.html#fractalshades.colors.Fractal_colormap.__init__"><code class="docutils literal notranslate"><span class="pre">Fractal_colormap.__init__()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../API/GUI.html">GUI</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../API/GUI.html#fractalshades.gui.guimodel.Fractal_GUI"><code class="docutils literal notranslate"><span class="pre">Fractal_GUI</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../API/GUI.html#fractalshades.gui.guimodel.Fractal_GUI.__init__"><code class="docutils literal notranslate"><span class="pre">Fractal_GUI.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../API/GUI.html#fractalshades.gui.guimodel.Fractal_GUI.connect_image"><code class="docutils literal notranslate"><span class="pre">Fractal_GUI.connect_image()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../API/GUI.html#fractalshades.gui.guimodel.Fractal_GUI.connect_mouse"><code class="docutils literal notranslate"><span class="pre">Fractal_GUI.connect_mouse()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../API/GUI.html#fractalshades.gui.guimodel.Fractal_GUI.show"><code class="docutils literal notranslate"><span class="pre">Fractal_GUI.show()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../API/GUI.html#fractalshades.gui.guitemplates.std_zooming"><code class="docutils literal notranslate"><span class="pre">std_zooming</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../API/GUI.html#fractalshades.gui.guitemplates.std_zooming.__init__"><code class="docutils literal notranslate"><span class="pre">std_zooming.__init__()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../API/logging.html">Logging</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../API/logging.html#fractalshades.log.set_log_handlers"><code class="docutils literal notranslate"><span class="pre">set_log_handlers()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../API/db.html">Databases</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../API/db.html#fractalshades.db.Db"><code class="docutils literal notranslate"><span class="pre">Db</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../API/db.html#fractalshades.db.Db.__init__"><code class="docutils literal notranslate"><span class="pre">Db.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../API/db.html#fractalshades.db.Db.plot"><code class="docutils literal notranslate"><span class="pre">Db.plot()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../API/db.html#fractalshades.db.Db.set_plotter"><code class="docutils literal notranslate"><span class="pre">Db.set_plotter()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../API/db.html#fractalshades.db.Frame"><code class="docutils literal notranslate"><span class="pre">Frame</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../API/db.html#fractalshades.db.Frame.__init__"><code class="docutils literal notranslate"><span class="pre">Frame.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../API/db.html#fractalshades.db.Exp_db"><code class="docutils literal notranslate"><span class="pre">Exp_db</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../API/db.html#fractalshades.db.Exp_db.__init__"><code class="docutils literal notranslate"><span class="pre">Exp_db.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../API/db.html#fractalshades.db.Exp_db.plot"><code class="docutils literal notranslate"><span class="pre">Exp_db.plot()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../API/db.html#fractalshades.db.Exp_frame"><code class="docutils literal notranslate"><span class="pre">Exp_frame</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../API/db.html#fractalshades.db.Exp_frame.__init__"><code class="docutils literal notranslate"><span class="pre">Exp_frame.__init__()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../API/movie.html">Movie module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../API/movie.html#fractalshades.movie.Movie"><code class="docutils literal notranslate"><span class="pre">Movie</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../API/movie.html#fractalshades.movie.Movie.__init__"><code class="docutils literal notranslate"><span class="pre">Movie.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../API/movie.html#fractalshades.movie.Movie.add_sequence"><code class="docutils literal notranslate"><span class="pre">Movie.add_sequence()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../API/movie.html#fractalshades.movie.Movie.export_frame"><code class="docutils literal notranslate"><span class="pre">Movie.export_frame()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../API/movie.html#fractalshades.movie.Movie.make"><code class="docutils literal notranslate"><span class="pre">Movie.make()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../API/movie.html#fractalshades.movie.Camera_pan"><code class="docutils literal notranslate"><span class="pre">Camera_pan</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../API/movie.html#fractalshades.movie.Camera_pan.__init__"><code class="docutils literal notranslate"><span class="pre">Camera_pan.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../API/movie.html#fractalshades.movie.Camera_zoom"><code class="docutils literal notranslate"><span class="pre">Camera_zoom</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../API/movie.html#fractalshades.movie.Camera_zoom.__init__"><code class="docutils literal notranslate"><span class="pre">Camera_zoom.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../API/movie.html#fractalshades.movie.Custom_sequence"><code class="docutils literal notranslate"><span class="pre">Custom_sequence</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../API/movie.html#fractalshades.movie.Custom_sequence.__init__"><code class="docutils literal notranslate"><span class="pre">Custom_sequence.__init__()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../making_movies.html">Making movies</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../making_movies.html#example-pan-sequence">Example: pan sequence</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../making_movies.html#example-zoom-sequence">Example: zoom sequence</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../making_movies.html#example-custom-zoom-sequence">Example: “Custom” zoom sequence</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../making_movies.html#example-using-distance-estimation-plots">Example: Using Distance Estimation plots</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../changelog.html#rev-1-1">Rev 1.1</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../changelog.html#rev-1-1-0">Rev 1.1.0</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../changelog.html#rev-1-1-1">Rev 1.1.1</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../changelog.html#rev-1-0">Rev 1.0</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../changelog.html#rev-1-0-3">Rev 1.0.3</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../changelog.html#rev-1-0-2">Rev 1.0.2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../changelog.html#rev-1-0-1">Rev 1.0.1</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../changelog.html#rev-1-0-0">Rev 1.0.0</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../changelog.html#rev-0-5">Rev 0.5</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../changelog.html#rev-0-5-6">Rev 0.5.6</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../changelog.html#rev-0-5-5">Rev 0.5.5</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../changelog.html#rev-0-5-4">Rev 0.5.4</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../changelog.html#rev-0-5-3">Rev 0.5.3</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../changelog.html#rev-0-5-2">Rev 0.5.2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../changelog.html#rev-0-5-0">Rev 0.5.0</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../changelog.html#rev-0-4">Rev 0.4</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../changelog.html#rev-0-4-3">Rev 0.4.3</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../changelog.html#rev-0-4-2">Rev 0.4.2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../changelog.html#rev-0-4-1">Rev 0.4.1</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../acknowledgment.html">Acknowledgment</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Fractalshades</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">fractalshades.postproc</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">

           <div itemprop="articleBody">
             
  <h1>Source code for fractalshades.postproc</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numba</span>
<span class="kn">from</span> <span class="nn">numpy.lib.format</span> <span class="kn">import</span> <span class="n">open_memmap</span>

<span class="kn">import</span> <span class="nn">fractalshades</span> <span class="k">as</span> <span class="nn">fs</span>
<span class="c1">#import fractalshades.numpy_utils.xrange as fsx</span>
<span class="kn">import</span> <span class="nn">fractalshades.numpy_utils.expr_parser</span> <span class="k">as</span> <span class="nn">fs_parser</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<div class="viewcode-block" id="Postproc_batch">
<a class="viewcode-back" href="../../API/postproc.html#fractalshades.postproc.Postproc_batch">[docs]</a>
<span class="k">class</span> <span class="nc">Postproc_batch</span><span class="p">:</span>
<div class="viewcode-block" id="Postproc_batch.__init__">
<a class="viewcode-back" href="../../API/postproc.html#fractalshades.postproc.Postproc_batch.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fractal</span><span class="p">,</span> <span class="n">calc_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Container for several postprocessing objects (instances of `Postproc`)</span>
<span class="sd">        which share the same Fractal &amp; calculation (*calc_name*)</span>
<span class="sd">        </span>
<span class="sd">        It is usefull to have such container to avoid re-calculation of data</span>
<span class="sd">        that can be shared between several post-processing objects.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ==========</span>
<span class="sd">        fractal : fractalshades.Fractal instance</span>
<span class="sd">            The shared fractal object</span>
<span class="sd">        calc_name : str </span>
<span class="sd">            The string identifier for the shared calculation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fractal</span> <span class="o">=</span> <span class="n">fractal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calc_name</span> <span class="o">=</span> <span class="n">calc_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">posts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">postnames_2d</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Temporary data used when iterating chunk_slices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span></div>

        <span class="c1"># self.clear_chunk_data()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">postnames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">posts</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

<div class="viewcode-block" id="Postproc_batch.add_postproc">
<a class="viewcode-back" href="../../API/postproc.html#fractalshades.postproc.Postproc_batch.add_postproc">[docs]</a>
    <span class="k">def</span> <span class="nf">add_postproc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">postname</span><span class="p">,</span> <span class="n">postproc</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add successive postprocessing and ensure they share identical</span>
<span class="sd">        *fractal* &amp; *calc_name*</span>

<span class="sd">        Parameters</span>
<span class="sd">        ==========</span>
<span class="sd">        postname : str</span>
<span class="sd">            The string identifier that will be associated with this</span>
<span class="sd">            post-processing object</span>
<span class="sd">        postproc : `Postproc` instance</span>
<span class="sd">            The post-processing object to be added</span>

<span class="sd">        Notes</span>
<span class="sd">        =====</span>
<span class="sd">        .. warning::</span>
<span class="sd">            A Postproc can only be added to one batch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">postproc</span><span class="o">.</span><span class="n">batch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Postproc can only be linked to one batch&quot;</span><span class="p">)</span>

        <span class="n">postproc</span><span class="o">.</span><span class="n">link_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="c1"># Give access to batch members from postproc</span>
        <span class="k">if</span> <span class="n">postproc</span><span class="o">.</span><span class="n">field_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">posts</span><span class="p">[</span><span class="n">postname</span><span class="p">]</span> <span class="o">=</span> <span class="n">postproc</span>

        <span class="k">elif</span> <span class="n">postproc</span><span class="o">.</span><span class="n">field_count</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># We need to add 2 separate fields</span>
            <span class="n">x_field</span> <span class="o">=</span> <span class="n">postproc</span><span class="o">.</span><span class="n">x</span>
            <span class="n">y_field</span> <span class="o">=</span> <span class="n">postproc</span><span class="o">.</span><span class="n">y</span>
            <span class="n">x_field</span><span class="o">.</span><span class="n">link_sibling</span><span class="p">(</span><span class="n">y_field</span><span class="p">)</span>
            <span class="n">y_field</span><span class="o">.</span><span class="n">link_sibling</span><span class="p">(</span><span class="n">x_field</span><span class="p">)</span>
            <span class="n">x_field</span><span class="o">.</span><span class="n">link_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">y_field</span><span class="o">.</span><span class="n">link_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">posts</span><span class="p">[</span><span class="n">postname</span> <span class="o">+</span> <span class="s2">&quot;_x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_field</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">posts</span><span class="p">[</span><span class="n">postname</span> <span class="o">+</span> <span class="s2">&quot;_y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_field</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">postnames_2d</span> <span class="o">+=</span> <span class="p">[</span><span class="n">postname</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;postproc.field_count bigger than 2: </span><span class="si">{</span><span class="n">postproc</span><span class="o">.</span><span class="n">field_count</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span></div>



    <span class="k">def</span> <span class="nf">set_chunk_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk_slice</span><span class="p">,</span> <span class="n">chunk_mask</span><span class="p">,</span> <span class="n">c_pix</span><span class="p">,</span>
            <span class="n">Z</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">stop_reason</span><span class="p">,</span> <span class="n">stop_iter</span><span class="p">,</span> <span class="n">complex_dic</span><span class="p">,</span> <span class="n">int_dic</span><span class="p">,</span> <span class="n">termination_dic</span>
    <span class="p">):</span>
        <span class="c1"># self.chunk_slice = chunk_slice</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span><span class="p">[</span><span class="n">chunk_slice</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">chunk_mask</span><span class="p">,</span> <span class="n">c_pix</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">stop_reason</span><span class="p">,</span> <span class="n">stop_iter</span><span class="p">,</span>
            <span class="n">complex_dic</span><span class="p">,</span> <span class="n">int_dic</span><span class="p">,</span> <span class="n">termination_dic</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="n">chunk_slice</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">update_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk_slice</span><span class="p">,</span> <span class="n">context_update</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="n">chunk_slice</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">context_update</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">clear_chunk_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk_slice</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Temporary data shared by postproc items when iterating a given</span>
<span class="sd">        chunk &quot;&quot;&quot;</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span><span class="p">[</span><span class="n">chunk_slice</span><span class="p">]</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="n">chunk_slice</span><span class="p">]</span></div>



<div class="viewcode-block" id="Postproc">
<a class="viewcode-back" href="../../API/postproc.html#fractalshades.postproc.Postproc">[docs]</a>
<span class="k">class</span> <span class="nc">Postproc</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract base class for all postprocessing objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">field_count</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Filter None values : removing them from post_dic.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_holomorphic</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">link_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Link to Postproc group</span>
<span class="sd">        :meta private:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch</span> <span class="o">=</span> <span class="n">batch</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fractal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">fractal</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">calc_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">calc_name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">raw_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">raw_data</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">context</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># The fractal state object</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractal</span><span class="o">.</span><span class="n">_calc_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">calc_name</span><span class="p">][</span><span class="s2">&quot;state&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">holomorphic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_holomorphic</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">complex_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">fractal</span><span class="o">.</span><span class="n">complex_type</span>
            <span class="n">select</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">):</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">):</span> <span class="kc">True</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_holomorphic</span> <span class="o">=</span> <span class="n">select</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">complex_type</span><span class="p">)]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_holomorphic</span>

    <span class="k">def</span> <span class="nf">ensure_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk_slice</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check that the provided context contains the expected data</span>
<span class="sd">        :meta private:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="n">chunk_slice</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> should be computed before </span><span class="si">{}</span><span class="s2">. &quot;</span>
                   <span class="s2">&quot;Please add the relevant item to this post-processing &quot;</span>
                   <span class="s2">&quot;batch.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk_slice</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Subclasses should implement</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">get_zn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">complex_dic</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">holomorphic</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Z</span><span class="p">[</span><span class="n">complex_dic</span><span class="p">[</span><span class="s2">&quot;zn&quot;</span><span class="p">],</span> <span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Z</span><span class="p">[</span><span class="n">complex_dic</span><span class="p">[</span><span class="s2">&quot;xn&quot;</span><span class="p">],</span> <span class="p">:]</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">Z</span><span class="p">[</span><span class="n">complex_dic</span><span class="p">[</span><span class="s2">&quot;yn&quot;</span><span class="p">],</span> <span class="p">:]</span>
        
    <span class="k">def</span> <span class="nf">get_dzndc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">c_pix</span><span class="p">,</span> <span class="n">complex_dic</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Returns the derivatives taking into account potential scaling</span>
<span class="sd">        due to transfomation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">proj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractal</span><span class="o">.</span><span class="n">projection</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">holomorphic</span><span class="p">:</span>
            <span class="n">dzndc</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">complex_dic</span><span class="p">[</span><span class="s2">&quot;dzndc&quot;</span><span class="p">],</span> <span class="p">:]</span>
            <span class="k">if</span> <span class="n">proj</span><span class="o">.</span><span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">apply_df</span><span class="p">(</span><span class="n">proj</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">c_pix</span><span class="p">,</span> <span class="n">dzndc</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">dzndc</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">dXdA</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">complex_dic</span><span class="p">[</span><span class="s2">&quot;dxnda&quot;</span><span class="p">],</span> <span class="p">:]</span>
            <span class="n">dXdB</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">complex_dic</span><span class="p">[</span><span class="s2">&quot;dxndb&quot;</span><span class="p">],</span> <span class="p">:]</span>
            <span class="n">dYdA</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">complex_dic</span><span class="p">[</span><span class="s2">&quot;dynda&quot;</span><span class="p">],</span> <span class="p">:]</span>
            <span class="n">dYdB</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">complex_dic</span><span class="p">[</span><span class="s2">&quot;dyndb&quot;</span><span class="p">],</span> <span class="p">:]</span>

            <span class="k">if</span> <span class="n">proj</span><span class="o">.</span><span class="n">dfBS</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">apply_dfBS</span><span class="p">(</span><span class="n">proj</span><span class="o">.</span><span class="n">dfBS</span><span class="p">,</span> <span class="n">c_pix</span><span class="p">,</span> <span class="n">dXdA</span><span class="p">,</span> <span class="n">dXdB</span><span class="p">,</span> <span class="n">dYdA</span><span class="p">,</span> <span class="n">dYdB</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">dXdA</span><span class="p">,</span> <span class="n">dXdB</span><span class="p">,</span> <span class="n">dYdA</span><span class="p">,</span> <span class="n">dYdB</span>


    <span class="k">def</span> <span class="nf">get_std_cpt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c_pix</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; image pixel -&gt; c mapping</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Note: we *could* store this at pp batch level but for the moment it</span>
        <span class="c1"># is only used for 1 postproc kind (Fieldlines) so not worth the effort</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractal</span><span class="o">.</span><span class="n">get_std_cpt</span><span class="p">(</span><span class="n">c_pix</span><span class="p">)</span></div>



<div class="viewcode-block" id="Raw_pp">
<a class="viewcode-back" href="../../API/postproc.html#fractalshades.postproc.Raw_pp">[docs]</a>
<span class="k">class</span> <span class="nc">Raw_pp</span><span class="p">(</span><span class="n">Postproc</span><span class="p">):</span>
<div class="viewcode-block" id="Raw_pp.__init__">
<a class="viewcode-back" href="../../API/postproc.html#fractalshades.postproc.Raw_pp.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;A raw postproc provide direct access to the res data stored (memmap)</span>
<span class="sd">        during calculation. (Similar to what does `Fractal_array`  but </span>
<span class="sd">        here within a `Postproc_batch`)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ==========</span>
<span class="sd">        key: str</span>
<span class="sd">            The raw data key. Should be one of the *complex_codes*,</span>
<span class="sd">            *int_codes*, *termination_codes* for this calculation.</span>
<span class="sd">        func: None | callable | a str of variable x (e.g. &quot;np.sin(x)&quot;)</span>
<span class="sd">            will be applied as a pre-processing step to the raw data if not</span>
<span class="sd">            `None`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">fs_parser</span><span class="o">.</span><span class="n">func_parser</span><span class="p">([</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">func</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk_slice</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Returns the raw array, with self.func applied if not None &quot;&quot;&quot;</span>
        <span class="n">fractal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractal</span>
        <span class="n">calc_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_name</span>
        <span class="n">func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span>
        <span class="n">codes</span> <span class="o">=</span> <span class="n">fractal</span><span class="o">.</span><span class="n">_calc_data</span><span class="p">[</span><span class="n">calc_name</span><span class="p">][</span><span class="s2">&quot;saved_codes&quot;</span><span class="p">]</span>
        <span class="p">(</span><span class="n">chunk_mask</span><span class="p">,</span> <span class="n">c_pix</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">stop_reason</span><span class="p">,</span> <span class="n">stop_iter</span><span class="p">,</span> <span class="n">complex_dic</span><span class="p">,</span>
         <span class="n">int_dic</span><span class="p">,</span> <span class="n">termination_dic</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span><span class="p">[</span><span class="n">chunk_slice</span><span class="p">]</span>
        
        <span class="n">kind</span> <span class="o">=</span> <span class="n">fractal</span><span class="o">.</span><span class="n">kind_from_code</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">codes</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;complex&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;for batch post-processing of </span><span class="si">{}</span><span class="s2">, complex &quot;</span>
                <span class="s2">&quot;vals should be mapped to float, provide `func` (</span><span class="si">{}</span><span class="s2">).&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">))</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">complex_dic</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="p">:]</span>
        <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;int&quot;</span><span class="p">:</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">U</span><span class="p">[</span><span class="n">int_dic</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="p">:]</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;stop_reason&quot;</span><span class="p">:</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">stop_reason</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;stop_iter&quot;</span><span class="p">:</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">stop_iter</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
        
        <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">arr</span><span class="p">,</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">arr</span><span class="p">),</span> <span class="p">{}</span></div>



<div class="viewcode-block" id="Continuous_iter_pp">
<a class="viewcode-back" href="../../API/postproc.html#fractalshades.postproc.Continuous_iter_pp">[docs]</a>
<span class="k">class</span> <span class="nc">Continuous_iter_pp</span><span class="p">(</span><span class="n">Postproc</span><span class="p">):</span>
<div class="viewcode-block" id="Continuous_iter_pp.__init__">
<a class="viewcode-back" href="../../API/postproc.html#fractalshades.postproc.Continuous_iter_pp.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">a_d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">epsilon_cv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">floor_iter</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a continuous iteration number: this is the iteration count at</span>
<span class="sd">        bailout, plus a fractionnal part to allow smooth coloring.</span>
<span class="sd">        Implementation based on potential, for details see:</span>

<span class="sd">            - *On Smooth Fractal Coloring Techniques*,</span>
<span class="sd">              **Jussi Härkönenen**, Abo University, 2007</span>

<span class="sd">        Parameters</span>
<span class="sd">        ==========</span>
<span class="sd">        kind :  str &quot;infinity&quot; | &quot;convergent&quot; | &quot;transcendent&quot;</span>
<span class="sd">            the classification of potential function.</span>
<span class="sd">        d : None | int</span>
<span class="sd">            degree of polynome d &gt;= 2 if kind = &quot;infinity&quot;</span>
<span class="sd">        a_d : None | float</span>
<span class="sd">            coeff of higher order monome if kind = &quot;infinity&quot;</span>
<span class="sd">        M : None | float</span>
<span class="sd">            High number corresponding to the criteria for stopping iteration</span>
<span class="sd">            if kind = &quot;infinity&quot;</span>
<span class="sd">        epsilon_cv : None | float</span>
<span class="sd">            Small number corresponding to the criteria for stopping iteration</span>
<span class="sd">            if kind = &quot;convergent&quot;</span>
<span class="sd">        floor_iter : int</span>
<span class="sd">            If not 0, a shift will be applied and floor_iter become the 0th </span>
<span class="sd">            iteration.</span>
<span class="sd">            Used to avoids loss of precision (banding) for very large iteration</span>
<span class="sd">            numbers, usually above several milions. For </span>
<span class="sd">            reference, the largest integer that cannot be accurately</span>
<span class="sd">            represented with a float32 is &gt; 16 M), banding will start to be</span>
<span class="sd">            noticeable before.</span>

<span class="sd">        Notes</span>
<span class="sd">        =====</span>
<span class="sd">        .. note::</span>
<span class="sd">            Usually it is not needed to set any parameter ; </span>
<span class="sd">            if a parameter ``param``</span>
<span class="sd">            is not provided, it will defaut to the attribute of </span>
<span class="sd">            the fractal with name ``potential_&lt;param&gt;``, which should be the </span>
<span class="sd">            recommended value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="n">post_dic</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;kind&quot;</span><span class="p">:</span> <span class="n">kind</span><span class="p">,</span>
            <span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="n">d</span><span class="p">,</span>
            <span class="s2">&quot;a_d&quot;</span><span class="p">:</span> <span class="n">a_d</span><span class="p">,</span>
            <span class="s2">&quot;M&quot;</span><span class="p">:</span> <span class="n">M</span><span class="p">,</span>
            <span class="s2">&quot;epsilon_cv&quot;</span><span class="p">:</span> <span class="n">epsilon_cv</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">post_dic</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">post_dic</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_potential_dic</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_floor_iter</span> <span class="o">=</span> <span class="n">floor_iter</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">potential_dic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Returns the potential parameters properties</span>
<span class="sd">           priority order :</span>
<span class="sd">               1) user input to Continuous_iter_pp constructor</span>
<span class="sd">               2) fractal (or fractal &#39;state&#39;) defaut potential attributes</span>
<span class="sd">                   (&quot;potential_&quot; + prop)</span>
<span class="sd">               3) default to None if 1) and 2) fail. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_potential_dic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_potential_dic</span>

        <span class="n">post_dic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_dic</span>
        <span class="n">_potential_dic</span> <span class="o">=</span> <span class="p">{}</span>


        <span class="n">fractal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractal</span> <span class="c1"># The factal</span>
        <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;a_d&quot;</span><span class="p">,</span> <span class="s2">&quot;M_cutoff&quot;</span><span class="p">]:</span>
            <span class="n">_potential_dic</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">=</span>  <span class="n">post_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">prop</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">fractal</span><span class="p">,</span> <span class="s2">&quot;potential_&quot;</span> <span class="o">+</span> <span class="n">prop</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="c1"># The fractal state</span>
        <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="s2">&quot;epsilon_cv&quot;</span><span class="p">]:</span>
            <span class="n">_potential_dic</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">=</span>  <span class="n">post_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">prop</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;potential_&quot;</span> <span class="o">+</span> <span class="n">prop</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_potential_dic</span> <span class="o">=</span> <span class="n">_potential_dic</span>
        <span class="k">return</span> <span class="n">_potential_dic</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk_slice</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;  Returns the real Iteration number</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">(</span><span class="n">chunk_mask</span><span class="p">,</span> <span class="n">c_pix</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">stop_reason</span><span class="p">,</span> <span class="n">stop_iter</span><span class="p">,</span> <span class="n">complex_dic</span><span class="p">,</span>
         <span class="n">int_dic</span><span class="p">,</span> <span class="n">termination_dic</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span><span class="p">[</span><span class="n">chunk_slice</span><span class="p">]</span>

        <span class="n">n</span> <span class="o">=</span> <span class="n">stop_iter</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">potential_dic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">potential_dic</span>
        
        <span class="n">zn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_zn</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">complex_dic</span><span class="p">)</span> <span class="c1">#[&quot;zn&quot;], :]</span>

        <span class="k">if</span> <span class="n">potential_dic</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;infinity&quot;</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">potential_dic</span><span class="p">[</span><span class="s2">&quot;d&quot;</span><span class="p">]</span>
            <span class="n">a_d</span> <span class="o">=</span> <span class="n">potential_dic</span><span class="p">[</span><span class="s2">&quot;a_d&quot;</span><span class="p">]</span>
            <span class="n">M</span> <span class="o">=</span> <span class="n">potential_dic</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">]</span>

            <span class="n">nu_frac</span> <span class="o">=</span> <span class="n">Continuous_iter_pp_infinity</span><span class="p">(</span><span class="n">zn</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">a_d</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">potential_dic</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;convergent&quot;</span><span class="p">:</span>
            <span class="n">eps</span> <span class="o">=</span> <span class="n">potential_dic</span><span class="p">[</span><span class="s2">&quot;epsilon_cv&quot;</span><span class="p">]</span>
            <span class="n">attractivity</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">complex_dic</span><span class="p">[</span><span class="s2">&quot;attractivity&quot;</span><span class="p">]]</span>
            <span class="n">z_star</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">complex_dic</span><span class="p">[</span><span class="s2">&quot;zr&quot;</span><span class="p">]]</span>
            <span class="n">nu_frac</span> <span class="o">=</span> <span class="n">Continuous_iter_pp_convergent</span><span class="p">(</span>
                <span class="n">zn</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">attractivity</span><span class="p">,</span> <span class="n">z_star</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">potential_dic</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;transcendent&quot;</span><span class="p">:</span>
            <span class="c1"># Not possible to define a proper potential for a </span>
            <span class="c1"># transcendental fonction</span>
            <span class="n">nu_frac</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Potential kind: </span><span class="si">{</span><span class="n">potential_dic</span><span class="p">[</span><span class="s1">&#39;kind&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> unsupported&quot;</span>
        <span class="p">)</span>

        <span class="c1"># We need to take care of special cases to ensure that</span>
        <span class="c1"># -1 &lt; nu_frac &lt;= 0. </span>
        <span class="c1"># This happen e.g. when the pixel hasn&#39;t reach the limit circle</span>
        <span class="c1"># at current max_iter, so its status is undefined.</span>
        <span class="n">nu_div</span><span class="p">,</span> <span class="n">nu_mod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divmod</span><span class="p">(</span><span class="o">-</span><span class="n">nu_frac</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
        <span class="n">nu_frac</span> <span class="o">=</span> <span class="o">-</span> <span class="n">nu_mod</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="n">nu_div</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="c1"># need explicit casting to int</span>

        <span class="n">nu</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_floor_iter</span><span class="p">)</span> <span class="o">+</span> <span class="n">nu_frac</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">nu</span>

        <span class="n">context_update</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;potential_dic&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">potential_dic</span><span class="p">,</span>
            <span class="s2">&quot;nu_frac&quot;</span><span class="p">:</span> <span class="n">nu_frac</span><span class="p">,</span>
            <span class="s2">&quot;n&quot;</span><span class="p">:</span> <span class="n">n</span><span class="p">,</span> <span class="c1"># + jump,</span>
            <span class="s2">&quot;backshift&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;backshift&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">val</span><span class="p">,</span> <span class="n">context_update</span></div>



<div class="viewcode-block" id="Fieldlines_pp">
<a class="viewcode-back" href="../../API/postproc.html#fractalshades.postproc.Fieldlines_pp">[docs]</a>
<span class="k">class</span> <span class="nc">Fieldlines_pp</span><span class="p">(</span><span class="n">Postproc</span><span class="p">):</span>
<div class="viewcode-block" id="Fieldlines_pp.__init__">
<a class="viewcode-back" href="../../API/postproc.html#fractalshades.postproc.Fieldlines_pp.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">swirl</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">endpoint_k</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a continuous orbit-averaged angular value, allowing to reveal</span>
<span class="sd">        fieldlines. Implementation based on [#f2]_. The averaging orbit starts</span>
<span class="sd">        at the computed `zn_orbit` field if it exists, otherwise at the exit </span>
<span class="sd">        `zn` value, and is truncated after `n_iter` iterations.</span>

<span class="sd">        Fieldlines approximate the external rays which are very important</span>
<span class="sd">        in the study of the Mandelbrot set and more generally in</span>
<span class="sd">        holomorphic dynamics. </span>

<span class="sd">        .. [#f2] *On Smooth Fractal Coloring Techniques*,</span>
<span class="sd">          **Jussi Härkönenen**, Abo University, 2007</span>

<span class="sd">        Parameters</span>
<span class="sd">        ==========</span>
<span class="sd">        n_iter :  int &gt; 0</span>
<span class="sd">            the number of orbit points used for the averageing</span>
<span class="sd">        swirl : float between -1. and 1.</span>
<span class="sd">            adds a random dephasing effect between each successive orbit point</span>
<span class="sd">        endpoint_k : float &gt; 0.</span>
<span class="sd">            A geometric serie is used for scaling individual orbit points,</span>
<span class="sd">            this parameters is the ratio between the last and the first scaling</span>
<span class="sd">            (For an arithmetic mean over the truncated orbit, use 1.)</span>

<span class="sd">        Notes</span>
<span class="sd">        =====</span>
<span class="sd">        .. note::</span>
<span class="sd">            The Continuous iteration number  shall have been calculated before</span>
<span class="sd">            in the same `Postproc_batch`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_iter</span> <span class="o">=</span> <span class="n">n_iter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">swirl</span> <span class="o">=</span> <span class="n">swirl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endpoint_k</span> <span class="o">=</span> <span class="n">endpoint_k</span></div>


    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk_slice</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;  Returns the post arr</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nu_frac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_context</span><span class="p">(</span><span class="n">chunk_slice</span><span class="p">,</span> <span class="s2">&quot;nu_frac&quot;</span><span class="p">)</span>
        <span class="n">potential_dic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_context</span><span class="p">(</span><span class="n">chunk_slice</span><span class="p">,</span> <span class="s2">&quot;potential_dic&quot;</span><span class="p">)</span>

        <span class="p">(</span><span class="n">chunk_mask</span><span class="p">,</span> <span class="n">c_pix</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">stop_reason</span><span class="p">,</span> <span class="n">stop_iter</span><span class="p">,</span> <span class="n">complex_dic</span><span class="p">,</span>
         <span class="n">int_dic</span><span class="p">,</span> <span class="n">termination_dic</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span><span class="p">[</span><span class="n">chunk_slice</span><span class="p">]</span>
        <span class="n">c_pt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_std_cpt</span><span class="p">(</span><span class="n">c_pix</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">potential_dic</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;infinity&quot;</span><span class="p">:</span>
            <span class="c1"># Following Jussi Härkönenen - 2007</span>
            <span class="n">backshift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_context</span><span class="p">(</span><span class="n">chunk_slice</span><span class="p">,</span> <span class="s2">&quot;backshift&quot;</span><span class="p">)</span>
            <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_context</span><span class="p">(</span><span class="n">chunk_slice</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">)</span>
            <span class="n">n_iter_fl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_iter</span>
            <span class="n">swirl_fl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">swirl</span>
            <span class="c1"># Geometric serie, last term being damping_ratio * first term</span>
            <span class="n">k_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">geomspace</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">endpoint_k</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">n_iter_fl</span><span class="p">)</span> 
            <span class="n">k_arr</span> <span class="o">=</span> <span class="n">k_arr</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">k_arr</span><span class="p">)</span>
    
            <span class="c1"># randomizing the phse angle</span>
            <span class="n">rg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">phi_arr</span> <span class="o">=</span> <span class="n">rg</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">n_iter_fl</span><span class="p">)</span> <span class="o">*</span> <span class="n">swirl_fl</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractal</span><span class="o">.</span><span class="n">holomorphic</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">zn</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">complex_dic</span><span class="p">[</span><span class="s2">&quot;zn_orbit&quot;</span><span class="p">],</span> <span class="p">:]</span>
                    <span class="n">is_backward</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">assert</span> <span class="n">backshift</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;No stored backshift field found for key: </span><span class="se">\&quot;</span><span class="s2">zn_orbit</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">defaulting to key: </span><span class="se">\&quot;</span><span class="s2">zn</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="n">zn</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">complex_dic</span><span class="p">[</span><span class="s2">&quot;zn&quot;</span><span class="p">],</span> <span class="p">:]</span>
                    <span class="n">is_backward</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">backshift</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Need the right datatype for jit compiler</span>
    
                <span class="n">zn_iterate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractal</span><span class="o">.</span><span class="n">zn_iterate</span>
    
                <span class="n">val</span> <span class="o">=</span> <span class="n">Fieldlines_pp_infinity</span><span class="p">(</span>
                    <span class="n">c_pt</span><span class="p">,</span> <span class="n">zn</span><span class="p">,</span> <span class="n">nu_frac</span><span class="p">,</span> <span class="n">k_arr</span><span class="p">,</span> <span class="n">phi_arr</span><span class="p">,</span> <span class="n">zn_iterate</span><span class="p">,</span>
                    <span class="n">is_backward</span><span class="p">,</span> <span class="n">backshift</span><span class="p">,</span> <span class="n">n</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Non-holomorphic case</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">xn</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">complex_dic</span><span class="p">[</span><span class="s2">&quot;xn_orbit&quot;</span><span class="p">],</span> <span class="p">:]</span>
                    <span class="n">yn</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">complex_dic</span><span class="p">[</span><span class="s2">&quot;yn_orbit&quot;</span><span class="p">],</span> <span class="p">:]</span>
                    <span class="n">is_backward</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">assert</span> <span class="n">backshift</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;No stored backshift field found for key: </span><span class="se">\&quot;</span><span class="s2">zn_orbit</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">defaulting to key: </span><span class="se">\&quot;</span><span class="s2">zn</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="n">xn</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">complex_dic</span><span class="p">[</span><span class="s2">&quot;xn&quot;</span><span class="p">],</span> <span class="p">:]</span>
                    <span class="n">yn</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">complex_dic</span><span class="p">[</span><span class="s2">&quot;yn&quot;</span><span class="p">],</span> <span class="p">:]</span>
                    <span class="n">is_backward</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">backshift</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Need the right datatype for jit compiler</span>
                    
                <span class="n">xnyn_iterate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractal</span><span class="o">.</span><span class="n">xnyn_iterate</span>
                
                <span class="n">val</span> <span class="o">=</span> <span class="n">Fieldlines_pp_infinity_BS</span><span class="p">(</span>
                    <span class="n">c_pt</span><span class="p">,</span> <span class="n">xn</span><span class="p">,</span> <span class="n">yn</span><span class="p">,</span> <span class="n">nu_frac</span><span class="p">,</span> <span class="n">k_arr</span><span class="p">,</span> <span class="n">phi_arr</span><span class="p">,</span> <span class="n">xnyn_iterate</span><span class="p">,</span>
                    <span class="n">is_backward</span><span class="p">,</span> <span class="n">backshift</span><span class="p">,</span> <span class="n">n</span>
                <span class="p">)</span>


        <span class="k">elif</span> <span class="n">potential_dic</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;convergent&quot;</span><span class="p">:</span>
            <span class="n">zn</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">complex_dic</span><span class="p">[</span><span class="s2">&quot;zn&quot;</span><span class="p">],</span> <span class="p">:]</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">Z</span><span class="p">[</span><span class="n">complex_dic</span><span class="p">[</span><span class="s2">&quot;attractivity&quot;</span><span class="p">]]</span>
            <span class="n">z_star</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">complex_dic</span><span class="p">[</span><span class="s2">&quot;zr&quot;</span><span class="p">]]</span>
            <span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">z_star</span> <span class="o">-</span> <span class="n">zn</span><span class="p">)</span> <span class="o">+</span> <span class="n">nu_frac</span> <span class="o">*</span> <span class="n">beta</span>
            <span class="c1"># We have an issue if z_star == zn...</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">*</span> <span class="mf">2.</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Unsupported potential &#39;</span><span class="si">{}</span><span class="s2">&#39; for field lines&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">potential_dic</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">]))</span>

        <span class="k">return</span> <span class="n">val</span><span class="p">,</span> <span class="p">{}</span></div>




<div class="viewcode-block" id="DEM_normal_pp">
<a class="viewcode-back" href="../../API/postproc.html#fractalshades.postproc.DEM_normal_pp">[docs]</a>
<span class="k">class</span> <span class="nc">DEM_normal_pp</span><span class="p">(</span><span class="n">Postproc</span><span class="p">):</span>
    <span class="n">field_count</span> <span class="o">=</span> <span class="mi">2</span>
<div class="viewcode-block" id="DEM_normal_pp.__init__">
<a class="viewcode-back" href="../../API/postproc.html#fractalshades.postproc.DEM_normal_pp.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;potential&quot;</span><span class="p">):</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Return the 2 components of the distance estimation method derivative</span>
<span class="sd">        (*normal map*).</span>
<span class="sd">        This postproc is normally used in combination with a</span>
<span class="sd">        `fractalshades.colors.layers.Normal_map_layer`</span>

<span class="sd">        Parameters</span>
<span class="sd">        ==========</span>
<span class="sd">        `kind`:  str &quot;potential&quot; | &quot;Milnor&quot; | &quot;convergent&quot;</span>
<span class="sd">            if &quot;potential&quot; (default) DEM is base on the potential.</span>
<span class="sd">            For Mandelbrot power 2, &quot;Milnor&quot; option is also available which </span>
<span class="sd">            gives slightly different results (sharper edges).</span>
<span class="sd">            Use &quot;convergent&quot; for convergent fractals...</span>

<span class="sd">        Notes</span>
<span class="sd">        =====</span>
<span class="sd">        .. note::</span>
<span class="sd">            The Continuous iteration number shall have been calculated before</span>
<span class="sd">            in the same `Postproc_batch`</span>
<span class="sd">            If kind=&quot;Milnor&quot;, the following raw complex fields</span>
<span class="sd">            must be available from the calculation:</span>
<span class="sd">            &quot;zn&quot;, &quot;dzndc&quot;, &quot;d2zndc2&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="n">kind</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">x</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Postproc for the real part &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">XYCoord_wrapper_pp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">y</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Postproc for the imag part &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">XYCoord_wrapper_pp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk_slice</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;  Returns the normal as a complex (x, y, 1) is the normal vec</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">potential_dic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_context</span><span class="p">(</span><span class="n">chunk_slice</span><span class="p">,</span> <span class="s2">&quot;potential_dic&quot;</span><span class="p">)</span>
        <span class="p">(</span><span class="n">chunk_mask</span><span class="p">,</span> <span class="n">c_pix</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">stop_reason</span><span class="p">,</span> <span class="n">stop_iter</span><span class="p">,</span> <span class="n">complex_dic</span><span class="p">,</span>
         <span class="n">int_dic</span><span class="p">,</span> <span class="n">termination_dic</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span><span class="p">[</span><span class="n">chunk_slice</span><span class="p">]</span>
        <span class="n">zn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_zn</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">complex_dic</span><span class="p">)</span> <span class="c1">#[&quot;zn&quot;], :]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;Milnor&quot;</span><span class="p">:</span>   <span class="c1"># use only for z -&gt; z**n + c</span>
<span class="c1"># https://www.math.univ-toulouse.fr/~cheritat/wiki-draw/index.php/Mandelbrot_set</span>
            <span class="c1"># dzndc = Z[complex_dic[&quot;dzndc&quot;], :]</span>
            <span class="n">dzndc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dzndc</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">c_pix</span><span class="p">,</span> <span class="n">complex_dic</span><span class="p">)</span>
            <span class="c1"># TODO: d2zndc2 may fail if a projection is used - not tested</span>
            <span class="n">d2zndc2</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">complex_dic</span><span class="p">[</span><span class="s2">&quot;d2zndc2&quot;</span><span class="p">],</span> <span class="p">:]</span> 
            <span class="n">abs_zn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">zn</span><span class="p">)</span>
            <span class="n">lo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">abs_zn</span><span class="p">)</span>
            <span class="n">normal</span> <span class="o">=</span> <span class="n">zn</span> <span class="o">*</span> <span class="n">dzndc</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span><span class="o">+</span><span class="n">lo</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">dzndc</span> <span class="o">*</span> <span class="n">dzndc</span><span class="p">)</span>
                          <span class="o">-</span><span class="n">lo</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">zn</span> <span class="o">*</span> <span class="n">d2zndc2</span><span class="p">))</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;potential&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">potential_dic</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;infinity&quot;</span><span class="p">:</span>
                <span class="c1"># pulls back the normal direction from an approximation of </span>
                <span class="c1"># potential: phi = log(|zn|) / 2**n</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">holomorphic</span><span class="p">:</span>
                    <span class="n">dzndc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dzndc</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">c_pix</span><span class="p">,</span> <span class="n">complex_dic</span><span class="p">)</span> <span class="c1">#, :]</span>
                    <span class="n">normal</span> <span class="o">=</span> <span class="n">zn</span> <span class="o">/</span> <span class="n">dzndc</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">dXdA</span><span class="p">,</span> <span class="n">dXdB</span><span class="p">,</span> <span class="n">dYdA</span><span class="p">,</span> <span class="n">dYdB</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dzndc</span><span class="p">(</span>
                            <span class="n">Z</span><span class="p">,</span> <span class="n">c_pix</span><span class="p">,</span> <span class="n">complex_dic</span>
                    <span class="p">)</span>
                    <span class="c1"># J = [dXdA dXdB]    J.T = [dXdA dYdA]   n = J.T * zn</span>
                    <span class="c1">#     [dYdA dYdB]          [dXdB dYdB]</span>
                    <span class="n">normal</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="p">(</span><span class="n">dXdA</span> <span class="o">*</span> <span class="n">zn</span><span class="o">.</span><span class="n">real</span> <span class="o">+</span> <span class="n">dYdA</span> <span class="o">*</span> <span class="n">zn</span><span class="o">.</span><span class="n">imag</span><span class="p">)</span>
                        <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="p">(</span><span class="n">dXdB</span> <span class="o">*</span> <span class="n">zn</span><span class="o">.</span><span class="n">real</span> <span class="o">+</span> <span class="n">dYdB</span> <span class="o">*</span> <span class="n">zn</span><span class="o">.</span><span class="n">imag</span><span class="p">)</span>
                    <span class="p">)</span>

            <span class="k">elif</span> <span class="n">potential_dic</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;convergent&quot;</span><span class="p">:</span>
            <span class="c1"># pulls back the normal direction from an approximation of</span>
            <span class="c1"># potential (/!\ need to derivate zr w.r.t. c...)</span>
            <span class="c1"># phi = 1. / (abs(zn - zr) * abs(alpha))</span>
                <span class="c1"># dzndc = Z[complex_dic[&quot;dzndc&quot;], :]</span>
                <span class="n">dzndc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dzndc</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">c_pix</span><span class="p">,</span> <span class="n">complex_dic</span><span class="p">)</span>
                <span class="n">zr</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">complex_dic</span><span class="p">[</span><span class="s2">&quot;zr&quot;</span><span class="p">],</span> <span class="p">:]</span>
                <span class="n">dzrdc</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">complex_dic</span><span class="p">[</span><span class="s2">&quot;dzrdc&quot;</span><span class="p">],</span> <span class="p">:]</span>
                <span class="n">normal</span> <span class="o">=</span> <span class="o">-</span> <span class="p">(</span><span class="n">zr</span> <span class="o">-</span> <span class="n">zn</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">dzrdc</span> <span class="o">-</span> <span class="n">dzndc</span><span class="p">)</span>

        <span class="n">skew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractal</span><span class="o">.</span><span class="n">skew</span>
        <span class="k">if</span> <span class="n">skew</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nx</span> <span class="o">=</span> <span class="n">normal</span><span class="o">.</span><span class="n">real</span>
            <span class="n">ny</span> <span class="o">=</span> <span class="n">normal</span><span class="o">.</span><span class="n">imag</span>
            <span class="c1"># These are contravariant coordinates -&gt; we UNskew</span>
            <span class="n">fs</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">apply_unskew_1d</span><span class="p">(</span><span class="n">skew</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span>

        <span class="n">normal</span> <span class="o">=</span> <span class="n">normal</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">normal</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">normal</span><span class="p">,</span> <span class="kc">None</span></div>



<span class="k">class</span> <span class="nc">XYCoord_wrapper_pp</span><span class="p">(</span><span class="n">Postproc</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pp_2d</span><span class="p">,</span> <span class="n">coord</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Helper class to split one complex Postproc into 2 real &amp; imag parts</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pp_2d</span> <span class="o">=</span> <span class="n">pp_2d</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coord</span> <span class="o">=</span> <span class="n">coord</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">context_getitem_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pp_2d</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot;.__getitem__&quot;</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk_slice</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord</span> <span class="o">==</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span>
            <span class="n">normal</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp_2d</span><span class="p">[</span><span class="n">chunk_slice</span><span class="p">]</span>
            <span class="c1"># Save imaginary part in context dict</span>
            <span class="n">context_update</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">context_getitem_key</span><span class="p">:</span> <span class="n">normal</span><span class="o">.</span><span class="n">imag</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">normal</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">context_update</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord</span> <span class="o">==</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span>
            <span class="c1"># Retrieve imaginary part from context, </span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="n">chunk_slice</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">context_getitem_key</span><span class="p">]</span>
            <span class="c1"># Then delete it</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="n">chunk_slice</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">context_getitem_key</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">val</span><span class="p">,</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coord</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">link_sibling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sibling</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; The other coord &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sibling</span> <span class="o">=</span> <span class="n">sibling</span>


<div class="viewcode-block" id="DEM_pp">
<a class="viewcode-back" href="../../API/postproc.html#fractalshades.postproc.DEM_pp">[docs]</a>
<span class="k">class</span> <span class="nc">DEM_pp</span><span class="p">(</span><span class="n">Postproc</span><span class="p">):</span>
    <span class="n">field_count</span> <span class="o">=</span> <span class="mi">1</span>
<div class="viewcode-block" id="DEM_pp.__init__">
<a class="viewcode-back" href="../../API/postproc.html#fractalshades.postproc.DEM_pp.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">px_snap</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Return a distance estimation of the pixel to the fractal set.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ==========</span>
<span class="sd">        `px_snap`:  None | float</span>
<span class="sd">            If not None, pixels at a distance from the fractal lower</span>
<span class="sd">            than `px_snap` (expressed in image pixel) will be snapped to 0.</span>

<span class="sd">        Notes</span>
<span class="sd">        =====</span>
<span class="sd">    </span>
<span class="sd">        .. note::</span>
<span class="sd">            The Continuous iteration number  shall have been calculated before</span>
<span class="sd">            in the same `Postproc_batch`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">px_snap</span> <span class="o">=</span> <span class="n">px_snap</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk_slice</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;  Returns the DEM - &quot;&quot;&quot;</span>
        <span class="n">potential_dic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_context</span><span class="p">(</span><span class="n">chunk_slice</span><span class="p">,</span><span class="s2">&quot;potential_dic&quot;</span><span class="p">)</span>
        <span class="p">(</span><span class="n">chunk_mask</span><span class="p">,</span> <span class="n">c_pix</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">stop_reason</span><span class="p">,</span> <span class="n">stop_iter</span><span class="p">,</span> <span class="n">complex_dic</span><span class="p">,</span>
         <span class="n">int_dic</span><span class="p">,</span> <span class="n">termination_dic</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span><span class="p">[</span><span class="n">chunk_slice</span><span class="p">]</span>

        <span class="n">zn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_zn</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">complex_dic</span><span class="p">)</span> <span class="c1">#Z[complex_dic[&quot;zn&quot;], :]</span>

        <span class="k">if</span> <span class="n">potential_dic</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;infinity&quot;</span><span class="p">:</span>
            <span class="n">abs_zn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">zn</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">holomorphic</span><span class="p">:</span>
                <span class="n">abs_dzndc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_dzndc</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">c_pix</span><span class="p">,</span> <span class="n">complex_dic</span><span class="p">))</span> <span class="c1">#, :]</span>
                <span class="c1"># val = abs_zn * np.log(abs_zn) / abs_dzndc</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="p">(</span><span class="n">dXdA</span><span class="p">,</span> <span class="n">dXdB</span><span class="p">,</span> <span class="n">dYdA</span><span class="p">,</span> <span class="n">dYdB</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dzndc</span><span class="p">(</span>
                        <span class="n">Z</span><span class="p">,</span> <span class="n">c_pix</span><span class="p">,</span> <span class="n">complex_dic</span>
                <span class="p">)</span>
                <span class="c1"># In which direction for an abs value ? </span>
                <span class="c1"># Lets take the maximal singular value</span>
<span class="c1"># https://scicomp.stackexchange.com/questions/8899/robust-algorithm-for-2-times-2-svd</span>
                <span class="c1"># J = [dXdA dXdB] = [a b]</span>
                <span class="c1">#     [dYdA dYdB]   [c d]</span>
                <span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">dXdA</span> <span class="o">+</span> <span class="n">dYdB</span><span class="p">,</span> <span class="n">dXdB</span> <span class="o">-</span> <span class="n">dYdA</span><span class="p">)</span>
                <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">dXdA</span> <span class="o">-</span> <span class="n">dYdB</span><span class="p">,</span> <span class="n">dXdB</span> <span class="o">+</span> <span class="n">dYdA</span><span class="p">)</span>
                <span class="n">abs_dzndc</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">Q</span> <span class="o">+</span> <span class="n">R</span><span class="p">)</span>


            <span class="k">def</span> <span class="nf">nan_frac</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">arr</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>

            <span class="n">val</span> <span class="o">=</span> <span class="n">abs_zn</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">abs_zn</span><span class="p">)</span> <span class="o">/</span> <span class="n">abs_dzndc</span>

        <span class="k">elif</span> <span class="n">potential_dic</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;convergent&quot;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">holomorphic</span>
            <span class="n">dzndc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dzndc</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">c_pix</span><span class="p">,</span> <span class="n">complex_dic</span><span class="p">)</span>
            <span class="n">zr</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">complex_dic</span><span class="p">[</span><span class="s2">&quot;zr&quot;</span><span class="p">]]</span>
            <span class="n">dzrdc</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">complex_dic</span><span class="p">[</span><span class="s2">&quot;dzrdc&quot;</span><span class="p">],</span> <span class="p">:]</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">zr</span> <span class="o">-</span> <span class="n">zn</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">dzrdc</span> <span class="o">-</span> <span class="n">dzndc</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">potential_dic</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">])</span>

        <span class="n">px_snap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">px_snap</span>
        <span class="k">if</span> <span class="n">px_snap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="n">px_snap</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">val</span><span class="p">,</span> <span class="p">{}</span></div>



<div class="viewcode-block" id="Attr_normal_pp">
<a class="viewcode-back" href="../../API/postproc.html#fractalshades.postproc.Attr_normal_pp">[docs]</a>
<span class="k">class</span> <span class="nc">Attr_normal_pp</span><span class="p">(</span><span class="n">Postproc</span><span class="p">):</span>
    <span class="n">field_count</span> <span class="o">=</span> <span class="mi">2</span>
<div class="viewcode-block" id="Attr_normal_pp.__init__">
<a class="viewcode-back" href="../../API/postproc.html#fractalshades.postproc.Attr_normal_pp.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Return the 2 components of the cycle attractivity derivative (*normal</span>
<span class="sd">        map*).</span>
<span class="sd">        This postproc is normally used in combination with a</span>
<span class="sd">        `fractalshades.colors.layers.Normal_map_layer`</span>

<span class="sd">        Notes</span>
<span class="sd">        =====</span>
<span class="sd">        .. note::</span>
<span class="sd">            The following complex fields must be available from a previously</span>
<span class="sd">            run calculation:</span>

<span class="sd">                - &quot;attractivity&quot;</span>
<span class="sd">                - &quot;order&quot; (optionnal)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">x</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Postproc for the real part &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">XYCoord_wrapper_pp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">y</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Postproc for the imag part &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">XYCoord_wrapper_pp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk_slice</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;  Returns the normal as a complex (x, y, 1) is the normal vec</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">(</span><span class="n">chunk_mask</span><span class="p">,</span> <span class="n">c_pix</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">stop_reason</span><span class="p">,</span> <span class="n">stop_iter</span><span class="p">,</span> <span class="n">complex_dic</span><span class="p">,</span>
         <span class="n">int_dic</span><span class="p">,</span> <span class="n">termination_dic</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span><span class="p">[</span><span class="n">chunk_slice</span><span class="p">]</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">Z</span><span class="p">[</span><span class="n">complex_dic</span><span class="p">[</span><span class="s2">&quot;attractivity&quot;</span><span class="p">],</span> <span class="p">:])</span>
        
        <span class="n">dattrdc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">Z</span><span class="p">[</span><span class="n">complex_dic</span><span class="p">[</span><span class="s2">&quot;dattrdc&quot;</span><span class="p">],</span> <span class="p">:])</span>
        <span class="n">proj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractal</span><span class="o">.</span><span class="n">projection</span>
        <span class="k">if</span> <span class="n">proj</span><span class="o">.</span><span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dattrdc</span> <span class="o">=</span> <span class="n">apply_df</span><span class="p">(</span><span class="n">proj</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">c_pix</span><span class="p">,</span> <span class="n">dattrdc</span><span class="p">)</span>


        <span class="n">invalid</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1.</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">putmask</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">invalid</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">putmask</span><span class="p">(</span><span class="n">dattrdc</span><span class="p">,</span> <span class="n">invalid</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>

        <span class="c1"># val = np.sqrt(1. - attr * np.conj(attr)) / r</span>
        <span class="c1"># Now let&#39;s take the total differential of this</span>
        <span class="c1"># While not totally exact this gives good results :</span>
        <span class="n">normal</span> <span class="o">=</span> <span class="n">attr</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">dattrdc</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dattrdc</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">normal</span><span class="p">,</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="Attr_pp">
<a class="viewcode-back" href="../../API/postproc.html#fractalshades.postproc.Attr_pp">[docs]</a>
<span class="k">class</span> <span class="nc">Attr_pp</span><span class="p">(</span><span class="n">Postproc</span><span class="p">):</span>
    <span class="n">field_count</span> <span class="o">=</span> <span class="mi">1</span>
<div class="viewcode-block" id="Attr_pp.__init__">
<a class="viewcode-back" href="../../API/postproc.html#fractalshades.postproc.Attr_pp.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scale_by_order</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Return the cycle attractivity</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ==========</span>
<span class="sd">        scale_by_order : bool</span>
<span class="sd">            If True return the attractivity divided by ccyle order (this</span>
<span class="sd">            allows more realistic 3d-view exports)</span>

<span class="sd">        Notes</span>
<span class="sd">        =====</span>
<span class="sd">        .. note::</span>
<span class="sd">            The following complex fields must be available from a previously</span>
<span class="sd">            run calculation:</span>

<span class="sd">                - &quot;attractivity&quot;</span>
<span class="sd">                - &quot;order&quot; (optionnal)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale_by_order</span> <span class="o">=</span> <span class="n">scale_by_order</span></div>


    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk_slice</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;  Returns the normal as a complex (x, y, 1) is the normal vec</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">(</span><span class="n">chunk_mask</span><span class="p">,</span> <span class="n">c_pix</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">stop_reason</span><span class="p">,</span> <span class="n">stop_iter</span><span class="p">,</span> <span class="n">complex_dic</span><span class="p">,</span>
         <span class="n">int_dic</span><span class="p">,</span> <span class="n">termination_dic</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span><span class="p">[</span><span class="n">chunk_slice</span><span class="p">]</span>
        <span class="c1"># Plotting the &#39;domed&#39; height map for the cycle attractivity</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">complex_dic</span><span class="p">[</span><span class="s2">&quot;attractivity&quot;</span><span class="p">],</span> <span class="p">:]</span>
        <span class="n">abs2_attr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">abs2_attr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">abs2_attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
        <span class="c1"># divide by the cycle order</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">abs2_attr</span><span class="p">)</span> <span class="c1"># / r</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_by_order</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">U</span><span class="p">[</span><span class="n">int_dic</span><span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">],</span> <span class="p">:]</span>
            <span class="n">val</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">r</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">val</span><span class="p">,</span> <span class="p">{}</span></div>



<div class="viewcode-block" id="Fractal_array">
<a class="viewcode-back" href="../../API/postproc.html#fractalshades.postproc.Fractal_array">[docs]</a>
<span class="k">class</span> <span class="nc">Fractal_array</span><span class="p">:</span>
<div class="viewcode-block" id="Fractal_array.__init__">
<a class="viewcode-back" href="../../API/postproc.html#fractalshades.postproc.Fractal_array.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fractal</span><span class="p">,</span> <span class="n">calc_name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inv</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Class which provide a direct access to the res data stored (memory</span>
<span class="sd">        mapping)  during calculation.</span>

<span class="sd">        One application, it can be passed as a *subset* parameter to most</span>
<span class="sd">        calculation models, e.g. : `fractalshades.models.Mandelbrot.base_calc`</span>

<span class="sd">        Parameters</span>
<span class="sd">        ==========</span>
<span class="sd">        fractal : `fractalshades.Fractal` derived class</span>
<span class="sd">            The reference fracal object</span>
<span class="sd">        calc_name : str </span>
<span class="sd">            The calculation name</span>
<span class="sd">        key :</span>
<span class="sd">            The raw data key. Should be one of the *complex_codes*,</span>
<span class="sd">            *int_codes*, *termination_codes* for this calculation.</span>
<span class="sd">        func: None | callable | a str of variable x (e.g. &quot;np.sin(x)&quot;)</span>
<span class="sd">              will be applied as a pre-processing step to the raw data if not</span>
<span class="sd">              `None` - use of str form is recommended</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fractal</span> <span class="o">=</span> <span class="n">fractal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calc_name</span> <span class="o">=</span> <span class="n">calc_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c1"># Note: possible improvement, see:</span>
            <span class="c1"># https://stackoverflow.com/questions/11878300/serializing-and-deserializing-lambdas</span>
            <span class="c1"># Seems over-the top here, just raising a detailed error</span>
            <span class="n">source_code</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;func is not provied in a serializable form:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">source_code</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;Consider passing func definition by string instead&quot;</span>
                <span class="o">+</span> <span class="s2">&quot; (e.g. </span><span class="se">\&quot;</span><span class="s2">np.sin(x)</span><span class="se">\&quot;</span><span class="s2">)&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_func</span> <span class="o">=</span> <span class="n">func</span> <span class="c1"># stored for future serialization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_func</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

        <span class="c1"># Manage ~ notation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inv</span> <span class="o">=</span> <span class="n">inv</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parse_func</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">fs_parser</span><span class="o">.</span><span class="n">func_parser</span><span class="p">([</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">func</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">func</span>

    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Enable standard Python serialization mechanism</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fractal</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk_slice</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Returns the raw array, with self.func applied if not None &quot;&quot;&quot;</span>
        <span class="n">fractal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractal</span>

        <span class="k">if</span> <span class="n">fractal</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Fractal_array without valid Fractal, &quot;</span>
                <span class="s2">&quot;might be an unbound state from unppickling. Use &quot;</span>
                <span class="s2">&quot;self.bind_fractal to rebind&quot;</span>
            <span class="p">)</span>

        <span class="n">f_class</span> <span class="o">=</span> <span class="n">fractal</span><span class="o">.</span><span class="vm">__class__</span>

        <span class="n">calc_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_name</span>
        <span class="n">codes</span> <span class="o">=</span> <span class="n">fractal</span><span class="o">.</span><span class="n">_calc_data</span><span class="p">[</span><span class="n">calc_name</span><span class="p">][</span><span class="s2">&quot;saved_codes&quot;</span><span class="p">]</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="n">f_class</span><span class="o">.</span><span class="n">kind_from_code</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">codes</span><span class="p">)</span>

        <span class="c1"># localise the pts range for the chunk /!\ use the right calc_name</span>
        <span class="k">if</span> <span class="n">chunk_slice</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">fractal</span><span class="o">.</span><span class="n">REPORT_ITEMS</span>
            <span class="n">report_mmap</span> <span class="o">=</span> <span class="n">open_memmap</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">fractal</span><span class="o">.</span><span class="n">report_path</span><span class="p">(</span><span class="n">calc_name</span><span class="p">),</span>
                                      <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">rank</span> <span class="o">=</span> <span class="n">fractal</span><span class="o">.</span><span class="n">chunk_rank</span><span class="p">(</span><span class="n">chunk_slice</span><span class="p">)</span>
            <span class="n">beg</span> <span class="o">=</span> <span class="n">report_mmap</span><span class="p">[</span><span class="n">rank</span><span class="p">,</span> <span class="n">items</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;chunk1d_begin&quot;</span><span class="p">)]</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">report_mmap</span><span class="p">[</span><span class="n">rank</span><span class="p">,</span> <span class="n">items</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;chunk1d_end&quot;</span><span class="p">)]</span>

        <span class="c1"># load the data</span>
        <span class="n">arr_from_kind</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;complex&quot;</span><span class="p">:</span> <span class="s2">&quot;Z&quot;</span><span class="p">,</span>
             <span class="s2">&quot;int&quot;</span><span class="p">:</span> <span class="s2">&quot;U&quot;</span><span class="p">,</span>
             <span class="s2">&quot;stop_reason&quot;</span><span class="p">:</span> <span class="s2">&quot;stop_reason&quot;</span><span class="p">,</span>
             <span class="s2">&quot;stop_iter&quot;</span><span class="p">:</span> <span class="s2">&quot;stop_iter&quot;</span>
        <span class="p">}</span>
        <span class="n">arr_str</span> <span class="o">=</span> <span class="n">arr_from_kind</span><span class="p">[</span><span class="n">kind</span><span class="p">]</span>
        <span class="n">data_path</span> <span class="o">=</span> <span class="n">fractal</span><span class="o">.</span><span class="n">data_path</span><span class="p">(</span><span class="n">calc_name</span><span class="p">)</span>
        <span class="n">mmap</span> <span class="o">=</span> <span class="n">open_memmap</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">data_path</span><span class="p">[</span><span class="n">arr_str</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>

        <span class="c1"># field from key :</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span>
        <span class="p">(</span><span class="n">complex_dic</span><span class="p">,</span> <span class="n">int_dic</span><span class="p">,</span> <span class="n">termination_dic</span><span class="p">)</span> <span class="o">=</span> <span class="n">f_class</span><span class="o">.</span><span class="n">codes_mapping</span><span class="p">(</span><span class="o">*</span><span class="n">codes</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;complex&quot;</span><span class="p">:</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">complex_dic</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;int&quot;</span><span class="p">:</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">int_dic</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">kind</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;stop_reason&quot;</span><span class="p">,</span> <span class="s2">&quot;stop_iter&quot;</span><span class="p">]:</span>
            <span class="n">field</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">kind</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">chunk_slice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># We return the full pts range</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">[</span><span class="n">field</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">[</span><span class="n">field</span><span class="p">,</span> <span class="n">beg</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>

        <span class="c1"># Apply last steps (func / inversion) and returns</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv</span><span class="p">:</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="o">~</span><span class="n">arr</span>
        <span class="k">return</span> <span class="n">arr</span>

    <span class="k">def</span> <span class="fm">__invert__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Allows use of the ~ notation &#39;ala numpy&#39; &quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">Fractal_array</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fractal</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="ow">not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inv</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Equality testing, useful when pickling / unpickling&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="n">eq</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_func</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_func</span><span class="p">)</span>
                <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calc_name</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">calc_name</span><span class="p">)</span>
                <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
                <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inv</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">inv</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">eq</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span></div>



<span class="c1">#==============================================================================</span>
<span class="c1"># Numba Nogil implementations</span>
<span class="nd">@numba</span><span class="o">.</span><span class="n">njit</span><span class="p">(</span><span class="n">nogil</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fastmath</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">apply_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">c_pix</span><span class="p">,</span> <span class="n">dzndc</span><span class="p">):</span>
    <span class="n">nvec</span><span class="p">,</span> <span class="o">=</span> <span class="n">c_pix</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nvec</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dzndc</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nvec</span><span class="p">):</span>
        <span class="n">ret</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">(</span><span class="n">c_pix</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="n">dzndc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">ret</span>

<span class="nd">@numba</span><span class="o">.</span><span class="n">njit</span><span class="p">(</span><span class="n">nogil</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fastmath</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">apply_dfBS</span><span class="p">(</span><span class="n">dfBS</span><span class="p">,</span> <span class="n">c_pix</span><span class="p">,</span> <span class="n">dXdA</span><span class="p">,</span> <span class="n">dXdB</span><span class="p">,</span> <span class="n">dYdA</span><span class="p">,</span> <span class="n">dYdB</span><span class="p">):</span>
    <span class="n">nvec</span><span class="p">,</span> <span class="o">=</span> <span class="n">c_pix</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">dXdA</span><span class="o">.</span><span class="n">dtype</span>
    <span class="n">dXdpixa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nvec</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dt</span><span class="p">)</span>
    <span class="n">dXdpixb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nvec</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dt</span><span class="p">)</span>
    <span class="n">dYdpixa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nvec</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dt</span><span class="p">)</span>
    <span class="n">dYdpixb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nvec</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dt</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nvec</span><span class="p">):</span>
        <span class="n">m00</span><span class="p">,</span> <span class="n">m01</span><span class="p">,</span> <span class="n">m10</span><span class="p">,</span> <span class="n">m11</span> <span class="o">=</span> <span class="n">dfBS</span><span class="p">(</span><span class="n">c_pix</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="c1"># mapping is defined as : pixa, pixb -f-&gt; AB</span>
        <span class="c1"># we want dXdpixa</span>
        <span class="c1"># See fs.core.apply_unskew_1d(skew, nx, ny)</span>
        <span class="c1"># Matricial product - contravariant</span>
        <span class="n">dXdpixa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dXdA</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">m00</span> <span class="o">+</span> <span class="n">dXdB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">m10</span>
        <span class="n">dXdpixb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dXdA</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">m01</span> <span class="o">+</span> <span class="n">dXdB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">m11</span>
        <span class="n">dYdpixa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dYdA</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">m00</span> <span class="o">+</span> <span class="n">dYdB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">m10</span>
        <span class="n">dYdpixb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dYdA</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">m01</span> <span class="o">+</span> <span class="n">dYdB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">m11</span>
    <span class="k">return</span> <span class="n">dXdpixa</span><span class="p">,</span> <span class="n">dXdpixb</span><span class="p">,</span> <span class="n">dYdpixa</span><span class="p">,</span> <span class="n">dYdpixb</span>


<span class="nd">@numba</span><span class="o">.</span><span class="n">njit</span><span class="p">(</span><span class="n">nogil</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">Continuous_iter_pp_infinity</span><span class="p">(</span><span class="n">zn</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">a_d</span><span class="p">,</span> <span class="n">M</span><span class="p">):</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a_d</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="n">d</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">))</span>
    <span class="c1"># k normaliszation corefficient, because the formula given</span>
    <span class="c1"># in https://en.wikipedia.org/wiki/Julia_set                    </span>
    <span class="c1"># suppose the highest order monome is normalized</span>
    <span class="n">nu_frac</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">zn</span> <span class="o">*</span> <span class="n">k</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">M</span> <span class="o">*</span> <span class="n">k</span><span class="p">))</span>
                <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">nu_frac</span>

<span class="nd">@numba</span><span class="o">.</span><span class="n">njit</span><span class="p">(</span><span class="n">nogil</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">Continuous_iter_pp_convergent</span><span class="p">(</span><span class="n">zn</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">attractivity</span><span class="p">,</span> <span class="n">z_star</span><span class="p">):</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">attractivity</span>
    <span class="n">nu_frac</span> <span class="o">=</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">eps</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">zn</span> <span class="o">-</span> <span class="n">z_star</span><span class="p">)</span>  <span class="c1"># nu frac &gt; 0</span>
                               <span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">alpha</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">nu_frac</span>


<span class="c1"># Catmull-Rom polynomials - C1 Smoothing of an orbit value</span>
<span class="nd">@numba</span><span class="o">.</span><span class="n">njit</span><span class="p">(</span><span class="n">nogil</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">cm_H0</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
     <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">x</span> <span class="o">+</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

<span class="nd">@numba</span><span class="o">.</span><span class="n">njit</span><span class="p">(</span><span class="n">nogil</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">cm_H1</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
     <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="mf">4.</span><span class="o">*</span> <span class="n">x</span> <span class="o">-</span> <span class="mf">3.</span> <span class="o">*</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

<span class="nd">@numba</span><span class="o">.</span><span class="n">njit</span><span class="p">(</span><span class="n">nogil</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">cm_H2</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
     <span class="k">return</span> <span class="mf">1.</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mf">5.</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="mf">3.</span> <span class="o">*</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

<span class="nd">@numba</span><span class="o">.</span><span class="n">njit</span><span class="p">(</span><span class="n">nogil</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">cm_H3</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
     <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.</span> <span class="o">+</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">x</span> <span class="o">-</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>


<span class="nd">@numba</span><span class="o">.</span><span class="n">njit</span><span class="p">(</span><span class="n">nogil</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">Fieldlines_pp_infinity</span><span class="p">(</span>
    <span class="n">c_pt</span><span class="p">,</span> <span class="n">zn</span><span class="p">,</span> <span class="n">nu_frac</span><span class="p">,</span> <span class="n">k_arr</span><span class="p">,</span> <span class="n">phi_arr</span><span class="p">,</span> <span class="n">zn_iterate</span><span class="p">,</span>
    <span class="n">is_backward</span><span class="p">,</span> <span class="n">backshift</span><span class="p">,</span> <span class="n">n</span>
<span class="p">):</span>
    <span class="n">M_cutoff</span> <span class="o">=</span> <span class="mf">100000.</span>  <span class="c1"># To be tuned...</span>
    <span class="n">n_iter_fl</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">k_arr</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">phi_arr</span><span class="p">)</span> <span class="o">==</span> <span class="n">n_iter_fl</span>

    <span class="n">nvec</span><span class="p">,</span> <span class="o">=</span> <span class="n">zn</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">orbit_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nvec</span><span class="p">,</span> <span class="n">n_iter_fl</span> <span class="o">+</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">zn</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">orbit_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nvec</span><span class="p">,</span> <span class="n">n_iter_fl</span> <span class="o">+</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="c1">#zn.dtype)</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nvec</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nvec</span><span class="p">):</span>
        <span class="n">z_loc</span> <span class="o">=</span> <span class="n">zn</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">orbit_z</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_loc</span>
        <span class="n">orbit_angle</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">z_loc</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_iter_fl</span> <span class="o">+</span> <span class="mi">2</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nvec</span><span class="p">):</span>
            <span class="n">z_loc</span> <span class="o">=</span> <span class="n">orbit_z</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">z_loc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">M_cutoff</span><span class="p">:</span>
                <span class="n">z_loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">orbit_angle</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1</span><span class="n">j</span><span class="p">)</span> <span class="o">*</span> <span class="n">M_cutoff</span>
                <span class="n">z_loc</span> <span class="o">=</span> <span class="n">zn_iterate</span><span class="p">(</span><span class="n">z_loc</span><span class="p">,</span> <span class="nb">complex</span><span class="p">(</span><span class="mf">0.</span><span class="p">))</span>
                <span class="n">orbit_z</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_loc</span> <span class="c1"># flag</span>
                <span class="n">orbit_angle</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">z_loc</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">z_loc</span> <span class="o">=</span> <span class="n">zn_iterate</span><span class="p">(</span><span class="n">orbit_z</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">c_pt</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="n">orbit_z</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_loc</span>
                <span class="n">orbit_angle</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">z_loc</span><span class="p">)</span>
    
    <span class="c1"># Now lets do some smoothing with Catmull-Rom polynomials</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nvec</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="o">-</span><span class="n">nu_frac</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="c1"># Correction if applying backshift would yield a negative index</span>
        <span class="c1"># in this case we just keep a constant nu_frac to avoid banding</span>
        <span class="k">if</span> <span class="n">is_backward</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">backshift</span> <span class="o">&gt;</span> <span class="n">n</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="c1"># Catmull-Rom spline weighting polynomials.</span>
        <span class="n">a0</span> <span class="o">=</span> <span class="n">cm_H0</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="n">a1</span> <span class="o">=</span> <span class="n">cm_H1</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="n">a2</span> <span class="o">=</span> <span class="n">cm_H2</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="n">a3</span> <span class="o">=</span> <span class="n">cm_H3</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_iter_fl</span><span class="p">):</span>
            <span class="n">val_loc</span> <span class="o">=</span> <span class="n">k_arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">a0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">orbit_angle</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">phi_arr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="o">+</span> <span class="n">a1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">orbit_angle</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">phi_arr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="o">+</span> <span class="n">a2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">orbit_angle</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">phi_arr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="o">+</span> <span class="n">a3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">orbit_angle</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">phi_arr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="n">val</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">val_loc</span>

    <span class="k">return</span> <span class="n">val</span>


<span class="nd">@numba</span><span class="o">.</span><span class="n">njit</span><span class="p">(</span><span class="n">nogil</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">Fieldlines_pp_infinity_BS</span><span class="p">(</span>
    <span class="n">c_pt</span><span class="p">,</span> <span class="n">xn</span><span class="p">,</span> <span class="n">yn</span><span class="p">,</span> <span class="n">nu_frac</span><span class="p">,</span> <span class="n">k_arr</span><span class="p">,</span> <span class="n">phi_arr</span><span class="p">,</span> <span class="n">xnyn_iterate</span><span class="p">,</span>
    <span class="n">is_backward</span><span class="p">,</span> <span class="n">backshift</span><span class="p">,</span> <span class="n">n</span>
<span class="p">):</span>
    <span class="n">M_cutoff</span> <span class="o">=</span> <span class="mf">100000.</span>  <span class="c1"># To be tuned...</span>
    <span class="n">n_iter_fl</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">k_arr</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">phi_arr</span><span class="p">)</span> <span class="o">==</span> <span class="n">n_iter_fl</span>

    <span class="n">nvec</span><span class="p">,</span> <span class="o">=</span> <span class="n">xn</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">orbit_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nvec</span><span class="p">,</span> <span class="n">n_iter_fl</span> <span class="o">+</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">xn</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">orbit_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nvec</span><span class="p">,</span> <span class="n">n_iter_fl</span> <span class="o">+</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">yn</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">orbit_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nvec</span><span class="p">,</span> <span class="n">n_iter_fl</span> <span class="o">+</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nvec</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nvec</span><span class="p">):</span>
        <span class="n">x_loc</span> <span class="o">=</span> <span class="n">xn</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">y_loc</span> <span class="o">=</span> <span class="n">yn</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">orbit_x</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_loc</span>
        <span class="n">orbit_y</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_loc</span>
        <span class="n">orbit_angle</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">y_loc</span><span class="p">,</span> <span class="n">x_loc</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_iter_fl</span> <span class="o">+</span> <span class="mi">2</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nvec</span><span class="p">):</span>
            <span class="n">aj</span> <span class="o">=</span> <span class="n">c_pt</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">real</span>
            <span class="n">bj</span> <span class="o">=</span> <span class="n">c_pt</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">imag</span>
            <span class="n">x_loc</span> <span class="o">=</span> <span class="n">orbit_x</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
            <span class="n">y_loc</span> <span class="o">=</span> <span class="n">orbit_y</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">x_loc</span><span class="p">,</span> <span class="n">y_loc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">M_cutoff</span><span class="p">:</span>
                
                <span class="n">x_loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">orbit_angle</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="n">M_cutoff</span>
                <span class="n">y_loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">orbit_angle</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="n">M_cutoff</span>
                <span class="n">x_loc</span><span class="p">,</span> <span class="n">y_loc</span> <span class="o">=</span> <span class="n">xnyn_iterate</span><span class="p">(</span><span class="n">x_loc</span><span class="p">,</span> <span class="n">y_loc</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>

                <span class="n">orbit_x</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_loc</span> <span class="c1"># flag</span>
                <span class="n">orbit_y</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_loc</span> <span class="c1"># flag</span>
                <span class="n">orbit_angle</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">y_loc</span><span class="p">,</span> <span class="n">x_loc</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x_loc</span><span class="p">,</span> <span class="n">y_loc</span> <span class="o">=</span> <span class="n">xnyn_iterate</span><span class="p">(</span>
                        <span class="n">orbit_x</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">orbit_y</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">aj</span><span class="p">,</span> <span class="n">bj</span>
                <span class="p">)</span>
                <span class="n">orbit_x</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_loc</span>
                <span class="n">orbit_y</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_loc</span>
                <span class="n">orbit_angle</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">y_loc</span><span class="p">,</span> <span class="n">x_loc</span><span class="p">)</span>
    
    <span class="c1"># Now lets do some smoothing with Catmull-Rom polynomials</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nvec</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="o">-</span><span class="n">nu_frac</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="c1"># Correction if applying backshift would yield a negative index</span>
        <span class="c1"># in this case we just keep a constant nu_frac to avoid banding</span>
        <span class="k">if</span> <span class="n">is_backward</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">backshift</span> <span class="o">&gt;</span> <span class="n">n</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="c1"># Catmull-Rom spline weighting polynomials.</span>
        <span class="n">a0</span> <span class="o">=</span> <span class="n">cm_H0</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="n">a1</span> <span class="o">=</span> <span class="n">cm_H1</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="n">a2</span> <span class="o">=</span> <span class="n">cm_H2</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="n">a3</span> <span class="o">=</span> <span class="n">cm_H3</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_iter_fl</span><span class="p">):</span>
            <span class="n">val_loc</span> <span class="o">=</span> <span class="n">k_arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">a0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">orbit_angle</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">phi_arr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="o">+</span> <span class="n">a1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">orbit_angle</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">phi_arr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="o">+</span> <span class="n">a2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">orbit_angle</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">phi_arr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="o">+</span> <span class="n">a3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">orbit_angle</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">phi_arr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="n">val</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">val_loc</span>

    <span class="k">return</span> <span class="n">val</span>
</pre></div>

           </div>
          </div>
<div class="ribbon">
  <a href="https://github.com/GBillotey/Fractalshades">Fork me on GitHub</a>
</div>

          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Fractalshades development team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 
<style>
  .wy-nav-content { max-width: 1250px !important; }
</style>


</body>
</html>