<!== Adding "Fork me on Github" ribbon ==>
<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>fractalshades.colors.color_mapping &mdash; Fractalshades 1.1.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../_static/rtd_dark.css?v=e3debd14" />
      <link rel="stylesheet" type="text/css" href="../../../_static/math.css?v=7fc59cab" />
      <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery.css?v=61a4c737" />
      <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-binder.css?v=f4aeca0c" />
      <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
      <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=58fbf978"></script>
        <script src="../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link href="../../../_static/ribbon.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Fractalshades
              <img src="../../../_static/logo3.jpg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.1.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started.html">Getting started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_started.html#installing">Installing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../getting_started.html#installing-gmp-mpfr-mpc-windows-users">Installing GMP / MPFR / MPC: Windows users</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../getting_started.html#installing-gmp-mpfr-mpc-unix-linux-users">Installing GMP / MPFR / MPC: Unix / Linux users</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../getting_started.html#installing-gmp-mpfr-mpc-mac-users">Installing GMP / MPFR / MPC: Mac users</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_started.html#a-5-minutes-guide-to-fractalshades">A 5-minutes guide to fractalshades</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_started.html#graphical-user-interface">Graphical user interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_started.html#finding-areas-of-interest">Finding areas of interest</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_started.html#unskewing-streched-areas">Unskewing streched areas</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../math.html">Mathematical background</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../math.html#zoom-level-and-native-floating-point-precision">Zoom level and native floating-point precision</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../math.html#perturbation-theory">Perturbation Theory</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../math.html#avoiding-loss-of-precision">Avoiding loss of precision</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../math.html#billinear-approximations">Billinear approximations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../math.html#extended-range-floating-points">Extended range floating points</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../math.html#finding-minibrots">Finding minibrots</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../math.html#going-further-a-few-references">Going further: a few references</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/index.html">Gallery</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/index.html#batch-mode-gallery">Batch mode gallery</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/index.html#colormaps-template-gallery">Colormaps template gallery</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/index.html#gui-mode-arbitrary-precision-implementations">GUI-mode: arbitrary precision implementations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/index.html#gui-mode-standard-implementation-examples">GUI-mode: standard implementation examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/index.html#lighting-examples-gallery">Lighting examples gallery</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/index.html#projections">Projections</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/batch_mode/index.html">Batch mode gallery</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/batch_mode/01-full_basic.html">01 - Full Mandelbrot basic example</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/batch_mode/02-bulb_fieldlines1.html">02 - Bulb fieldlines example “tint_or_shade”</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/batch_mode/03-bulb_fieldlines2.html">03 - Bulb fieldlines example “twinfield”</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/batch_mode/04-seahorse_shaded.html">04 - Seahorse shaded example</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/batch_mode/05-seahorse_shaded_colored.html">05 - Seahorse shaded and colored example</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/batch_mode/06-seahorse_interior.html">06 - Seahorse interior example</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/batch_mode/07-seahorse_DEM.html">07 - Seahorse DEM example</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/batch_mode/08-run_perturb_DEM.html">08 - DEM example with perturbation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/batch_mode/09-run_flake_DEM.html">09 - A deeper DEM example</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/batch_mode/10-double_embedded_julia.html">10 - Double embedded Julia set</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/batch_mode/11-run_perturbdeep.html">11- Ultra-deep embedded Julia set</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/batch_mode/12-burning_ship_deep.html">12 - Burning Ship deep zoom</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/batch_mode/13-burning_ship.html">13 - Burning ship DEM</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/batch_mode/14-burning_ship-deeper_DEM.html">14 - Burning ship deeper DEM</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/batch_mode/15-burning_ship-deepJulia_DEM.html">15 - Burning Ship ultra-deep embedded Julia set</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/batch_mode/16-tetration_spring.html">16 - Tetration (power tower) zoom: “Spring”</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/batch_mode/17-perpendicular_burning_ship_DEM.html">17 - “Perpendicular” Burning Ship</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/batch_mode/18-perpendicular_burning_ship_glynn.html">18 - “Perpendicular” Burning Ship: hidden Glynn spiral</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/batch_mode/19-perpendicular_burning_ship_Koch.html">19 - “Perpendicular” Burning Ship: hidden Koch snowflakes</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/batch_mode/20-perpendicular_burning_ship_Sierpinski.html">20 - “Perpendicular” Burning Ship: hidden Sierpinski carpets</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/batch_mode/21-perpendicular_burning_ship_trees.html">21 - “Perpendicular” Burning Ship: tree structures</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/batch_mode/22-shark_fin_deep.html">22 - “Shark Fin” escape-time fractal</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/batch_mode/23-deep_min.html">23 - A deep mini</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/colormaps/index.html">Colormaps template gallery</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/colormaps/plot_cmaps.html">Colormaps: available templates</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/interactive_deepzoom/index.html">GUI-mode: arbitrary precision implementations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/interactive_deepzoom/D01_run_interactive.html">D01 - Mandelbrot arbitrary-precision explorer</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/interactive_deepzoom/D02_run_BS_interactive.html">D02 - Burning Ship arbitrary-precision explorer</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/interactive_deepzoom/D03_run_interactive_Mn.html">D03 - Mandelbrot arbitrary-precision explorer</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/interactive_standard/index.html">GUI-mode: standard implementation examples</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/interactive_standard/S01_run_interactive_shallow.html">S01 - Mandelbrot explorer - Standard precision</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/interactive_standard/S02_run_BS_shallow.html">S02 - Burning ship explorer - Standard precision</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/interactive_standard/S03_run_interactive_Mn_shallow.html">S03 - Mandelbrot power n explorer - Standard precision</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/interactive_standard/S04_run_collatz.html">S04 - Collatz explorer - Standard precision</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/interactive_standard/S05_run_power_tower_shallow.html">S05 - Tetration fractal explorer - Standard precision</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/lighting/index.html">Lighting examples gallery</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/lighting/plot_lighting.html">Ligthings: available effects</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/projections/index.html">Projections</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/projections/P01-feigenbaum_expmap.html">P01 - Exponential mapping: Feigenbaum point</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/projections/P02-inversion.html">P02 - Inversion of the Mandelbrot set</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/projections/P03-Elephant_valley_moebius.html">P03 - Moebius mapping: Elephant and Seahorse valleys</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/projections/P04-deep_expmap.html">P04 - Exponential mapping for deep zoom</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../API.html">Application Programming Interface</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../API/settings.html">Application-level settings</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../API/settings.html#fractalshades.settings.enable_multithreading"><code class="docutils literal notranslate"><span class="pre">enable_multithreading</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/settings.html#fractalshades.settings.skip_calc"><code class="docutils literal notranslate"><span class="pre">skip_calc</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/settings.html#fractalshades.settings.newton_zoom_level"><code class="docutils literal notranslate"><span class="pre">newton_zoom_level</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/settings.html#fractalshades.settings.no_newton"><code class="docutils literal notranslate"><span class="pre">no_newton</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/settings.html#fractalshades.settings.inspect_calc"><code class="docutils literal notranslate"><span class="pre">inspect_calc</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/settings.html#fractalshades.settings.chunk_size"><code class="docutils literal notranslate"><span class="pre">chunk_size</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/settings.html#fractalshades.settings.verbosity"><code class="docutils literal notranslate"><span class="pre">verbosity</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/settings.html#fractalshades.settings.postproc_dtype"><code class="docutils literal notranslate"><span class="pre">postproc_dtype</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/settings.html#fractalshades.settings.log_directory"><code class="docutils literal notranslate"><span class="pre">log_directory</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/settings.html#fractalshades.settings.disable_decompression_size_check"><code class="docutils literal notranslate"><span class="pre">disable_decompression_size_check()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/settings.html#fractalshades.settings.BLA_compression"><code class="docutils literal notranslate"><span class="pre">BLA_compression</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/settings.html#fractalshades.settings.GUI_image_Mblimit"><code class="docutils literal notranslate"><span class="pre">GUI_image_Mblimit</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../API/core.html">Core components</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../API/core.html#fractalshades.Fractal"><code class="docutils literal notranslate"><span class="pre">Fractal</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/core.html#fractalshades.Fractal.__init__"><code class="docutils literal notranslate"><span class="pre">Fractal.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/core.html#fractalshades.Fractal.clean_up"><code class="docutils literal notranslate"><span class="pre">Fractal.clean_up()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/core.html#fractalshades.Fractal.zoom"><code class="docutils literal notranslate"><span class="pre">Fractal.zoom()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/core.html#fractalshades.PerturbationFractal"><code class="docutils literal notranslate"><span class="pre">PerturbationFractal</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/core.html#fractalshades.PerturbationFractal.__init__"><code class="docutils literal notranslate"><span class="pre">PerturbationFractal.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/core.html#fractalshades.PerturbationFractal.zoom"><code class="docutils literal notranslate"><span class="pre">PerturbationFractal.zoom()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/core.html#fractalshades.Fractal_plotter"><code class="docutils literal notranslate"><span class="pre">Fractal_plotter</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/core.html#fractalshades.Fractal_plotter.__init__"><code class="docutils literal notranslate"><span class="pre">Fractal_plotter.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/core.html#fractalshades.Fractal_plotter.add_layer"><code class="docutils literal notranslate"><span class="pre">Fractal_plotter.add_layer()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/core.html#fractalshades.Fractal_plotter.plot"><code class="docutils literal notranslate"><span class="pre">Fractal_plotter.plot()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/core.html#fractalshades.Fractal_plotter.save_db"><code class="docutils literal notranslate"><span class="pre">Fractal_plotter.save_db()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/core.html#fractalshades.zoom_options"><code class="docutils literal notranslate"><span class="pre">zoom_options()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/core.html#fractalshades.calc_options"><code class="docutils literal notranslate"><span class="pre">calc_options()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/core.html#fractalshades.interactive_options"><code class="docutils literal notranslate"><span class="pre">interactive_options()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../API/projection.html">Projections</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../API/projection.html#fractalshades.projection.Projection"><code class="docutils literal notranslate"><span class="pre">Projection</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/projection.html#fractalshades.projection.Projection.__init__"><code class="docutils literal notranslate"><span class="pre">Projection.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/projection.html#fractalshades.projection.Cartesian"><code class="docutils literal notranslate"><span class="pre">Cartesian</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/projection.html#fractalshades.projection.Cartesian.__init__"><code class="docutils literal notranslate"><span class="pre">Cartesian.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/projection.html#fractalshades.projection.Expmap"><code class="docutils literal notranslate"><span class="pre">Expmap</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/projection.html#fractalshades.projection.Expmap.__init__"><code class="docutils literal notranslate"><span class="pre">Expmap.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/projection.html#fractalshades.projection.Generic_mapping"><code class="docutils literal notranslate"><span class="pre">Generic_mapping</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/projection.html#fractalshades.projection.Generic_mapping.__init__"><code class="docutils literal notranslate"><span class="pre">Generic_mapping.__init__()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../API/arbitrary_models.html">Fractal models: Arbitrary-precision implementations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../API/arbitrary_models.html#fractalshades.models.Perturbation_mandelbrot"><code class="docutils literal notranslate"><span class="pre">Perturbation_mandelbrot</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/arbitrary_models.html#fractalshades.models.Perturbation_mandelbrot.__init__"><code class="docutils literal notranslate"><span class="pre">Perturbation_mandelbrot.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/arbitrary_models.html#fractalshades.models.Perturbation_mandelbrot.calc_std_div"><code class="docutils literal notranslate"><span class="pre">Perturbation_mandelbrot.calc_std_div()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/arbitrary_models.html#fractalshades.models.Perturbation_mandelbrot_N"><code class="docutils literal notranslate"><span class="pre">Perturbation_mandelbrot_N</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/arbitrary_models.html#fractalshades.models.Perturbation_mandelbrot_N.__init__"><code class="docutils literal notranslate"><span class="pre">Perturbation_mandelbrot_N.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/arbitrary_models.html#fractalshades.models.Perturbation_mandelbrot_N.calc_std_div"><code class="docutils literal notranslate"><span class="pre">Perturbation_mandelbrot_N.calc_std_div()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/arbitrary_models.html#fractalshades.models.Perturbation_burning_ship"><code class="docutils literal notranslate"><span class="pre">Perturbation_burning_ship</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/arbitrary_models.html#fractalshades.models.Perturbation_burning_ship.__init__"><code class="docutils literal notranslate"><span class="pre">Perturbation_burning_ship.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/arbitrary_models.html#fractalshades.models.Perturbation_burning_ship.calc_std_div"><code class="docutils literal notranslate"><span class="pre">Perturbation_burning_ship.calc_std_div()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../API/standard_models.html">Fractal models: Standard-precision implementations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../API/standard_models.html#fractalshades.models.Mandelbrot"><code class="docutils literal notranslate"><span class="pre">Mandelbrot</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/standard_models.html#fractalshades.models.Mandelbrot.__init__"><code class="docutils literal notranslate"><span class="pre">Mandelbrot.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/standard_models.html#fractalshades.models.Mandelbrot.calc_std_div"><code class="docutils literal notranslate"><span class="pre">Mandelbrot.calc_std_div()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/standard_models.html#fractalshades.models.Mandelbrot.newton_calc"><code class="docutils literal notranslate"><span class="pre">Mandelbrot.newton_calc()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/standard_models.html#fractalshades.models.Mandelbrot_N"><code class="docutils literal notranslate"><span class="pre">Mandelbrot_N</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/standard_models.html#fractalshades.models.Mandelbrot_N.__init__"><code class="docutils literal notranslate"><span class="pre">Mandelbrot_N.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/standard_models.html#fractalshades.models.Mandelbrot_N.calc_std_div"><code class="docutils literal notranslate"><span class="pre">Mandelbrot_N.calc_std_div()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/standard_models.html#fractalshades.models.Mandelbrot_N.newton_calc"><code class="docutils literal notranslate"><span class="pre">Mandelbrot_N.newton_calc()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/standard_models.html#fractalshades.models.Burning_ship"><code class="docutils literal notranslate"><span class="pre">Burning_ship</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/standard_models.html#fractalshades.models.Burning_ship.__init__"><code class="docutils literal notranslate"><span class="pre">Burning_ship.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/standard_models.html#fractalshades.models.Burning_ship.calc_std_div"><code class="docutils literal notranslate"><span class="pre">Burning_ship.calc_std_div()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/standard_models.html#fractalshades.models.Power_tower"><code class="docutils literal notranslate"><span class="pre">Power_tower</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/standard_models.html#fractalshades.models.Power_tower.__init__"><code class="docutils literal notranslate"><span class="pre">Power_tower.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/standard_models.html#fractalshades.models.Power_tower.newton_calc"><code class="docutils literal notranslate"><span class="pre">Power_tower.newton_calc()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/standard_models.html#fractalshades.models.Collatz"><code class="docutils literal notranslate"><span class="pre">Collatz</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/standard_models.html#fractalshades.models.Collatz.__init__"><code class="docutils literal notranslate"><span class="pre">Collatz.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/standard_models.html#fractalshades.models.Collatz.base_calc"><code class="docutils literal notranslate"><span class="pre">Collatz.base_calc()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../API/postproc.html">Postprocessing fields</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../API/postproc.html#fractalshades.postproc.Postproc_batch"><code class="docutils literal notranslate"><span class="pre">Postproc_batch</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/postproc.html#fractalshades.postproc.Postproc_batch.__init__"><code class="docutils literal notranslate"><span class="pre">Postproc_batch.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/postproc.html#fractalshades.postproc.Postproc_batch.add_postproc"><code class="docutils literal notranslate"><span class="pre">Postproc_batch.add_postproc()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/postproc.html#fractalshades.postproc.Postproc"><code class="docutils literal notranslate"><span class="pre">Postproc</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/postproc.html#fractalshades.postproc.Raw_pp"><code class="docutils literal notranslate"><span class="pre">Raw_pp</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/postproc.html#fractalshades.postproc.Raw_pp.__init__"><code class="docutils literal notranslate"><span class="pre">Raw_pp.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/postproc.html#fractalshades.postproc.Continuous_iter_pp"><code class="docutils literal notranslate"><span class="pre">Continuous_iter_pp</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/postproc.html#fractalshades.postproc.Continuous_iter_pp.__init__"><code class="docutils literal notranslate"><span class="pre">Continuous_iter_pp.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/postproc.html#fractalshades.postproc.Fieldlines_pp"><code class="docutils literal notranslate"><span class="pre">Fieldlines_pp</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/postproc.html#fractalshades.postproc.Fieldlines_pp.__init__"><code class="docutils literal notranslate"><span class="pre">Fieldlines_pp.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/postproc.html#fractalshades.postproc.DEM_pp"><code class="docutils literal notranslate"><span class="pre">DEM_pp</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/postproc.html#fractalshades.postproc.DEM_pp.__init__"><code class="docutils literal notranslate"><span class="pre">DEM_pp.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/postproc.html#fractalshades.postproc.DEM_normal_pp"><code class="docutils literal notranslate"><span class="pre">DEM_normal_pp</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/postproc.html#fractalshades.postproc.DEM_normal_pp.__init__"><code class="docutils literal notranslate"><span class="pre">DEM_normal_pp.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/postproc.html#fractalshades.postproc.Attr_pp"><code class="docutils literal notranslate"><span class="pre">Attr_pp</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/postproc.html#fractalshades.postproc.Attr_pp.__init__"><code class="docutils literal notranslate"><span class="pre">Attr_pp.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/postproc.html#fractalshades.postproc.Attr_normal_pp"><code class="docutils literal notranslate"><span class="pre">Attr_normal_pp</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/postproc.html#fractalshades.postproc.Attr_normal_pp.__init__"><code class="docutils literal notranslate"><span class="pre">Attr_normal_pp.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/postproc.html#fractalshades.postproc.Fractal_array"><code class="docutils literal notranslate"><span class="pre">Fractal_array</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/postproc.html#fractalshades.postproc.Fractal_array.__init__"><code class="docutils literal notranslate"><span class="pre">Fractal_array.__init__()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../API/layers.html">Image layers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Virtual_layer"><code class="docutils literal notranslate"><span class="pre">Virtual_layer</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Virtual_layer.__init__"><code class="docutils literal notranslate"><span class="pre">Virtual_layer.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Virtual_layer.set_mask"><code class="docutils literal notranslate"><span class="pre">Virtual_layer.set_mask()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Bool_layer"><code class="docutils literal notranslate"><span class="pre">Bool_layer</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Bool_layer.__init__"><code class="docutils literal notranslate"><span class="pre">Bool_layer.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Color_layer"><code class="docutils literal notranslate"><span class="pre">Color_layer</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Color_layer.__init__"><code class="docutils literal notranslate"><span class="pre">Color_layer.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Color_layer.overlay"><code class="docutils literal notranslate"><span class="pre">Color_layer.overlay()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Color_layer.set_mask"><code class="docutils literal notranslate"><span class="pre">Color_layer.set_mask()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Color_layer.set_twin_field"><code class="docutils literal notranslate"><span class="pre">Color_layer.set_twin_field()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Color_layer.shade"><code class="docutils literal notranslate"><span class="pre">Color_layer.shade()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Normal_map_layer"><code class="docutils literal notranslate"><span class="pre">Normal_map_layer</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Normal_map_layer.__init__"><code class="docutils literal notranslate"><span class="pre">Normal_map_layer.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Normal_map_layer.set_mask"><code class="docutils literal notranslate"><span class="pre">Normal_map_layer.set_mask()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Grey_layer"><code class="docutils literal notranslate"><span class="pre">Grey_layer</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Grey_layer.__init__"><code class="docutils literal notranslate"><span class="pre">Grey_layer.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Grey_layer.set_mask"><code class="docutils literal notranslate"><span class="pre">Grey_layer.set_mask()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Disp_layer"><code class="docutils literal notranslate"><span class="pre">Disp_layer</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Disp_layer.__init__"><code class="docutils literal notranslate"><span class="pre">Disp_layer.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Disp_layer.set_mask"><code class="docutils literal notranslate"><span class="pre">Disp_layer.set_mask()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Blinn_lighting"><code class="docutils literal notranslate"><span class="pre">Blinn_lighting</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Blinn_lighting.__init__"><code class="docutils literal notranslate"><span class="pre">Blinn_lighting.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Blinn_lighting.add_light_source"><code class="docutils literal notranslate"><span class="pre">Blinn_lighting.add_light_source()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Overlay_mode"><code class="docutils literal notranslate"><span class="pre">Overlay_mode</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Overlay_mode.__init__"><code class="docutils literal notranslate"><span class="pre">Overlay_mode.__init__()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../API/colors.html">Color mapping</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../API/colors.html#fractalshades.colors.Fractal_colormap"><code class="docutils literal notranslate"><span class="pre">Fractal_colormap</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/colors.html#fractalshades.colors.Fractal_colormap.__init__"><code class="docutils literal notranslate"><span class="pre">Fractal_colormap.__init__()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../API/GUI.html">GUI</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../API/GUI.html#fractalshades.gui.guimodel.Fractal_GUI"><code class="docutils literal notranslate"><span class="pre">Fractal_GUI</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/GUI.html#fractalshades.gui.guimodel.Fractal_GUI.__init__"><code class="docutils literal notranslate"><span class="pre">Fractal_GUI.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/GUI.html#fractalshades.gui.guimodel.Fractal_GUI.connect_image"><code class="docutils literal notranslate"><span class="pre">Fractal_GUI.connect_image()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/GUI.html#fractalshades.gui.guimodel.Fractal_GUI.connect_mouse"><code class="docutils literal notranslate"><span class="pre">Fractal_GUI.connect_mouse()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/GUI.html#fractalshades.gui.guimodel.Fractal_GUI.show"><code class="docutils literal notranslate"><span class="pre">Fractal_GUI.show()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/GUI.html#fractalshades.gui.guitemplates.std_zooming"><code class="docutils literal notranslate"><span class="pre">std_zooming</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/GUI.html#fractalshades.gui.guitemplates.std_zooming.__init__"><code class="docutils literal notranslate"><span class="pre">std_zooming.__init__()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../API/logging.html">Logging</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../API/logging.html#fractalshades.log.set_log_handlers"><code class="docutils literal notranslate"><span class="pre">set_log_handlers()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../API/db.html">Databases</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../API/db.html#fractalshades.db.Db"><code class="docutils literal notranslate"><span class="pre">Db</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/db.html#fractalshades.db.Db.__init__"><code class="docutils literal notranslate"><span class="pre">Db.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/db.html#fractalshades.db.Db.plot"><code class="docutils literal notranslate"><span class="pre">Db.plot()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/db.html#fractalshades.db.Db.set_plotter"><code class="docutils literal notranslate"><span class="pre">Db.set_plotter()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/db.html#fractalshades.db.Frame"><code class="docutils literal notranslate"><span class="pre">Frame</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/db.html#fractalshades.db.Frame.__init__"><code class="docutils literal notranslate"><span class="pre">Frame.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/db.html#fractalshades.db.Exp_db"><code class="docutils literal notranslate"><span class="pre">Exp_db</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/db.html#fractalshades.db.Exp_db.__init__"><code class="docutils literal notranslate"><span class="pre">Exp_db.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/db.html#fractalshades.db.Exp_db.plot"><code class="docutils literal notranslate"><span class="pre">Exp_db.plot()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/db.html#fractalshades.db.Exp_frame"><code class="docutils literal notranslate"><span class="pre">Exp_frame</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/db.html#fractalshades.db.Exp_frame.__init__"><code class="docutils literal notranslate"><span class="pre">Exp_frame.__init__()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../API/movie.html">Movie module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../API/movie.html#fractalshades.movie.Movie"><code class="docutils literal notranslate"><span class="pre">Movie</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/movie.html#fractalshades.movie.Movie.__init__"><code class="docutils literal notranslate"><span class="pre">Movie.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/movie.html#fractalshades.movie.Movie.add_sequence"><code class="docutils literal notranslate"><span class="pre">Movie.add_sequence()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/movie.html#fractalshades.movie.Movie.export_frame"><code class="docutils literal notranslate"><span class="pre">Movie.export_frame()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/movie.html#fractalshades.movie.Movie.make"><code class="docutils literal notranslate"><span class="pre">Movie.make()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/movie.html#fractalshades.movie.Camera_pan"><code class="docutils literal notranslate"><span class="pre">Camera_pan</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/movie.html#fractalshades.movie.Camera_pan.__init__"><code class="docutils literal notranslate"><span class="pre">Camera_pan.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/movie.html#fractalshades.movie.Camera_zoom"><code class="docutils literal notranslate"><span class="pre">Camera_zoom</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/movie.html#fractalshades.movie.Camera_zoom.__init__"><code class="docutils literal notranslate"><span class="pre">Camera_zoom.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/movie.html#fractalshades.movie.Custom_sequence"><code class="docutils literal notranslate"><span class="pre">Custom_sequence</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/movie.html#fractalshades.movie.Custom_sequence.__init__"><code class="docutils literal notranslate"><span class="pre">Custom_sequence.__init__()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../making_movies.html">Making movies</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../making_movies.html#example-pan-sequence">Example: pan sequence</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../making_movies.html#example-zoom-sequence">Example: zoom sequence</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../making_movies.html#example-custom-zoom-sequence">Example: “Custom” zoom sequence</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../making_movies.html#example-using-distance-estimation-plots">Example: Using Distance Estimation plots</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#rev-1-1">Rev 1.1</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../changelog.html#rev-1-1-0">Rev 1.1.0</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../changelog.html#rev-1-1-1">Rev 1.1.1</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#rev-1-0">Rev 1.0</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../changelog.html#rev-1-0-3">Rev 1.0.3</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../changelog.html#rev-1-0-2">Rev 1.0.2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../changelog.html#rev-1-0-1">Rev 1.0.1</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../changelog.html#rev-1-0-0">Rev 1.0.0</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#rev-0-5">Rev 0.5</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../changelog.html#rev-0-5-6">Rev 0.5.6</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../changelog.html#rev-0-5-5">Rev 0.5.5</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../changelog.html#rev-0-5-4">Rev 0.5.4</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../changelog.html#rev-0-5-3">Rev 0.5.3</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../changelog.html#rev-0-5-2">Rev 0.5.2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../changelog.html#rev-0-5-0">Rev 0.5.0</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#rev-0-4">Rev 0.4</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../changelog.html#rev-0-4-3">Rev 0.4.3</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../changelog.html#rev-0-4-2">Rev 0.4.2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../changelog.html#rev-0-4-1">Rev 0.4.1</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../acknowledgment.html">Acknowledgment</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Fractalshades</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">fractalshades.colors.color_mapping</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">

           <div itemprop="articleBody">
             
  <h1>Source code for fractalshades.colors.color_mapping</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">import</span> <span class="nn">enum</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="c1">#import matplotlib.colors</span>
<span class="c1">#from matplotlib.figure import Figure</span>
<span class="c1">#from matplotlib.backends.backend_agg import FigureCanvasAgg</span>
<span class="kn">import</span> <span class="nn">numba</span>
<span class="kn">import</span> <span class="nn">PIL</span>
<span class="kn">import</span> <span class="nn">PIL.ImageQt</span>

<span class="kn">import</span> <span class="nn">fractalshades.numpy_utils</span> <span class="k">as</span> <span class="nn">np_utils</span>



<span class="k">class</span> <span class="nc">Color_tools</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; A bunch of staticmethods</span>
<span class="sd">    Color conversions from http://www.easyrgb.com/en/math.php#text7</span>
<span class="sd">    All take as input and return arrays of size [n, 3]&quot;&quot;&quot;</span>
    <span class="c1"># CIE LAB constants Illuminant= D65</span>
    <span class="c1"># Simulates noon daylight with correlated color temperature of 6504 K. </span>
    <span class="n">Lab_ref_white</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.95047</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.08883</span><span class="p">])</span>
    <span class="c1"># CIE LAB constants Illuminant= D55</span>
    <span class="c1"># Simulates mid-morning or mid-afternoon daylight with correlated color</span>
    <span class="c1"># temperature of 5500 K. </span>
    <span class="n">D55_ref_white</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.9568</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.9214</span><span class="p">])</span>
    <span class="c1"># CIE LAB constants Illuminant= D50</span>
    <span class="c1"># Simulates warm daylight at sunrise or sunset with correlated color</span>
    <span class="c1"># temperature of 5003 K. Also known as horizon light.</span>
    <span class="n">D50_ref_white</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.964212</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">.825188</span><span class="p">])</span>
    <span class="c1"># CIE standard illuminant A, . Simulates typical, domestic,</span>
    <span class="c1"># tungsten-filament lighting with correlated color temperature of 2856 K. </span>
    <span class="n">A_ref_white</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0985</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="mf">0.3558</span><span class="p">])</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">rgb_to_XYZ</span><span class="p">(</span><span class="n">rgb</span><span class="p">):</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">rgb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">arr</span> <span class="o">&gt;</span> <span class="mf">0.04045</span><span class="p">,</span> <span class="p">((</span><span class="n">arr</span> <span class="o">+</span> <span class="mf">0.055</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1.055</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.4</span><span class="p">,</span>
                       <span class="n">arr</span> <span class="o">/</span> <span class="mf">12.92</span><span class="p">)</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.4124</span><span class="p">,</span> <span class="mf">0.3576</span><span class="p">,</span> <span class="mf">0.1805</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.2126</span><span class="p">,</span> <span class="mf">0.7152</span><span class="p">,</span> <span class="mf">0.0722</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.0193</span><span class="p">,</span> <span class="mf">0.1192</span><span class="p">,</span> <span class="mf">0.9505</span><span class="p">]])</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">arr</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">XYZ_to_rgb</span><span class="p">(</span><span class="n">XYZ</span><span class="p">):</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">XYZ</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">matrix_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span> <span class="mf">3.24062548</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.53720797</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.4986286</span> <span class="p">],</span>
                               <span class="p">[</span><span class="o">-</span><span class="mf">0.96893071</span><span class="p">,</span>  <span class="mf">1.87575606</span><span class="p">,</span>  <span class="mf">0.04151752</span><span class="p">],</span>
                               <span class="p">[</span> <span class="mf">0.05571012</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.20402105</span><span class="p">,</span>  <span class="mf">1.05699594</span><span class="p">]])</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">matrix_inv</span><span class="p">,</span> <span class="n">arr</span><span class="p">)</span>
        <span class="n">arr</span><span class="p">[</span><span class="n">arr</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">arr</span> <span class="o">&gt;</span> <span class="mf">0.0031308</span><span class="p">,</span>
                       <span class="mf">1.055</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="mf">1.</span> <span class="o">/</span> <span class="mf">2.4</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.055</span><span class="p">,</span> <span class="n">arr</span> <span class="o">*</span> <span class="mf">12.92</span><span class="p">)</span>
        <span class="n">arr</span><span class="p">[</span><span class="n">arr</span> <span class="o">&gt;</span> <span class="mf">1.</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>    
    <span class="k">def</span> <span class="nf">XYZ_to_CIELab</span><span class="p">(</span><span class="n">XYZ</span><span class="p">,</span> <span class="n">ref_white</span><span class="o">=</span><span class="n">Lab_ref_white</span><span class="p">):</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">XYZ</span> <span class="o">/</span> <span class="n">ref_white</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">arr</span> <span class="o">&gt;</span> <span class="mf">0.008856</span><span class="p">,</span> <span class="n">arr</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="mf">3.</span><span class="p">),</span>
                       <span class="p">(</span><span class="mf">7.787</span> <span class="o">*</span> <span class="n">arr</span><span class="p">)</span> <span class="o">+</span> <span class="mf">16.</span> <span class="o">/</span> <span class="mf">116.</span><span class="p">)</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">arr</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">arr</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">L</span><span class="p">,</span> <span class="n">a</span> <span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="mf">116.</span> <span class="o">*</span> <span class="n">y</span><span class="p">)</span> <span class="o">-</span> <span class="mf">16.</span> <span class="p">,</span> <span class="mf">500.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span> <span class="p">,</span> <span class="mf">200.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">z</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">L</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">]),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="nd">@staticmethod</span> 
    <span class="k">def</span> <span class="nf">CIELab_to_XYZ</span><span class="p">(</span><span class="n">Lab</span><span class="p">,</span> <span class="n">ref_white</span><span class="o">=</span><span class="n">Lab_ref_white</span><span class="p">):</span>
        <span class="n">L</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">Lab</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">Lab</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">Lab</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">L</span> <span class="o">+</span> <span class="mf">16.</span><span class="p">)</span> <span class="o">/</span> <span class="mf">116.</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">/</span> <span class="mf">500.</span><span class="p">)</span> <span class="o">+</span> <span class="n">y</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="p">(</span><span class="n">b</span> <span class="o">/</span> <span class="mf">200.</span><span class="p">)</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">])</span> 
        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">arr</span> <span class="o">&gt;</span> <span class="mf">0.2068966</span><span class="p">,</span> <span class="n">arr</span> <span class="o">**</span> <span class="mf">3.</span><span class="p">,</span>
                       <span class="p">(</span><span class="n">arr</span> <span class="o">-</span> <span class="mf">16.</span> <span class="o">/</span> <span class="mf">116.</span><span class="p">)</span> <span class="o">/</span> <span class="mf">7.787</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ref_white</span>

    <span class="nd">@staticmethod</span> 
    <span class="k">def</span> <span class="nf">CIELab_to_CIELch</span><span class="p">(</span><span class="n">Lab</span><span class="p">):</span>
        <span class="n">L</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">Lab</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">Lab</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">Lab</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">h</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">h</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mf">180.</span><span class="p">,</span>
                     <span class="mf">360.</span> <span class="o">+</span> <span class="n">h</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mf">180.</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">b</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">L</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">h</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="nd">@staticmethod</span> 
    <span class="k">def</span> <span class="nf">CIELch_to_CIELab</span><span class="p">(</span><span class="n">Lch</span><span class="p">):</span>
        <span class="n">L</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">Lch</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">Lch</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">Lch</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">h_rad</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">c</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">h_rad</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">c</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">h_rad</span><span class="p">)</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">L</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="nd">@staticmethod</span> 
    <span class="k">def</span> <span class="nf">rgb_to_CIELab</span><span class="p">(</span><span class="n">rgb</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Color_tools</span><span class="o">.</span><span class="n">XYZ_to_CIELab</span><span class="p">(</span><span class="n">Color_tools</span><span class="o">.</span><span class="n">rgb_to_XYZ</span><span class="p">(</span><span class="n">rgb</span><span class="p">))</span>
    <span class="nd">@staticmethod</span> 
    <span class="k">def</span> <span class="nf">rgb_to_CIELch</span><span class="p">(</span><span class="n">rgb</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Color_tools</span><span class="o">.</span><span class="n">CIELab_to_CIELch</span><span class="p">(</span>
            <span class="n">Color_tools</span><span class="o">.</span><span class="n">XYZ_to_CIELab</span><span class="p">(</span><span class="n">Color_tools</span><span class="o">.</span><span class="n">rgb_to_XYZ</span><span class="p">(</span><span class="n">rgb</span><span class="p">)))</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">CIELab_to_rgb</span><span class="p">(</span><span class="n">Lab</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Color_tools</span><span class="o">.</span><span class="n">XYZ_to_rgb</span><span class="p">(</span><span class="n">Color_tools</span><span class="o">.</span><span class="n">CIELab_to_XYZ</span><span class="p">(</span><span class="n">Lab</span><span class="p">))</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">CIELch_to_rgb</span><span class="p">(</span><span class="n">Lch</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Color_tools</span><span class="o">.</span><span class="n">XYZ_to_rgb</span><span class="p">(</span>
            <span class="n">Color_tools</span><span class="o">.</span><span class="n">CIELab_to_XYZ</span><span class="p">(</span><span class="n">Color_tools</span><span class="o">.</span><span class="n">CIELch_to_CIELab</span><span class="p">(</span><span class="n">Lch</span><span class="p">)))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">Lab_gradient</span><span class="p">(</span><span class="n">color_1</span><span class="p">,</span> <span class="n">color_2</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a color gradient between color_1 and color_2, default linear in </span>
<span class="sd">        Lab</span>
<span class="sd">        *color1* and *color_2* in rgb coordinate</span>
<span class="sd">        *n* integer number of color in gradient</span>
<span class="sd">        *f* function default to linear, general case c1 + f * (c2 - c1)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Color_tools</span><span class="o">.</span><span class="n">customized_Lab_gradient</span><span class="p">(</span><span class="n">color_1</span><span class="p">,</span> <span class="n">color_2</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">desaturated</span><span class="p">(</span><span class="n">color</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the grey tone of identical Luminance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">Color_tools</span><span class="o">.</span><span class="n">rgb_to_CIELab</span><span class="p">(</span><span class="n">color</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:])[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">Color_tools</span><span class="o">.</span><span class="n">CIELab_to_rgb</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">L</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]]))[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">Lch_gradient</span><span class="p">(</span><span class="n">color_1</span><span class="p">,</span> <span class="n">color_2</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">long_path</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a color gradient between color_1 and color_2, default linear in</span>
<span class="sd">        Lch</span>
<span class="sd">        *color1* and *color_2* in rgb coordinate</span>
<span class="sd">        *n* integer number of color in gradient</span>
<span class="sd">        *long_path* boolean If True, select the path that is &gt; 180° in hue</span>
<span class="sd">        *f* function default to linear, general case c1 + f * (c2 - c1)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Color_tools</span><span class="o">.</span><span class="n">customized_Lch_gradient</span><span class="p">(</span><span class="n">color_1</span><span class="p">,</span> <span class="n">color_2</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span>
                                                   <span class="n">long_path</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">color_gradient</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="n">color_1</span><span class="p">,</span> <span class="n">color_2</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a color gradient between color_1 and color_2, default linear in</span>
<span class="sd">        Lch</span>
<span class="sd">        *kind* &quot;Lab&quot; | &quot;Lch&quot; </span>
<span class="sd">        *color1* and *color_2* in rgb coordinate</span>
<span class="sd">        *n* integer number of color in gradient</span>
<span class="sd">        *f* function default to linear, general case c1 + f * (c2 - c1)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;Lab&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Color_tools</span><span class="o">.</span><span class="n">Lab_gradient</span><span class="p">(</span><span class="n">color_1</span><span class="p">,</span> <span class="n">color_2</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;Lch&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Color_tools</span><span class="o">.</span><span class="n">Lch_gradient</span><span class="p">(</span><span class="n">color_1</span><span class="p">,</span> <span class="n">color_2</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Unsupported kind </span><span class="si">{}</span><span class="s2">, expecting Lab or Lch&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kind</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">customized_Lab_gradient</span><span class="p">(</span><span class="n">color_1</span><span class="p">,</span> <span class="n">color_2</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> 
        <span class="n">L</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">,</span> <span class="n">ab</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Idem Lab_gradient except we customize 2 functions L and a = b noted ab</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Lab_1</span> <span class="o">=</span> <span class="n">Color_tools</span><span class="o">.</span><span class="n">rgb_to_CIELab</span><span class="p">(</span><span class="n">color_1</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:])[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">Lab_2</span> <span class="o">=</span> <span class="n">Color_tools</span><span class="o">.</span><span class="n">rgb_to_CIELab</span><span class="p">(</span><span class="n">color_2</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:])[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">Lab_1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> 
                         <span class="n">f</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">Lab_2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">Lab_1</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> 
                         <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">L</span><span class="p">,</span> <span class="n">ab</span><span class="p">,</span> <span class="n">ab</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])])</span><span class="o">.</span><span class="n">T</span>
        <span class="k">return</span> <span class="n">Color_tools</span><span class="o">.</span><span class="n">CIELab_to_rgb</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">customized_Lch_gradient</span><span class="p">(</span><span class="n">color_1</span><span class="p">,</span> <span class="n">color_2</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">long_path</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">L</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Idem Lch_gradient except we customize all 3 functions L, c, h</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Lch_1</span> <span class="o">=</span> <span class="n">Color_tools</span><span class="o">.</span><span class="n">rgb_to_CIELch</span><span class="p">(</span><span class="n">color_1</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:])[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">Lch_2</span> <span class="o">=</span> <span class="n">Color_tools</span><span class="o">.</span><span class="n">rgb_to_CIELch</span><span class="p">(</span><span class="n">color_2</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:])[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">h1</span><span class="p">,</span> <span class="n">h2</span> <span class="o">=</span> <span class="n">Lch_1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">Lch_2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">h2</span><span class="o">-</span> <span class="n">h1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">180.</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">long_path</span><span class="p">):</span>
            <span class="n">Lch_2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">h2</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">h2</span> <span class="o">-</span> <span class="n">h1</span><span class="p">)</span> <span class="o">*</span> <span class="mf">360.</span> <span class="c1"># take the shortest path</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">h2</span><span class="o">-</span> <span class="n">h1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">180.</span> <span class="ow">and</span> <span class="n">long_path</span><span class="p">:</span>
            <span class="n">Lch_2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">h2</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">h2</span> <span class="o">-</span> <span class="n">h1</span><span class="p">)</span> <span class="o">*</span> <span class="mf">360.</span> <span class="c1"># take the longest path</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">Lch_1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> 
                         <span class="n">f</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">Lch_2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">Lch_1</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> 
                         <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">L</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">h</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])])</span><span class="o">.</span><span class="n">T</span>
        <span class="k">return</span> <span class="n">Color_tools</span><span class="o">.</span><span class="n">CIELch_to_rgb</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">blend</span><span class="p">(</span><span class="n">rgb</span><span class="p">,</span> <span class="n">shade</span><span class="p">,</span> <span class="n">shade_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Provides several &quot;shading&quot; options based on shade_type dict</span>
<span class="sd">        *rgb* array of colors to &#39;shade&#39;, shape (nx, 3) or (nx, ny, 3)</span>
<span class="sd">        *shade* N&amp;B array shape similar to rgb but last dim is 1</span>
<span class="sd">        *shade_type* {&quot;Lch&quot;: x1, &quot;overlay&quot;: x2, &quot;pegtop&quot;: x3}</span>
<span class="sd">            x1, x2, x3 positive scalars, the proportion of each shading method</span>
<span class="sd">            in the final image.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">shade_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">shade_type</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Lch&quot;</span><span class="p">:</span> <span class="mf">4.</span><span class="p">,</span> <span class="s2">&quot;overlay&quot;</span><span class="p">:</span> <span class="mf">4.</span><span class="p">,</span> <span class="s2">&quot;pegtop&quot;</span><span class="p">:</span> <span class="mf">1.</span><span class="p">}</span>        
        
        <span class="n">blend_T</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">sum</span><span class="p">((</span><span class="n">shade_type</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span><span class="p">[</span><span class="s2">&quot;Lch&quot;</span><span class="p">,</span> <span class="s2">&quot;overlay&quot;</span><span class="p">,</span> <span class="s2">&quot;pegtop&quot;</span><span class="p">])))</span>

        <span class="n">is_image</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rgb</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_image</span><span class="p">:</span>
            <span class="n">imx</span><span class="p">,</span> <span class="n">imy</span><span class="p">,</span> <span class="n">ichannel</span> <span class="o">=</span> <span class="n">rgb</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">if</span> <span class="n">ichannel</span><span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;expectd rgb array&quot;</span><span class="p">)</span>
            <span class="n">rgb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">rgb</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">imx</span> <span class="o">*</span> <span class="n">imy</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
            <span class="n">shade</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">shade</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">imx</span> <span class="o">*</span> <span class="n">imy</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="n">XYZ</span> <span class="o">=</span> <span class="n">Color_tools</span><span class="o">.</span><span class="n">rgb_to_XYZ</span><span class="p">(</span><span class="n">rgb</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>

        <span class="n">XYZ_overlay</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">imx</span> <span class="o">*</span> <span class="n">imy</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
        <span class="n">XYZ_pegtop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">imx</span> <span class="o">*</span> <span class="n">imy</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
        <span class="n">XYZ_Lch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">imx</span> <span class="o">*</span> <span class="n">imy</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>

        <span class="n">ref_white</span> <span class="o">=</span> <span class="n">Color_tools</span><span class="o">.</span><span class="n">D50_ref_white</span>


        <span class="k">if</span> <span class="n">shade_type</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;overlay&quot;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">low</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">shade</span> <span class="o">*</span> <span class="n">XYZ</span>
            <span class="n">high</span> <span class="o">=</span> <span class="n">ref_white</span> <span class="o">*</span> <span class="mf">100.</span> <span class="o">-</span> <span class="mf">2.</span>  <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">shade</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ref_white</span> <span class="o">*</span> <span class="mf">100.</span> <span class="o">-</span> <span class="n">XYZ</span><span class="p">)</span>
            <span class="n">XYZ_overlay</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">XYZ</span> <span class="o">&lt;=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">ref_white</span> <span class="o">*</span> <span class="mf">100.</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">)</span>            

        <span class="k">if</span> <span class="n">shade_type</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pegtop&quot;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">XYZ_pegtop</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">shade</span> <span class="o">*</span> <span class="n">XYZ</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">shade</span><span class="p">)</span> <span class="o">*</span> <span class="n">XYZ</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ref_white</span>

        <span class="k">if</span> <span class="n">shade_type</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Lch&quot;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">shade</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">shade</span> <span class="o">-</span> <span class="mf">1.</span>
            <span class="n">Lab</span> <span class="o">=</span> <span class="n">Color_tools</span><span class="o">.</span><span class="n">XYZ_to_CIELab</span><span class="p">(</span><span class="n">XYZ</span><span class="p">)</span>
            <span class="n">L</span> <span class="o">=</span> <span class="n">Lab</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">Lab</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">Lab</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
            <span class="n">np</span><span class="o">.</span><span class="n">putmask</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">shade</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">L</span>  <span class="o">+</span> <span class="n">shade</span> <span class="o">*</span> <span class="p">(</span><span class="mf">100.</span> <span class="o">-</span> <span class="n">L</span><span class="p">))</span>     <span class="c1"># lighten</span>
            <span class="n">np</span><span class="o">.</span><span class="n">putmask</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">shade</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">L</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span>  <span class="n">shade</span> <span class="p">))</span>          <span class="c1"># darken</span>
            <span class="n">np</span><span class="o">.</span><span class="n">putmask</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">shade</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">a</span>  <span class="o">-</span> <span class="n">shade</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span>           <span class="c1"># lighten</span>
            <span class="n">np</span><span class="o">.</span><span class="n">putmask</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">shade</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">a</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span>  <span class="n">shade</span><span class="o">**</span><span class="mi">2</span> <span class="p">))</span>       <span class="c1"># darken</span>
            <span class="n">np</span><span class="o">.</span><span class="n">putmask</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">shade</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">b</span>  <span class="o">-</span> <span class="n">shade</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">b</span><span class="p">)</span>           <span class="c1"># lighten</span>
            <span class="n">np</span><span class="o">.</span><span class="n">putmask</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">shade</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">b</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span>  <span class="n">shade</span><span class="o">**</span><span class="mi">2</span> <span class="p">))</span>       <span class="c1"># darken</span>
            <span class="n">Lab</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">L</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">Lab</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">Lab</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">XYZ_Lch</span> <span class="o">=</span> <span class="n">Color_tools</span><span class="o">.</span><span class="n">CIELab_to_XYZ</span><span class="p">(</span><span class="n">Lab</span><span class="p">)</span>

        <span class="n">XYZ</span> <span class="o">=</span> <span class="p">(</span><span class="n">XYZ_overlay</span> <span class="o">*</span> <span class="n">shade_type</span><span class="p">[</span><span class="s2">&quot;overlay&quot;</span><span class="p">]</span> <span class="o">+</span>
               <span class="n">XYZ_pegtop</span> <span class="o">*</span> <span class="n">shade_type</span><span class="p">[</span><span class="s2">&quot;pegtop&quot;</span><span class="p">]</span> <span class="o">+</span>
               <span class="n">XYZ_Lch</span> <span class="o">*</span> <span class="n">shade_type</span><span class="p">[</span><span class="s2">&quot;Lch&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="n">blend_T</span>

        <span class="c1"># Convert modified hsv back to rgb.</span>
        <span class="n">blend</span> <span class="o">=</span> <span class="n">Color_tools</span><span class="o">.</span><span class="n">XYZ_to_rgb</span><span class="p">(</span><span class="n">XYZ</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_image</span><span class="p">:</span>
            <span class="n">blend</span> <span class="o">=</span> <span class="n">blend</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">imx</span><span class="p">,</span> <span class="n">imy</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">blend</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">shade_layer</span><span class="p">(</span><span class="n">normal</span><span class="p">,</span> <span class="n">theta_LS</span><span class="p">,</span> <span class="n">phi_LS</span><span class="p">,</span> <span class="n">shininess</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">ratio_specular</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        *normal* flat array of normal vect</span>
<span class="sd">        shade_dict:</span>
<span class="sd">            &quot;theta_LS&quot; angle of incoming light [0, 360]</span>
<span class="sd">            &quot;phi_LS&quot;   azimuth of incoming light [0, 90] 90 is vertical</span>
<span class="sd">            &quot;shininess&quot; material coefficient for specular</span>
<span class="sd">            &quot;ratio_specular&quot; ratio of specular to lambert</span>
<span class="sd">        Returns </span>
<span class="sd">        *shade* array of light intensity, greyscale image (value btwn 0 and 1)</span>
<span class="sd">        https://en.wikipedia.org/wiki/Blinn%E2%80%93Phong_reflection_model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;LS_coords&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># LS is localized somewhere in the image computing theta_LS</span>
            <span class="c1"># as a vector</span>
            <span class="n">LSx</span><span class="p">,</span> <span class="n">LSy</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;LS_coords&quot;</span><span class="p">]</span>
            <span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">ixx</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iyy</span><span class="p">)</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;chunk_slice&quot;</span><span class="p">]</span>
            <span class="n">chunk_mask</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;chunk_mask&quot;</span><span class="p">]</span>
            <span class="n">nx</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;nx&quot;</span><span class="p">]</span>
            <span class="n">ny</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;ny&quot;</span><span class="p">]</span>
            <span class="n">nx_grid</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">ixx</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="n">nx</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span>
            <span class="n">ny_grid</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">iy</span><span class="p">,</span> <span class="n">iyy</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="n">ny</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span>
            <span class="n">ny_vec</span><span class="p">,</span> <span class="n">nx_vec</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">ny_grid</span><span class="p">,</span> <span class="n">nx_grid</span><span class="p">)</span>
            <span class="n">theta_LS</span> <span class="o">=</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">LSy</span> <span class="o">-</span> <span class="n">ny_vec</span><span class="p">,</span> <span class="n">nx_vec</span> <span class="o">-</span> <span class="n">LSx</span><span class="p">))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
            <span class="k">if</span> <span class="n">chunk_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">theta_LS</span> <span class="o">=</span> <span class="n">theta_LS</span><span class="p">[</span><span class="n">chunk_mask</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Default case LS at infinity incoming angle provided</span>
            <span class="n">theta_LS</span> <span class="o">=</span> <span class="n">theta_LS</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span>
        <span class="n">phi_LS</span> <span class="o">=</span> <span class="n">phi_LS</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span>
        
        <span class="k">if</span> <span class="s2">&quot;exp_map&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">()</span> <span class="c1"># debug</span>
            <span class="c1"># Normal angle correction in case of exponential map</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;exp_map&quot;</span><span class="p">]:</span>
                <span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">ixx</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iyy</span><span class="p">)</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;chunk_slice&quot;</span><span class="p">]</span>
                <span class="n">chunk_mask</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;chunk_mask&quot;</span><span class="p">]</span>
                <span class="n">nx</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;nx&quot;</span><span class="p">]</span>
                <span class="n">ny</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;ny&quot;</span><span class="p">]</span>
                <span class="n">nx_grid</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">ixx</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="n">nx</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span>
                <span class="n">ny_grid</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">iy</span><span class="p">,</span> <span class="n">iyy</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="n">ny</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span>
                <span class="n">ny_vec</span><span class="p">,</span> <span class="n">nx_vec</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">ny_grid</span><span class="p">,</span> <span class="n">nx_grid</span><span class="p">)</span>
                <span class="n">expmap_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="p">(</span><span class="n">ny_vec</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mf">2.</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">chunk_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">expmap_angle</span> <span class="o">=</span> <span class="n">expmap_angle</span><span class="p">[</span><span class="n">chunk_mask</span><span class="p">]</span>
                <span class="n">normal</span> <span class="o">=</span> <span class="n">normal</span> <span class="o">*</span> <span class="n">expmap_angle</span>

        <span class="c1"># k_ambient = - 1. / (2. * ratio_specular + 1.)</span>
        <span class="n">k_lambert</span> <span class="o">=</span> <span class="mf">1.</span> <span class="c1">#- 2. * k_ambient</span>
        <span class="n">k_spec</span> <span class="o">=</span> <span class="n">ratio_specular</span> <span class="o">*</span> <span class="n">k_lambert</span>

        <span class="c1"># Light source coordinates</span>
        <span class="n">LSx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta_LS</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi_LS</span><span class="p">)</span>
        <span class="n">LSy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta_LS</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi_LS</span><span class="p">)</span>
        <span class="n">LSz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi_LS</span><span class="p">)</span> 

        <span class="c1"># Normal vector coordinates - Lambert shading</span>
        <span class="n">nx</span> <span class="o">=</span> <span class="n">normal</span><span class="o">.</span><span class="n">real</span>
        <span class="n">ny</span> <span class="o">=</span> <span class="n">normal</span><span class="o">.</span><span class="n">imag</span>
        <span class="n">nz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">nx</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">ny</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> 
        <span class="k">if</span> <span class="s2">&quot;inverse_n&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;inverse_n&quot;</span><span class="p">]:</span>
                <span class="n">nx</span> <span class="o">=</span> <span class="o">-</span><span class="n">nx</span>
                <span class="n">ny</span> <span class="o">=</span> <span class="o">-</span><span class="n">ny</span>
                
        <span class="n">lambert</span> <span class="o">=</span> <span class="n">LSx</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">+</span> <span class="n">LSy</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">+</span> <span class="n">LSz</span> <span class="o">*</span> <span class="n">nz</span>
        <span class="n">np</span><span class="o">.</span><span class="n">putmask</span><span class="p">(</span><span class="n">lambert</span><span class="p">,</span> <span class="n">lambert</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>

        <span class="c1"># half-way vector coordinates - Blinn Phong shading</span>
        <span class="n">specular</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">lambert</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ratio_specular</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">phi_half</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="n">phi_LS</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>
            <span class="n">half_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta_LS</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi_half</span><span class="p">)</span>
            <span class="n">half_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta_LS</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi_half</span><span class="p">)</span>
            <span class="n">half_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi_half</span><span class="p">)</span>
            <span class="n">spec_angle</span> <span class="o">=</span> <span class="n">half_x</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">+</span> <span class="n">half_y</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">+</span> <span class="n">half_z</span> <span class="o">*</span> <span class="n">nz</span>
            <span class="n">np</span><span class="o">.</span><span class="n">putmask</span><span class="p">(</span><span class="n">spec_angle</span><span class="p">,</span> <span class="n">spec_angle</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
            <span class="n">specular</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">spec_angle</span><span class="p">,</span> <span class="n">shininess</span><span class="p">)</span>
            
        <span class="n">res</span> <span class="o">=</span>  <span class="n">k_lambert</span> <span class="o">*</span> <span class="n">lambert</span> <span class="o">+</span> <span class="n">k_spec</span> <span class="o">*</span> <span class="n">specular</span> <span class="c1"># + k_ambient</span>
        
        <span class="c1">#res[normal == 0.] = 0.5 * (np.nanmin(res) + np.nanmax(res))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">putmask</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">normal</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">res</span><span class="p">)))</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">return</span> <span class="n">res</span><span class="c1"># k_ambient + k_lambert * lambert + k_spec * specular</span>

<span class="k">class</span> <span class="nc">Color</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; An interface for QtGui.QColor &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span>

    <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;arr shape not as expected: </span><span class="si">{</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        


<div class="viewcode-block" id="Fractal_colormap">
<a class="viewcode-back" href="../../../API/colors.html#fractalshades.colors.Fractal_colormap">[docs]</a>
<span class="k">class</span> <span class="nc">Fractal_colormap</span><span class="p">:</span>

    <span class="n">KIND_ENUM</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span>
        <span class="s2">&quot;kind&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="s2">&quot;Lab&quot;</span><span class="p">,</span> <span class="s2">&quot;Lch&quot;</span><span class="p">),</span>
        <span class="n">module</span><span class="o">=</span><span class="vm">__name__</span>
    <span class="p">)</span>
    <span class="n">kind_type</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">Literal</span><span class="p">[</span><span class="n">KIND_ENUM</span><span class="p">]</span>

    <span class="n">EXTENT_ENUM</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span>
        <span class="s2">&quot;extent&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="s2">&quot;clip&quot;</span><span class="p">,</span> <span class="s2">&quot;mirror&quot;</span><span class="p">,</span> <span class="s2">&quot;repeat&quot;</span><span class="p">),</span>
        <span class="n">module</span><span class="o">=</span><span class="vm">__name__</span>
    <span class="p">)</span>
    <span class="n">extent_type</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">Literal</span><span class="p">[</span><span class="n">EXTENT_ENUM</span><span class="p">]</span>
    
<div class="viewcode-block" id="Fractal_colormap.__init__">
<a class="viewcode-back" href="../../../API/colors.html#fractalshades.colors.Fractal_colormap.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">colors</span><span class="p">:</span> <span class="n">Color</span><span class="p">,</span>
        <span class="n">kinds</span><span class="p">:</span> <span class="n">kind_type</span><span class="p">,</span>
        <span class="n">grad_npts</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
        <span class="n">grad_funcs</span><span class="p">:</span> <span class="n">np_utils</span><span class="o">.</span><span class="n">Numpy_expr</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span>
        <span class="n">extent</span><span class="p">:</span> <span class="n">extent_type</span><span class="o">=</span><span class="s2">&quot;mirror&quot;</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fractal_colormap, concatenates (n-1) color gradients (passing</span>
<span class="sd">        through n colors).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ==========</span>
<span class="sd">        colors : rgb float np.array of shape [n, 3]</span>
<span class="sd">            The successives colors of the colormap</span>
<span class="sd">        kinds: arrays of string [n-1] , &quot;Lab&quot; or &quot;Lch&quot;</span>
<span class="sd">            The kind of gradient between colors n and n+1 : either linear in</span>
<span class="sd">            Lab space of Lch space</span>
<span class="sd">        grad_npts : int np.array of size [n-1]</span>
<span class="sd">            number of internal points stores, gradient between colors n and n+1</span>
<span class="sd">            a typical value is 32.</span>
<span class="sd">        grad_funcs : [n-1] array of callables mapping [0, 1.] to [0., 1]</span>
<span class="sd">            These are passed to each gradient. Callable passed as a string</span>
<span class="sd">            expression of the &quot;x&quot; variable</span>
<span class="sd">            (ie, the callable is the evaluation of &quot;lambda x: &quot; + expr).</span>
<span class="sd">            Default to identity (&quot;x&quot;).</span>
<span class="sd">        extent : &quot;clip&quot; | &quot;mirror&quot; | &quot;repeat&quot;</span>
<span class="sd">            What to do with out-of-range values.</span>

<span class="sd">        Notes</span>
<span class="sd">        =====</span>
<span class="sd">        .. note::</span>

<span class="sd">            See also the colormap section of the gallery for the available</span>
<span class="sd">            templates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">colors</span> <span class="o">=</span> <span class="n">colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_grads</span> <span class="o">=</span> <span class="n">n_grads</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_probes</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Provides sensible defaults if a scalar is provided</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kinds</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">kinds</span> <span class="o">=</span> <span class="p">[</span><span class="n">kinds</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_grads</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">grad_npts</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">grad_npts</span> <span class="o">=</span> <span class="p">[</span><span class="n">grad_npts</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_grads</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">grad_funcs</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> <span class="c1">#callable(grad_funcs):</span>
            <span class="n">grad_funcs</span> <span class="o">=</span> <span class="p">[</span><span class="n">grad_funcs</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_grads</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">kinds</span> <span class="o">=</span> <span class="n">kinds</span> <span class="c1"># = np.asarray(kinds)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grad_npts</span> <span class="o">=</span> <span class="n">grad_npts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">grad_npts</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grad_funcs</span> <span class="o">=</span> <span class="n">grad_funcs</span> <span class="c1"># = np.asarray(grad_funcs)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extent</span> <span class="o">=</span> <span class="n">extent</span>

        <span class="c1"># Deprecated option (not compatible with GUI editor)</span>
        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">grad_funcs</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Callable grad_funcs deprecated, use string&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_internal_arrays</span><span class="p">()</span></div>



    <span class="k">def</span> <span class="nf">_load_internal_arrays</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; To be called when one of the base array is modified &quot;&quot;&quot;</span>
        <span class="n">n_grads</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_grads</span>
        <span class="n">n_probes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_probes</span>

        <span class="n">colors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">colors</span>
        <span class="n">grad_npts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_npts</span>
        <span class="n">grad_funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_funcs</span>
        <span class="n">kinds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinds</span>

        <span class="c1"># Should define 2 internal arrays</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_interp_colors</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">grad_npts</span><span class="p">)</span> <span class="o">-</span> <span class="n">n_grads</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interp_colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_interp_colors</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_probes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">n_probes</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="n">grad_func_evals</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">np_utils</span><span class="o">.</span><span class="n">func_parser</span><span class="p">([</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">grad_funcs</span><span class="p">[</span><span class="n">i_grad</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i_grad</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_grads</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="n">i_col</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i_grad</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_grads</span><span class="p">):</span>
            <span class="n">grad</span> <span class="o">=</span> <span class="n">Color_tools</span><span class="o">.</span><span class="n">color_gradient</span><span class="p">(</span>
                <span class="n">kinds</span><span class="p">[</span><span class="n">i_grad</span><span class="p">],</span> <span class="n">colors</span><span class="p">[</span><span class="n">i_grad</span><span class="p">,</span> <span class="p">:],</span> <span class="n">colors</span><span class="p">[</span><span class="n">i_grad</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>
                <span class="n">grad_npts</span><span class="p">[</span><span class="n">i_grad</span><span class="p">],</span> <span class="n">grad_func_evals</span><span class="p">[</span><span class="n">i_grad</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_interp_colors</span><span class="p">[</span><span class="n">i_col</span><span class="p">:</span> <span class="n">i_col</span> <span class="o">+</span> <span class="n">grad_npts</span><span class="p">[</span><span class="n">i_grad</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">grad</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_probes</span><span class="p">[</span><span class="n">i_grad</span><span class="p">]</span> <span class="o">=</span> <span class="n">i_col</span>
            <span class="n">i_col</span> <span class="o">+=</span> <span class="p">(</span><span class="n">grad_npts</span><span class="p">[</span><span class="n">i_grad</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_probes</span><span class="p">[</span><span class="n">n_grads</span><span class="p">]</span> <span class="o">=</span> <span class="n">i_col</span> <span class="c1"># last piquet</span>

        <span class="c1"># Is is it a known template ?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_template</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#~~~~~~~~~~~~~~ GUI interaction methods</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">modify_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col_key</span><span class="p">,</span> <span class="n">irow</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; In place modifcation of cmap &quot;&quot;&quot;</span>
<span class="c1">#        print(&quot;in color.Colormap modify_item&quot;, col_key, irow, value, type(value))</span>
<span class="c1">#        print(&quot;In OBJECT modify_item&quot;, col_key, irow, value, type(value))</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col_key</span><span class="p">)[</span><span class="n">irow</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_internal_arrays</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">col_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col_key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Returns a column of the expected field &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col_key</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">default_kind</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">default_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Default value for next line when adjusting</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_funcs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">default_color</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Default value for next line when adjusting</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">default_grad_npts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Default value for next line when adjusting</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_npts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">adjust_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_probes</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; In place modifcation of array size&quot;&quot;&quot;</span>
        <span class="n">n_probes_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_probes</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">n_probes</span> <span class="o">-</span> <span class="n">n_probes_old</span>
        <span class="n">n_grads</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_grads</span> <span class="o">+</span> <span class="n">diff</span>

        <span class="k">if</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">colors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">[:</span><span class="n">n_probes</span><span class="p">,</span> <span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kinds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinds</span><span class="p">[:</span><span class="n">n_grads</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grad_npts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_npts</span><span class="p">[:</span><span class="n">n_grads</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grad_funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_funcs</span><span class="p">[:</span><span class="n">n_grads</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">diff</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kinds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinds</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">default_kind</span><span class="p">]</span> <span class="o">*</span> <span class="n">diff</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grad_funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_funcs</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">default_func</span><span class="p">]</span> <span class="o">*</span> <span class="n">diff</span>
            <span class="c1"># numpy arrays:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grad_npts</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">grad_npts</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">default_grad_npts</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">diff</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)],</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">,</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">default_color</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]]</span> <span class="o">*</span> <span class="n">diff</span><span class="p">)</span>
                <span class="p">],</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Nothing has changed...</span>
            <span class="k">return</span>

        <span class="c1"># Store the new values !</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_probes</span> <span class="o">=</span> <span class="n">n_probes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_grads</span> <span class="o">=</span> <span class="n">n_grads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_internal_arrays</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">save_as_pickle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Save as .cmap pickle file&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;wb+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tmpfile</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tmpfile</span><span class="p">,</span> <span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load_as_pickle</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">save_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Load a .cmap pickle file and returns the result&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tmpfile</span><span class="p">:</span>
            <span class="n">cmap_res</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cmap_res</span>


    <span class="k">def</span> <span class="nf">script_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return a string that can be used to restore the colormap</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">shift_arr</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_template&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_template</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;fs.colors.cmap_register[</span><span class="se">\&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_template</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">]&quot;</span>

        <span class="n">colors_str</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array2string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>
        <span class="n">colors_str</span> <span class="o">=</span> <span class="n">colors_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">shift_arr</span><span class="p">)</span>

        <span class="n">kinds_str</span> <span class="o">=</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kinds</span><span class="p">,</span> <span class="n">compact</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># repr(self.kinds)</span>
        <span class="n">kinds_str</span> <span class="o">=</span> <span class="n">kinds_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">shift_arr</span><span class="p">)</span>

        <span class="n">grad_npts_str</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array2string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grad_npts</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>
        <span class="n">grad_npts_str</span> <span class="o">=</span> <span class="n">grad_npts_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">shift_arr</span><span class="p">)</span>

        <span class="n">grad_funcs_str</span> <span class="o">=</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grad_funcs</span><span class="p">,</span> <span class="n">compact</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># repr(self.grad_funcs)</span>
        <span class="n">grad_funcs_str</span> <span class="o">=</span> <span class="n">grad_funcs_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">shift_arr</span><span class="p">)</span>

        <span class="n">extent_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extent</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="s2">&quot;fs.colors.Fractal_colormap(</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">shift</span><span class="si">}</span><span class="s2">colors=</span><span class="se">{{}}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">shift</span><span class="si">}</span><span class="s2">kinds=</span><span class="se">{{}}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">shift</span><span class="si">}</span><span class="s2">grad_npts=</span><span class="se">{{}}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">shift</span><span class="si">}</span><span class="s2">grad_funcs=</span><span class="se">{{}}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">shift</span><span class="si">}</span><span class="s2">extent=</span><span class="se">\&#39;{{}}\&#39;\n</span><span class="s2">)&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">colors_str</span><span class="p">,</span> <span class="n">kinds_str</span><span class="p">,</span> <span class="n">grad_npts_str</span><span class="p">,</span> <span class="n">grad_funcs_str</span><span class="p">,</span>
                 <span class="n">extent_str</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">):</span>
        <span class="n">nx_fi</span> <span class="o">=</span> <span class="n">nx</span>
        <span class="n">ny_fi</span> <span class="o">=</span> <span class="n">ny</span>
        
        <span class="n">nx</span> <span class="o">*=</span> <span class="mi">2</span>
        <span class="n">ny</span> <span class="o">*=</span> <span class="mi">2</span>
        
        <span class="n">margin</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">nx_im</span> <span class="o">=</span> <span class="n">nx</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">margin</span>
        <span class="n">ny_im</span> <span class="o">=</span> <span class="n">ny</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">margin</span>
        <span class="n">arrow_size</span> <span class="o">=</span> <span class="mf">0.05</span>
        
        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">arrow_size</span><span class="p">,</span> <span class="mf">1.</span> <span class="o">+</span> <span class="n">arrow_size</span><span class="p">,</span> <span class="n">nx_im</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
            <span class="n">ny_im</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>
        <span class="n">i_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">j_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">arrow_size</span><span class="p">,</span> <span class="n">arrow_size</span><span class="p">,</span> <span class="n">ny_im</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
            <span class="n">nx_im</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>
        
        <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">colorize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_probes</span><span class="p">)))</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="n">img</span> <span class="o">*</span> <span class="mf">255.999</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_arrow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">i_arr</span><span class="p">,</span> <span class="n">j_arr</span><span class="p">,</span> <span class="n">arrow_size</span><span class="p">)</span>
        
        <span class="c1"># Apply LANCZOS filter</span>
        <span class="n">PIL_img</span> <span class="o">=</span> <span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">PIL_img</span> <span class="o">=</span> <span class="n">PIL_img</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span>
             <span class="n">size</span><span class="o">=</span><span class="p">((</span><span class="n">ny_fi</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">margin</span><span class="p">),</span> <span class="p">(</span><span class="n">nx_fi</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">margin</span><span class="p">)),</span>
             <span class="n">resample</span><span class="o">=</span><span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">LANCZOS</span>
        <span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">PIL_img</span><span class="p">)</span>
        
        <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">nx_fi</span><span class="p">,</span> <span class="n">ny_fi</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span> <span class="o">*</span> <span class="mi">255</span>
        <span class="n">B</span><span class="p">[</span><span class="n">margin</span><span class="p">:</span><span class="n">nx_fi</span> <span class="o">-</span> <span class="n">margin</span><span class="p">,</span> <span class="n">margin</span><span class="p">:</span><span class="n">ny_fi</span> <span class="o">-</span> <span class="n">margin</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">img</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_add_arrow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">i_arr</span><span class="p">,</span> <span class="n">j_arr</span><span class="p">,</span> <span class="n">arrow_size</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Draws the shape of the extra arrow in white &quot;&quot;&quot;</span>
        <span class="n">arr1</span> <span class="o">=</span> <span class="p">(</span><span class="n">i_arr</span> <span class="o">+</span> <span class="n">j_arr</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">arrow_size</span><span class="p">)</span>
        <span class="n">arr2</span> <span class="o">=</span> <span class="p">(</span><span class="n">i_arr</span> <span class="o">-</span> <span class="n">j_arr</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">arrow_size</span><span class="p">)</span>
        <span class="n">arr3</span> <span class="o">=</span> <span class="p">(</span><span class="n">i_arr</span> <span class="o">+</span> <span class="n">j_arr</span> <span class="o">&gt;</span> <span class="mf">1.</span> <span class="o">+</span> <span class="n">arrow_size</span><span class="p">)</span>
        <span class="n">arr4</span> <span class="o">=</span> <span class="p">(</span><span class="n">i_arr</span> <span class="o">-</span> <span class="n">j_arr</span> <span class="o">&gt;</span> <span class="mf">1.</span> <span class="o">+</span> <span class="n">arrow_size</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">arrloc</span> <span class="ow">in</span> <span class="p">(</span><span class="n">arr1</span><span class="p">,</span> <span class="n">arr2</span><span class="p">,</span> <span class="n">arr3</span><span class="p">,</span> <span class="n">arr4</span><span class="p">):</span>
            <span class="n">np</span><span class="o">.</span><span class="n">putmask</span><span class="p">(</span><span class="n">img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">arrloc</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,))</span>
            <span class="n">np</span><span class="o">.</span><span class="n">putmask</span><span class="p">(</span><span class="n">img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">arrloc</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,))</span>
            <span class="n">np</span><span class="o">.</span><span class="n">putmask</span><span class="p">(</span><span class="n">img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">arrloc</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,))</span>

        

    <span class="k">def</span> <span class="nf">output_png</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Outputs the colorbar to a .png files:</span>
<span class="sd">        dir_path/file_name.cbar.png</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span>
        <span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">B</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">+</span> <span class="s2">&quot;.cbar.png&quot;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">output_ImageQt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">):</span>
<span class="c1">#https://stackoverflow.com/questions/34697559/pil-image-to-qpixmap-conversion-issue</span>
        <span class="n">B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PIL</span><span class="o">.</span><span class="n">ImageQt</span><span class="o">.</span><span class="n">ImageQt</span><span class="p">(</span><span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">B</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">colorize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">probes_z</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a color array bazed on z values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">probes_z</span><span class="p">)</span>
        <span class="c1"># linear interpolation in sorted color array</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_interp_colors</span><span class="p">),</span> <span class="n">z</span><span class="p">)</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">indices</span> <span class="o">-</span> <span class="n">z</span>
        <span class="n">search_colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_interp_colors</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_interp_colors</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_interp_colors</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
        <span class="p">])</span>
        <span class="n">z_colors</span> <span class="o">=</span> <span class="p">(</span><span class="n">alpha</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">search_colors</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> 
             <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">alpha</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span> <span class="o">*</span> <span class="n">search_colors</span><span class="p">[</span><span class="n">indices</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">z_colors</span><span class="p">,</span> <span class="p">[</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>  

    <span class="k">def</span> <span class="nf">greyscale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">probes_z</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a color array bazed on z values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">probes_z</span><span class="p">)</span>
        <span class="c1"># linear interpolation in sorted greyscale array</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_interp_colors</span><span class="p">),</span> <span class="n">z</span><span class="p">)</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">indices</span> <span class="o">-</span> <span class="n">z</span>
        <span class="n">search_colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span>
            <span class="p">[</span><span class="mf">0.</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_interp_colors</span><span class="p">),</span>  <span class="p">[</span><span class="mf">1.</span><span class="p">]])</span>
        <span class="n">z_greys</span> <span class="o">=</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">search_colors</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span> <span class="o">+</span>
                   <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">search_colors</span><span class="p">[</span><span class="n">indices</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">z_greys</span>

    <span class="k">def</span> <span class="nf">normalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">probes_z</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Normalise z , z -&gt; z* so that z*min = 0 / z*max = self.n_interp_colors</span>
<span class="sd">        *z*  array to normalise</span>
<span class="sd">        *probes_z* array of dim self.n_probes: values of z at probes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">probes_z</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_probes</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">probes_z</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,):</span>
                <span class="n">probes_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">probes_z</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">probes_z</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">num</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_probes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">probes_z</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">probes_z</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_probes</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Expected *probes_values* of shape </span><span class="si">{0}</span><span class="s2">, &quot;</span>
                    <span class="s2">&quot;given </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_probes</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">probes_z</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>        

        <span class="c1"># on over / under flow : clip or mirror</span>
        <span class="n">ext_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">probes_z</span><span class="p">)</span>
        <span class="n">ext_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">probes_z</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extent</span> <span class="o">==</span> <span class="s2">&quot;clip&quot;</span><span class="p">:</span>
            <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">ext_min</span><span class="p">,</span> <span class="n">ext_max</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">extent</span> <span class="o">==</span> <span class="s2">&quot;mirror&quot;</span><span class="p">:</span>
            <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mirror</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">ext_min</span><span class="p">,</span> <span class="n">ext_max</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">extent</span> <span class="o">==</span> <span class="s2">&quot;repeat&quot;</span><span class="p">:</span>
            <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">ext_min</span><span class="p">,</span> <span class="n">ext_max</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unexpected extent property </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">extent</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">probes_z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_probes</span><span class="p">)</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">clip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ext_min</span><span class="p">,</span> <span class="n">ext_max</span><span class="p">):</span>
        <span class="n">np</span><span class="o">.</span><span class="n">putmask</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">ext_min</span><span class="p">,</span> <span class="n">ext_min</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">putmask</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">ext_max</span><span class="p">,</span> <span class="n">ext_max</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">mirror</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ext_min</span><span class="p">,</span> <span class="n">ext_max</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Mirroring of x on ext_min &amp; ext_max</span>
<span class="sd">Formula: https://en.wikipedia.org/wiki/Triangle_wave</span>
<span class="sd">4/p * (t - p/2 * floor(2t/p + 1/2)) * (-1)**floor(2t/p + 1/2) where p = 4</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">ext_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ext_max</span> <span class="o">-</span> <span class="n">ext_min</span><span class="p">)</span>  <span class="c1"># btw. 0. and 1</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">t</span> <span class="o">-</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">e</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ext_min</span> <span class="o">+</span> <span class="p">(</span><span class="n">t</span> <span class="o">*</span> <span class="p">(</span><span class="n">ext_max</span> <span class="o">-</span> <span class="n">ext_min</span><span class="p">))</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">repeat</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ext_min</span><span class="p">,</span> <span class="n">ext_max</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Repeating x based on ext_min &amp; ext_max (Sawtooth)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ext_min</span> <span class="o">+</span> <span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">ext_min</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">ext_max</span> <span class="o">-</span> <span class="n">ext_min</span><span class="p">))</span></div>



<span class="k">class</span> <span class="nc">Image_interpolator</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">screen_coord</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Interpolation of points in an image</span>
<span class="sd">        image: Pillow image</span>
<span class="sd">        wrap : if True, margins are wraped</span>
<span class="sd">        screen_coord : if True pixels to interpolate are in screen coords</span>
<span class="sd">                       (y downwards)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_im</span> <span class="o">=</span> <span class="n">image</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wrap</span> <span class="o">=</span> <span class="n">wrap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_screen_coord</span> <span class="o">=</span> <span class="n">screen_coord</span>

    <span class="k">def</span> <span class="nf">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_im</span><span class="o">.</span><span class="n">mode</span> 
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;RGB&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolate_rgb</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">interpolate_rgb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        x arrays of floats between [0, nx]</span>
<span class="sd">        y arrays of floats between [0, ny]</span>
<span class="sd">        </span>
<span class="sd">        Return an RGB array of shape shape-x) + (3,), dtype np.uint8)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span> <span class="o">+</span> <span class="p">(</span><span class="mi">3</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">wrap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrap</span>
        <span class="n">screen_coord</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_screen_coord</span>
        <span class="k">if</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">shape</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;x and y shall have same shape&quot;</span><span class="p">)</span>
        <span class="n">xr</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">yr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;channels&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_im</span><span class="p">)</span>
        <span class="c1"># channels &lt;PIL.PngImagePlugin.PngImageFile image mode=RGB size=3600x3600 at 0x7FF2C0CA20A0&gt;</span>
        <span class="n">im_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_im</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;channel&quot;</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="n">im_arr</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">ic</span><span class="p">]</span><span class="c1">#self._im.getchannel(ic)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xr</span><span class="p">))</span>
            <span class="n">im_interpolate</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">wrap</span><span class="p">,</span> <span class="n">screen_coord</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
            <span class="n">res</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">ic</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span> <span class="c1">#/ 255.</span>
        <span class="k">return</span> <span class="n">res</span>
        

<span class="nd">@numba</span><span class="o">.</span><span class="n">njit</span>
<span class="k">def</span> <span class="nf">im_interpolate</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">wrap</span><span class="p">,</span> <span class="n">screen_coord</span><span class="p">,</span> <span class="n">out</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Numba jitted function to interpolate in an image channel</span>

<span class="sd">    channel: The 2d image channel to interpolate </span>
<span class="sd">    x: The 1d x-axis pts for interpolation</span>
<span class="sd">    y: The 1d y-axis pts for interpolation</span>
<span class="sd">    wrap: if True, wraps, otherwise, clip</span>
<span class="sd">    out: the res array</span>

<span class="sd">    # note :  channel.shape: height x width (column-major)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span> <span class="o">=</span>  <span class="n">channel</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">npts</span><span class="p">,</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">for</span> <span class="n">ipt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npts</span><span class="p">):</span>
        <span class="c1"># The x coords</span>
        <span class="n">xloc</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">ipt</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span>
        <span class="n">divx</span><span class="p">,</span> <span class="n">modx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divmod</span><span class="p">(</span><span class="n">xloc</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
        <span class="n">divx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">divx</span><span class="p">)</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">divx</span> <span class="o">&lt;=</span> <span class="n">nx</span> <span class="o">-</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">ix1</span> <span class="o">=</span> <span class="n">divx</span>
            <span class="n">ix2</span> <span class="o">=</span> <span class="n">ix1</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">divx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># divx = -1</span>
            <span class="n">ix2</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">wrap</span><span class="p">:</span>
                <span class="n">ix1</span> <span class="o">=</span> <span class="n">nx</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ix1</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># divx = nx - 1</span>
            <span class="n">ix1</span> <span class="o">=</span> <span class="n">nx</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">wrap</span><span class="p">:</span>
                <span class="n">ix1</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ix1</span> <span class="o">=</span> <span class="n">nx</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="c1"># The y coords</span>
        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span> <span class="c1">#screen_coord:</span>
            <span class="n">yloc</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">ipt</span><span class="p">]</span> <span class="o">-</span> <span class="n">ny</span> <span class="o">+</span> <span class="mf">0.5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">yloc</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">ipt</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span>
        <span class="n">divy</span><span class="p">,</span> <span class="n">mody</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divmod</span><span class="p">(</span><span class="n">yloc</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
        <span class="n">divy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">divy</span><span class="p">)</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">divy</span> <span class="o">&lt;=</span> <span class="n">ny</span> <span class="o">-</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">iy1</span> <span class="o">=</span> <span class="n">divy</span>
            <span class="n">iy2</span> <span class="o">=</span> <span class="n">iy1</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">divy</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># divy = -1</span>
            <span class="n">iy2</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">wrap</span><span class="p">:</span>
                <span class="n">iy1</span> <span class="o">=</span> <span class="n">ny</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">iy1</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># divx = ny - 1</span>
            <span class="n">iy1</span> <span class="o">=</span> <span class="n">ny</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">wrap</span><span class="p">:</span>
                <span class="n">iy1</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">iy1</span> <span class="o">=</span> <span class="n">ny</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="c1"># The interpolation as barycentric coordinates</span>
        <span class="n">out</span><span class="p">[</span><span class="n">ipt</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">modx</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">mody</span><span class="p">)</span> <span class="o">*</span> <span class="n">channel</span><span class="p">[</span><span class="n">iy1</span><span class="p">,</span> <span class="n">ix1</span><span class="p">]</span>
            <span class="o">+</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">modx</span><span class="p">)</span> <span class="o">*</span> <span class="n">mody</span> <span class="o">*</span> <span class="n">channel</span><span class="p">[</span><span class="n">iy2</span><span class="p">,</span> <span class="n">ix1</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">modx</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">mody</span><span class="p">)</span> <span class="o">*</span> <span class="n">channel</span><span class="p">[</span><span class="n">iy1</span><span class="p">,</span> <span class="n">ix2</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">modx</span> <span class="o">*</span> <span class="n">mody</span> <span class="o">*</span> <span class="n">channel</span><span class="p">[</span><span class="n">iy2</span><span class="p">,</span> <span class="n">ix2</span><span class="p">]</span>
        <span class="p">)</span>
            







<span class="k">class</span> <span class="nc">Curve</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">brightness</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hardness</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">blur_ranges</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        TODO - work in progress</span>
<span class="sd">        A transfert curve from [0, 1] to [0, 1]</span>
<span class="sd">        (&quot;Grey levels map&quot;)</span>
<span class="sd">        brightness float, O. leaves untouched, 0..+1 brighten</span>
<span class="sd">                                              -1..0 darken</span>
<span class="sd">        hardness float, 1. leaves untouched, 1..inf more contrast </span>
<span class="sd">                                              0..1 les contrast</span>
<span class="sd">        blur_ranges: danping base on layer &quot;damping_pp&quot;               </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: refactor as an editor with control points ?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fn</span> <span class="o">=</span> <span class="n">fn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">brightness</span> <span class="o">=</span> <span class="n">brightness</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hardness</span> <span class="o">=</span> <span class="n">hardness</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blur_ranges</span> <span class="o">=</span> <span class="n">blur_ranges</span>
    
    <span class="k">def</span> <span class="nf">set_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;  register the curve as linked to a layer</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer</span> <span class="o">=</span> <span class="n">layer</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">blur_base</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">damping_pp</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>      
        <span class="n">brightness</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">brightness</span>
        <span class="n">hardness</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hardness</span>
        <span class="n">blur_ranges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blur_ranges</span>

        <span class="c1"># renormalise between -1 and 1</span>
        <span class="n">data</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">data</span> <span class="o">-</span> <span class="mf">1.</span>

        <span class="k">if</span> <span class="n">brightness</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">brighten</span><span class="p">(</span><span class="n">brightness</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hardness</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">harden</span><span class="p">(</span><span class="n">hardness</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">blur_ranges</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blur</span><span class="p">(</span><span class="n">blur_ranges</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">blur_base</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">data</span> <span class="o">+</span> <span class="mf">1.</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">brighten</span><span class="p">(</span><span class="n">brightness</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Input : data between [-1, 1]</span>
<span class="sd">        output: data linearly rescaled between [min, max] so that :</span>
<span class="sd">            - min = -1 or max = +1</span>
<span class="sd">            - skewness = 0.5 * (min+max)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">brightness</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mf">1.</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Expected skew strictly between -1. and 1.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">brightness</span> <span class="o">&gt;=</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1.</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">data</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">brightness</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mf">1.</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">data</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">brightness</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">harden</span><span class="p">(</span><span class="n">hardness</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adjust contrast for a np.array between -1 and 1</span>
<span class="sd">        Parameter:</span>
<span class="sd">        *hardness*   if  1. data unchanged</span>
<span class="sd">                     if  0. &lt; hardness &lt; 1., soften the contrast</span>
<span class="sd">                     if  hardness &gt; 1., accentuate the contrast</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">hardness</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">hardness</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">hardness</span><span class="p">)</span>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">bluring_coeff</span><span class="p">(</span><span class="n">blur1</span><span class="p">,</span> <span class="n">blur2</span><span class="p">,</span> <span class="n">blur3</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define bluring coefficents for *x*, parameter blur1, blur2, blur3</span>
<span class="sd">        Paramters</span>
<span class="sd">        *blur1*, *blur2*, *blur3*    Monotonic, real inputs</span>
<span class="sd">        *x*                          Array</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        *y*   Arrays of bluring coefficient at x location, as below if blur </span>
<span class="sd">              param are increasing :</span>
<span class="sd">                 1 below blur1.    </span>
<span class="sd">                 smooth from blur1 to blur 2 1. -&gt; 0.</span>
<span class="sd">                 stay at 0 between blur2 and blur 3</span>
<span class="sd">                 back to 1. after blur3</span>
<span class="sd">            If param blur1 to blur3 are decreasing inverse the logic (mirror)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">blur2</span> <span class="o">-</span> <span class="n">blur1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">blur3</span> <span class="o">-</span> <span class="n">blur2</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Expected monotonic blur1, blur2, blur3&quot;</span><span class="p">)</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">blur3</span> <span class="o">-</span> <span class="n">blur1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sign</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unable to define blur direction, as blur1=blur3&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">sign</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Curve</span><span class="o">.</span><span class="n">bluring_coeff</span><span class="p">(</span><span class="o">-</span><span class="n">blur1</span><span class="p">,</span> <span class="o">-</span><span class="n">blur2</span><span class="p">,</span> <span class="o">-</span><span class="n">blur3</span><span class="p">,</span> <span class="o">-</span><span class="n">x</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">y</span><span class="p">[</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">blur1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
            <span class="n">y</span><span class="p">[</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">blur3</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span> 
            <span class="n">y</span><span class="p">[(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">blur2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">blur3</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">blur1</span> <span class="o">+</span> <span class="n">blur2</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">mid</span> <span class="o">-</span> <span class="n">blur1</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">blur1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">mid</span><span class="p">)</span>
            <span class="n">y</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">-</span> <span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">blur1</span><span class="p">)</span> <span class="o">/</span> <span class="n">l</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="mf">0.5</span> 
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">mid</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">blur2</span><span class="p">)</span>
            <span class="n">y</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">blur2</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span> <span class="o">/</span> <span class="n">l</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="mf">0.5</span> 
            <span class="k">return</span> <span class="n">y</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">blur</span><span class="p">(</span><span class="n">blur_ranges</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">blur_base</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Selectively &quot;blurs&quot; ie contracts to 0. the data inside &quot;blur ranges&quot;</span>
<span class="sd">        defined as quantiles of the base_layer_data.</span>
<span class="sd">        Parameters :</span>
<span class="sd">        blur_ranges [[blur1, blur2, blur3],</span>
<span class="sd">                     [blur2, blur2, blur3], ...]  </span>
<span class="sd">                     bluri expressed as quantiles of base_layer_data (in 0 - 1)</span>

<span class="sd">        qt_base     distribution function applied to base data values </span>
<span class="sd">                    (= the quantiles)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">blur_range</span> <span class="ow">in</span> <span class="n">blur_ranges</span><span class="p">:</span>
            <span class="n">blur1</span><span class="p">,</span> <span class="n">blur2</span><span class="p">,</span> <span class="n">blur3</span> <span class="o">=</span> <span class="n">blur_range</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">*</span> <span class="n">Curve</span><span class="o">.</span><span class="n">bluring_coeff</span><span class="p">(</span><span class="n">blur1</span><span class="p">,</span> <span class="n">blur2</span><span class="p">,</span> <span class="n">blur3</span><span class="p">,</span> <span class="n">blur_base</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>
</pre></div>

           </div>
          </div>
<div class="ribbon">
  <a href="https://github.com/GBillotey/Fractalshades">Fork me on GitHub</a>
</div>

          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Fractalshades development team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 
<style>
  .wy-nav-content { max-width: 1250px !important; }
</style>


</body>
</html>