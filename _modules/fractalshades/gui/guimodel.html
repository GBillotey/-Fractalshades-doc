<!== Adding "Fork me on Github" ribbon ==>
<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>fractalshades.gui.guimodel &mdash; Fractalshades 1.1.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../_static/rtd_dark.css?v=e3debd14" />
      <link rel="stylesheet" type="text/css" href="../../../_static/math.css?v=7fc59cab" />
      <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery.css?v=61a4c737" />
      <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-binder.css?v=f4aeca0c" />
      <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
      <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=58fbf978"></script>
        <script src="../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link href="../../../_static/ribbon.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Fractalshades
              <img src="../../../_static/logo3.jpg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.1.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started.html">Getting started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_started.html#installing">Installing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../getting_started.html#installing-gmp-mpfr-mpc-windows-users">Installing GMP / MPFR / MPC: Windows users</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../getting_started.html#installing-gmp-mpfr-mpc-unix-linux-users">Installing GMP / MPFR / MPC: Unix / Linux users</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../getting_started.html#installing-gmp-mpfr-mpc-mac-users">Installing GMP / MPFR / MPC: Mac users</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_started.html#a-5-minutes-guide-to-fractalshades">A 5-minutes guide to fractalshades</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_started.html#graphical-user-interface">Graphical user interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_started.html#finding-areas-of-interest">Finding areas of interest</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_started.html#unskewing-streched-areas">Unskewing streched areas</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../math.html">Mathematical background</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../math.html#zoom-level-and-native-floating-point-precision">Zoom level and native floating-point precision</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../math.html#perturbation-theory">Perturbation Theory</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../math.html#avoiding-loss-of-precision">Avoiding loss of precision</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../math.html#billinear-approximations">Billinear approximations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../math.html#extended-range-floating-points">Extended range floating points</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../math.html#finding-minibrots">Finding minibrots</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../math.html#going-further-a-few-references">Going further: a few references</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/index.html">Gallery</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/index.html#batch-mode-gallery">Batch mode gallery</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/index.html#colormaps-template-gallery">Colormaps template gallery</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/index.html#gui-mode-arbitrary-precision-implementations">GUI-mode: arbitrary precision implementations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/index.html#gui-mode-standard-implementation-examples">GUI-mode: standard implementation examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/index.html#lighting-examples-gallery">Lighting examples gallery</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/index.html#projections">Projections</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/batch_mode/index.html">Batch mode gallery</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/batch_mode/01-full_basic.html">01 - Full Mandelbrot basic example</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/batch_mode/02-bulb_fieldlines1.html">02 - Bulb fieldlines example “tint_or_shade”</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/batch_mode/03-bulb_fieldlines2.html">03 - Bulb fieldlines example “twinfield”</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/batch_mode/04-seahorse_shaded.html">04 - Seahorse shaded example</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/batch_mode/05-seahorse_shaded_colored.html">05 - Seahorse shaded and colored example</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/batch_mode/06-seahorse_interior.html">06 - Seahorse interior example</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/batch_mode/07-seahorse_DEM.html">07 - Seahorse DEM example</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/batch_mode/08-run_perturb_DEM.html">08 - DEM example with perturbation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/batch_mode/09-run_flake_DEM.html">09 - A deeper DEM example</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/batch_mode/10-double_embedded_julia.html">10 - Double embedded Julia set</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/batch_mode/11-run_perturbdeep.html">11- Ultra-deep embedded Julia set</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/batch_mode/12-burning_ship_deep.html">12 - Burning Ship deep zoom</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/batch_mode/13-burning_ship.html">13 - Burning ship DEM</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/batch_mode/14-burning_ship-deeper_DEM.html">14 - Burning ship deeper DEM</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/batch_mode/15-burning_ship-deepJulia_DEM.html">15 - Burning Ship ultra-deep embedded Julia set</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/batch_mode/16-tetration_spring.html">16 - Tetration (power tower) zoom: “Spring”</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/batch_mode/17-perpendicular_burning_ship_DEM.html">17 - “Perpendicular” Burning Ship</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/batch_mode/18-perpendicular_burning_ship_glynn.html">18 - “Perpendicular” Burning Ship: hidden Glynn spiral</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/batch_mode/19-perpendicular_burning_ship_Koch.html">19 - “Perpendicular” Burning Ship: hidden Koch snowflakes</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/batch_mode/20-perpendicular_burning_ship_Sierpinski.html">20 - “Perpendicular” Burning Ship: hidden Sierpinski carpets</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/batch_mode/21-perpendicular_burning_ship_trees.html">21 - “Perpendicular” Burning Ship: tree structures</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/batch_mode/22-shark_fin_deep.html">22 - “Shark Fin” escape-time fractal</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/batch_mode/23-deep_min.html">23 - A deep mini</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/colormaps/index.html">Colormaps template gallery</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/colormaps/plot_cmaps.html">Colormaps: available templates</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/interactive_deepzoom/index.html">GUI-mode: arbitrary precision implementations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/interactive_deepzoom/D01_run_interactive.html">D01 - Mandelbrot arbitrary-precision explorer</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/interactive_deepzoom/D02_run_BS_interactive.html">D02 - Burning Ship arbitrary-precision explorer</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/interactive_deepzoom/D03_run_interactive_Mn.html">D03 - Mandelbrot arbitrary-precision explorer</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/interactive_standard/index.html">GUI-mode: standard implementation examples</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/interactive_standard/S01_run_interactive_shallow.html">S01 - Mandelbrot explorer - Standard precision</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/interactive_standard/S02_run_BS_shallow.html">S02 - Burning ship explorer - Standard precision</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/interactive_standard/S03_run_interactive_Mn_shallow.html">S03 - Mandelbrot power n explorer - Standard precision</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/interactive_standard/S04_run_collatz.html">S04 - Collatz explorer - Standard precision</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/interactive_standard/S05_run_power_tower_shallow.html">S05 - Tetration fractal explorer - Standard precision</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/lighting/index.html">Lighting examples gallery</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/lighting/plot_lighting.html">Ligthings: available effects</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/projections/index.html">Projections</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/projections/P01-feigenbaum_expmap.html">P01 - Exponential mapping: Feigenbaum point</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/projections/P02-inversion.html">P02 - Inversion of the Mandelbrot set</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/projections/P03-Elephant_valley_moebius.html">P03 - Moebius mapping: Elephant and Seahorse valleys</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../examples/projections/P04-deep_expmap.html">P04 - Exponential mapping for deep zoom</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../API.html">Application Programming Interface</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../API/settings.html">Application-level settings</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../API/settings.html#fractalshades.settings.enable_multithreading"><code class="docutils literal notranslate"><span class="pre">enable_multithreading</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/settings.html#fractalshades.settings.skip_calc"><code class="docutils literal notranslate"><span class="pre">skip_calc</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/settings.html#fractalshades.settings.newton_zoom_level"><code class="docutils literal notranslate"><span class="pre">newton_zoom_level</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/settings.html#fractalshades.settings.no_newton"><code class="docutils literal notranslate"><span class="pre">no_newton</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/settings.html#fractalshades.settings.inspect_calc"><code class="docutils literal notranslate"><span class="pre">inspect_calc</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/settings.html#fractalshades.settings.chunk_size"><code class="docutils literal notranslate"><span class="pre">chunk_size</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/settings.html#fractalshades.settings.verbosity"><code class="docutils literal notranslate"><span class="pre">verbosity</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/settings.html#fractalshades.settings.postproc_dtype"><code class="docutils literal notranslate"><span class="pre">postproc_dtype</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/settings.html#fractalshades.settings.log_directory"><code class="docutils literal notranslate"><span class="pre">log_directory</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/settings.html#fractalshades.settings.disable_decompression_size_check"><code class="docutils literal notranslate"><span class="pre">disable_decompression_size_check()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/settings.html#fractalshades.settings.BLA_compression"><code class="docutils literal notranslate"><span class="pre">BLA_compression</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/settings.html#fractalshades.settings.GUI_image_Mblimit"><code class="docutils literal notranslate"><span class="pre">GUI_image_Mblimit</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../API/core.html">Core components</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../API/core.html#fractalshades.Fractal"><code class="docutils literal notranslate"><span class="pre">Fractal</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/core.html#fractalshades.Fractal.__init__"><code class="docutils literal notranslate"><span class="pre">Fractal.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/core.html#fractalshades.Fractal.clean_up"><code class="docutils literal notranslate"><span class="pre">Fractal.clean_up()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/core.html#fractalshades.Fractal.zoom"><code class="docutils literal notranslate"><span class="pre">Fractal.zoom()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/core.html#fractalshades.PerturbationFractal"><code class="docutils literal notranslate"><span class="pre">PerturbationFractal</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/core.html#fractalshades.PerturbationFractal.__init__"><code class="docutils literal notranslate"><span class="pre">PerturbationFractal.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/core.html#fractalshades.PerturbationFractal.zoom"><code class="docutils literal notranslate"><span class="pre">PerturbationFractal.zoom()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/core.html#fractalshades.Fractal_plotter"><code class="docutils literal notranslate"><span class="pre">Fractal_plotter</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/core.html#fractalshades.Fractal_plotter.__init__"><code class="docutils literal notranslate"><span class="pre">Fractal_plotter.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/core.html#fractalshades.Fractal_plotter.add_layer"><code class="docutils literal notranslate"><span class="pre">Fractal_plotter.add_layer()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/core.html#fractalshades.Fractal_plotter.plot"><code class="docutils literal notranslate"><span class="pre">Fractal_plotter.plot()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/core.html#fractalshades.Fractal_plotter.save_db"><code class="docutils literal notranslate"><span class="pre">Fractal_plotter.save_db()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/core.html#fractalshades.zoom_options"><code class="docutils literal notranslate"><span class="pre">zoom_options()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/core.html#fractalshades.calc_options"><code class="docutils literal notranslate"><span class="pre">calc_options()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/core.html#fractalshades.interactive_options"><code class="docutils literal notranslate"><span class="pre">interactive_options()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../API/projection.html">Projections</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../API/projection.html#fractalshades.projection.Projection"><code class="docutils literal notranslate"><span class="pre">Projection</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/projection.html#fractalshades.projection.Projection.__init__"><code class="docutils literal notranslate"><span class="pre">Projection.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/projection.html#fractalshades.projection.Cartesian"><code class="docutils literal notranslate"><span class="pre">Cartesian</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/projection.html#fractalshades.projection.Cartesian.__init__"><code class="docutils literal notranslate"><span class="pre">Cartesian.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/projection.html#fractalshades.projection.Expmap"><code class="docutils literal notranslate"><span class="pre">Expmap</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/projection.html#fractalshades.projection.Expmap.__init__"><code class="docutils literal notranslate"><span class="pre">Expmap.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/projection.html#fractalshades.projection.Generic_mapping"><code class="docutils literal notranslate"><span class="pre">Generic_mapping</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/projection.html#fractalshades.projection.Generic_mapping.__init__"><code class="docutils literal notranslate"><span class="pre">Generic_mapping.__init__()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../API/arbitrary_models.html">Fractal models: Arbitrary-precision implementations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../API/arbitrary_models.html#fractalshades.models.Perturbation_mandelbrot"><code class="docutils literal notranslate"><span class="pre">Perturbation_mandelbrot</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/arbitrary_models.html#fractalshades.models.Perturbation_mandelbrot.__init__"><code class="docutils literal notranslate"><span class="pre">Perturbation_mandelbrot.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/arbitrary_models.html#fractalshades.models.Perturbation_mandelbrot.calc_std_div"><code class="docutils literal notranslate"><span class="pre">Perturbation_mandelbrot.calc_std_div()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/arbitrary_models.html#fractalshades.models.Perturbation_mandelbrot_N"><code class="docutils literal notranslate"><span class="pre">Perturbation_mandelbrot_N</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/arbitrary_models.html#fractalshades.models.Perturbation_mandelbrot_N.__init__"><code class="docutils literal notranslate"><span class="pre">Perturbation_mandelbrot_N.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/arbitrary_models.html#fractalshades.models.Perturbation_mandelbrot_N.calc_std_div"><code class="docutils literal notranslate"><span class="pre">Perturbation_mandelbrot_N.calc_std_div()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/arbitrary_models.html#fractalshades.models.Perturbation_burning_ship"><code class="docutils literal notranslate"><span class="pre">Perturbation_burning_ship</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/arbitrary_models.html#fractalshades.models.Perturbation_burning_ship.__init__"><code class="docutils literal notranslate"><span class="pre">Perturbation_burning_ship.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/arbitrary_models.html#fractalshades.models.Perturbation_burning_ship.calc_std_div"><code class="docutils literal notranslate"><span class="pre">Perturbation_burning_ship.calc_std_div()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../API/standard_models.html">Fractal models: Standard-precision implementations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../API/standard_models.html#fractalshades.models.Mandelbrot"><code class="docutils literal notranslate"><span class="pre">Mandelbrot</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/standard_models.html#fractalshades.models.Mandelbrot.__init__"><code class="docutils literal notranslate"><span class="pre">Mandelbrot.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/standard_models.html#fractalshades.models.Mandelbrot.calc_std_div"><code class="docutils literal notranslate"><span class="pre">Mandelbrot.calc_std_div()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/standard_models.html#fractalshades.models.Mandelbrot.newton_calc"><code class="docutils literal notranslate"><span class="pre">Mandelbrot.newton_calc()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/standard_models.html#fractalshades.models.Mandelbrot_N"><code class="docutils literal notranslate"><span class="pre">Mandelbrot_N</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/standard_models.html#fractalshades.models.Mandelbrot_N.__init__"><code class="docutils literal notranslate"><span class="pre">Mandelbrot_N.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/standard_models.html#fractalshades.models.Mandelbrot_N.calc_std_div"><code class="docutils literal notranslate"><span class="pre">Mandelbrot_N.calc_std_div()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/standard_models.html#fractalshades.models.Mandelbrot_N.newton_calc"><code class="docutils literal notranslate"><span class="pre">Mandelbrot_N.newton_calc()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/standard_models.html#fractalshades.models.Burning_ship"><code class="docutils literal notranslate"><span class="pre">Burning_ship</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/standard_models.html#fractalshades.models.Burning_ship.__init__"><code class="docutils literal notranslate"><span class="pre">Burning_ship.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/standard_models.html#fractalshades.models.Burning_ship.calc_std_div"><code class="docutils literal notranslate"><span class="pre">Burning_ship.calc_std_div()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/standard_models.html#fractalshades.models.Power_tower"><code class="docutils literal notranslate"><span class="pre">Power_tower</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/standard_models.html#fractalshades.models.Power_tower.__init__"><code class="docutils literal notranslate"><span class="pre">Power_tower.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/standard_models.html#fractalshades.models.Power_tower.newton_calc"><code class="docutils literal notranslate"><span class="pre">Power_tower.newton_calc()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/standard_models.html#fractalshades.models.Collatz"><code class="docutils literal notranslate"><span class="pre">Collatz</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/standard_models.html#fractalshades.models.Collatz.__init__"><code class="docutils literal notranslate"><span class="pre">Collatz.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/standard_models.html#fractalshades.models.Collatz.base_calc"><code class="docutils literal notranslate"><span class="pre">Collatz.base_calc()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../API/postproc.html">Postprocessing fields</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../API/postproc.html#fractalshades.postproc.Postproc_batch"><code class="docutils literal notranslate"><span class="pre">Postproc_batch</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/postproc.html#fractalshades.postproc.Postproc_batch.__init__"><code class="docutils literal notranslate"><span class="pre">Postproc_batch.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/postproc.html#fractalshades.postproc.Postproc_batch.add_postproc"><code class="docutils literal notranslate"><span class="pre">Postproc_batch.add_postproc()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/postproc.html#fractalshades.postproc.Postproc"><code class="docutils literal notranslate"><span class="pre">Postproc</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/postproc.html#fractalshades.postproc.Raw_pp"><code class="docutils literal notranslate"><span class="pre">Raw_pp</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/postproc.html#fractalshades.postproc.Raw_pp.__init__"><code class="docutils literal notranslate"><span class="pre">Raw_pp.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/postproc.html#fractalshades.postproc.Continuous_iter_pp"><code class="docutils literal notranslate"><span class="pre">Continuous_iter_pp</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/postproc.html#fractalshades.postproc.Continuous_iter_pp.__init__"><code class="docutils literal notranslate"><span class="pre">Continuous_iter_pp.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/postproc.html#fractalshades.postproc.Fieldlines_pp"><code class="docutils literal notranslate"><span class="pre">Fieldlines_pp</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/postproc.html#fractalshades.postproc.Fieldlines_pp.__init__"><code class="docutils literal notranslate"><span class="pre">Fieldlines_pp.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/postproc.html#fractalshades.postproc.DEM_pp"><code class="docutils literal notranslate"><span class="pre">DEM_pp</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/postproc.html#fractalshades.postproc.DEM_pp.__init__"><code class="docutils literal notranslate"><span class="pre">DEM_pp.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/postproc.html#fractalshades.postproc.DEM_normal_pp"><code class="docutils literal notranslate"><span class="pre">DEM_normal_pp</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/postproc.html#fractalshades.postproc.DEM_normal_pp.__init__"><code class="docutils literal notranslate"><span class="pre">DEM_normal_pp.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/postproc.html#fractalshades.postproc.Attr_pp"><code class="docutils literal notranslate"><span class="pre">Attr_pp</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/postproc.html#fractalshades.postproc.Attr_pp.__init__"><code class="docutils literal notranslate"><span class="pre">Attr_pp.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/postproc.html#fractalshades.postproc.Attr_normal_pp"><code class="docutils literal notranslate"><span class="pre">Attr_normal_pp</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/postproc.html#fractalshades.postproc.Attr_normal_pp.__init__"><code class="docutils literal notranslate"><span class="pre">Attr_normal_pp.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/postproc.html#fractalshades.postproc.Fractal_array"><code class="docutils literal notranslate"><span class="pre">Fractal_array</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/postproc.html#fractalshades.postproc.Fractal_array.__init__"><code class="docutils literal notranslate"><span class="pre">Fractal_array.__init__()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../API/layers.html">Image layers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Virtual_layer"><code class="docutils literal notranslate"><span class="pre">Virtual_layer</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Virtual_layer.__init__"><code class="docutils literal notranslate"><span class="pre">Virtual_layer.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Virtual_layer.set_mask"><code class="docutils literal notranslate"><span class="pre">Virtual_layer.set_mask()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Bool_layer"><code class="docutils literal notranslate"><span class="pre">Bool_layer</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Bool_layer.__init__"><code class="docutils literal notranslate"><span class="pre">Bool_layer.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Color_layer"><code class="docutils literal notranslate"><span class="pre">Color_layer</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Color_layer.__init__"><code class="docutils literal notranslate"><span class="pre">Color_layer.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Color_layer.overlay"><code class="docutils literal notranslate"><span class="pre">Color_layer.overlay()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Color_layer.set_mask"><code class="docutils literal notranslate"><span class="pre">Color_layer.set_mask()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Color_layer.set_twin_field"><code class="docutils literal notranslate"><span class="pre">Color_layer.set_twin_field()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Color_layer.shade"><code class="docutils literal notranslate"><span class="pre">Color_layer.shade()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Normal_map_layer"><code class="docutils literal notranslate"><span class="pre">Normal_map_layer</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Normal_map_layer.__init__"><code class="docutils literal notranslate"><span class="pre">Normal_map_layer.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Normal_map_layer.set_mask"><code class="docutils literal notranslate"><span class="pre">Normal_map_layer.set_mask()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Grey_layer"><code class="docutils literal notranslate"><span class="pre">Grey_layer</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Grey_layer.__init__"><code class="docutils literal notranslate"><span class="pre">Grey_layer.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Grey_layer.set_mask"><code class="docutils literal notranslate"><span class="pre">Grey_layer.set_mask()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Disp_layer"><code class="docutils literal notranslate"><span class="pre">Disp_layer</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Disp_layer.__init__"><code class="docutils literal notranslate"><span class="pre">Disp_layer.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Disp_layer.set_mask"><code class="docutils literal notranslate"><span class="pre">Disp_layer.set_mask()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Blinn_lighting"><code class="docutils literal notranslate"><span class="pre">Blinn_lighting</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Blinn_lighting.__init__"><code class="docutils literal notranslate"><span class="pre">Blinn_lighting.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Blinn_lighting.add_light_source"><code class="docutils literal notranslate"><span class="pre">Blinn_lighting.add_light_source()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Overlay_mode"><code class="docutils literal notranslate"><span class="pre">Overlay_mode</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/layers.html#fractalshades.colors.layers.Overlay_mode.__init__"><code class="docutils literal notranslate"><span class="pre">Overlay_mode.__init__()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../API/colors.html">Color mapping</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../API/colors.html#fractalshades.colors.Fractal_colormap"><code class="docutils literal notranslate"><span class="pre">Fractal_colormap</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/colors.html#fractalshades.colors.Fractal_colormap.__init__"><code class="docutils literal notranslate"><span class="pre">Fractal_colormap.__init__()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../API/GUI.html">GUI</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../API/GUI.html#fractalshades.gui.guimodel.Fractal_GUI"><code class="docutils literal notranslate"><span class="pre">Fractal_GUI</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/GUI.html#fractalshades.gui.guimodel.Fractal_GUI.__init__"><code class="docutils literal notranslate"><span class="pre">Fractal_GUI.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/GUI.html#fractalshades.gui.guimodel.Fractal_GUI.connect_image"><code class="docutils literal notranslate"><span class="pre">Fractal_GUI.connect_image()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/GUI.html#fractalshades.gui.guimodel.Fractal_GUI.connect_mouse"><code class="docutils literal notranslate"><span class="pre">Fractal_GUI.connect_mouse()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/GUI.html#fractalshades.gui.guimodel.Fractal_GUI.show"><code class="docutils literal notranslate"><span class="pre">Fractal_GUI.show()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/GUI.html#fractalshades.gui.guitemplates.std_zooming"><code class="docutils literal notranslate"><span class="pre">std_zooming</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/GUI.html#fractalshades.gui.guitemplates.std_zooming.__init__"><code class="docutils literal notranslate"><span class="pre">std_zooming.__init__()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../API/logging.html">Logging</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../API/logging.html#fractalshades.log.set_log_handlers"><code class="docutils literal notranslate"><span class="pre">set_log_handlers()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../API/db.html">Databases</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../API/db.html#fractalshades.db.Db"><code class="docutils literal notranslate"><span class="pre">Db</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/db.html#fractalshades.db.Db.__init__"><code class="docutils literal notranslate"><span class="pre">Db.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/db.html#fractalshades.db.Db.plot"><code class="docutils literal notranslate"><span class="pre">Db.plot()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/db.html#fractalshades.db.Db.set_plotter"><code class="docutils literal notranslate"><span class="pre">Db.set_plotter()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/db.html#fractalshades.db.Frame"><code class="docutils literal notranslate"><span class="pre">Frame</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/db.html#fractalshades.db.Frame.__init__"><code class="docutils literal notranslate"><span class="pre">Frame.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/db.html#fractalshades.db.Exp_db"><code class="docutils literal notranslate"><span class="pre">Exp_db</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/db.html#fractalshades.db.Exp_db.__init__"><code class="docutils literal notranslate"><span class="pre">Exp_db.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/db.html#fractalshades.db.Exp_db.plot"><code class="docutils literal notranslate"><span class="pre">Exp_db.plot()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/db.html#fractalshades.db.Exp_frame"><code class="docutils literal notranslate"><span class="pre">Exp_frame</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/db.html#fractalshades.db.Exp_frame.__init__"><code class="docutils literal notranslate"><span class="pre">Exp_frame.__init__()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../API/movie.html">Movie module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../API/movie.html#fractalshades.movie.Movie"><code class="docutils literal notranslate"><span class="pre">Movie</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/movie.html#fractalshades.movie.Movie.__init__"><code class="docutils literal notranslate"><span class="pre">Movie.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/movie.html#fractalshades.movie.Movie.add_sequence"><code class="docutils literal notranslate"><span class="pre">Movie.add_sequence()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/movie.html#fractalshades.movie.Movie.export_frame"><code class="docutils literal notranslate"><span class="pre">Movie.export_frame()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../API/movie.html#fractalshades.movie.Movie.make"><code class="docutils literal notranslate"><span class="pre">Movie.make()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/movie.html#fractalshades.movie.Camera_pan"><code class="docutils literal notranslate"><span class="pre">Camera_pan</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/movie.html#fractalshades.movie.Camera_pan.__init__"><code class="docutils literal notranslate"><span class="pre">Camera_pan.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/movie.html#fractalshades.movie.Camera_zoom"><code class="docutils literal notranslate"><span class="pre">Camera_zoom</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/movie.html#fractalshades.movie.Camera_zoom.__init__"><code class="docutils literal notranslate"><span class="pre">Camera_zoom.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../API/movie.html#fractalshades.movie.Custom_sequence"><code class="docutils literal notranslate"><span class="pre">Custom_sequence</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../API/movie.html#fractalshades.movie.Custom_sequence.__init__"><code class="docutils literal notranslate"><span class="pre">Custom_sequence.__init__()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../making_movies.html">Making movies</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../making_movies.html#example-pan-sequence">Example: pan sequence</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../making_movies.html#example-zoom-sequence">Example: zoom sequence</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../making_movies.html#example-custom-zoom-sequence">Example: “Custom” zoom sequence</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../making_movies.html#example-using-distance-estimation-plots">Example: Using Distance Estimation plots</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#rev-1-1">Rev 1.1</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../changelog.html#rev-1-1-0">Rev 1.1.0</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../changelog.html#rev-1-1-1">Rev 1.1.1</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#rev-1-0">Rev 1.0</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../changelog.html#rev-1-0-3">Rev 1.0.3</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../changelog.html#rev-1-0-2">Rev 1.0.2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../changelog.html#rev-1-0-1">Rev 1.0.1</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../changelog.html#rev-1-0-0">Rev 1.0.0</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#rev-0-5">Rev 0.5</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../changelog.html#rev-0-5-6">Rev 0.5.6</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../changelog.html#rev-0-5-5">Rev 0.5.5</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../changelog.html#rev-0-5-4">Rev 0.5.4</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../changelog.html#rev-0-5-3">Rev 0.5.3</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../changelog.html#rev-0-5-2">Rev 0.5.2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../changelog.html#rev-0-5-0">Rev 0.5.0</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#rev-0-4">Rev 0.4</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../changelog.html#rev-0-4-3">Rev 0.4.3</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../changelog.html#rev-0-4-2">Rev 0.4.2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../changelog.html#rev-0-4-1">Rev 0.4.1</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../acknowledgment.html">Acknowledgment</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Fractalshades</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">fractalshades.gui.guimodel</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">

           <div itemprop="articleBody">
             
  <h1>Source code for fractalshades.gui.guimodel</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="c1"># import textwrap</span>
<span class="c1">#import pprint</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="kn">import</span> <span class="nn">PIL</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="c1">#import copy</span>
<span class="c1">#from operator import getitem, setitem</span>
<span class="kn">import</span> <span class="nn">mpmath</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">ast</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">9</span><span class="p">):</span>
<span class="c1"># See :</span>
<span class="c1"># https://discuss.python.org/t/deprecating-importlib-resources-legacy-api/11386/24</span>
    <span class="kn">import</span> <span class="nn">importlib_resources</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">importlib.resources</span> <span class="k">as</span> <span class="nn">importlib_resources</span> 

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">PyQt6</span> <span class="kn">import</span> <span class="n">QtCore</span>
<span class="kn">from</span> <span class="nn">PyQt6.QtCore</span> <span class="kn">import</span> <span class="n">Qt</span>
<span class="c1">#from PyQt5.QtGui import QIcon</span>
<span class="kn">from</span> <span class="nn">PyQt6.QtCore</span> <span class="kn">import</span> <span class="p">(</span>
     <span class="n">pyqtSignal</span><span class="p">,</span>
     <span class="n">pyqtSlot</span><span class="p">,</span>
     <span class="n">QTimer</span><span class="p">,</span>
     <span class="n">QPropertyAnimation</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">PyQt6</span> <span class="kn">import</span> <span class="n">QtWidgets</span><span class="p">,</span> <span class="n">QtGui</span>
<span class="kn">from</span> <span class="nn">PyQt6.QtGui</span> <span class="kn">import</span> <span class="n">QAction</span>
<span class="kn">from</span> <span class="nn">PyQt6.QtWidgets</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">QApplication</span><span class="p">,</span>
    <span class="n">QMainWindow</span><span class="p">,</span>
    <span class="n">QWidget</span><span class="p">,</span>
    <span class="n">QDialog</span><span class="p">,</span>
    <span class="n">QInputDialog</span><span class="p">,</span>
    <span class="n">QDockWidget</span><span class="p">,</span>
    <span class="n">QPushButton</span><span class="p">,</span>
    <span class="n">QMenu</span><span class="p">,</span>
    <span class="n">QHBoxLayout</span><span class="p">,</span>
    <span class="n">QVBoxLayout</span><span class="p">,</span>
    <span class="n">QCheckBox</span><span class="p">,</span>
    <span class="n">QLabel</span><span class="p">,</span>
    <span class="n">QStatusBar</span><span class="p">,</span>
<span class="c1">#    QMenuBar,</span>
<span class="c1">#    QToolBar,</span>
    <span class="n">QToolButton</span><span class="p">,</span>
    <span class="n">QComboBox</span><span class="p">,</span>
    <span class="n">QLineEdit</span><span class="p">,</span>
    <span class="n">QStackedWidget</span><span class="p">,</span>
    <span class="n">QGroupBox</span><span class="p">,</span>
    <span class="n">QTextEdit</span><span class="p">,</span>
    <span class="n">QMessageBox</span><span class="p">,</span>
    <span class="n">QFileDialog</span><span class="p">,</span>
    <span class="n">QGridLayout</span><span class="p">,</span>
<span class="c1">#    QSpacerItem,</span>
    <span class="n">QSizePolicy</span><span class="p">,</span>
    <span class="n">QGraphicsScene</span><span class="p">,</span>
    <span class="n">QGraphicsView</span><span class="p">,</span>
    <span class="n">QGraphicsPixmapItem</span><span class="p">,</span>
    <span class="n">QGraphicsItemGroup</span><span class="p">,</span>
    <span class="n">QGraphicsRectItem</span><span class="p">,</span>
    <span class="n">QGraphicsLineItem</span><span class="p">,</span>
    <span class="n">QFrame</span><span class="p">,</span>
    <span class="n">QScrollArea</span><span class="p">,</span> 
    <span class="n">QPlainTextEdit</span><span class="p">,</span>
    <span class="n">QColorDialog</span><span class="p">,</span>
    <span class="n">QGraphicsOpacityEffect</span><span class="p">,</span>
    <span class="n">QSpinBox</span><span class="p">,</span>
    <span class="n">QStyledItemDelegate</span><span class="p">,</span>
    <span class="n">QTableWidget</span><span class="p">,</span>
    <span class="n">QTableWidgetItem</span>
<span class="p">)</span>


<span class="kn">import</span> <span class="nn">fractalshades</span> <span class="k">as</span> <span class="nn">fs</span>
<span class="kn">import</span> <span class="nn">fractalshades.colors</span>
<span class="kn">import</span> <span class="nn">fractalshades.settings</span>
<span class="kn">from</span> <span class="nn">fractalshades.gui</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">separator</span><span class="p">,</span>
    <span class="n">collapsible_separator</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">fractalshades.gui.model</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Model</span><span class="p">,</span>
    <span class="n">Func_submodel</span><span class="p">,</span>
    <span class="n">Colormap_presenter</span><span class="p">,</span>
    <span class="n">Lighting_presenter</span><span class="p">,</span>
    <span class="n">Fractal_presenter</span><span class="p">,</span>
    <span class="n">Presenter</span><span class="p">,</span>
    <span class="n">type_name</span><span class="p">,</span>
    <span class="n">typing_litteral_choices</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">fractalshades.gui.QCodeEditor</span> <span class="kn">import</span> <span class="n">Fractal_code_editor</span>
<span class="kn">import</span> <span class="nn">fractalshades.numpy_utils.expr_parser</span> <span class="k">as</span> <span class="nn">fs_parser</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="c1"># Setting allocation limit for QImageReader - to allow displaying larger image</span>
<span class="c1"># in the GUI </span>
<span class="c1"># setAllocationLimit() is  currently not wrapped in pyQt6 implementation</span>
<span class="c1"># as of 2022.08.07 ; see: </span>
<span class="c1"># https://doc.qt.io/qt-6/qimagereader.html#setAllocationLimit</span>
<span class="c1"># https://stackoverflow.com/questions/71458968/pyqt6-how-to-set-allocation-limit-in-qimagereader</span>
<span class="k">def</span> <span class="nf">QImageReader_setAllocationLimit</span><span class="p">(</span><span class="n">mblimit</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="c1"># Note: The memory requirements are calculated for a minimum of 32 bits per</span>
    <span class="c1"># pixel, since Qt will typically convert an image to that depth when it is</span>
    <span class="c1"># used in GUI. This means that the effective allocation limit is</span>
    <span class="c1"># significantly smaller than mbLimit when reading 1 bpp and 8 bpp images.</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;QT_IMAGEIO_MAXALLOC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">mblimit</span><span class="p">)</span>
<span class="n">QImageReader_setAllocationLimit</span><span class="p">(</span><span class="n">fs</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">GUI_image_Mblimit</span><span class="p">)</span>

<span class="c1"># Devlopement note: to know the actual pyQt version used:</span>
<span class="c1"># from PyQt6 import QtCore</span>
<span class="c1"># PyQt6.QtCore.qVersion()</span>

<span class="c1"># QMainWindow</span>
<span class="n">MAIN_WINDOW_CSS</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">QWidget {background-color: #646464;</span>
<span class="s2">        color: white;}</span>
<span class="s2">QMainWindow::separator {</span>
<span class="s2">    background: #7e7e7e;</span>
<span class="s2">    width: 4px; /* when vertical */</span>
<span class="s2">    height: 4px; /* when horizontal */</span>
<span class="s2">}</span>
<span class="s2">QMainWindow::separator:hover {</span>
<span class="s2">    background: #df4848;</span>
<span class="s2">}</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">DOCK_WIDGET_CSS</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">QDockWidget {</span>
<span class="s2">    font-size: 8pt;</span>
<span class="s2">    font: bold;</span>
<span class="s2">    color: #A0A5AA;</span>
<span class="s2">}</span>
<span class="s2">QDockWidget::title {</span>
<span class="s2">    padding-left: 12px;</span>
<span class="s2">    padding-top: 3px;</span>
<span class="s2">    padding-bottom: 3px;</span>
<span class="s2">    text-align: center left;</span>
<span class="s2">    border-left: 1px solid #32363F;</span>
<span class="s2">    border-top: 1px solid #32363F;</span>
<span class="s2">    border-right: 1px solid #32363F;</span>
<span class="s2">    background: #25272C;</span>
<span class="s2">}</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">GROUP_BOX_CSS</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">QGroupBox{{</span>
<span class="s2">    border:1px solid </span><span class="si">{0}</span><span class="s2">;</span>
<span class="s2">    border-radius:5px;margin-top: 1ex;</span>
<span class="s2">}}</span>
<span class="s2">QGroupBox::title{{</span>
<span class="s2">    subcontrol-origin: margin;</span>
<span class="s2">    subcontrol-position:top left;</span>
<span class="s2">    left: 15px;</span>
<span class="s2">}}</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="c1"># QLineEdit</span>
<span class="n">PARAM_LINE_EDIT_CSS</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">QLineEdit {{</span>
<span class="s2">    color: white;</span>
<span class="s2">    background: </span><span class="si">{0}</span><span class="s2">;</span>
<span class="s2">}}</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="c1"># QPlainTextEdit</span>
<span class="n">PLAIN_TEXT_EDIT_CSS</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">QWidget {{</span>
<span class="s2">    color: white;</span>
<span class="s2">    background: </span><span class="si">{0}</span><span class="s2">;</span>
<span class="s2">    border-radius: 2px;</span>
<span class="s2">}}</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">COMBO_BOX_CSS</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">QComboBox {</span>
<span class="s2">    color: white;</span>
<span class="s2">    background: #25272C;</span>
<span class="s2">}</span>
<span class="s2">QComboBox:item {</span>
<span class="s2">    color: white;</span>
<span class="s2">    background: #25272C;</span>
<span class="s2">}</span>
<span class="s2">QComboBox:item:selected {</span>
<span class="s2">    color: #df4848;</span>
<span class="s2">    background: #25272C;</span>
<span class="s2">}</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="c1">## QSpinBox</span>
<span class="n">SPINBOX_CSS</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">QSpinBox{{</span>
<span class="s2">    background-color : </span><span class="si">{0}</span><span class="s2">;</span>
<span class="s2">}}</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="n">CHECK_BOX_CSS</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">QCheckBox::indicator:unchecked {</span>
<span class="s2">    border: 1px solid #25272c;</span>
<span class="s2">}</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="c1"># https://stackoverflow.com/questions/28255641/how-to-style-qtableview-css</span>
<span class="n">TABLE_WIDGET_CSS</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">QTableView {</span>
<span class="s2">    selection-background-color: #25272c;</span>
<span class="s2">}</span>
<span class="s2">QTableView::item </span>
<span class="s2">{   </span>
<span class="s2">    background: #25272c;        </span>
<span class="s2">}</span>
<span class="s2">QTableView::item::selected {</span>
<span class="s2">    border: 2px solid red;</span>
<span class="s2">    border-radius: 2px;</span>
<span class="s2">}</span>
<span class="s2">QHeaderView::section { background-color: #646464 }</span>
<span class="s2">QTableCornerButton::section { background-color: #646464 }</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">STATUS_BAR_CSS</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">QStatusBar {</span>
<span class="s2">background: #7e7e7e;</span>
<span class="s2">}</span>
<span class="s2">QStatusBar::item {</span>
<span class="s2">background: #646464;</span>
<span class="s2">}</span>
<span class="s2">QStatusBar QLabel {</span>
<span class="s2">margin: 2px;</span>
<span class="s2">border: 0;</span>
<span class="s2">background: #646464;</span>
<span class="s2">}</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="k">def</span> <span class="nf">getapp</span><span class="p">():</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">app</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">QApplication</span><span class="p">([])</span>
    <span class="k">return</span> <span class="n">app</span>

<span class="k">def</span> <span class="nf">getmainwindow</span><span class="p">(</span><span class="n">win</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    win : QWidget</span>
<span class="sd">    Return the QMainWindow that is in `win` ancestors list, if found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="n">win</span>
    <span class="k">while</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">inherits</span><span class="p">(</span><span class="s1">&#39;QMainWindow&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">parent</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Count not find QMainWindow instance.&#39;</span><span class="p">,</span> <span class="n">win</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">MinimizedStackedWidget</span><span class="p">(</span><span class="n">QStackedWidget</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">sizeHint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentWidget</span><span class="p">()</span><span class="o">.</span><span class="n">sizeHint</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">minimumSizeHint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentWidget</span><span class="p">()</span><span class="o">.</span><span class="n">sizeHint</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">_Pixmap_figure</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This class is a wrapper that can be used to redirect a Fractal_plotter</span>
<span class="sd">        output, for instance when generating the documentation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">img</span> <span class="o">=</span> <span class="n">img</span>

    <span class="k">def</span> <span class="nf">save_png</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">im_path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">im_path</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;PNG&quot;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Calc_status_bar</span><span class="p">(</span><span class="n">QStatusBar</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func_model</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="n">STATUS_BAR_CSS</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_func_model</span> <span class="o">=</span> <span class="n">func_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="n">QTimer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">timeout</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_time_incr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_status</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">reset_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Reset the properties of the status according to the fractal</span>
<span class="sd">        object &quot;&quot;&quot;</span>
        <span class="n">status</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;elapsed&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;val&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>
                <span class="s2">&quot;str_val&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">()),</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="n">fractal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func_model</span><span class="o">.</span><span class="n">param0</span>
        <span class="n">status</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fractal</span><span class="o">.</span><span class="n">new_status</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">status</span>

    <span class="k">def</span> <span class="nf">layout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_layout</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">str_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_layout</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">str_label</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_layout</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">start_timer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_status</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_layout</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_status</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="c1"># Update timer display every second</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">stop_timer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">on_time_incr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span><span class="p">[</span><span class="s2">&quot;elapsed&quot;</span><span class="p">][</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">1.</span>
        <span class="n">curr_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_status</span><span class="p">[</span><span class="s2">&quot;elapsed&quot;</span><span class="p">][</span><span class="s2">&quot;val&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_status</span><span class="p">(</span><span class="s2">&quot;elapsed&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">curr_time</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">update_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">str_val</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Update the text status and refresh the display</span>
<span class="sd">        if str_val is None, only refresh the display</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">str_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_status</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;str_val&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">str_val</span>
        <span class="n">wget</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_layout</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">wget</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;str_val&quot;</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">Action_func_widget</span><span class="p">(</span><span class="n">QFrame</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Func_widget with parameters &amp; actions group</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">func_started</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="n">func_performed</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="n">lock_navigation</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">error_in_thread</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">(</span><span class="ne">Exception</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">func_smodel</span><span class="p">,</span> <span class="n">refresh_alias</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">callback</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">may_interrupt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">locks_navigation</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_submodel</span> <span class="o">=</span> <span class="n">func_smodel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">may_interrupt</span> <span class="o">=</span> <span class="n">may_interrupt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">locks_navigation</span> <span class="o">=</span> <span class="n">locks_navigation</span>

        <span class="c1"># Parameters and action boxes</span>
        <span class="n">param_box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_param_box</span><span class="p">(</span><span class="n">func_smodel</span><span class="p">)</span>
        <span class="n">action_box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_action_box</span><span class="p">()</span>

        <span class="c1"># general layout</span>
        <span class="n">layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">()</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">param_box</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">action_box</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
            
        <span class="c1"># Connect events</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_script</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">show_script</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">show_func_params</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">may_interrupt</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_interrupt</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raise_interruption</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_func</span><span class="p">)</span>
        
        <span class="c1"># adds a binding to the image modified of other setting</span>
        <span class="k">if</span> <span class="n">refresh_alias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">keys</span><span class="p">)</span> <span class="o">=</span> <span class="n">refresh_alias</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">func_smodel</span><span class="o">.</span><span class="n">_model</span>
            <span class="n">model</span><span class="o">.</span><span class="n">set_alias</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">keys</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">func_performed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
                <span class="n">model</span><span class="o">.</span><span class="n">item_refresh</span><span class="p">,</span> <span class="n">alias</span><span class="p">)</span>
            <span class="p">)</span>
        
        <span class="c1"># adds a binding to the parent slot</span>
        <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">func_performed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
                <span class="n">parent</span><span class="o">.</span><span class="n">func_callback</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="p">)</span>
        
        <span class="c1"># add a binding to the navigation window</span>
        <span class="k">if</span> <span class="n">locks_navigation</span><span class="p">:</span> 
            <span class="n">nav_win</span> <span class="o">=</span> <span class="n">getmainwindow</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">centralWidget</span><span class="p">()</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">lock_navigation</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">nav_win</span><span class="o">.</span><span class="n">lock</span><span class="p">)</span>
        
        <span class="c1"># Adds Exception handling</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_in_thread</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">on_error_in_thread</span><span class="p">)</span>

        <span class="c1"># Starts / stops status bar timer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func_started</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">status_bar</span><span class="o">.</span><span class="n">start_timer</span><span class="p">)</span><span class="c1">#)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func_performed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">status_bar</span><span class="o">.</span><span class="n">stop_timer</span><span class="p">)</span><span class="c1">#)</span>

    <span class="k">def</span> <span class="nf">add_param_box</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func_smodel</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_param_widget</span> <span class="o">=</span> <span class="n">Func_widget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func_smodel</span><span class="p">)</span>
        <span class="n">param_box</span> <span class="o">=</span> <span class="n">QGroupBox</span><span class="p">(</span><span class="s2">&quot;Parameters&quot;</span><span class="p">)</span>
        <span class="n">param_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">()</span>
        <span class="n">param_scrollarea</span> <span class="o">=</span> <span class="n">QScrollArea</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">param_scrollarea</span><span class="o">.</span><span class="n">setWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_param_widget</span><span class="p">)</span>
        <span class="n">param_scrollarea</span><span class="o">.</span><span class="n">setWidgetResizable</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">param_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">param_scrollarea</span><span class="p">)</span>
        <span class="n">param_box</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">param_layout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_border_style</span><span class="p">(</span><span class="n">param_box</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">param_box</span>

    <span class="k">def</span> <span class="nf">add_action_box</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">action_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_script</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Show script&quot;</span><span class="p">)</span>
        <span class="n">action_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_script</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Show params&quot;</span><span class="p">)</span>
        <span class="n">action_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">may_interrupt</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_interrupt</span><span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Interrupt&quot;</span><span class="p">)</span>
            <span class="n">action_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_interrupt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Run&quot;</span><span class="p">)</span>
        <span class="n">action_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_run</span><span class="p">)</span>
        
        <span class="n">action_box</span> <span class="o">=</span> <span class="n">QGroupBox</span><span class="p">(</span><span class="s2">&quot;Actions&quot;</span><span class="p">)</span>
        <span class="n">action_box</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">action_layout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_border_style</span><span class="p">(</span><span class="n">action_box</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">action_box</span>

    <span class="k">def</span> <span class="nf">set_border_style</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gb</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; adds borders to an action box&quot;&quot;&quot;</span>
        <span class="n">gb</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span>
            <span class="s2">&quot;QGroupBox{border:1px solid #646464;&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;border-radius:5px;margin-top: 1ex;}&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;QGroupBox::title{subcontrol-origin: margin;&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;subcontrol-position:top left;&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;left: 15px;}&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">raise_interruption</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_submodel</span><span class="o">.</span><span class="n">param0</span><span class="o">.</span><span class="n">raise_interruption</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">lower_interruption</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_submodel</span><span class="o">.</span><span class="n">param0</span><span class="o">.</span><span class="n">lower_interruption</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">load_calling_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Reload parameters stored from last call &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs_path</span><span class="p">(),</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">param_file</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">param_file</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Reset the interruption setting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lower_interruption</span><span class="p">()</span>
        <span class="c1"># Save the func kwargs</span>
        <span class="n">func_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_submodel</span><span class="o">.</span><span class="n">getkwargs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_submodel</span><span class="o">.</span><span class="n">save_func_dict</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">thread_job</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">func_started</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">locks_navigation</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lock_navigation</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;background-color: red&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_submodel</span><span class="o">.</span><span class="n">_func</span><span class="p">(</span><span class="o">**</span><span class="n">func_kwargs</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># send exception to the mainloop</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error_in_thread</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="c1"># Does some clean-up to not lock everything on Error</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_run</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;background-color: #646464&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">locks_navigation</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lock_navigation</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">func_performed</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>

        <span class="c1"># Now run the function in a dedicated thread</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">thread_job</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">show_func_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_submodel</span>
        <span class="n">ce</span> <span class="o">=</span> <span class="n">Fractal_code_editor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">str_assign</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">guitemplates</span><span class="o">.</span><span class="n">script_assignments</span><span class="p">(</span><span class="n">sm</span><span class="o">.</span><span class="n">getkwargs</span><span class="p">())</span>
        
        
        <span class="n">ce</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="n">str_assign</span><span class="p">)</span>
        <span class="n">ce</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Parameters&quot;</span><span class="p">)</span>
        <span class="n">ce</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">show_script</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">movie</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Display the script in GUI &quot;&quot;&quot;</span>
        <span class="n">sm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_submodel</span>
        <span class="n">script</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">getscript</span><span class="p">(</span><span class="n">movie</span><span class="o">=</span><span class="n">movie</span><span class="p">)</span>
        <span class="n">ce</span> <span class="o">=</span> <span class="n">Fractal_code_editor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">ce</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>
        <span class="n">ce</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Script&quot;</span><span class="p">)</span>
        <span class="n">ce</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">Layout_col_synchronizer</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QObject</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cols</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ensure several Param_Box share the same column width</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cols</span> <span class="o">=</span> <span class="n">cols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_grid_pool</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">add_parambox</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">box</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">Param_Box</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;expecting a Param_Box&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_grid_pool</span> <span class="o">+=</span> <span class="p">[</span><span class="n">box</span><span class="o">.</span><span class="n">gridLayout</span><span class="p">]</span>
        <span class="n">box</span><span class="o">.</span><span class="n">synchro_size_evt</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">synchro_slot</span><span class="p">)</span>

    <span class="nd">@pyqtSlot</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">synchro_slot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; On synchro_slot event, align all col width&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">icol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">synchro_width</span><span class="p">(</span><span class="n">icol</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">synchro_width</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">icol</span><span class="p">):</span>
        <span class="n">col_w_hint</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid_pool</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">irow</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">rowCount</span><span class="p">()):</span>
                 <span class="n">l_item</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">itemAtPosition</span><span class="p">(</span><span class="n">irow</span><span class="p">,</span> <span class="n">icol</span><span class="p">)</span>
                 <span class="k">if</span> <span class="n">l_item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                     <span class="n">col_w_hint</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">col_w_hint</span><span class="p">,</span> <span class="n">l_item</span><span class="o">.</span><span class="n">sizeHint</span><span class="p">()</span><span class="o">.</span><span class="n">width</span><span class="p">())</span>
        <span class="c1"># Now setting the common Width Hint</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid_pool</span><span class="p">:</span>
            <span class="n">b</span><span class="o">.</span><span class="n">setColumnMinimumWidth</span><span class="p">(</span><span class="n">icol</span><span class="p">,</span> <span class="n">col_w_hint</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Param_Box</span><span class="p">(</span><span class="n">QWidget</span><span class="p">):</span>
    
    <span class="n">synchro_size_evt</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A QGridLayout with a nice title block</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="c1"># </span>
        <span class="n">box_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">box_layout</span><span class="o">.</span><span class="n">setSpacing</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">box_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">title</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">make_label</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
            <span class="n">box_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">make_content_area</span><span class="p">()</span>
        <span class="n">box_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content_area</span><span class="p">)</span>
        

    <span class="k">def</span> <span class="nf">make_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Create a label child item &quot;&quot;&quot;</span>
        <span class="c1"># Adds the label at 0 - 0 position</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="n">sep_Font</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QFont</span><span class="p">()</span>
        <span class="n">sep_Font</span><span class="o">.</span><span class="n">setStyle</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QFont</span><span class="o">.</span><span class="n">Style</span><span class="o">.</span><span class="n">StyleItalic</span><span class="p">)</span>
        <span class="n">label</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">sep_Font</span><span class="p">)</span>
        <span class="n">label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span>
            <span class="s2">&quot;border-bottom-width: 1px; &quot;</span>
            <span class="s2">&quot;border-bottom-style: solid; &quot;</span>
            <span class="s2">&quot;border-bottom-color: #b8b8b8; &quot;</span>
            <span class="s2">&quot;border-radius: 0px; &quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">make_content_area</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Create the content area, with its gridLayout &quot;&quot;&quot;</span>
        <span class="n">content_area</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_area</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gridLayout</span> <span class="o">=</span> <span class="n">QGridLayout</span><span class="p">(</span><span class="n">content_area</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">resizeEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">resizeEvent</span><span class="p">(</span><span class="n">evt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">synchro_size_evt</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>




<span class="k">class</span> <span class="nc">Clickable_QLabel</span><span class="p">(</span><span class="n">QLabel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Just a QLabel with clicked evt&quot;&quot;&quot;</span>
    <span class="n">clicked</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">mousePressEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ev</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">Collapsible_Param_Box</span><span class="p">(</span><span class="n">Param_Box</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A QGridLayout with a nice title block ; content is collapsible</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anim</span> <span class="o">=</span> <span class="n">QPropertyAnimation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content_area</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;maximumHeight&quot;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">make_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Create a label child item &quot;&quot;&quot;</span>
        <span class="c1"># Adds the label at 0 - 0 position</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
        <span class="n">box_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
        
        <span class="n">label_txt</span> <span class="o">=</span> <span class="n">Clickable_QLabel</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="n">sep_Font</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QFont</span><span class="p">()</span>
        <span class="n">sep_Font</span><span class="o">.</span><span class="n">setStyle</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QFont</span><span class="o">.</span><span class="n">Style</span><span class="o">.</span><span class="n">StyleItalic</span><span class="p">)</span>
        <span class="n">label_txt</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">sep_Font</span><span class="p">)</span>
        <span class="n">label_txt</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span>
            <span class="s2">&quot;border-bottom-width: 1px; &quot;</span>
            <span class="s2">&quot;border-bottom-style: solid; &quot;</span>
            <span class="s2">&quot;border-bottom-color: #b8b8b8; &quot;</span>
            <span class="s2">&quot;border-radius: 0px; &quot;</span>
        <span class="p">)</span>
        <span class="n">label_txt</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_label_clicked</span><span class="p">)</span> 

        <span class="n">toggle_button</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">toggle_button</span> <span class="o">=</span> <span class="n">QToolButton</span><span class="p">(</span>
            <span class="n">text</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">checkable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">checked</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">toggle_button</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;QToolButton { border: none; }&quot;</span><span class="p">)</span>
        <span class="n">toggle_button</span><span class="o">.</span><span class="n">setToolButtonStyle</span><span class="p">(</span>
            <span class="n">Qt</span><span class="o">.</span><span class="n">ToolButtonStyle</span><span class="o">.</span><span class="n">ToolButtonTextBesideIcon</span>
        <span class="p">)</span>
        <span class="n">toggle_button</span><span class="o">.</span><span class="n">setArrowType</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">ArrowType</span><span class="o">.</span><span class="n">RightArrow</span><span class="p">)</span>
        <span class="n">toggle_button</span><span class="o">.</span><span class="n">toggled</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_toggle</span><span class="p">)</span>
        
        <span class="n">box_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">toggle_button</span><span class="p">)</span>
        <span class="n">box_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">label_txt</span><span class="p">)</span>
        

    <span class="k">def</span> <span class="nf">make_content_area</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Create the content area, with its gridLayout &quot;&quot;&quot;</span>
        <span class="n">content_area</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_area</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gridLayout</span> <span class="o">=</span> <span class="n">QGridLayout</span><span class="p">(</span><span class="n">content_area</span><span class="p">)</span>
        <span class="n">content_area</span><span class="o">.</span><span class="n">setMaximumHeight</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">content_area</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span>
            <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_label_clicked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toggle_button</span><span class="o">.</span><span class="n">toggle</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">on_toggle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">checked</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">toggle_button</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toggle_button</span><span class="o">.</span><span class="n">setArrowType</span><span class="p">(</span>
            <span class="n">Qt</span><span class="o">.</span><span class="n">ArrowType</span><span class="o">.</span><span class="n">DownArrow</span> <span class="k">if</span> <span class="n">checked</span> <span class="k">else</span> <span class="n">Qt</span><span class="o">.</span><span class="n">ArrowType</span><span class="o">.</span><span class="n">RightArrow</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">checked</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># self.content_area.maximumHeight()</span>
            <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gridLayout</span><span class="o">.</span><span class="n">sizeHint</span><span class="p">()</span><span class="o">.</span><span class="n">height</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gridLayout</span><span class="o">.</span><span class="n">sizeHint</span><span class="p">()</span><span class="o">.</span><span class="n">height</span><span class="p">()</span>
            <span class="n">end</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># self.layout()</span>

        <span class="n">anim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anim</span>
        <span class="n">anim</span><span class="o">.</span><span class="n">setDuration</span><span class="p">(</span><span class="mi">250</span><span class="p">)</span>
        <span class="n">anim</span><span class="o">.</span><span class="n">setStartValue</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
        <span class="n">anim</span><span class="o">.</span><span class="n">setEndValue</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">checked</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">no_limit</span><span class="p">():</span>
                <span class="c1"># No limit on height</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">content_area</span><span class="o">.</span><span class="n">setMaximumHeight</span><span class="p">(</span><span class="mi">16777215</span><span class="p">)</span>
                <span class="n">anim</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
            <span class="n">anim</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">no_limit</span><span class="p">)</span>

        <span class="n">anim</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">Func_widget</span><span class="p">(</span><span class="n">QFrame</span><span class="p">):</span>
    <span class="c1"># Signal to inform the model that a parameter has been modified by the </span>
    <span class="c1"># user.</span>
    <span class="n">func_user_modified</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="nb">object</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">func_smodel</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">func_smodel</span><span class="o">.</span><span class="n">_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_func_keys</span> <span class="o">=</span> <span class="n">func_smodel</span><span class="o">.</span><span class="n">_keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_submodel</span> <span class="o">=</span> <span class="n">func_smodel</span><span class="c1"># model[func_keys]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_widgets</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span> <span class="c1"># Will store references to the widgets that can</span>
                               <span class="c1"># be programmatically updated </span>

        <span class="c1"># Components and layout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_layout</span> <span class="o">=</span> <span class="n">QGridLayout</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span>
        <span class="c1"># Publish / subscribe signals with the submodel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func_user_modified</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_submodel</span><span class="o">.</span><span class="n">func_user_modified_slot</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">model_event</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_event_slot</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span>
            <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> 
            <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">layout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_submodel</span><span class="o">.</span><span class="n">_dict</span>

        <span class="n">synchro</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">synchro</span> <span class="o">=</span> <span class="n">Layout_col_synchronizer</span><span class="p">(</span><span class="n">cols</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

        <span class="n">box</span> <span class="o">=</span> <span class="n">Param_Box</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="n">synchro</span><span class="o">.</span><span class="n">add_parambox</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">current_layout</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">gridLayout</span> <span class="c1"># self._layout</span>
        <span class="n">current_layout_row</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">main_layout_row</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">i_param</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">fd</span><span class="p">[</span><span class="s2">&quot;n_params&quot;</span><span class="p">]):</span>
            <span class="n">uni_typed</span> <span class="o">=</span> <span class="p">(</span><span class="n">fd</span><span class="p">[(</span><span class="n">i_param</span><span class="p">,</span> <span class="s2">&quot;n_types&quot;</span><span class="p">)]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">uni_typed</span> <span class="ow">and</span> <span class="p">(</span><span class="n">fd</span><span class="p">[(</span><span class="n">i_param</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">)]</span> <span class="ow">is</span> <span class="n">separator</span><span class="p">):</span>
                <span class="c1"># This is a new &#39;normal, non-collapsible&#39; block</span>
                <span class="n">box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layout_separator</span><span class="p">(</span>
                    <span class="n">i_param</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_layout</span><span class="p">,</span> <span class="n">main_layout_row</span>
                <span class="p">)</span>
                <span class="n">synchro</span><span class="o">.</span><span class="n">add_parambox</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>
                <span class="n">current_layout</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">gridLayout</span>
                <span class="n">current_layout_row</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">main_layout_row</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">elif</span> <span class="p">(</span><span class="n">uni_typed</span>
                  <span class="ow">and</span> <span class="p">(</span><span class="n">fd</span><span class="p">[(</span><span class="n">i_param</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">)]</span> <span class="ow">is</span> <span class="n">collapsible_separator</span><span class="p">)):</span>
                <span class="c1"># This is a new &#39;collapsible&#39; block</span>
                <span class="n">box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layout_collapsible_separator</span><span class="p">(</span>
                    <span class="n">i_param</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_layout</span><span class="p">,</span> <span class="n">main_layout_row</span>
                <span class="p">)</span>
                <span class="n">synchro</span><span class="o">.</span><span class="n">add_parambox</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>
                <span class="n">current_layout</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">gridLayout</span>
                <span class="n">current_layout_row</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">main_layout_row</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># adding a parameter editor to the current block layout,</span>
                <span class="c1"># or directly the main layout box</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">layout_param</span><span class="p">(</span><span class="n">i_param</span><span class="p">,</span> <span class="n">current_layout</span><span class="p">,</span> <span class="n">current_layout_row</span><span class="p">)</span>
                <span class="n">current_layout_row</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">current_layout</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">_layout</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">()</span>
                    <span class="c1"># main_layout_row += 1</span>

        <span class="c1"># adds a spacer at bottom</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_layout</span><span class="o">.</span><span class="n">setRowStretch</span><span class="p">(</span><span class="n">main_layout_row</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># Middle column is allocated  all the strech space</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_layout</span><span class="o">.</span><span class="n">setColumnStretch</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_layout</span><span class="o">.</span><span class="n">setColumnStretch</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_layout</span><span class="o">.</span><span class="n">setColumnStretch</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">layout_separator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i_param</span><span class="p">,</span> <span class="n">layout</span><span class="p">,</span> <span class="n">layout_row</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Adds a separator to the main layout - Returns a handle to the</span>
<span class="sd">        separator area sublayout &quot;&quot;&quot;</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_submodel</span><span class="o">.</span><span class="n">_dict</span>
        <span class="n">sep_name</span> <span class="o">=</span> <span class="n">fd</span><span class="p">[(</span><span class="n">i_param</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">)]</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">Param_Box</span><span class="p">(</span><span class="n">sep_name</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">layout_row</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">setRowStretch</span><span class="p">(</span><span class="n">i_param</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">box</span>


    <span class="k">def</span>  <span class="nf">layout_collapsible_separator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i_param</span><span class="p">,</span> <span class="n">layout</span><span class="p">,</span> <span class="n">layout_row</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Adds a collapsible separator to the main layout</span>
<span class="sd">        Returns a handle to the separator area sublayout &quot;&quot;&quot;</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_submodel</span><span class="o">.</span><span class="n">_dict</span>
        <span class="n">sep_name</span> <span class="o">=</span> <span class="n">fd</span><span class="p">[(</span><span class="n">i_param</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">)]</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">Collapsible_Param_Box</span><span class="p">(</span><span class="n">sep_name</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">layout_row</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">setRowStretch</span><span class="p">(</span><span class="n">i_param</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">box</span>
        

    <span class="k">def</span> <span class="nf">layout_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i_param</span><span class="p">,</span> <span class="n">layout</span><span class="p">,</span> <span class="n">layout_row</span><span class="p">):</span> <span class="c1"># Added : layout</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_submodel</span><span class="o">.</span><span class="n">_dict</span>
        
        <span class="n">name</span> <span class="o">=</span> <span class="n">fd</span><span class="p">[(</span><span class="n">i_param</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">)]</span>
        <span class="n">name_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">myFont</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QFont</span><span class="p">()</span>
        <span class="n">myFont</span><span class="o">.</span><span class="n">setWeight</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QFont</span><span class="o">.</span><span class="n">Weight</span><span class="o">.</span><span class="n">ExtraBold</span><span class="p">)</span>
        <span class="n">name_label</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">myFont</span><span class="p">)</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">name_label</span><span class="p">,</span> <span class="n">layout_row</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Handles Union types</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">QStackedWidget</span><span class="p">()</span>
        <span class="n">qs</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span>
                <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span>
                <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Minimum</span>
        <span class="p">)</span>
        <span class="n">n_uargs</span> <span class="o">=</span> <span class="n">fd</span><span class="p">[(</span><span class="n">i_param</span><span class="p">,</span> <span class="s2">&quot;n_types&quot;</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">n_uargs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">utype</span> <span class="o">=</span> <span class="n">fd</span><span class="p">[(</span><span class="n">i_param</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">)]</span>
            <span class="n">utype_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">type_name</span><span class="p">(</span><span class="n">utype</span><span class="p">))</span>
            <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">utype_label</span><span class="p">,</span> <span class="n">layout_row</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">layout_uarg</span><span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="n">i_param</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">utypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">fd</span><span class="p">[(</span><span class="n">i_param</span><span class="p">,</span> <span class="n">utype</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">)]</span> <span class="k">for</span> <span class="n">utype</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_uargs</span><span class="p">)]</span>
            <span class="n">utypes_combo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_widgets</span><span class="p">[(</span><span class="n">i_param</span><span class="p">,</span> <span class="s2">&quot;type_sel&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">QComboBox</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_widgets</span><span class="p">[(</span><span class="n">i_param</span><span class="p">,</span> <span class="s1">&#39;qs_type_sel&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">utypes_combo</span>
            <span class="n">utypes_combo</span><span class="o">.</span><span class="n">addItems</span><span class="p">(</span><span class="n">type_name</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">utypes</span><span class="p">)</span>
            <span class="n">utypes_combo</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="n">fd</span><span class="p">[(</span><span class="n">i_param</span><span class="p">,</span> <span class="s2">&quot;type_sel&quot;</span><span class="p">)])</span>
            <span class="n">utypes_combo</span><span class="o">.</span><span class="n">activated</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">on_user_mod</span><span class="p">,</span> <span class="p">(</span><span class="n">i_param</span><span class="p">,</span> <span class="s2">&quot;type_sel&quot;</span><span class="p">),</span>
                <span class="n">utypes_combo</span><span class="o">.</span><span class="n">currentIndex</span>
            <span class="p">))</span>
            <span class="c1"># Connect to the QS</span>
            <span class="n">utypes_combo</span><span class="o">.</span><span class="n">currentIndexChanged</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">utypes_combo</span><span class="p">,</span> <span class="n">layout_row</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">utype</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_uargs</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">layout_uarg</span><span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="n">i_param</span><span class="p">,</span> <span class="n">utype</span><span class="p">)</span>

        <span class="c1"># The displayed item of the union is denoted by &quot;type_sel&quot; :</span>
        <span class="c1"># self.layout_uarg(qs, i_param, fd[(i_param, &quot;type_sel&quot;)])</span>
        <span class="n">qs</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="n">fd</span><span class="p">[(</span><span class="n">i_param</span><span class="p">,</span> <span class="s2">&quot;type_sel&quot;</span><span class="p">)])</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="n">layout_row</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">setRowStretch</span><span class="p">(</span><span class="n">layout_row</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>


    
    <span class="k">def</span> <span class="nf">layout_uarg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qs</span><span class="p">,</span> <span class="n">i_param</span><span class="p">,</span> <span class="n">i_union</span><span class="p">):</span>

        <span class="n">fd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_submodel</span><span class="o">.</span><span class="n">_dict</span>
        <span class="c1"># n_uargs = fd[(i_param, &quot;n_types&quot;)]</span>
        <span class="n">utype</span> <span class="o">=</span> <span class="n">fd</span><span class="p">[(</span><span class="n">i_param</span><span class="p">,</span> <span class="n">i_union</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">)]</span>
        <span class="n">uval</span> <span class="o">=</span> <span class="n">fd</span><span class="p">[(</span><span class="n">i_param</span><span class="p">,</span> <span class="n">i_union</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">)]</span>
        <span class="n">atom_wget</span> <span class="o">=</span> <span class="n">atom_wget_factory</span><span class="p">(</span><span class="n">utype</span><span class="p">)(</span><span class="n">utype</span><span class="p">,</span> <span class="n">uval</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_widgets</span><span class="p">[(</span><span class="n">i_param</span><span class="p">,</span> <span class="n">i_union</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">atom_wget</span>

        <span class="n">atom_wget</span><span class="o">.</span><span class="n">user_modified</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">on_user_mod</span><span class="p">,</span> <span class="p">(</span><span class="n">i_param</span><span class="p">,</span> <span class="n">i_union</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">),</span>
                <span class="n">atom_wget</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">qs</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">atom_wget</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">atom_wget</span><span class="p">,</span> <span class="n">Atom_Presenter_mixin</span><span class="p">):</span>
            <span class="n">atom_wget</span><span class="o">.</span><span class="n">request_presenter</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">on_presenter</span><span class="p">,</span> <span class="p">(</span><span class="n">i_param</span><span class="p">,</span> <span class="n">i_union</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">)))</span>


    <span class="k">def</span> <span class="nf">reset_layout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Delete every item in self._layout &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Shall never be called ?&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_layout</span><span class="o">.</span><span class="n">count</span><span class="p">())):</span> 
            <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_layout</span><span class="o">.</span><span class="n">itemAt</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">widget</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">w</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">w</span><span class="o">.</span><span class="n">setParent</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="c1"># Alternative deletion instruction :</span>
                <span class="c1"># w.deleteLater() </span>
<span class="c1"># https://stackoverflow.com/questions/41053306/removing-a-widget-from-its-wxpython-parent</span>

    <span class="k">def</span> <span class="nf">on_user_mod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val_callback</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Notify the model of modification by the user of a widget&quot;&quot;&quot;</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">val_callback</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func_user_modified</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">model_event_slot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Handles modification of widget triggered from model &quot;&quot;&quot;</span>
        <span class="c1"># Does the event impact one of my child widgets ? otherwise, return</span>
        <span class="k">if</span> <span class="n">keys</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func_keys</span><span class="p">:</span>
            <span class="k">return</span> <span class="c1"># This is not for this Func_widget</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">wget</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_widgets</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># Not a widget, probably a parameter default signal</span>
            <span class="k">return</span>

        <span class="c1"># Check first Atom_Mixin</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wget</span><span class="p">,</span> <span class="n">Atom_Edit_mixin</span><span class="p">):</span>
            <span class="n">wget</span><span class="o">.</span><span class="n">on_model_event</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Func_widget.model_event_slot </span><span class="si">{</span><span class="n">wget</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_presenter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">presenter_class</span><span class="p">,</span> <span class="n">wget_class</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Handles creation of a parameter presenter or visibility toggling</span>
<span class="sd">        when clicked</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;presenters&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">presenters</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="n">varname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_submodel</span><span class="o">.</span><span class="n">_dict</span><span class="p">[(</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;name&quot;</span><span class="p">)]</span>
        <span class="n">register_key</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">(</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">presenter_class</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">varname</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">register_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">presenters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># We create the Docwidget and presenter</span>
            <span class="c1"># parameter presenter, the only mapping key should be the class</span>
            <span class="c1"># name </span>
            <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span><span class="n">presenter_class</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span>  <span class="bp">self</span><span class="o">.</span><span class="n">_func_keys</span> <span class="o">+</span> <span class="p">(</span><span class="n">keys</span><span class="p">,)}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
                <span class="n">presenter_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">,</span> <span class="n">mapping</span><span class="p">),</span>
                <span class="n">register_key</span>
            <span class="p">)</span>
            <span class="n">wget</span> <span class="o">=</span> <span class="n">wget_class</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">_register</span><span class="p">[</span><span class="n">register_key</span><span class="p">])</span>
            <span class="n">main_window</span> <span class="o">=</span> <span class="n">getmainwindow</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">dock_widget</span> <span class="o">=</span> <span class="n">QDockWidget</span><span class="p">(</span><span class="n">register_key</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Qt</span><span class="o">.</span><span class="n">WindowType</span><span class="o">.</span><span class="n">Window</span><span class="p">)</span>
            <span class="n">dock_widget</span><span class="o">.</span><span class="n">setWidget</span><span class="p">(</span><span class="n">wget</span><span class="p">)</span>
            <span class="n">dock_widget</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="n">DOCK_WIDGET_CSS</span><span class="p">)</span>
            <span class="n">main_window</span><span class="o">.</span><span class="n">addDockWidget</span><span class="p">(</span>
                <span class="n">Qt</span><span class="o">.</span><span class="n">DockWidgetArea</span><span class="o">.</span><span class="n">RightDockWidgetArea</span><span class="p">,</span>
                <span class="n">dock_widget</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">presenters</span><span class="p">[</span><span class="n">register_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">dock_widget</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Docwidget of presenter exists, we only toggles visibility</span>
            <span class="n">dock_widget</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">presenters</span><span class="p">[</span><span class="n">register_key</span><span class="p">]</span>
            <span class="n">toggle</span> <span class="o">=</span> <span class="ow">not</span><span class="p">(</span><span class="n">dock_widget</span><span class="o">.</span><span class="n">isVisible</span><span class="p">())</span>
            <span class="n">dock_widget</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="n">toggle</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">toggle</span><span class="p">:</span>
                <span class="n">dock_widget</span><span class="o">.</span><span class="n">raise_</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">atom_wget_factory</span><span class="p">(</span><span class="n">atom_type</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">typing</span><span class="o">.</span><span class="n">get_origin</span><span class="p">(</span><span class="n">atom_type</span><span class="p">)</span> <span class="ow">is</span> <span class="n">typing</span><span class="o">.</span><span class="n">Literal</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Atom_QComboBox</span>
    <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">atom_type</span><span class="p">,</span> <span class="n">fs</span><span class="o">.</span><span class="n">Fractal</span><span class="p">):</span> 
        <span class="k">return</span> <span class="n">Atom_fractal_button</span>
    <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">atom_type</span><span class="p">,</span> <span class="n">fs</span><span class="o">.</span><span class="n">numpy_utils</span><span class="o">.</span><span class="n">Numpy_expr</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Atom_QLineEdit</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">wget_dic</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nb">int</span><span class="p">:</span> <span class="n">Atom_QLineEdit</span><span class="p">,</span>
            <span class="nb">float</span><span class="p">:</span> <span class="n">Atom_QLineEdit</span><span class="p">,</span>
            <span class="nb">str</span><span class="p">:</span> <span class="n">Atom_QLineEdit</span><span class="p">,</span>
            <span class="nb">bool</span><span class="p">:</span> <span class="n">Atom_QCheckBox</span><span class="p">,</span> <span class="c1"># Atom_QBoolComboBox</span>
            <span class="n">mpmath</span><span class="o">.</span><span class="n">mpf</span><span class="p">:</span> <span class="n">Atom_QPlainTextEdit</span><span class="p">,</span>
            <span class="n">fs</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Color</span><span class="p">:</span> <span class="n">Atom_Color</span><span class="p">,</span>
            <span class="n">fs</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Fractal_colormap</span><span class="p">:</span> <span class="n">Atom_cmap_button</span><span class="p">,</span>
            <span class="n">fs</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Blinn_lighting</span><span class="p">:</span> <span class="n">Atom_lighting_button</span><span class="p">,</span>
            <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span> <span class="n">Atom_QLineEdit</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">wget_dic</span><span class="p">[</span><span class="n">atom_type</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">Atom_Edit_mixin</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Subclasses should implement&quot;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Atom_Presenter_mixin</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Subclasses should implement&quot;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Atom_QCheckBox</span><span class="p">(</span><span class="n">QCheckBox</span><span class="p">,</span> <span class="n">Atom_Edit_mixin</span><span class="p">):</span>
    <span class="n">user_modified</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom_type</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">=</span> <span class="n">atom_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stateChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_user_event</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="n">CHECK_BOX_CSS</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">on_user_event</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_modified</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">on_model_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>    
        <span class="k">with</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QSignalBlocker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">NoWheel_mixin</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">eventFilter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">widget</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Prevent annoying wheel action for Combobox derived classes &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">evt</span><span class="o">.</span><span class="n">type</span><span class="p">()</span> <span class="o">==</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QEvent</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">Wheel</span><span class="p">:</span>
            <span class="n">evt</span><span class="o">.</span><span class="n">ignore</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">QComboBox</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">eventFilter</span><span class="p">(</span><span class="n">widget</span><span class="p">,</span> <span class="n">evt</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Atom_QBoolComboBox</span><span class="p">(</span><span class="n">QComboBox</span><span class="p">,</span> <span class="n">Atom_Edit_mixin</span><span class="p">,</span> <span class="n">NoWheel_mixin</span><span class="p">):</span>
    <span class="n">user_modified</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom_type</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">installEventFilter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="n">COMBO_BOX_CSS</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">=</span> <span class="n">atom_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_choices</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;True&quot;</span><span class="p">,</span> <span class="s2">&quot;False&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_values</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentTextChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_user_event</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addItems</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_choices</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">currentIndex</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">on_user_event</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_modified</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">on_model_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>    
        <span class="k">with</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QSignalBlocker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">Atom_Color</span><span class="p">(</span><span class="n">QPushButton</span><span class="p">,</span> <span class="n">Atom_Edit_mixin</span><span class="p">):</span>
    <span class="n">user_modified</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom_type</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        val is given in rgb float, or rgba float (in the range [0., 1.])</span>
<span class="sd">        Internally we use QtGui.QColor rgb or rgba i.e. uint8 format</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">=</span> <span class="n">atom_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kind</span> <span class="o">=</span> <span class="p">{</span><span class="mi">3</span><span class="p">:</span> <span class="s2">&quot;rgb&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="s2">&quot;rgba&quot;</span><span class="p">}[</span><span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_qcolor</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_color</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_user_event</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_color</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">color</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; color: QtGui.QColor or fs.colors.Color &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">):</span>
            <span class="n">qcolor</span> <span class="o">=</span> <span class="n">color</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qcolor</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span>
                <span class="o">*</span><span class="nb">list</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">channel</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span> <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">color</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">qcolor</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qcolor</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_qcolor</span> <span class="o">=</span> <span class="n">qcolor</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;background-color: </span><span class="si">{0}</span><span class="s2">;&quot;</span>
                               <span class="s2">&quot;border-color: </span><span class="si">{1}</span><span class="s2">;&quot;</span>
                               <span class="s2">&quot;border-style: solid;&quot;</span>
                               <span class="s2">&quot;border-width: 1px;&quot;</span>
                               <span class="s2">&quot;border-radius: 4px;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">_qcolor</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="s2">&quot;grey&quot;</span><span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kind</span> <span class="o">==</span> <span class="s2">&quot;rgba&quot;</span><span class="p">:</span>
                <span class="c1"># Paint a gradient from the color with transparency to the</span>
                <span class="c1"># color with no transparency (rgba &quot;a&quot; value set to 255)</span>
                <span class="n">gradient</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QLinearGradient</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">gradient</span><span class="o">.</span><span class="n">setCoordinateMode</span><span class="p">(</span>
                    <span class="n">QtGui</span><span class="o">.</span><span class="n">QGradient</span><span class="o">.</span><span class="n">CoordinateMode</span><span class="o">.</span><span class="n">ObjectBoundingMode</span>
                <span class="p">)</span>
                <span class="n">gradient</span><span class="o">.</span><span class="n">setColorAt</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">qcolor</span><span class="o">.</span><span class="n">alpha</span><span class="p">()))</span>
                <span class="n">gradient</span><span class="o">.</span><span class="n">setColorAt</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">qcolor</span><span class="o">.</span><span class="n">alpha</span><span class="p">()))</span>
                <span class="n">gradient</span><span class="o">.</span><span class="n">setColorAt</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">Qt</span><span class="o">.</span><span class="n">GlobalColor</span><span class="o">.</span><span class="n">black</span><span class="p">)</span>
                <span class="n">gradient</span><span class="o">.</span><span class="n">setColorAt</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">Qt</span><span class="o">.</span><span class="n">GlobalColor</span><span class="o">.</span><span class="n">black</span><span class="p">)</span>
                <span class="n">effect</span> <span class="o">=</span> <span class="n">QGraphicsOpacityEffect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="n">effect</span><span class="o">.</span><span class="n">setOpacity</span><span class="p">(</span><span class="mf">1.</span><span class="p">)</span>
                <span class="n">effect</span><span class="o">.</span><span class="n">setOpacityMask</span><span class="p">(</span><span class="n">gradient</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setGraphicsEffect</span><span class="p">(</span><span class="n">effect</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">repaint</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_modified</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qcolor</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kind</span> <span class="o">==</span> <span class="s2">&quot;rgb&quot;</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">redF</span><span class="p">(),</span> <span class="n">c</span><span class="o">.</span><span class="n">greenF</span><span class="p">(),</span> <span class="n">c</span><span class="o">.</span><span class="n">blueF</span><span class="p">())</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kind</span> <span class="o">==</span> <span class="s2">&quot;rgba&quot;</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">redF</span><span class="p">(),</span> <span class="n">c</span><span class="o">.</span><span class="n">greenF</span><span class="p">(),</span> <span class="n">c</span><span class="o">.</span><span class="n">blueF</span><span class="p">(),</span> <span class="n">c</span><span class="o">.</span><span class="n">alphaF</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">on_user_event</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">colord</span> <span class="o">=</span> <span class="n">QColorDialog</span><span class="p">()</span>
        <span class="n">colord</span><span class="o">.</span><span class="n">setOption</span><span class="p">(</span><span class="n">QColorDialog</span><span class="o">.</span><span class="n">ColorDialogOption</span><span class="o">.</span><span class="n">DontUseNativeDialog</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kind</span> <span class="o">==</span> <span class="s2">&quot;rgba&quot;</span><span class="p">:</span>
            <span class="n">colord</span><span class="o">.</span><span class="n">setOption</span><span class="p">(</span><span class="n">QColorDialog</span><span class="o">.</span><span class="n">ColorDialogOption</span><span class="o">.</span><span class="n">ShowAlphaChannel</span><span class="p">)</span>
        <span class="n">colord</span><span class="o">.</span><span class="n">setCurrentColor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_qcolor</span><span class="p">)</span>
        <span class="n">colord</span><span class="o">.</span><span class="n">setCustomColor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qcolor</span><span class="p">)</span>
        <span class="n">colord</span><span class="o">.</span><span class="n">currentColorChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_color</span><span class="p">)</span>
        <span class="n">old_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qcolor</span>
        <span class="k">if</span> <span class="n">colord</span><span class="o">.</span><span class="n">exec</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_color</span><span class="p">(</span><span class="n">colord</span><span class="o">.</span><span class="n">currentColor</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_color</span><span class="p">(</span><span class="n">old_col</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_model_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QSignalBlocker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_color</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Atom_QLineEdit</span><span class="p">(</span><span class="n">QLineEdit</span><span class="p">,</span> <span class="n">Atom_Edit_mixin</span><span class="p">):</span> 
    <span class="n">user_modified</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom_type</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">=</span> <span class="n">atom_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">textChanged</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">editingFinished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_user_event</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setValidator</span><span class="p">(</span><span class="n">Atom_Text_Validator</span><span class="p">(</span><span class="n">atom_type</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="n">PARAM_LINE_EDIT_CSS</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;#25272C&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">atom_type</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setReadOnly</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">(),</span> <span class="n">acceptable_color</span><span class="o">=</span><span class="s2">&quot;#25272C&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_type</span><span class="p">,</span> <span class="n">fs</span><span class="o">.</span><span class="n">numpy_utils</span><span class="o">.</span><span class="n">Numpy_expr</span><span class="p">):</span>
            <span class="c1"># We return a Nump_expr, the variables are those of the default</span>
            <span class="c1"># value, as stored in the validator</span>
            <span class="n">variables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="p">()</span><span class="o">.</span><span class="n">_variables</span>
            <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">on_user_event</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_modified</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">on_model_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span> 
        <span class="k">with</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QSignalBlocker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">(),</span> <span class="n">acceptable_color</span><span class="o">=</span><span class="s2">&quot;#25272C&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">acceptable_color</span><span class="o">=</span><span class="s2">&quot;#c8c8c8&quot;</span><span class="p">):</span>
        <span class="n">validator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">validator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ret</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">validator</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">ret</span> <span class="o">==</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QValidator</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">Acceptable</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="n">PARAM_LINE_EDIT_CSS</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                       <span class="n">acceptable_color</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="n">PARAM_LINE_EDIT_CSS</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                       <span class="s2">&quot;#dc4646&quot;</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">Atom_QPlainTextEdit</span><span class="p">(</span><span class="n">QPlainTextEdit</span><span class="p">,</span> <span class="n">Atom_Edit_mixin</span><span class="p">):</span>
    <span class="n">user_modified</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="c1"># TODO could use this to update mode dps in line with x, y text </span>
    <span class="n">mp_dps_used</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>  

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom_type</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">=</span> <span class="n">atom_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;border: 1px solid  lightgrey&quot;</span><span class="p">)</span>
        <span class="c1"># Wrapping parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setLineWrapMode</span><span class="p">(</span><span class="n">QPlainTextEdit</span><span class="o">.</span><span class="n">LineWrapMode</span><span class="o">.</span><span class="n">WidgetWidth</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">setWordWrapMode</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QTextOption</span><span class="o">.</span><span class="n">WrapMode</span><span class="o">.</span><span class="n">WrapAnywhere</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="n">PLAIN_TEXT_EDIT_CSS</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;#25272C&quot;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_validator</span> <span class="o">=</span> <span class="n">Atom_Text_Validator</span><span class="p">(</span><span class="n">atom_type</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

        <span class="c1"># signals / slots</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">textChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">toPlainText</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">on_model_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QSignalBlocker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">str_val</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">if</span> <span class="n">str_val</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">toPlainText</span><span class="p">():</span>
                <span class="c1"># Signals shall be blocked to avoid an infinite event loop.</span>
                <span class="k">with</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QSignalBlocker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">setPlainText</span><span class="p">(</span><span class="n">str_val</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">from_user</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_user</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Sets background color according to the text validation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">toPlainText</span><span class="p">()</span>
        <span class="n">validator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validator</span>
        <span class="k">if</span> <span class="n">validator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ret</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">validator</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">ret</span> <span class="o">==</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QValidator</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">Acceptable</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="n">PLAIN_TEXT_EDIT_CSS</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                       <span class="s2">&quot;#25272C&quot;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">from_user</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">user_modified</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="n">PLAIN_TEXT_EDIT_CSS</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                       <span class="s2">&quot;#dc4646&quot;</span><span class="p">))</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QTextCursor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="p">())</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">movePosition</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QTextCursor</span><span class="o">.</span><span class="n">MoveOperation</span><span class="o">.</span><span class="n">End</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">paintEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Adjust widget size to its text content</span>
<span class="sd">        ref: https://doc.qt.io/qt-5/qplaintextdocumentlayout.html</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="p">()</span>
        <span class="n">nrows</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">lineCount</span><span class="p">()</span>
        <span class="n">row_height</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QFontMetricsF</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">font</span><span class="p">())</span><span class="o">.</span><span class="n">lineSpacing</span><span class="p">()</span>
        <span class="n">margins</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contentsMargins</span><span class="p">()</span><span class="o">.</span><span class="n">top</span><span class="p">()</span>
                   <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">contentsMargins</span><span class="p">()</span><span class="o">.</span><span class="n">bottom</span><span class="p">()</span>
                   <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">doc</span><span class="o">.</span><span class="n">rootFrame</span><span class="p">()</span><span class="o">.</span><span class="n">frameFormat</span><span class="p">()</span><span class="o">.</span><span class="n">margin</span><span class="p">()</span>
                   <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">doc_height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row_height</span> <span class="o">*</span> <span class="n">nrows</span> <span class="o">+</span> <span class="n">margins</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">()</span> <span class="o">!=</span> <span class="n">doc_height</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">adjust_size</span><span class="p">(</span><span class="n">doc_height</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">paintEvent</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">adjust_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doc_height</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Auto-adjust the text edit to its wrapped content</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setMaximumHeight</span><span class="p">(</span><span class="n">doc_height</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setMinimumHeight</span><span class="p">(</span><span class="n">doc_height</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updateGeometry</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">sizeHint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QSize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">())</span>


<span class="k">class</span> <span class="nc">Atom_QComboBox</span><span class="p">(</span><span class="n">QComboBox</span><span class="p">,</span> <span class="n">Atom_Edit_mixin</span><span class="p">,</span> <span class="n">NoWheel_mixin</span><span class="p">):</span>
    <span class="n">user_modified</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom_type</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="n">COMBO_BOX_CSS</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">installEventFilter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">=</span> <span class="n">atom_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_choices</span> <span class="o">=</span> <span class="n">typing_litteral_choices</span><span class="p">(</span><span class="n">atom_type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentTextChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_user_event</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addItems</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_choices</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentIndex</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">on_user_event</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_modified</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">on_model_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QSignalBlocker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Atom_fractal_button</span><span class="p">(</span><span class="n">QPushButton</span><span class="p">,</span> <span class="n">Atom_Edit_mixin</span><span class="p">,</span> <span class="n">Atom_Presenter_mixin</span><span class="p">):</span>
    <span class="n">user_modified</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="n">request_presenter</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="nb">object</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom_type</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fractal</span> <span class="o">=</span> <span class="n">val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fractal</span>

    <span class="k">def</span> <span class="nf">on_model_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">mouseReleaseEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_presenter</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">Fractal_presenter</span><span class="p">,</span> <span class="n">Fractal_editor</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Qobject_image</span><span class="p">(</span><span class="n">QWidget</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Widget of an object implementing &quot;output_ImageQt&quot; image,</span>
<span class="sd">    fixed height and  expanding width &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">img_object</span><span class="p">,</span> <span class="n">minwidth</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_object</span> <span class="o">=</span> <span class="n">img_object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setMinimumWidth</span><span class="p">(</span><span class="n">minwidth</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setMinimumHeight</span><span class="p">(</span><span class="n">height</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setMaximumHeight</span><span class="p">(</span><span class="n">height</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span>
                <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Minimum</span><span class="p">,</span>
                <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">paintEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
        <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span> <span class="o">=</span> <span class="n">size</span><span class="o">.</span><span class="n">width</span><span class="p">(),</span> <span class="n">size</span><span class="o">.</span><span class="n">height</span><span class="p">()</span>
        <span class="n">QtGui</span><span class="o">.</span><span class="n">QPainter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">drawImage</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_object</span><span class="o">.</span><span class="n">output_ImageQt</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">Atom_cmap_button</span><span class="p">(</span><span class="n">Qobject_image</span><span class="p">,</span> <span class="n">Atom_Edit_mixin</span><span class="p">,</span> <span class="n">Atom_Presenter_mixin</span><span class="p">):</span>
    <span class="n">user_modified</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="n">request_presenter</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="nb">object</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom_type</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_object</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_cmap</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_cmap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmap</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; cmap: fs.color.Fractal_colormap &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_object</span> <span class="o">=</span> <span class="n">cmap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repaint</span><span class="p">()</span>
        <span class="c1"># Note : we do not emit self.user_modified, this shall be done at</span>
        <span class="c1"># Qcmap_editor widget level</span>

    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_object</span>

    <span class="k">def</span> <span class="nf">on_model_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QSignalBlocker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_cmap</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">mouseReleaseEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_presenter</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">Colormap_presenter</span><span class="p">,</span> <span class="n">Qcmap_editor</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Atom_lighting_button</span><span class="p">(</span><span class="n">Qobject_image</span><span class="p">,</span> <span class="n">Atom_Edit_mixin</span><span class="p">,</span> <span class="n">Atom_Presenter_mixin</span><span class="p">):</span>
    <span class="n">user_modified</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="n">request_presenter</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="nb">object</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom_type</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_object</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_lighting</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_lighting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lighting</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; cmap: fs.color.Fractal_colormap &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">lighting</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_object</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_object</span> <span class="o">=</span> <span class="n">lighting</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">repaint</span><span class="p">()</span>
            <span class="c1"># Note : we do not emit self.user_modified, this shall be done at</span>
            <span class="c1"># Qcmap_editor widget level</span>

    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_object</span>

    <span class="k">def</span> <span class="nf">on_model_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QSignalBlocker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_lighting</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">mouseReleaseEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_presenter</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">Lighting_presenter</span><span class="p">,</span> <span class="n">Qlighting_editor</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Atom_Text_Validator</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QValidator</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom_type</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">=</span> <span class="n">atom_type</span>

        <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">atom_type</span><span class="p">,</span> <span class="n">fs</span><span class="o">.</span><span class="n">numpy_utils</span><span class="o">.</span><span class="n">Numpy_expr</span><span class="p">):</span>
            <span class="c1"># The only way to keep track of the variables : keep those of</span>
            <span class="c1"># the provided default (the type will not hold this info)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_variables</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="p">{</span><span class="kc">True</span><span class="p">:</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QValidator</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">Acceptable</span><span class="p">,</span>
                 <span class="kc">False</span><span class="p">:</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QValidator</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">Intermediate</span><span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">valid</span><span class="p">[</span><span class="n">val</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">],</span> <span class="n">val</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_type</span><span class="p">,</span> <span class="n">fs</span><span class="o">.</span><span class="n">numpy_utils</span><span class="o">.</span><span class="n">Numpy_expr</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="n">valid</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_type</span><span class="o">.</span><span class="n">validates_expr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_variables</span><span class="p">,</span> <span class="n">val</span><span class="p">)],</span>
                <span class="n">val</span><span class="p">,</span>
                <span class="n">pos</span>
            <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">casted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">valid</span><span class="p">[</span><span class="kc">False</span><span class="p">],</span> <span class="n">val</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="ow">is</span> <span class="n">mpmath</span><span class="o">.</span><span class="n">ctx_mp_python</span><span class="o">.</span><span class="n">mpf</span><span class="p">:</span>
            <span class="c1"># Starting or trailing carriage return are invalid</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">valid</span><span class="p">[</span><span class="kc">False</span><span class="p">],</span> <span class="n">val</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">valid</span><span class="p">[</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">casted</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type</span><span class="p">)],</span> <span class="n">val</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

<span class="c1">#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="c1"># Delegates implementation for array cells</span>

<span class="k">class</span> <span class="nc">ColorDelegate</span><span class="p">(</span><span class="n">QStyledItemDelegate</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Custom cell delegate to display / edit a colors</span>
<span class="sd">        parent : the QTableWidget</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">createEditor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">dialog</span> <span class="o">=</span> <span class="n">QColorDialog</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="c1">#</span>
        <span class="n">dialog</span><span class="o">.</span><span class="n">setOption</span><span class="p">(</span><span class="n">QColorDialog</span><span class="o">.</span><span class="n">ColorDialogOption</span><span class="o">.</span><span class="n">DontUseNativeDialog</span><span class="p">)</span>
        <span class="n">dialog</span><span class="o">.</span><span class="n">setCurrentColor</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemDataRole</span><span class="o">.</span><span class="n">BackgroundRole</span><span class="p">))</span>
        <span class="n">dialog</span><span class="o">.</span><span class="n">setCustomColor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemDataRole</span><span class="o">.</span><span class="n">BackgroundRole</span><span class="p">))</span>
        <span class="c1"># QT doc: The returned editor widget should have Qt::StrongFocus</span>
        <span class="n">dialog</span><span class="o">.</span><span class="n">setFocusPolicy</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">FocusPolicy</span><span class="o">.</span><span class="n">StrongFocus</span><span class="p">)</span>
        <span class="n">dialog</span><span class="o">.</span><span class="n">setFocusProxy</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dialog</span>

    <span class="k">def</span> <span class="nf">setEditorData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">editor</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemDataRole</span><span class="o">.</span><span class="n">BackgroundRole</span><span class="p">)</span>
        <span class="n">editor</span><span class="o">.</span><span class="n">setCurrentColor</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setModelData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">editor</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; If modal QColorDialog result code is Accepted, save color&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">editor</span><span class="o">.</span><span class="n">result</span><span class="p">():</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">editor</span><span class="o">.</span><span class="n">currentColor</span><span class="p">()</span>
            <span class="n">model</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">Qt</span><span class="o">.</span><span class="n">ItemDataRole</span><span class="o">.</span><span class="n">BackgroundRole</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">paint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">painter</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Fill with BackgroundRole color + red rectangle for selection.&quot;&quot;&quot;</span>
        <span class="c1"># QT doc: After painting, you should ensure that the painter is</span>
        <span class="c1"># returned to the state it was supplied in when this function was</span>
        <span class="c1"># called.</span>
        <span class="n">painter</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">selected</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">option</span><span class="o">.</span><span class="n">state</span> 
                        <span class="o">&amp;</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QStyle</span><span class="o">.</span><span class="n">StateFlag</span><span class="o">.</span><span class="n">State_Selected</span><span class="p">)</span>
        <span class="n">painter</span><span class="o">.</span><span class="n">fillRect</span><span class="p">(</span><span class="n">option</span><span class="o">.</span><span class="n">rect</span><span class="p">,</span> <span class="n">index</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemDataRole</span><span class="o">.</span><span class="n">BackgroundRole</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">selected</span><span class="p">:</span>
            <span class="n">rect</span> <span class="o">=</span> <span class="n">option</span><span class="o">.</span><span class="n">rect</span>
            <span class="n">rect</span><span class="o">.</span><span class="n">adjust</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">pen</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QPen</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">GlobalColor</span><span class="o">.</span><span class="n">red</span><span class="p">)</span>
            <span class="n">pen</span><span class="o">.</span><span class="n">setWidth</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">painter</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">pen</span><span class="p">)</span>
            <span class="n">painter</span><span class="o">.</span><span class="n">drawRect</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>
        <span class="n">painter</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">IntDelegate</span><span class="p">(</span><span class="n">QStyledItemDelegate</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Custom cell delegate to display / edit an int</span>
<span class="sd">        parent : the QTableWidget</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_val</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;min&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_val</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;max&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">createEditor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">editor</span> <span class="o">=</span> <span class="n">QLineEdit</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="n">editor</span><span class="o">.</span><span class="n">setFrame</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">editor</span>

    <span class="k">def</span> <span class="nf">setEditorData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">editor</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        index: PyQt5.QtCore.QModelIndex</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemDataRole</span><span class="o">.</span><span class="n">DisplayRole</span><span class="p">)</span>
        <span class="n">editor</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setModelData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">editor</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; save int val to the model&quot;&quot;&quot;</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">editor</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
        <span class="n">model</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">Qt</span><span class="o">.</span><span class="n">ItemDataRole</span><span class="o">.</span><span class="n">DisplayRole</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="s2">&quot;#646464&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">Qt</span><span class="o">.</span><span class="n">ItemDataRole</span><span class="o">.</span><span class="n">BackgroundRole</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">updateEditorGeometry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">editor</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">editor</span><span class="o">.</span><span class="n">setGeometry</span><span class="p">(</span><span class="n">option</span><span class="o">.</span><span class="n">rect</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemDataRole</span><span class="o">.</span><span class="n">DisplayRole</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_val</span> <span class="ow">and</span> <span class="n">val</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_val</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">FloatDelegate</span><span class="p">(</span><span class="n">QStyledItemDelegate</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Custom cell delegate to display / edit a float</span>
<span class="sd">        parent : the QTableWidget</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
<span class="c1">#        self.min_val = options[&quot;min&quot;]</span>
<span class="c1">#        self.max_val = options[&quot;max&quot;]</span>

    <span class="k">def</span> <span class="nf">createEditor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">editor</span> <span class="o">=</span> <span class="n">QLineEdit</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="n">editor</span><span class="o">.</span><span class="n">setFrame</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">editor</span>

    <span class="k">def</span> <span class="nf">setEditorData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">editor</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        index: PyQt5.QtCore.QModelIndex</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemDataRole</span><span class="o">.</span><span class="n">DisplayRole</span><span class="p">)</span>
        <span class="n">editor</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setModelData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">editor</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; save int val to the model&quot;&quot;&quot;</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">editor</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
        <span class="n">model</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">Qt</span><span class="o">.</span><span class="n">ItemDataRole</span><span class="o">.</span><span class="n">DisplayRole</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="s2">&quot;#646464&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">Qt</span><span class="o">.</span><span class="n">ItemDataRole</span><span class="o">.</span><span class="n">BackgroundRole</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">updateEditorGeometry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">editor</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">editor</span><span class="o">.</span><span class="n">setGeometry</span><span class="p">(</span><span class="n">option</span><span class="o">.</span><span class="n">rect</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemDataRole</span><span class="o">.</span><span class="n">DisplayRole</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span> <span class="c1"># (val &gt;= self.min_val and val &lt;= self.max_val)</span>


<span class="k">class</span> <span class="nc">ComboDelegate</span><span class="p">(</span><span class="n">QStyledItemDelegate</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Custom cell delegate to display / edit a combo box</span>
<span class="sd">        parent : the QTableWidget</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">choices</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;choices&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">createEditor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">editor</span> <span class="o">=</span> <span class="n">QComboBox</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="n">editor</span><span class="o">.</span><span class="n">addItems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">choices</span><span class="p">)</span>
        <span class="n">editor</span><span class="o">.</span><span class="n">setFrame</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">editor</span>

    <span class="k">def</span> <span class="nf">setEditorData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">editor</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemDataRole</span><span class="o">.</span><span class="n">DisplayRole</span><span class="p">)</span>
        <span class="n">editor</span><span class="o">.</span><span class="n">setCurrentText</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setModelData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">editor</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">editor</span><span class="o">.</span><span class="n">currentText</span><span class="p">()</span>
        <span class="n">model</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">Qt</span><span class="o">.</span><span class="n">ItemDataRole</span><span class="o">.</span><span class="n">DisplayRole</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">updateEditorGeometry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">editor</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">editor</span><span class="o">.</span><span class="n">setGeometry</span><span class="p">(</span><span class="n">option</span><span class="o">.</span><span class="n">rect</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemDataRole</span><span class="o">.</span><span class="n">DisplayRole</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">choices</span>


<span class="k">class</span> <span class="nc">ExprDelegate</span><span class="p">(</span><span class="n">QStyledItemDelegate</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Custom cell delegate to display / edit an expr</span>
<span class="sd">        parent : the QTableWidget</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modifier</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;modifier&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">createEditor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">editor</span> <span class="o">=</span> <span class="n">QLineEdit</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="n">editor</span><span class="o">.</span><span class="n">setFrame</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">editor</span>

    <span class="k">def</span> <span class="nf">setEditorData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">editor</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemDataRole</span><span class="o">.</span><span class="n">DisplayRole</span><span class="p">)</span>
        <span class="n">editor</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setModelData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">editor</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">editor</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
        <span class="n">model</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">Qt</span><span class="o">.</span><span class="n">ItemDataRole</span><span class="o">.</span><span class="n">DisplayRole</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="s2">&quot;#646464&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">Qt</span><span class="o">.</span><span class="n">ItemDataRole</span><span class="o">.</span><span class="n">BackgroundRole</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">updateEditorGeometry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">editor</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">editor</span><span class="o">.</span><span class="n">setGeometry</span><span class="p">(</span><span class="n">option</span><span class="o">.</span><span class="n">rect</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemDataRole</span><span class="o">.</span><span class="n">DisplayRole</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="s2">&quot;x&quot;</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modifier</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fs_parser</span><span class="o">.</span><span class="n">acceptable_expr</span><span class="p">(</span>
                <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;eval&quot;</span><span class="p">),</span> <span class="n">safe_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">SyntaxError</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

<span class="c1">#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="c1"># Array Editors</span>
<span class="c1">#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="k">class</span> <span class="nc">Table_QSpinBox</span><span class="p">(</span><span class="n">QSpinBox</span><span class="p">,</span> <span class="n">Atom_Edit_mixin</span><span class="p">):</span>

    <span class="n">user_modified</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom_type</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; SpinBox wich request a user explicit validation is when text is</span>
<span class="sd">        modified (event editingFinished) before sending the new val.</span>
<span class="sd">        Dedicated to the nrow chooser&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">atom_type</span> <span class="o">==</span> <span class="nb">int</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">=</span> <span class="nb">int</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">editingFinished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_edit_finished</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="n">SPINBOX_CSS</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;#25272C&quot;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">keyPressEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="n">SPINBOX_CSS</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;#c8c8c8&quot;</span><span class="p">))</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">keyPressEvent</span><span class="p">(</span><span class="n">evt</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">stepBy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">int_steps</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">stepBy</span><span class="p">(</span><span class="n">int_steps</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_modified</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">on_edit_finished</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="n">SPINBOX_CSS</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;#25272C&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_modified</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">on_model_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">Base_array_editor</span><span class="p">(</span><span class="n">QWidget</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base widget for editors which feature a data table and a parameter panel</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data_user_modified</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="nb">object</span><span class="p">)</span>
    
    <span class="n">std_flags</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">Qt</span><span class="o">.</span><span class="n">ItemFlag</span><span class="o">.</span><span class="n">ItemIsSelectable</span>
            <span class="o">|</span> <span class="n">Qt</span><span class="o">.</span><span class="n">ItemFlag</span><span class="o">.</span><span class="n">ItemIsEnabled</span>
            <span class="o">|</span> <span class="n">Qt</span><span class="o">.</span><span class="n">ItemFlag</span><span class="o">.</span><span class="n">ItemIsEditable</span>
    <span class="p">)</span>
    <span class="n">unvalidated_flags</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">Qt</span><span class="o">.</span><span class="n">ItemFlag</span><span class="o">.</span><span class="n">ItemIsEnabled</span> <span class="o">|</span> <span class="n">Qt</span><span class="o">.</span><span class="n">ItemFlag</span><span class="o">.</span><span class="n">ItemIsEditable</span>
    <span class="p">)</span>
    <span class="n">locked_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemFlag</span><span class="o">.</span><span class="n">ItemIsEnabled</span><span class="p">)</span>

    <span class="n">min_row</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">max_row</span> <span class="o">=</span> <span class="mi">256</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">data_presenter</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>    
        <span class="c1"># General data from presenter</span>
        <span class="c1"># Load titles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_title</span> <span class="o">=</span> <span class="n">data_presenter</span><span class="o">.</span><span class="n">param_title</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_title</span> <span class="o">=</span> <span class="n">data_presenter</span><span class="o">.</span><span class="n">table_title</span>

        <span class="c1"># Load columns data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col_arr_items</span> <span class="o">=</span> <span class="n">data_presenter</span><span class="o">.</span><span class="n">col_arr_items</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col_arr_dtypes</span> <span class="o">=</span> <span class="n">data_presenter</span><span class="o">.</span><span class="n">col_arr_dtypes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_delegates</span><span class="p">(</span><span class="n">data_presenter</span><span class="o">.</span><span class="n">special_hooks</span><span class="p">)</span>

        <span class="c1"># Load extra parameters list</span>
        <span class="c1"># Detailed implementation is delegated to child classes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_parameters</span> <span class="o">=</span> <span class="n">data_presenter</span><span class="o">.</span><span class="n">extra_parameters</span>

        <span class="c1"># Model pointers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">data_presenter</span><span class="o">.</span><span class="n">_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span> <span class="o">=</span> <span class="n">data_presenter</span><span class="o">.</span><span class="n">_mapping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_presenter</span> <span class="o">=</span> <span class="n">data_presenter</span>

        <span class="c1"># Bypass machinery for efficient table update</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_update_lock</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="n">layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">()</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">add_param_box</span><span class="p">())</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">add_table_box</span><span class="p">(),</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_wget_n</span><span class="o">.</span><span class="n">user_modified</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_ncol_mod</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wget_n</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">itemChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event_filter</span><span class="p">,</span> <span class="s2">&quot;table&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data_user_modified</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="n">data_presenter</span><span class="o">.</span><span class="n">data_user_modified_slot</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">model_event</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_event_slot</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data_update_lock</span> <span class="o">=</span> <span class="kc">False</span>
        
    <span class="k">def</span> <span class="nf">on_ncol_mod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val_callback</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Notify of modification by the user of col number &quot;&quot;&quot;</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">val_callback</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_filter</span><span class="p">(</span><span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">build_delegates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">special_hooks</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Builds the GUI implementation for each column based on data type</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">delegates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">delegates_options</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">roles</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">val_funcs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">row_ranges_func</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        
        <span class="n">bgr</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">ItemDataRole</span><span class="o">.</span><span class="n">BackgroundRole</span>
        <span class="n">dpr</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">ItemDataRole</span><span class="o">.</span><span class="n">DisplayRole</span>

        <span class="k">for</span> <span class="n">icol</span><span class="p">,</span> <span class="n">item_type</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">col_arr_dtypes</span><span class="p">):</span>
            <span class="n">is_class</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">item_type</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">item_type</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
                <span class="n">delegates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">IntDelegate</span><span class="p">)</span>
                <span class="n">delegates_options</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span><span class="mi">256</span><span class="p">})</span>
                <span class="n">roles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dpr</span><span class="p">)</span>
                <span class="n">val_funcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                <span class="n">row_ranges_func</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">l</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">item_type</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">:</span>
                <span class="n">delegates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">FloatDelegate</span><span class="p">)</span>
                <span class="n">delegates_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">roles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dpr</span><span class="p">)</span>
                <span class="n">val_funcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                <span class="n">row_ranges_func</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">l</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">is_class</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">item_type</span><span class="p">,</span> <span class="n">fs</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Color</span><span class="p">):</span>
                <span class="n">delegates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ColorDelegate</span><span class="p">)</span>
                <span class="n">delegates_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">roles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bgr</span><span class="p">)</span>
                <span class="n">val_funcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="o">*</span><span class="nb">list</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">255</span> <span class="o">*</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">v</span><span class="p">))</span>
                <span class="p">)</span>
                <span class="n">row_ranges_func</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">l</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">is_class</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">item_type</span><span class="p">,</span> <span class="n">fs</span><span class="o">.</span><span class="n">numpy_utils</span><span class="o">.</span><span class="n">Numpy_expr</span><span class="p">):</span>
                <span class="n">delegates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ExprDelegate</span><span class="p">)</span>
                <span class="n">delegates_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span><span class="s2">&quot;modifier&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">expr</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;lambda x: &quot;</span> <span class="o">+</span> <span class="n">expr</span><span class="p">)}</span>
                <span class="p">)</span>
                <span class="n">roles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dpr</span><span class="p">)</span>
                <span class="n">val_funcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span><span class="p">)</span>
                <span class="n">row_ranges_func</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">l</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">typing</span><span class="o">.</span><span class="n">get_origin</span><span class="p">(</span><span class="n">item_type</span><span class="p">)</span> <span class="ow">is</span> <span class="n">typing</span><span class="o">.</span><span class="n">Literal</span><span class="p">:</span>
                <span class="c1"># it is an enumeration...</span>
                <span class="n">delegates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ComboDelegate</span><span class="p">)</span>
                <span class="n">delegates_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="n">typing_litteral_choices</span><span class="p">(</span><span class="n">item_type</span><span class="p">)}</span>
                <span class="p">)</span>
                <span class="n">roles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dpr</span><span class="p">)</span>
                <span class="n">val_funcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span><span class="p">)</span>
                <span class="n">row_ranges_func</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">l</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">item_type</span><span class="p">)</span>

        <span class="c1"># Now we apply the special hooks from the presenter, if any</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">icol</span><span class="p">,</span> <span class="n">item</span><span class="p">),</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">special_hooks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="s2">&quot;row_ranges_func&quot;</span><span class="p">:</span>
                <span class="n">row_ranges_func</span><span class="p">[</span><span class="n">icol</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">elif</span> <span class="n">item</span> <span class="o">==</span> <span class="s2">&quot;delegates_options&quot;</span><span class="p">:</span>
                <span class="n">delegates_options</span><span class="p">[</span><span class="n">icol</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">col_delegates</span> <span class="o">=</span> <span class="n">delegates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col_delegates_options</span> <span class="o">=</span> <span class="n">delegates_options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col_roles</span> <span class="o">=</span> <span class="n">roles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col_val_funcs</span> <span class="o">=</span> <span class="n">val_funcs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">row_ranges_func</span> <span class="o">=</span> <span class="n">row_ranges_func</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_cols</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">col_arr_items</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_presenter</span><span class="o">.</span><span class="n">n_rows</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">presenter_classname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># e.g., &quot;Colormap_presenter&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_presenter</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> 

    <span class="k">def</span> <span class="nf">add_param_box</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Note: derived classes should implement the detailed layout</span>
        <span class="n">param_box</span> <span class="o">=</span> <span class="n">QGroupBox</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param_title</span><span class="p">)</span>
        <span class="c1"># Widget for the number of lines</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wget_n</span> <span class="o">=</span> <span class="n">Table_QSpinBox</span><span class="p">(</span>
            <span class="n">atom_type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_presenter</span><span class="o">.</span><span class="n">n_rows</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span>
        <span class="p">)</span> <span class="c1"># </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wget_n</span><span class="o">.</span><span class="n">setRange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_row</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">param_box</span>

    <span class="k">def</span> <span class="nf">populate_param_box</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wget_n</span><span class="o">.</span><span class="n">setRange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_row</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wget_n</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_presenter</span><span class="o">.</span><span class="n">n_rows</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_table_box</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">table_box</span> <span class="o">=</span> <span class="n">QGroupBox</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table_title</span><span class="p">)</span>
        <span class="n">table_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_table</span> <span class="o">=</span> <span class="n">QTableWidget</span><span class="p">()</span>
        
        <span class="c1"># COLUMNS : colors, kinds, n, funcs=None</span>
        <span class="n">n_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_cols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">setColumnCount</span><span class="p">(</span><span class="n">n_cols</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">populate_table</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="n">TABLE_WIDGET_CSS</span><span class="p">)</span>


        <span class="c1"># Set up the delegates</span>
        <span class="k">for</span> <span class="n">icol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cols</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">setItemDelegateForColumn</span><span class="p">(</span>
                <span class="n">icol</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">col_delegates</span><span class="p">[</span><span class="n">icol</span><span class="p">](</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_delegates_options</span><span class="p">[</span><span class="n">icol</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">setHorizontalHeaderLabels</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">col_arr_items</span><span class="p">))</span>

        <span class="n">h_header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">horizontalHeader</span><span class="p">()</span>
        <span class="n">h_header</span><span class="o">.</span><span class="n">setSectionResizeMode</span><span class="p">(</span>
            <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QHeaderView</span><span class="o">.</span><span class="n">ResizeMode</span><span class="o">.</span><span class="n">ResizeToContents</span>
        <span class="p">)</span>
        <span class="n">h_header</span><span class="o">.</span><span class="n">setStretchLastSection</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">h_header</span><span class="o">.</span><span class="n">setDefaultAlignment</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignmentFlag</span><span class="o">.</span><span class="n">AlignLeft</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">verticalHeader</span><span class="p">()</span><span class="o">.</span><span class="n">setSectionResizeMode</span><span class="p">(</span>
            <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QHeaderView</span><span class="o">.</span><span class="n">ResizeMode</span><span class="o">.</span><span class="n">ResizeToContents</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">setSelectionMode</span><span class="p">(</span>
            <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QAbstractItemView</span><span class="o">.</span><span class="n">SelectionMode</span><span class="o">.</span><span class="n">SingleSelection</span>
        <span class="p">)</span>

        <span class="n">table_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>
        <span class="n">table_box</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">table_layout</span><span class="p">)</span>
        <span class="n">table_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>




        <span class="k">return</span> <span class="n">table_box</span>

    <span class="k">def</span> <span class="nf">populate_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Signals shall be temporarly blocked to avoid infinite event loop.</span>
        <span class="k">with</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QSignalBlocker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">):</span>
            <span class="n">n_rows</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">_presenter</span><span class="o">.</span><span class="n">n_rows</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">setRowCount</span><span class="p">(</span><span class="n">n_rows</span><span class="p">)</span>

            <span class="n">n_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_cols</span>
            <span class="k">for</span> <span class="n">icol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cols</span><span class="p">):</span>
                <span class="n">col_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_arr_items</span><span class="p">[</span><span class="n">icol</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">populate_column</span><span class="p">(</span>
                    <span class="n">col</span><span class="o">=</span><span class="n">icol</span><span class="p">,</span>
                    <span class="n">row_range</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">row_ranges_func</span><span class="p">[</span><span class="n">icol</span><span class="p">](</span><span class="n">n_rows</span><span class="p">)),</span>
                    <span class="n">role</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">col_roles</span><span class="p">[</span><span class="n">icol</span><span class="p">],</span>
                    <span class="n">tab</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_presenter</span><span class="o">.</span><span class="n">col_data</span><span class="p">(</span><span class="n">col_item</span><span class="p">),</span>
                    <span class="n">old_tab</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_presenter</span><span class="o">.</span><span class="n">old_col_data</span><span class="p">(</span><span class="n">col_item</span><span class="p">),</span>
                    <span class="n">val_func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">col_val_funcs</span><span class="p">[</span><span class="n">icol</span><span class="p">],</span>
                    <span class="n">flags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">std_flags</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="nf">populate_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">row_range</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="n">tab</span><span class="p">,</span> <span class="n">old_tab</span><span class="p">,</span>
                        <span class="n">val_func</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">irow</span> <span class="ow">in</span> <span class="n">row_range</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">tab</span><span class="p">[</span><span class="n">irow</span><span class="p">]</span>
            <span class="c1"># to speed up we have to explicitely track the modifications</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_old_val</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">irow</span><span class="p">,</span> <span class="n">old_tab</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">val</span> <span class="o">=</span> <span class="n">val_func</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">irow</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">QTableWidgetItem</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">setItem</span><span class="p">(</span><span class="n">irow</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">flags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">item</span><span class="o">.</span><span class="n">setFlags</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span>
            <span class="n">item</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">role</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">match_old_val</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">irow</span><span class="p">,</span> <span class="n">old_tab</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return True if the value has not been modifed &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_update_lock</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">irow</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">old_tab</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c1"># always update the last row</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">old_val</span> <span class="o">=</span> <span class="n">old_tab</span><span class="p">[</span><span class="n">irow</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="c1"># Update if we have a new row</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
            <span class="c1"># special case of RGB cells</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">old_val</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">val</span> <span class="o">==</span> <span class="n">old_val</span>


    <span class="k">def</span> <span class="nf">event_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="c1"># event handling on _table.itemChanged.connect</span>
        <span class="k">if</span> <span class="n">source</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">,]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_parameters</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_user_modified</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">source</span> <span class="o">==</span> <span class="s2">&quot;table&quot;</span><span class="p">:</span>
            <span class="c1"># val : PyQt5.QtWidgets.QTableWidgetItem. We need to process it for</span>
            <span class="c1"># the Presenter</span>
            <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">row</span><span class="p">(),</span> <span class="n">val</span><span class="o">.</span><span class="n">column</span><span class="p">()</span>
            <span class="n">role</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_roles</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
            <span class="n">item_data</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">role</span><span class="p">)</span>
            <span class="n">item_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_arr_dtypes</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
            <span class="n">is_class</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">item_type</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">is_class</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">item_type</span><span class="p">,</span> <span class="n">fs</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Color</span><span class="p">):</span>
                <span class="c1"># No validation needed, as values are selected programmatically</span>
                <span class="n">validated</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># QColor to arrray concersion</span>
                <span class="n">item_data</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">item_data</span><span class="o">.</span><span class="n">redF</span><span class="p">(),</span> <span class="n">item_data</span><span class="o">.</span><span class="n">greenF</span><span class="p">(),</span> <span class="n">item_data</span><span class="o">.</span><span class="n">blueF</span><span class="p">()</span>
                <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Need delegate validation</span>
                <span class="n">delegate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">itemDelegateForColumn</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">model</span><span class="p">()</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span> 
                <span class="n">validated</span> <span class="o">=</span> <span class="n">delegate</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">item_type</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">item_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="n">item_data</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">item_data</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">validated</span><span class="p">:</span>
                <span class="c1"># make sure that the normal flags are activated (selection</span>
                <span class="c1"># allowed)</span>
                <span class="k">with</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QSignalBlocker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">):</span>
                    <span class="n">val</span><span class="o">.</span><span class="n">setFlags</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">std_flags</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">data_user_modified</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">item_data</span><span class="p">))</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Invalid value, the event is not emited</span>
                <span class="c1"># Prevent the cell from being selected, to display the &quot;red&quot; bg</span>
                <span class="c1"># color (through flags)</span>
                <span class="k">with</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QSignalBlocker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">):</span>
                    <span class="n">val</span><span class="o">.</span><span class="n">setFlags</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unvalidated_flags</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">model_event_slot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">keys</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_presenter</span><span class="o">.</span><span class="n">_mapping</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">presenter_classname</span><span class="p">]:</span>
            <span class="c1"># Sets the value of the sub-widgets according to the smodel</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">populate_param_box</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QSignalBlocker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">):</span>
                <span class="n">reset</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_changes</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">reset</span><span class="p">:</span> <span class="c1"># Massive change, faster to start from new</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">setRowCount</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data_update_lock</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">populate_table</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_presenter</span><span class="o">.</span><span class="n">reset_old_data</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">reset</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data_update_lock</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">count_changes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Number of items that have changed&quot;&quot;&quot;</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">n_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_cols</span>

        <span class="k">for</span> <span class="n">icol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cols</span><span class="p">):</span>
            <span class="n">col_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_arr_items</span><span class="p">[</span><span class="n">icol</span><span class="p">]</span>
            <span class="n">tab</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_presenter</span><span class="o">.</span><span class="n">col_data</span><span class="p">(</span><span class="n">col_item</span><span class="p">)</span>
            <span class="n">old_tab</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_presenter</span><span class="o">.</span><span class="n">old_col_data</span><span class="p">(</span><span class="n">col_item</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">irow</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tab</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_tab</span><span class="p">))):</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">tab</span><span class="p">[</span><span class="n">irow</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">match_old_val</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">irow</span><span class="p">,</span> <span class="n">old_tab</span><span class="p">)):</span>
                    <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">counter</span>

<span class="c1">#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="c1"># Base_array_editor implementations</span>

<span class="k">class</span> <span class="nc">Qcmap_editor</span><span class="p">(</span><span class="n">Base_array_editor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Widget of a cmap editor : parameters &amp; data table</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data_user_modified</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="nb">object</span><span class="p">)</span>
    <span class="n">min_row</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">cmap_presenter</span><span class="p">):</span>
        <span class="c1"># Additional data from the presenter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extent_choices</span> <span class="o">=</span> <span class="n">cmap_presenter</span><span class="o">.</span><span class="n">extent_choices</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">cmap_presenter</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wget_extent</span><span class="o">.</span><span class="n">currentTextChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event_filter</span><span class="p">,</span> <span class="s2">&quot;extent&quot;</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_cmap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_presenter</span><span class="o">.</span><span class="n">data</span>

    <span class="k">def</span> <span class="nf">add_param_box</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Customize base class layout &quot;&quot;&quot;</span>
        <span class="n">param_box</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_param_box</span><span class="p">()</span> <span class="c1">#param_box_base_items()</span>
        <span class="n">param_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>
        <span class="n">param_box</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">param_layout</span><span class="p">)</span>

        <span class="c1"># Other add-hoc items :</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wget_extent</span> <span class="o">=</span> <span class="n">QComboBox</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wget_extent</span><span class="o">.</span><span class="n">addItems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extent_choices</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_preview</span> <span class="o">=</span> <span class="n">Qobject_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmap</span><span class="p">)</span>

        <span class="n">param_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wget_n</span><span class="p">)</span>
        <span class="n">param_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wget_extent</span><span class="p">)</span>
        <span class="n">param_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_preview</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">populate_param_box</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">param_box</span>

    <span class="k">def</span> <span class="nf">populate_param_box</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">populate_param_box</span><span class="p">()</span>
        <span class="n">val_extent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extent_choices</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cmap</span><span class="o">.</span><span class="n">extent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wget_extent</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="n">val_extent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_preview</span><span class="o">.</span><span class="n">_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_preview</span><span class="o">.</span><span class="n">repaint</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">populate_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Customizing the table with a frozen last row... &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">populate_table</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QSignalBlocker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">freeze_row</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_rows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">freeze_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col_range</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">icol</span> <span class="ow">in</span> <span class="n">col_range</span><span class="p">:</span>
            <span class="c1"># https://forum.qt.io/topic/3489/solved-how-enable-editing-to-qtablewidgetitem/2</span>
            <span class="n">freezed_item</span> <span class="o">=</span> <span class="n">QTableWidgetItem</span><span class="p">()</span>
            <span class="n">freezed_item</span><span class="o">.</span><span class="n">setFlags</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">locked_flags</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">setItem</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">icol</span><span class="p">,</span> <span class="n">freezed_item</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Qlighting_editor</span><span class="p">(</span><span class="n">Base_array_editor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Widget of a cmap editor : parameters &amp; data table</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data_user_modified</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="nb">object</span><span class="p">)</span>
    <span class="n">min_row</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">lighting_presenter</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">lighting_presenter</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">wg</span><span class="p">,</span> <span class="n">source</span> <span class="ow">in</span> <span class="p">{</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_wget_k_ambient</span><span class="p">:</span> <span class="s2">&quot;k_ambient&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_wget_color_ambient</span><span class="p">:</span><span class="s2">&quot;color_ambient&quot;</span>
        <span class="p">}</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">wg</span><span class="o">.</span><span class="n">user_modified</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_user_mod</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">wg</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_lighting</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_presenter</span><span class="o">.</span><span class="n">data</span>

    <span class="k">def</span> <span class="nf">add_param_box</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Customize base class layout &quot;&quot;&quot;</span>
        <span class="n">param_box</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_param_box</span><span class="p">()</span> <span class="c1">#param_box_base_items()</span>
        
        <span class="n">param_layout</span> <span class="o">=</span> <span class="n">QGridLayout</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">param_box</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">param_layout</span><span class="p">)</span>

        <span class="n">myFont</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QFont</span><span class="p">()</span>
        <span class="n">myFont</span><span class="o">.</span><span class="n">setWeight</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QFont</span><span class="o">.</span><span class="n">Weight</span><span class="o">.</span><span class="n">ExtraBold</span><span class="p">)</span>

        <span class="n">k_ambient_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Ambiant strength:&quot;</span><span class="p">)</span>
        <span class="n">color_ambient_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Ambiant color:&quot;</span><span class="p">)</span>
        <span class="n">n_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Lights count:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">lbl</span> <span class="ow">in</span> <span class="p">(</span><span class="n">k_ambient_label</span><span class="p">,</span> <span class="n">color_ambient_label</span><span class="p">,</span> <span class="n">n_label</span><span class="p">):</span>
            <span class="n">lbl</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">myFont</span><span class="p">)</span>

        <span class="c1"># Other add-hoc items :</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_preview</span> <span class="o">=</span> <span class="n">Qobject_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lighting</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wget_k_ambient</span> <span class="o">=</span> <span class="n">Atom_QLineEdit</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_presenter</span><span class="o">.</span><span class="n">ambiant_intensity_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lighting</span><span class="o">.</span><span class="n">k_ambient</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="kc">None</span> <span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wget_color_ambient</span> <span class="o">=</span> <span class="n">Atom_Color</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_presenter</span><span class="o">.</span><span class="n">ambiant_color_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lighting</span><span class="o">.</span><span class="n">color_ambient</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="kc">None</span> <span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span>
        <span class="p">)</span>
        <span class="c1"># labels</span>
        <span class="n">param_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">k_ambient_label</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">param_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">color_ambient_label</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">param_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">n_label</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># wgets</span>
        <span class="n">param_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_preview</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">param_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wget_k_ambient</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">param_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wget_color_ambient</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">param_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wget_n</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">populate_param_box</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">param_box</span>

    <span class="k">def</span> <span class="nf">populate_param_box</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">populate_param_box</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wget_k_ambient</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lighting</span><span class="o">.</span><span class="n">k_ambient</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wget_color_ambient</span><span class="o">.</span><span class="n">update_color</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lighting</span><span class="o">.</span><span class="n">color_ambient</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_preview</span><span class="o">.</span><span class="n">_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lighting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_preview</span><span class="o">.</span><span class="n">repaint</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">on_user_mod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">val_callback</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Notify of modification by the user of a Atom widget&quot;&quot;&quot;</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">val_callback</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_filter</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">source</span> <span class="o">==</span> <span class="s2">&quot;k_ambient&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wget_k_ambient</span><span class="o">.</span><span class="n">on_model_event</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

<span class="c1">#==============================================================================</span>

<span class="k">class</span> <span class="nc">Fractal_editor</span><span class="p">(</span><span class="n">QWidget</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Widget for a Fractal parameter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data_user_modified</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="nb">object</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">data_presenter</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>

        <span class="c1"># Model pointers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">data_presenter</span><span class="o">.</span><span class="n">_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span> <span class="o">=</span> <span class="n">data_presenter</span><span class="o">.</span><span class="n">_mapping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_presenter</span> <span class="o">=</span> <span class="n">data_presenter</span>

        <span class="n">layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">()</span>
        <span class="n">f_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_name</span> <span class="o">=</span> <span class="n">QLineEdit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">populate_fname</span><span class="p">()</span>
        <span class="n">param_box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_box</span> <span class="o">=</span> <span class="n">QGroupBox</span><span class="p">(</span><span class="s2">&quot;Fractal parameters&quot;</span><span class="p">)</span>
        <span class="n">param_box</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="n">GROUP_BOX_CSS</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;#32363F&quot;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">populate_param_box</span><span class="p">()</span>

        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">f_name</span><span class="p">)</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">param_box</span><span class="p">)</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addStretch</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">data_user_modified</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="n">data_presenter</span><span class="o">.</span><span class="n">data_user_modified_slot</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">model_event</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_event_slot</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">populate_fname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Just a reminder of the fractal class &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_name</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_presenter</span><span class="o">.</span><span class="n">data_class</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">populate_param_box</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Editor for each parameter &quot;&quot;&quot;</span>
        <span class="n">wgets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wgets</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="n">param_layout</span> <span class="o">=</span> <span class="n">QGridLayout</span><span class="p">()</span>
        <span class="n">data_init_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_presenter</span><span class="o">.</span><span class="n">data_init_kwargs</span>
        <span class="n">sgn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_presenter</span><span class="o">.</span><span class="n">data_init_signature</span>

        <span class="k">for</span> <span class="n">i_param</span><span class="p">,</span> <span class="p">(</span><span class="n">pname</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sgn</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="c1"># Adds the paramter name</span>
            <span class="n">name_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>
            <span class="n">myFont</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QFont</span><span class="p">()</span>
            <span class="n">myFont</span><span class="o">.</span><span class="n">setWeight</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QFont</span><span class="o">.</span><span class="n">Weight</span><span class="o">.</span><span class="n">ExtraBold</span><span class="p">)</span>
            <span class="n">name_label</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">myFont</span><span class="p">)</span>
            <span class="n">param_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">name_label</span><span class="p">,</span> <span class="n">i_param</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Adds the paramter value</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">data_init_kwargs</span><span class="p">[</span><span class="n">pname</span><span class="p">]</span>
            <span class="n">ptype</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">annotation</span>
            <span class="k">if</span> <span class="n">typing</span><span class="o">.</span><span class="n">get_origin</span><span class="p">(</span><span class="n">ptype</span><span class="p">)</span> <span class="ow">is</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="s2">&quot;Union type not supported in GUI for Fractal __init__ &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;parameter: </span><span class="si">{</span><span class="n">pname</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="n">wget</span> <span class="o">=</span> <span class="n">wgets</span><span class="p">[</span><span class="n">pname</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_wget</span><span class="p">(</span><span class="n">pname</span><span class="p">,</span> <span class="n">ptype</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
            <span class="n">param_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">wget</span><span class="p">,</span> <span class="n">i_param</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Adds the paramter type</span>
            <span class="n">type_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">type_name</span><span class="p">(</span><span class="n">ptype</span><span class="p">))</span>
            <span class="n">param_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">type_label</span><span class="p">,</span> <span class="n">i_param</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">param_layout</span><span class="o">.</span><span class="n">setRowStretch</span><span class="p">(</span><span class="n">i_param</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># extend at bottom</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">param_box</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">param_layout</span><span class="p">)</span>

        <span class="c1"># Middle column is allocated  all the strech space</span>
        <span class="n">param_layout</span><span class="o">.</span><span class="n">setColumnStretch</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">param_layout</span><span class="o">.</span><span class="n">setColumnStretch</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">param_layout</span><span class="o">.</span><span class="n">setColumnStretch</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># param_layout.setRowStretch(-1, 1) # extend at bottom</span>
    
    <span class="k">def</span> <span class="nf">update_param_box</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_fractal</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Updates the individual wget editors according to the new fractal&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">pname</span><span class="p">,</span> <span class="n">wget</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wgets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">pname</span> <span class="o">==</span> <span class="s2">&quot;directory&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">new_fractal</span><span class="p">,</span> <span class="n">pname</span><span class="p">)</span>
            <span class="n">wget_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_presenter</span><span class="o">.</span><span class="n">get_wget_val</span><span class="p">(</span><span class="n">pname</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

            
            <span class="n">wget</span><span class="o">.</span><span class="n">on_model_event</span><span class="p">(</span><span class="n">wget_val</span><span class="p">)</span>
        
    
    <span class="k">def</span> <span class="nf">get_wget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pname</span><span class="p">,</span> <span class="n">ptype</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pname</span> <span class="o">==</span> <span class="s2">&quot;directory&quot;</span><span class="p">:</span>
            <span class="c1"># Directory is read-only</span>
            <span class="n">wget</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="n">wget</span><span class="o">.</span><span class="n">setWordWrap</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">wget</span><span class="o">.</span><span class="n">setTextInteractionFlags</span><span class="p">(</span>
                <span class="n">Qt</span><span class="o">.</span><span class="n">TextInteractionFlag</span><span class="o">.</span><span class="n">TextSelectableByMouse</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">origin</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">get_origin</span><span class="p">(</span><span class="n">ptype</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="n">typing</span><span class="o">.</span><span class="n">Literal</span><span class="p">:</span>
                <span class="n">choices</span> <span class="o">=</span> <span class="n">typing_litteral_choices</span><span class="p">(</span><span class="n">ptype</span><span class="p">,</span> <span class="n">p_name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">choices</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="c1"># manage the droplist choice case</span>
            <span class="n">wget</span> <span class="o">=</span> <span class="n">atom_wget_factory</span><span class="p">(</span><span class="n">ptype</span><span class="p">)(</span><span class="n">ptype</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">wget</span><span class="o">.</span><span class="n">user_modified</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">on_user_mod</span><span class="p">,</span> <span class="n">pname</span><span class="p">,</span> <span class="n">wget</span><span class="o">.</span><span class="n">value</span>
            <span class="p">))</span>
        <span class="k">return</span> <span class="n">wget</span>

    <span class="k">def</span> <span class="nf">on_user_mod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pname</span><span class="p">,</span> <span class="n">val_callback</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Notify the model of modification by the user of a widget&quot;&quot;&quot;</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">wget_val</span> <span class="o">=</span> <span class="n">val_callback</span><span class="p">()</span>
        <span class="n">wget_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_presenter</span><span class="o">.</span><span class="n">get_wget_val</span><span class="p">(</span><span class="n">pname</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wgets</span><span class="p">[</span><span class="n">pname</span><span class="p">]</span><span class="o">.</span><span class="n">on_model_event</span><span class="p">(</span><span class="n">wget_val</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_user_modified</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">pname</span><span class="p">,</span> <span class="n">wget_val</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">model_event_slot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">keys</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_presenter</span><span class="o">.</span><span class="n">_mapping</span><span class="p">[</span><span class="s2">&quot;Fractal_presenter&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_param_box</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="c1"># Asks user to rester zoom parameters </span>
            <span class="n">msgBox</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
            <span class="n">msgBox</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Icon</span><span class="o">.</span><span class="n">Question</span><span class="p">)</span>
            <span class="n">msgBox</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span>
                    <span class="s2">&quot;Fractal object parameters have been updated, &quot;</span>
                    <span class="s2">&quot;reset zoom to default values ?&quot;</span>
            <span class="p">)</span>
            <span class="n">msgBox</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Zoom reset Dialog&quot;</span><span class="p">)</span>
            <span class="n">msgBox</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span>
                <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">Ok</span>
                <span class="o">|</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">Cancel</span>
            <span class="p">)</span>
            <span class="n">user_ret</span> <span class="o">=</span> <span class="n">msgBox</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">user_ret</span> <span class="o">==</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">Ok</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reset_zoom_parameters</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">reset_zoom_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Reset the zoom parameters to default &quot;&quot;&quot;</span>
        <span class="n">gui</span> <span class="o">=</span> <span class="n">getmainwindow</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_gui</span>

        <span class="n">full_zoom_keys</span> <span class="o">=</span> <span class="n">Image_widget</span><span class="o">.</span><span class="n">full_zoom_keys</span>
        <span class="n">other_parameters</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">gui</span><span class="o">.</span><span class="n">other_parameters</span><span class="p">)</span>
        <span class="n">reset_listing</span> <span class="o">=</span> <span class="p">(</span><span class="n">full_zoom_keys</span> <span class="o">+</span> <span class="n">other_parameters</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_presenter</span><span class="o">.</span><span class="n">reset_zoom_parameters</span><span class="p">(</span><span class="n">gui</span><span class="p">,</span> <span class="n">reset_listing</span><span class="p">)</span>


<span class="c1">#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="k">class</span> <span class="nc">QDict_viewer</span><span class="p">(</span><span class="n">QWidget</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">qdict</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_layout</span> <span class="o">=</span> <span class="n">QGridLayout</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_layout</span><span class="o">.</span><span class="n">setSpacing</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_layout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">widgets_reset</span><span class="p">(</span><span class="n">qdict</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span>
            <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Minimum</span><span class="p">,</span> 
            <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Fixed</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">widgets_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qdict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clears and reset all child widgets</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_del_ranges</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_qdict</span> <span class="o">=</span> <span class="n">qdict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_key_row</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">row</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">qdict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> <span class="c1">#kwargs_dic.items():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">QLabel</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">row</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">QLabel</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)),</span> <span class="n">row</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_key_row</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span>
            <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">values_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update_dic</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates in-place with update_dic values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">update_dic</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key_row</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">widget</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_layout</span><span class="o">.</span><span class="n">itemAtPosition</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">widget</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">widget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_qdict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                <span class="n">widget</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_del_ranges</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Delete every item in self._layout &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_layout</span><span class="o">.</span><span class="n">count</span><span class="p">())):</span> 
            <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_layout</span><span class="o">.</span><span class="n">itemAt</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">widget</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">w</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">w</span><span class="o">.</span><span class="n">setParent</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="c1"># w.deleteLater()</span>

<span class="c1">#==============================================================================</span>
<span class="c1"># Graphics Scene classes</span>
<span class="c1">#==============================================================================                </span>
<span class="k">class</span> <span class="nc">Zoomable_Drawer_mixin</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Commom methods that allow to wheel-zoom, and draw objects</span>
<span class="sd">    Pass mouse position (self._object_pos, self._object_drag) to the subclasses</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Initiate a GaphicsScene &quot;&quot;&quot;</span>
        <span class="c1"># sets graphics scene and view</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scene</span> <span class="o">=</span> <span class="n">QGraphicsScene</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_group</span> <span class="o">=</span> <span class="n">QGraphicsItemGroup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_view</span> <span class="o">=</span> <span class="n">QGraphicsView</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scene</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_view</span><span class="o">.</span><span class="n">setScene</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scene</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_view</span><span class="o">.</span><span class="n">setCursor</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QCursor</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">CursorShape</span><span class="o">.</span><span class="n">CrossCursor</span><span class="p">))</span>
        
        <span class="c1"># Initialize the object drawn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_object_pos</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()</span> <span class="c1"># No coords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_object_drag</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_drawing</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="c1"># zooms anchors for wheel events - note this is only active </span>
        <span class="c1"># when the image fully occupies the widget</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_view</span><span class="o">.</span><span class="n">setTransformationAnchor</span><span class="p">(</span>
                <span class="n">QGraphicsView</span><span class="o">.</span><span class="n">ViewportAnchor</span><span class="o">.</span><span class="n">AnchorUnderMouse</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_view</span><span class="o">.</span><span class="n">setResizeAnchor</span><span class="p">(</span>
                <span class="n">QGraphicsView</span><span class="o">.</span><span class="n">ViewportAnchor</span><span class="o">.</span><span class="n">AnchorUnderMouse</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_view</span><span class="o">.</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignmentFlag</span><span class="o">.</span><span class="n">AlignCenter</span><span class="p">)</span>

        <span class="c1"># events filters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_view</span><span class="o">.</span><span class="n">viewport</span><span class="p">()</span><span class="o">.</span><span class="n">installEventFilter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scene</span><span class="o">.</span><span class="n">installEventFilter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Locker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Activates / desactivates locking ========================================</span>
    <span class="nd">@pyqtSlot</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">lock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">val</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_locked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="c1"># Mouse interaction =======================================================</span>
    <span class="k">def</span> <span class="nf">eventFilter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="c1"># ref: https://doc.qt.io/qt-5/qevent.html</span>
        <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scene</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="ow">is</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGraphicsSceneMouseEvent</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_viewport_mouse</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="ow">is</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QEnterEvent</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_enter</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">type</span><span class="p">()</span> <span class="o">==</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QEvent</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">Leave</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_leave</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">source</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">_view</span><span class="o">.</span><span class="n">viewport</span><span class="p">():</span>
            <span class="c1"># Catch context menu</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="o">==</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QContextMenuEvent</span><span class="p">:</span>
                <span class="c1"># return self.on_context_menu(event)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span><span class="p">()</span> <span class="o">==</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QEvent</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">Wheel</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_wheel</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span><span class="p">()</span> <span class="o">==</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QEvent</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">ToolTip</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">on_enter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">on_leave</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">on_wheel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        - Updates the zoom</span>
<span class="sd">        - Send the current zoom value to `pos_tracker` if exists </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_view</span>
            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">angleDelta</span><span class="p">()</span><span class="o">.</span><span class="n">y</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">factor</span> <span class="o">=</span> <span class="mf">1.25</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">factor</span> <span class="o">=</span> <span class="mf">0.8</span>
            <span class="n">view</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">factor</span><span class="p">,</span> <span class="n">factor</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;pos_tracker&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pos_tracker</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;zoom&quot;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zoom</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">zoom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_view</span>
        <span class="n">pc</span> <span class="o">=</span> <span class="mf">100.</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">transform</span><span class="p">()</span><span class="o">.</span><span class="n">determinant</span><span class="p">())</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{0:.2f}</span><span class="s2"> %&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pc</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">fit_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Reset the zoom so that the image fits in the widget &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">rect</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QRectF</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_qim</span><span class="o">.</span><span class="n">pixmap</span><span class="p">()</span><span class="o">.</span><span class="n">rect</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rect</span><span class="o">.</span><span class="n">isNull</span><span class="p">():</span>
            <span class="c1"># always scrollbars off</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_view</span><span class="o">.</span><span class="n">setVerticalScrollBarPolicy</span><span class="p">(</span>
                    <span class="n">Qt</span><span class="o">.</span><span class="n">ScrollBarPolicy</span><span class="o">.</span><span class="n">ScrollBarAlwaysOff</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_view</span><span class="o">.</span><span class="n">setHorizontalScrollBarPolicy</span><span class="p">(</span>
                    <span class="n">Qt</span><span class="o">.</span><span class="n">ScrollBarPolicy</span><span class="o">.</span><span class="n">ScrollBarAlwaysOff</span>
            <span class="p">)</span>
            
            <span class="n">view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_view</span>
            <span class="n">view</span><span class="o">.</span><span class="n">setSceneRect</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>
            <span class="n">unity</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">transform</span><span class="p">()</span><span class="o">.</span><span class="n">mapRect</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QRectF</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">view</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">unity</span><span class="o">.</span><span class="n">width</span><span class="p">(),</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">unity</span><span class="o">.</span><span class="n">height</span><span class="p">())</span>
            <span class="n">viewrect</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">viewport</span><span class="p">()</span><span class="o">.</span><span class="n">rect</span><span class="p">()</span>
            <span class="n">scenerect</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">transform</span><span class="p">()</span><span class="o">.</span><span class="n">mapRect</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">viewrect</span><span class="o">.</span><span class="n">width</span><span class="p">()</span> <span class="o">/</span> <span class="n">scenerect</span><span class="o">.</span><span class="n">width</span><span class="p">(),</span>
                         <span class="n">viewrect</span><span class="o">.</span><span class="n">height</span><span class="p">()</span> <span class="o">/</span> <span class="n">scenerect</span><span class="o">.</span><span class="n">height</span><span class="p">())</span>
            <span class="n">view</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">factor</span><span class="p">,</span> <span class="n">factor</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">_view</span><span class="o">.</span><span class="n">setVerticalScrollBarPolicy</span><span class="p">(</span>
                    <span class="n">Qt</span><span class="o">.</span><span class="n">ScrollBarPolicy</span><span class="o">.</span><span class="n">ScrollBarAsNeeded</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_view</span><span class="o">.</span><span class="n">setHorizontalScrollBarPolicy</span><span class="p">(</span>
                    <span class="n">Qt</span><span class="o">.</span><span class="n">ScrollBarPolicy</span><span class="o">.</span><span class="n">ScrollBarAsNeeded</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;pos_tracker&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pos_tracker</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;zoom&quot;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zoom</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">on_viewport_mouse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span><span class="p">()</span> <span class="o">==</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QEvent</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">GraphicsSceneMouseMove</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on_mouse_move</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">elif</span> <span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">type</span><span class="p">()</span> <span class="o">==</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QEvent</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">GraphicsSceneMousePress</span>
              <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">button</span><span class="p">()</span> <span class="o">==</span> <span class="n">Qt</span><span class="o">.</span><span class="n">MouseButton</span><span class="o">.</span><span class="n">LeftButton</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on_mouse_left_press</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        
        <span class="k">elif</span> <span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">type</span><span class="p">()</span> <span class="o">==</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QEvent</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">GraphicsSceneMousePress</span>
              <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">button</span><span class="p">()</span> <span class="o">==</span> <span class="n">Qt</span><span class="o">.</span><span class="n">MouseButton</span><span class="o">.</span><span class="n">RightButton</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on_mouse_right_press</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">elif</span> <span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">type</span><span class="p">()</span> <span class="o">==</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QEvent</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">GraphicsSceneMouseDoubleClick</span>
              <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">button</span><span class="p">()</span> <span class="o">==</span> <span class="n">Qt</span><span class="o">.</span><span class="n">MouseButton</span><span class="o">.</span><span class="n">LeftButton</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on_mouse_double_left_click</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">on_mouse_left_press</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Left-clicking adds the point and might finish editing if max</span>
<span class="sd">        number of points reached &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_locked</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_drawing</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_object_pos</span> <span class="o">+=</span> <span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">scenePos</span><span class="p">(),)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_object_pos</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">object_max_pts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_drawing</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">publish_object</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_object_pos</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">on_mouse_double_left_click</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Double-left-clicking finishes editing &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_locked</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_drawing</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">publish_object</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_object_pos</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">on_mouse_right_press</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="k">pass</span>


    <span class="k">def</span> <span class="nf">on_mouse_move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        - Publish the position to a pos tracker if exists </span>
<span class="sd">        - If object is being drawn, send a draw_object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;pos_tracker&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pos_tracker</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;pos&quot;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">scenePos</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drawing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_object_drag</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">scenePos</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">draw_object</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">publish_object</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Object has been drawn &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Derived classes should implement&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">draw_object</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Object is being drawn &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Derived classes should implement&quot;</span><span class="p">)</span>


<span class="c1">#==============================================================================</span>
<span class="c1"># Base widget for displaying the fractal</span>
<span class="c1">#==============================================================================</span>
<span class="k">class</span> <span class="nc">Image_widget</span><span class="p">(</span><span class="n">QWidget</span><span class="p">,</span> <span class="n">Zoomable_Drawer_mixin</span><span class="p">):</span>
    
    <span class="n">param_user_modified</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span>
    <span class="n">on_fractal_result</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="nb">object</span><span class="p">)</span>

    <span class="n">zoom_keys</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;dx&quot;</span><span class="p">,</span> <span class="s2">&quot;xy_ratio&quot;</span><span class="p">,</span> <span class="s2">&quot;theta_deg&quot;</span><span class="p">)</span>
    <span class="n">full_zoom_keys</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;nx&quot;</span><span class="p">,</span> <span class="s2">&quot;dx&quot;</span><span class="p">,</span> <span class="s2">&quot;xy_ratio&quot;</span><span class="p">,</span> <span class="s2">&quot;theta_deg&quot;</span><span class="p">,</span> <span class="s2">&quot;dps&quot;</span><span class="p">)</span>
    <span class="n">editable_keys</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;dx&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">view_presenter</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="n">parent</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span>
            <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Preferred</span><span class="p">,</span> 
            <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Policy</span><span class="o">.</span><span class="n">Expanding</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">view_presenter</span><span class="o">.</span><span class="n">_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span> <span class="o">=</span> <span class="n">view_presenter</span><span class="o">.</span><span class="n">_mapping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_presenter</span> <span class="o">=</span> <span class="n">view_presenter</span>
        
        <span class="c1"># Need dps ?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_dps</span> <span class="o">=</span> <span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">_gui</span><span class="o">.</span><span class="n">_dps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Sets layout, with only one Widget, the image itself</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_layout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_view</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># Sets property widget &quot;image_doc_widget&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span> <span class="o">=</span> <span class="n">QDict_viewer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="p">{</span><span class="s2">&quot;Image metadata&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;px&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;py&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;zoom&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>
        <span class="n">dock_widget</span> <span class="o">=</span> <span class="n">QDockWidget</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">Qt</span><span class="o">.</span><span class="n">WindowType</span><span class="o">.</span><span class="n">Window</span><span class="p">)</span>
        <span class="n">dock_widget</span><span class="o">.</span><span class="n">setWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_labels</span><span class="p">)</span>
        <span class="c1"># Not closable :</span>
        <span class="n">dock_widget</span><span class="o">.</span><span class="n">setFeatures</span><span class="p">(</span>
            <span class="n">QDockWidget</span><span class="o">.</span><span class="n">DockWidgetFeature</span><span class="o">.</span><span class="n">DockWidgetFloatable</span> 
            <span class="o">|</span> <span class="n">QDockWidget</span><span class="o">.</span><span class="n">DockWidgetFeature</span><span class="o">.</span><span class="n">DockWidgetMovable</span>
        <span class="p">)</span>
        <span class="n">dock_widget</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Image&quot;</span><span class="p">)</span>
        <span class="n">dock_widget</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="n">DOCK_WIDGET_CSS</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_doc_widget</span> <span class="o">=</span> <span class="n">dock_widget</span>

        <span class="c1"># Sets the objects being drawn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rect</span><span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rect_under</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">object_max_pts</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="c1"># Sets Image</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_qim</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_zoom_init</span><span class="p">(</span><span class="n">try_reload</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_im</span><span class="p">()</span>
        
        <span class="c1"># Publish / subscribe signals with the submodel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">model_event</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_event_slot</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_fractal_result</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fractal_result_slot</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">on_mouse_right_press</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Interactive menu with all the defined &quot;interactive_options&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_presenter</span><span class="p">[</span><span class="s2">&quot;fractal&quot;</span><span class="p">]</span>
        <span class="n">methods</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">interactive_options</span><span class="o">.</span><span class="n">methods</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">scenePos</span><span class="p">()</span>

        <span class="n">menu</span> <span class="o">=</span> <span class="n">QMenu</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">:</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="n">menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
            <span class="n">action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">on_fractal_method</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">pos</span><span class="p">))</span>
        <span class="n">menu</span><span class="o">.</span><span class="n">popup</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">screenPos</span><span class="p">())</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">on_fractal_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">m_name</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Runs the selected method of the fractal, passing the event coords</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">px</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">x</span><span class="p">()</span>
        <span class="n">py</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">y</span><span class="p">()</span>
        <span class="n">ref_zoom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fractal_zoom_init</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">nx</span> <span class="o">=</span> <span class="n">ref_zoom</span><span class="p">[</span><span class="s2">&quot;nx&quot;</span><span class="p">]</span>
        <span class="n">ny</span> <span class="o">=</span> <span class="n">ref_zoom</span><span class="p">[</span><span class="s2">&quot;ny&quot;</span><span class="p">]</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">mpmath</span><span class="o">.</span><span class="n">mpf</span><span class="p">(</span><span class="n">ref_zoom</span><span class="p">[</span><span class="s2">&quot;dx&quot;</span><span class="p">])</span>
        <span class="n">pix</span> <span class="o">=</span> <span class="n">dx</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">ref_zoom</span><span class="p">[</span><span class="s2">&quot;nx&quot;</span><span class="p">])</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">ref_zoom</span><span class="p">[</span><span class="s2">&quot;theta_deg&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span><span class="p">)</span>
        
        <span class="c1"># The skew matrice</span>
        <span class="n">skew_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">skew_from_ref_zoom</span><span class="p">(</span><span class="n">ref_zoom</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">mpmath</span><span class="o">.</span><span class="n">workdps</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
            <span class="c1"># Sets the working dps to 10e-8 x pixel size</span>
            <span class="n">dps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="o">-</span><span class="n">mpmath</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">pix</span> <span class="o">/</span> <span class="n">nx</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">mpmath</span><span class="o">.</span><span class="n">workdps</span><span class="p">(</span><span class="n">dps</span><span class="p">):</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="n">mpmath</span><span class="o">.</span><span class="n">mpf</span><span class="p">(</span><span class="n">ref_zoom</span><span class="p">[</span><span class="s2">&quot;dx&quot;</span><span class="p">])</span>
            <span class="n">x_center</span> <span class="o">=</span> <span class="n">mpmath</span><span class="o">.</span><span class="n">mpf</span><span class="p">(</span><span class="n">ref_zoom</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">])</span>
            <span class="n">y_center</span> <span class="o">=</span> <span class="n">mpmath</span><span class="o">.</span><span class="n">mpf</span><span class="p">(</span><span class="n">ref_zoom</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">])</span>
            
            <span class="n">pix</span> <span class="o">=</span> <span class="n">dx</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">ref_zoom</span><span class="p">[</span><span class="s2">&quot;nx&quot;</span><span class="p">])</span>
            <span class="n">center_off_px</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">nx</span>
            <span class="n">center_off_py</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">-</span> <span class="n">py</span>
            
            <span class="n">off_x</span><span class="p">,</span> <span class="n">off_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_coord_offset</span><span class="p">(</span>
                <span class="n">center_off_px</span><span class="p">,</span> <span class="n">center_off_py</span><span class="p">,</span> <span class="n">pix</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="o">*</span><span class="n">skew_params</span>
            <span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x_center</span> <span class="o">+</span> <span class="n">off_x</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y_center</span> <span class="o">+</span> <span class="n">off_y</span>

            <span class="k">def</span> <span class="nf">thread_job</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="n">res</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">m_name</span><span class="p">)(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">pix</span><span class="p">,</span> <span class="n">dps</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="c1"># Send a signal rather than direct call, to avoid a crash</span>
                <span class="c1"># QBasicTimer::start: Timers cannot be started from another</span>
                <span class="c1"># thread Segmentation fault (core dumped)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">on_fractal_result</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">m_name</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_view</span><span class="o">.</span><span class="n">setCursor</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QCursor</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">CursorShape</span><span class="o">.</span><span class="n">WaitCursor</span><span class="p">))</span>

            <span class="n">suppl_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">method_kwargs</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">m_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">suppl_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_view</span><span class="o">.</span><span class="n">setCursor</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QCursor</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">CursorShape</span><span class="o">.</span><span class="n">CrossCursor</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">thread_job</span><span class="p">,</span>
                                 <span class="n">kwargs</span><span class="o">=</span><span class="n">suppl_kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">skew_from_ref_zoom</span><span class="p">(</span><span class="n">ref_zoom</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the skew params or default value if no skew stored &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">has_skew</span> <span class="o">=</span> <span class="n">ref_zoom</span><span class="p">[</span><span class="s2">&quot;has_skew&quot;</span><span class="p">]</span> 
            <span class="n">skew_00</span> <span class="o">=</span> <span class="n">ref_zoom</span><span class="p">[</span><span class="s2">&quot;skew_00&quot;</span><span class="p">]</span> 
            <span class="n">skew_01</span> <span class="o">=</span> <span class="n">ref_zoom</span><span class="p">[</span><span class="s2">&quot;skew_01&quot;</span><span class="p">]</span> 
            <span class="n">skew_10</span> <span class="o">=</span> <span class="n">ref_zoom</span><span class="p">[</span><span class="s2">&quot;skew_10&quot;</span><span class="p">]</span> 
            <span class="n">skew_11</span> <span class="o">=</span> <span class="n">ref_zoom</span><span class="p">[</span><span class="s2">&quot;skew_11&quot;</span><span class="p">]</span> 
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">has_skew</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">skew_00</span> <span class="o">=</span> <span class="n">skew_11</span> <span class="o">=</span> <span class="mf">1.</span>
            <span class="n">skew_01</span> <span class="o">=</span> <span class="n">skew_10</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">return</span> <span class="n">has_skew</span><span class="p">,</span> <span class="n">skew_00</span><span class="p">,</span> <span class="n">skew_01</span><span class="p">,</span> <span class="n">skew_10</span><span class="p">,</span> <span class="n">skew_11</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_coord_offset</span><span class="p">(</span>
        <span class="n">center_off_px</span><span class="p">,</span> <span class="n">center_off_py</span><span class="p">,</span> <span class="n">pix</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span>
        <span class="n">has_skew</span><span class="p">,</span> <span class="n">skew_00</span><span class="p">,</span> <span class="n">skew_01</span><span class="p">,</span> <span class="n">skew_10</span><span class="p">,</span> <span class="n">skew_11</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the coords offset from the screen offset &quot;&quot;&quot;</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">c</span> <span class="o">*</span> <span class="n">center_off_px</span> <span class="o">-</span> <span class="n">s</span> <span class="o">*</span> <span class="n">center_off_py</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">s</span> <span class="o">*</span> <span class="n">center_off_px</span> <span class="o">+</span> <span class="n">c</span> <span class="o">*</span> <span class="n">center_off_py</span>

        <span class="c1"># The skew part</span>
        <span class="k">if</span> <span class="n">has_skew</span><span class="p">:</span>
            <span class="n">tmpx</span> <span class="o">=</span> <span class="n">dx</span>
            <span class="n">tmpy</span> <span class="o">=</span> <span class="n">dy</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="n">skew_00</span> <span class="o">*</span> <span class="n">tmpx</span> <span class="o">+</span> <span class="n">skew_01</span> <span class="o">*</span> <span class="n">tmpy</span>
            <span class="n">dy</span> <span class="o">=</span> <span class="n">skew_10</span> <span class="o">*</span> <span class="n">tmpx</span> <span class="o">+</span> <span class="n">skew_11</span> <span class="o">*</span> <span class="n">tmpy</span>

        <span class="k">return</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">pix</span><span class="p">,</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">pix</span>


    <span class="k">def</span> <span class="nf">method_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">m_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Collect the additionnal parameters that might be needed&quot;&quot;&quot;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">m_name</span><span class="p">)</span>
        <span class="c1"># Note: use inspect for a fractal GUI-method </span>
        <span class="n">sign</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="n">add_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i_param</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sign</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;pix&quot;</span><span class="p">,</span> <span class="s2">&quot;dps&quot;</span><span class="p">):</span>
                <span class="c1"># These we already know them</span>
                <span class="k">continue</span>
            <span class="n">ptype</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">annotation</span>
            <span class="n">default</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">default</span>

            <span class="k">if</span> <span class="n">ptype</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="n">default</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">int_param</span><span class="p">,</span> <span class="n">ok</span> <span class="o">=</span> <span class="n">QInputDialog</span><span class="o">.</span><span class="n">getInt</span><span class="p">(</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="s2">&quot;Integer input for ball method&quot;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;Enter </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">value</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                    <span class="n">add_params</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">int_param</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span> <span class="c1"># Cancel semaphore </span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported type </span><span class="si">{</span><span class="n">ptype</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">add_params</span>


    <span class="k">def</span> <span class="nf">fractal_result_slot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m_name</span><span class="p">,</span> <span class="n">res</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_view</span><span class="o">.</span><span class="n">setCursor</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QCursor</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">CursorShape</span><span class="o">.</span><span class="n">CrossCursor</span><span class="p">))</span>
        <span class="n">res_display</span> <span class="o">=</span> <span class="n">Fractal_code_editor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">res_display</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="n">res_display</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">m_name</span><span class="si">}</span><span class="s2"> results&quot;</span><span class="p">)</span>
        <span class="n">res_display</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">pos_tracker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Updated the displayed info &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;pos&quot;</span><span class="p">:</span> <span class="c1"># val is event.scenePos()</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span><span class="o">.</span><span class="n">values_update</span><span class="p">({</span><span class="s2">&quot;px&quot;</span><span class="p">:</span> <span class="n">val</span><span class="o">.</span><span class="n">x</span><span class="p">(),</span> <span class="s2">&quot;py&quot;</span><span class="p">:</span> <span class="n">val</span><span class="o">.</span><span class="n">y</span><span class="p">()})</span>
        <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;zoom&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span><span class="o">.</span><span class="n">values_update</span><span class="p">({</span><span class="s2">&quot;zoom&quot;</span><span class="p">:</span> <span class="n">val</span><span class="p">})</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">xy_ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_presenter</span><span class="p">[</span><span class="s2">&quot;xy_ratio&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">other_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">_gui</span><span class="o">.</span><span class="n">other_parameters</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_zoom_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">try_reload</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Resets the zoom init, </span>
<span class="sd">         - from the saved pickled files</span>
<span class="sd">         - of, if not found, from the script parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># parent is Fractal_MainWindow - func_wget is not initialized at this</span>
        <span class="c1"># point, so we use the model itself</span>
        <span class="n">func_sm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">from_register</span><span class="p">((</span><span class="s2">&quot;func&quot;</span><span class="p">,))</span>
        <span class="k">if</span> <span class="n">try_reload</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">func_sm</span><span class="o">.</span><span class="n">load_func_dict</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># We now load the parameters current value from the func model</span>
        <span class="n">fm_params</span> <span class="o">=</span> <span class="n">func_sm</span><span class="o">.</span><span class="n">getkwargs</span><span class="p">()</span>

        <span class="c1"># Setting _fractal_zoom_init from script_params</span>
        <span class="n">gui</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">_gui</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fractal_zoom_init</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_zoom_keys</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">other_parameters</span><span class="p">):</span>
            <span class="c1"># Mapping with func param as defined through `connect_mouse` method</span>
            <span class="c1"># of the gui object</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;dps&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">gui</span><span class="o">.</span><span class="n">_dps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fractal_zoom_init</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">fm_params</span><span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">gui</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">key</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_fractal_zoom_init</span><span class="p">[</span><span class="s2">&quot;ny&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fractal_zoom_init</span><span class="p">[</span><span class="s2">&quot;nx&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fractal_zoom_init</span><span class="p">[</span><span class="s2">&quot;xy_ratio&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="mf">0.5</span>
        <span class="p">)</span>


    <span class="k">def</span> <span class="nf">set_im</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This reloads the image and checks that the </span>
<span class="sd">        metadata is matching the expected values from &#39;last_call&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">image_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_presenter</span><span class="p">[</span><span class="s2">&quot;fractal&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">directory</span><span class="p">,</span> 
                                   <span class="bp">self</span><span class="o">.</span><span class="n">_presenter</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span><span class="p">)</span>
        <span class="n">valid_image</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">im</span><span class="p">:</span>
                <span class="n">info</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">info</span>
                <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">size</span>

        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="n">valid_image</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zoom_keys</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zoom_keys</span><span class="p">)))</span>
            <span class="n">nx</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">ny</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Storing the &quot;image&quot; zoom info </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_image_zoom_init</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">info</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> 
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">zoom_keys</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_image_zoom_init</span><span class="p">[</span><span class="s2">&quot;nx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_image_zoom_init</span><span class="p">[</span><span class="s2">&quot;ny&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ny</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_dps</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_image_zoom_init</span><span class="p">[</span><span class="s2">&quot;dps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;precision&quot;</span><span class="p">,</span> <span class="n">mpmath</span><span class="o">.</span><span class="n">mp</span><span class="o">.</span><span class="n">dps</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_qim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rect</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rect_under</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="o">.</span><span class="n">removeFromGroup</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">valid_image</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_qim</span> <span class="o">=</span> <span class="n">QGraphicsPixmapItem</span><span class="p">(</span>
                <span class="n">QtGui</span><span class="o">.</span><span class="n">QPixmap</span><span class="o">.</span><span class="n">fromImage</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QImage</span><span class="p">(</span><span class="n">image_file</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="c1"># Antialiasing activated :</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_qim</span><span class="o">.</span><span class="n">setTransformationMode</span><span class="p">(</span>
                <span class="n">Qt</span><span class="o">.</span><span class="n">TransformationMode</span><span class="o">.</span><span class="n">SmoothTransformation</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_qim</span><span class="o">.</span><span class="n">setAcceptHoverEvents</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="o">.</span><span class="n">addToGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_qim</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fit_image</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_qim</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_rect</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rect_under</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_drawing_rect</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">cast</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">example</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Casts value to the same type as example &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">example</span><span class="p">)(</span><span class="n">val</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_zoom_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Checks if the image &#39;zoom init&#39; matches the parameters ;</span>
<span class="sd">        otherwise, warns in the image text display</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># We store 2 values of the parameters :</span>
        <span class="c1"># the _fractal_zoom_init is a copy of the parameters values &quot;when the </span>
        <span class="c1"># image has been produced&quot;</span>
        <span class="c1"># the _presenter value is a convenience to access current parameter</span>
        <span class="c1"># value</span>
        <span class="c1"># Here, the check performed is to ensure the image metadata matches</span>
        <span class="c1"># _fractal_zoom_init</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zoom_keys</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_dps</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;dps&quot;</span><span class="p">,)</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">expected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image_zoom_init</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fractal_zoom_init</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">expected</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># No image data</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">casted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">casted</span> <span class="o">!=</span> <span class="n">expected</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;GUI Unmatching image parameter for </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">casted</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">expected</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Sets Image metadata message &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_zoom_init</span><span class="p">()</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;OK, matching&quot;</span><span class="p">,</span>
                   <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;/!\ image metadata mismatch&quot;</span><span class="p">,</span>
                   <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;Image data missing&quot;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span><span class="o">.</span><span class="n">values_update</span><span class="p">({</span><span class="s2">&quot;Image metadata&quot;</span><span class="p">:</span> 
            <span class="n">message</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">validated</span><span class="p">]})</span>


    <span class="k">def</span> <span class="nf">cancel_drawing_rect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dclick</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Cancellation cases : double-click or empty rectangle</span>
<span class="sd">        if dclick, we also reset xy_ratio and theta_deg</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">editable_keys</span>
        <span class="k">if</span> <span class="n">dclick</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zoom_keys</span>
        <span class="c1"># resets everything - the zoom ratio only if dclick</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fractal_zoom_init</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Send a model modification request</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_presenter</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="c1"># Removes the objects</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rect</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="o">.</span><span class="n">removeFromGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rect</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rect</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rect_under</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="o">.</span><span class="n">removeFromGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rect_under</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rect_under</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">publish_object</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Export the zoom area at model level</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">cancel</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">dclick</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_object_pos</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># We can only be there if double-click</span>
            <span class="n">cancel</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">dclick</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rect_pos0</span><span class="p">,</span> <span class="n">rect_pos1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_object_pos</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">rect_pos0</span> <span class="o">==</span> <span class="n">rect_pos1</span><span class="p">):</span>
                <span class="n">cancel</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># zoom is invalid</span>

        <span class="k">if</span> <span class="n">cancel</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cancel_drawing_rect</span><span class="p">(</span><span class="n">dclick</span><span class="o">=</span><span class="n">dclick</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dclick</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fit_image</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="n">nx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fractal_zoom_init</span><span class="p">[</span><span class="s2">&quot;nx&quot;</span><span class="p">]</span>
        <span class="n">ny</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fractal_zoom_init</span><span class="p">[</span><span class="s2">&quot;ny&quot;</span><span class="p">]</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fractal_zoom_init</span><span class="p">[</span><span class="s2">&quot;theta_deg&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span><span class="p">)</span>

        <span class="c1"># The skew matrice</span>
        <span class="n">skew_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">skew_from_ref_zoom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fractal_zoom_init</span><span class="p">)</span>

        <span class="c1"># new center offet in pixel - independent of angle</span>
        <span class="n">topleft</span><span class="p">,</span> <span class="n">bottomRight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection_corners</span><span class="p">(</span><span class="n">rect_pos0</span><span class="p">,</span> <span class="n">rect_pos1</span><span class="p">)</span>
        <span class="n">center_off_px</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">topleft</span><span class="o">.</span><span class="n">x</span><span class="p">()</span> <span class="o">+</span> <span class="n">bottomRight</span><span class="o">.</span><span class="n">x</span><span class="p">()</span> <span class="o">-</span> <span class="n">nx</span><span class="p">)</span>
        <span class="n">center_off_py</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">ny</span> <span class="o">-</span> <span class="n">topleft</span><span class="o">.</span><span class="n">y</span><span class="p">()</span> <span class="o">-</span> <span class="n">bottomRight</span><span class="o">.</span><span class="n">y</span><span class="p">())</span>
        <span class="n">dx_pix</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">topleft</span><span class="o">.</span><span class="n">x</span><span class="p">()</span> <span class="o">-</span> <span class="n">bottomRight</span><span class="o">.</span><span class="n">x</span><span class="p">())</span>

        <span class="n">ref_zoom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fractal_zoom_init</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># str -&gt; mpf as needed</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_dps</span><span class="p">:</span>
            <span class="n">to_mpf</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fractal_zoom_init</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span>
                      <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;dx&quot;</span><span class="p">]}</span>
            <span class="c1"># We may need to increase the dps to hold sufficent digits</span>
            <span class="k">if</span> <span class="n">to_mpf</span><span class="p">[</span><span class="s2">&quot;dx&quot;</span><span class="p">]:</span>
                <span class="n">ref_zoom</span><span class="p">[</span><span class="s2">&quot;dx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpmath</span><span class="o">.</span><span class="n">mpf</span><span class="p">(</span><span class="n">ref_zoom</span><span class="p">[</span><span class="s2">&quot;dx&quot;</span><span class="p">])</span>
            <span class="n">pix</span> <span class="o">=</span> <span class="n">ref_zoom</span><span class="p">[</span><span class="s2">&quot;dx&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">ref_zoom</span><span class="p">[</span><span class="s2">&quot;nx&quot;</span><span class="p">])</span>
            <span class="k">with</span> <span class="n">mpmath</span><span class="o">.</span><span class="n">workdps</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
                <span class="c1"># Sets the working dps to 10e-8 x pixel size</span>
                <span class="n">ref_zoom</span><span class="p">[</span><span class="s2">&quot;dps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="o">-</span><span class="n">mpmath</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">pix</span> <span class="o">*</span> <span class="n">dx_pix</span> <span class="o">/</span> <span class="n">nx</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span>
    
            <span class="k">with</span> <span class="n">mpmath</span><span class="o">.</span><span class="n">workdps</span><span class="p">(</span><span class="n">ref_zoom</span><span class="p">[</span><span class="s2">&quot;dps&quot;</span><span class="p">]):</span>
                <span class="c1"># x, y position is measured on the image -&gt; ref angle is theta</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">to_mpf</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                        <span class="n">ref_zoom</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpmath</span><span class="o">.</span><span class="n">mpf</span><span class="p">(</span><span class="n">ref_zoom</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                        
                <span class="n">off_x</span><span class="p">,</span> <span class="n">off_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_coord_offset</span><span class="p">(</span>
                    <span class="n">center_off_px</span><span class="p">,</span> <span class="n">center_off_py</span><span class="p">,</span> <span class="n">pix</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="o">*</span><span class="n">skew_params</span>
                <span class="p">)</span>
                <span class="n">ref_zoom</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">off_x</span>
                <span class="n">ref_zoom</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">off_y</span>

                <span class="n">ref_zoom</span><span class="p">[</span><span class="s2">&quot;dx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dx_pix</span> <span class="o">*</span> <span class="n">pix</span>

                <span class="c1">#  mpf -&gt; str (back)</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">to_mpf</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">v</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;dx&quot;</span><span class="p">:</span>
                            <span class="n">ref_zoom</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpmath</span><span class="o">.</span><span class="n">nstr</span><span class="p">(</span><span class="n">ref_zoom</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ref_zoom</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ref_zoom</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ref_zoom</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ref_zoom</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">])</span>
            <span class="n">ref_zoom</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ref_zoom</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">])</span>
            <span class="n">ref_zoom</span><span class="p">[</span><span class="s2">&quot;dx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ref_zoom</span><span class="p">[</span><span class="s2">&quot;dx&quot;</span><span class="p">])</span>

            <span class="n">pix</span> <span class="o">=</span> <span class="n">ref_zoom</span><span class="p">[</span><span class="s2">&quot;dx&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">ref_zoom</span><span class="p">[</span><span class="s2">&quot;nx&quot;</span><span class="p">])</span>
            <span class="n">ref_zoom</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">pix</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">center_off_px</span>
                <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">center_off_py</span>
            <span class="p">)</span>
            <span class="n">ref_zoom</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">pix</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">center_off_px</span>
                <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">center_off_py</span>
            <span class="p">)</span>
            <span class="n">ref_zoom</span><span class="p">[</span><span class="s2">&quot;dx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dx_pix</span> <span class="o">*</span> <span class="n">pix</span>

        <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">editable_keys</span> <span class="c1"># Note that theta is not editable by mouse</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_dps</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;dps&quot;</span><span class="p">,)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_presenter</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref_zoom</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            

    <span class="k">def</span> <span class="nf">draw_object</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Draws the selection rectangle &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_object_pos</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid drawing </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_object_pos</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="p">(</span><span class="n">pos0</span><span class="p">,)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_object_pos</span>
        <span class="n">pos1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_object_drag</span>

        <span class="c1"># Enforce the correct rotation angle</span>
        <span class="n">topleft</span><span class="p">,</span> <span class="n">bottomRight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection_corners</span><span class="p">(</span><span class="n">pos0</span><span class="p">,</span> <span class="n">pos1</span><span class="p">)</span>
        <span class="n">rotation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection_rotation</span><span class="p">()</span>

        <span class="n">rectF</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QRectF</span><span class="p">(</span><span class="n">topleft</span><span class="p">,</span> <span class="n">bottomRight</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rect</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rect</span><span class="o">.</span><span class="n">setRect</span><span class="p">(</span><span class="n">rectF</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rect_under</span><span class="o">.</span><span class="n">setRect</span><span class="p">(</span><span class="n">rectF</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rect_under</span> <span class="o">=</span> <span class="n">QGraphicsRectItem</span><span class="p">(</span><span class="n">rectF</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rect_under</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QPen</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="s2">&quot;red&quot;</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Qt</span><span class="o">.</span><span class="n">PenStyle</span><span class="o">.</span><span class="n">SolidLine</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="o">.</span><span class="n">addToGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rect_under</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_rect</span> <span class="o">=</span> <span class="n">QGraphicsRectItem</span><span class="p">(</span><span class="n">rectF</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rect</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QPen</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="s2">&quot;black&quot;</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Qt</span><span class="o">.</span><span class="n">PenStyle</span><span class="o">.</span><span class="n">DotLine</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="o">.</span><span class="n">addToGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rect</span><span class="p">)</span>

        <span class="c1"># Now apply the rotation</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rect_under</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rect</span><span class="p">):</span>
            <span class="n">r</span><span class="o">.</span><span class="n">setTransformOriginPoint</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">boundingRect</span><span class="p">()</span><span class="o">.</span><span class="n">center</span><span class="p">())</span>
            <span class="n">r</span><span class="o">.</span><span class="n">setRotation</span><span class="p">(</span><span class="n">rotation</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">selection_corners</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos0</span><span class="p">,</span> <span class="n">pos1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; These are the selection rectangle corners &quot;&quot;&quot;</span>
        <span class="c1"># Enforce the correct ratio</span>
        <span class="n">diffx</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">pos1</span><span class="o">.</span><span class="n">x</span><span class="p">()</span> <span class="o">-</span> <span class="n">pos0</span><span class="o">.</span><span class="n">x</span><span class="p">())</span>
        <span class="n">diffy</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">pos1</span><span class="o">.</span><span class="n">y</span><span class="p">()</span> <span class="o">-</span> <span class="n">pos0</span><span class="o">.</span><span class="n">y</span><span class="p">())</span>
        <span class="c1"># Enforce the correct ratio</span>
        <span class="n">radius_sq</span> <span class="o">=</span> <span class="n">diffx</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">diffy</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">diffx0</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">radius_sq</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="mf">1.</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy_ratio</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">diffy0</span> <span class="o">=</span> <span class="n">diffx0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy_ratio</span>
        <span class="n">topleft</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QPointF</span><span class="p">(</span><span class="n">pos0</span><span class="o">.</span><span class="n">x</span><span class="p">()</span> <span class="o">-</span> <span class="n">diffx0</span><span class="p">,</span> <span class="n">pos0</span><span class="o">.</span><span class="n">y</span><span class="p">()</span> <span class="o">-</span> <span class="n">diffy0</span><span class="p">)</span>
        <span class="n">bottomRight</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QPointF</span><span class="p">(</span><span class="n">pos0</span><span class="o">.</span><span class="n">x</span><span class="p">()</span> <span class="o">+</span> <span class="n">diffx0</span><span class="p">,</span> <span class="n">pos0</span><span class="o">.</span><span class="n">y</span><span class="p">()</span> <span class="o">+</span> <span class="n">diffy0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">topleft</span><span class="p">,</span> <span class="n">bottomRight</span>

    <span class="k">def</span> <span class="nf">selection_rotation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; The rotation angle &quot;&quot;&quot;</span>
        <span class="n">theta_diff_deg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fractal_zoom_init</span><span class="p">[</span><span class="s2">&quot;theta_deg&quot;</span><span class="p">]</span>
            <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_presenter</span><span class="p">[</span><span class="s2">&quot;theta_deg&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">theta_diff_deg</span>

    <span class="k">def</span> <span class="nf">model_event_slot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; A model item has been modified - will it impact the widget ? &quot;&quot;&quot;</span>
        <span class="c1"># Find the matching &quot;mapping&quot; - None if no match</span>
        <span class="n">mapped</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="n">keys</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mapped</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;fractal&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_zoom_init</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_im</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">mapped</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;dx&quot;</span><span class="p">,</span> <span class="s2">&quot;xy_ratio&quot;</span><span class="p">,</span> <span class="s2">&quot;theta_deg&quot;</span><span class="p">,</span> <span class="s2">&quot;dps&quot;</span><span class="p">]:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mapped</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="s2">&quot;Mapping event not implemented: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mapped</span><span class="p">)</span>
                <span class="p">)</span>


<span class="c1">#==============================================================================</span>
<span class="c1"># Cmap picker from image</span>
<span class="c1">#==============================================================================</span>

<span class="k">class</span> <span class="nc">Cmap_Image_widget</span><span class="p">(</span><span class="n">QDialog</span><span class="p">,</span> <span class="n">Zoomable_Drawer_mixin</span><span class="p">):</span>
    <span class="n">model_changerequest</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="nb">object</span><span class="p">)</span>
    <span class="n">param_user_drawn</span><span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span> <span class="c1"># (px1, py1, px2, px2)</span>
    <span class="c1"># zoom_params = [&quot;x&quot;, &quot;y&quot;, &quot;dx&quot;, &quot;xy_ratio&quot;]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span> <span class="c1"># im=None):#, xy_ratio=None):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Cmap creator: from image&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span> <span class="o">=</span> <span class="n">file_path</span>

        <span class="c1"># Sets Image</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_im</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cmap</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Fractal_colormap</span><span class="p">(</span>
            <span class="n">colors</span><span class="o">=</span><span class="p">[[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span>
                    <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]],</span>
            <span class="n">kinds</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Lch&#39;</span><span class="p">],</span>
            <span class="n">grad_npts</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">],</span>
            <span class="n">grad_funcs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span>
            <span class="n">extent</span><span class="o">=</span><span class="s1">&#39;mirror&#39;</span>
        <span class="p">)</span>

        <span class="c1"># Sets the objects being drawn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_line</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_line_under</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">object_max_pts</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="c1"># Sets layout, with only one Widget, the image itself</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_layout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_view</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">add_param_box</span><span class="p">(),</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">add_cmap_box</span><span class="p">(),</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">add_action_box</span><span class="p">(),</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Event binding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_grad</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_cmap</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_pts</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_cmap</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kind</span><span class="o">.</span><span class="n">currentTextChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_cmap</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_go</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">display_cmap_code</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_push</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">push_to_param</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">)</span>
        
        <span class="c1"># Signal / slot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_changerequest</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                <span class="n">parent</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">model_changerequest_slot</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">set_im</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_qim</span> <span class="o">=</span> <span class="n">QGraphicsPixmapItem</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QPixmap</span><span class="o">.</span><span class="n">fromImage</span><span class="p">(</span>
                <span class="n">QtGui</span><span class="o">.</span><span class="n">QImage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_qim</span><span class="o">.</span><span class="n">setAcceptHoverEvents</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="o">.</span><span class="n">addToGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_qim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_image</span><span class="p">()</span>
        <span class="c1"># interpolator object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">im_interpolator</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Image_interpolator</span><span class="p">(</span>
                <span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">add_param_box</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">param_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>

        <span class="n">ngrad_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">()</span>
        <span class="n">lbl_n_grad</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Number of gradients:&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_grad</span> <span class="o">=</span> <span class="n">QSpinBox</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_grad</span><span class="o">.</span><span class="n">setRange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_grad</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
        <span class="n">ngrad_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">lbl_n_grad</span><span class="p">)</span>
        <span class="n">ngrad_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_grad</span><span class="p">)</span>
        <span class="n">param_layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">ngrad_layout</span><span class="p">)</span>

        <span class="n">npts_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">()</span>
        <span class="n">lbl_n_pts</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Points per gradient:&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_pts</span> <span class="o">=</span> <span class="n">QSpinBox</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_pts</span><span class="o">.</span><span class="n">setRange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_pts</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">npts_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">lbl_n_pts</span><span class="p">)</span>
        <span class="n">npts_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_pts</span><span class="p">)</span>
        <span class="n">param_layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">npts_layout</span><span class="p">)</span>

        <span class="n">kind_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">()</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Kind of gradient:&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kind</span> <span class="o">=</span> <span class="n">QComboBox</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kind</span><span class="o">.</span><span class="n">addItems</span><span class="p">((</span><span class="s2">&quot;Lch&quot;</span><span class="p">,</span> <span class="s2">&quot;Lab&quot;</span><span class="p">))</span>
        <span class="n">kind_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">kind</span><span class="p">)</span>
        <span class="n">kind_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_kind</span><span class="p">)</span>
        <span class="n">param_layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">kind_layout</span><span class="p">)</span>


        <span class="n">action_box</span> <span class="o">=</span> <span class="n">QGroupBox</span><span class="p">(</span><span class="s2">&quot;Parameters&quot;</span><span class="p">)</span>
        <span class="n">action_box</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">param_layout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_border_style</span><span class="p">(</span><span class="n">action_box</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">action_box</span>

    <span class="k">def</span> <span class="nf">add_action_box</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">action_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>

        <span class="n">go_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">()</span>
        <span class="n">go</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Gradient code:&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_go</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Source code&quot;</span><span class="p">)</span>
        <span class="n">go_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">go</span><span class="p">)</span>
        <span class="n">go_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_go</span><span class="p">)</span>
        <span class="n">action_layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">go_layout</span><span class="p">)</span>

        <span class="n">push_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">()</span>
        <span class="n">push</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Gradient to parameter:&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_push</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Push&quot;</span><span class="p">)</span>
        <span class="n">push_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">push</span><span class="p">)</span>
        <span class="n">push_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_push</span><span class="p">)</span>
        <span class="n">action_layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">push_layout</span><span class="p">)</span>

        <span class="n">save_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">()</span>
        <span class="n">save</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Save to file:&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Save&quot;</span><span class="p">)</span>
        <span class="n">save_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">save</span><span class="p">)</span>
        <span class="n">save_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_save</span><span class="p">)</span>
        <span class="n">action_layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">save_layout</span><span class="p">)</span>

        <span class="n">action_box</span> <span class="o">=</span> <span class="n">QGroupBox</span><span class="p">(</span><span class="s2">&quot;Actions&quot;</span><span class="p">)</span>
        <span class="n">action_box</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">action_layout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_border_style</span><span class="p">(</span><span class="n">action_box</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">action_box</span>

    <span class="k">def</span> <span class="nf">display_cmap_code</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; displays source code for Fractal object &quot;&quot;&quot;</span>
        <span class="n">ce</span> <span class="o">=</span> <span class="n">Fractal_code_editor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">str_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmap</span><span class="o">.</span><span class="n">script_repr</span><span class="p">()</span>
        <span class="n">ce</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="n">str_args</span><span class="p">)</span>
        <span class="n">ce</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Fractal code&quot;</span><span class="p">)</span>
        <span class="n">ce</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">push_to_param</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Try to push to a colormap param if there is one &quot;&quot;&quot;</span>
        <span class="c1"># sign = inspect.signature(self.parent()._gui._func)</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">guitemplates</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span><span class="o">.</span><span class="n">_gui</span><span class="o">.</span><span class="n">_func</span>
        <span class="p">)</span>
        
        <span class="n">cmap_params_index</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i_param</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sign</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">annotation</span> <span class="ow">is</span> <span class="n">fs</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Fractal_colormap</span><span class="p">:</span>
                <span class="n">cmap_params_index</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">i_param</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmap_params_index</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No fs.colors.Fractal_colormap parameter&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmap_params_index</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">i_param</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">cmap_params_index</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cmap_params_index</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">param</span><span class="p">,</span> <span class="n">ok</span> <span class="o">=</span> <span class="n">QInputDialog</span><span class="o">.</span><span class="n">getItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Select parameter&quot;</span><span class="p">,</span> 
                <span class="s2">&quot;available parameters&quot;</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ok</span> <span class="ow">and</span> <span class="n">param</span><span class="p">:</span>
                 <span class="n">i_param</span> <span class="o">=</span> <span class="n">cmap_params_index</span><span class="p">[</span><span class="n">param</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model_changerequest</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span>
                <span class="p">(</span><span class="s2">&quot;func&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">i_param</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmap</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Save the camp as a pickle .cmap file&quot;&quot;&quot;</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmap</span>
        <span class="n">mainw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">cmap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">mainw</span><span class="o">.</span><span class="n">gui_file_path</span><span class="p">(</span>
                    <span class="n">_filter</span><span class="o">=</span><span class="s2">&quot;Colormap (*.cmap)&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;save&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">file_path</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="k">return</span> 

            <span class="n">root</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ext</span> <span class="o">!=</span> <span class="s2">&quot;cmap&quot;</span><span class="p">:</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="n">root</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="s2">&quot;cmap&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Changed cmap save file to: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">cmap</span><span class="o">.</span><span class="n">save_as_pickle</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_cmap_box</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cmap_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_preview</span> <span class="o">=</span> <span class="n">Qobject_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmap</span><span class="p">)</span>
        <span class="n">cmap_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>
        <span class="n">cmap_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_preview</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">cmap_box</span> <span class="o">=</span> <span class="n">QGroupBox</span><span class="p">(</span><span class="s2">&quot;Colormap&quot;</span><span class="p">)</span>
        <span class="n">cmap_box</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">cmap_layout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_border_style</span><span class="p">(</span><span class="n">cmap_box</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cmap_box</span>

    <span class="k">def</span> <span class="nf">set_border_style</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gb</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; adds borders to an action box&quot;&quot;&quot;</span>
        <span class="n">gb</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="n">GROUP_BOX_CSS</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;#32363F&quot;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">cancel_drawing_line</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Removes the objects</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_line</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="o">.</span><span class="n">removeFromGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_line</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_line</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_line_under</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="o">.</span><span class="n">removeFromGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_line_under</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_line_under</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">publish_object</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a colormap from the line</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cancel</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">dclick</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_object_pos</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># We can only be there if double-click</span>
            <span class="n">cancel</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">dclick</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">line_pos0</span><span class="p">,</span> <span class="n">line_pos1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_object_pos</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">line_pos0</span> <span class="o">==</span> <span class="n">line_pos1</span><span class="p">):</span>
                <span class="n">cancel</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># zoom is invalid</span>

        <span class="k">if</span> <span class="n">cancel</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cancel_drawing_line</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">dclick</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fit_image</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">validated_object_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_object_pos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_cmap</span><span class="p">()</span>
        

    <span class="k">def</span> <span class="nf">update_cmap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;validated_object_pos&quot;</span><span class="p">)):</span>
            <span class="c1"># Nothing to update</span>
            <span class="k">return</span>

        <span class="p">(</span><span class="n">pos0</span><span class="p">,</span> <span class="n">pos1</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validated_object_pos</span>
        <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="n">pos0</span><span class="o">.</span><span class="n">x</span><span class="p">(),</span> <span class="n">pos0</span><span class="o">.</span><span class="n">y</span><span class="p">()</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">pos1</span><span class="o">.</span><span class="n">x</span><span class="p">(),</span> <span class="n">pos1</span><span class="o">.</span><span class="n">y</span><span class="p">()</span>
        <span class="n">n_grad</span><span class="p">,</span> <span class="n">npts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_grad</span><span class="o">.</span><span class="n">value</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_pts</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
        <span class="n">kinds</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_kind</span><span class="o">.</span><span class="n">currentText</span><span class="p">())</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">n_grad</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">n_grad</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.</span>

        <span class="c1"># Creates the new cmap widget, replace the old one (in-place)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cmap</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Fractal_colormap</span><span class="p">(</span>
            <span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span>
            <span class="n">kinds</span><span class="o">=</span><span class="n">kinds</span><span class="p">,</span>
            <span class="n">grad_npts</span><span class="o">=</span><span class="n">npts</span><span class="p">,</span>
            <span class="n">grad_funcs</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span>
            <span class="n">extent</span><span class="o">=</span><span class="s1">&#39;mirror&#39;</span>
        <span class="p">)</span>
        <span class="n">new_cmap</span> <span class="o">=</span> <span class="n">Qobject_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmap</span><span class="p">)</span>
        <span class="n">containing_layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preview</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span>
        <span class="n">containing_layout</span><span class="o">.</span><span class="n">replaceWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_preview</span><span class="p">,</span> <span class="n">new_cmap</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_preview</span> <span class="o">=</span> <span class="n">new_cmap</span>

    <span class="k">def</span> <span class="nf">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">im_interpolator</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">draw_object</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Draws the selection rectangle &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_object_pos</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid drawing </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_object_pos</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="p">(</span><span class="n">pos0</span><span class="p">,)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_object_pos</span>
        <span class="n">pos1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_object_drag</span> 
        <span class="n">qlineF</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QLineF</span><span class="p">(</span><span class="n">pos0</span><span class="p">,</span> <span class="n">pos1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_line</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_line</span><span class="o">.</span><span class="n">setLine</span><span class="p">(</span><span class="n">qlineF</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_line_under</span><span class="o">.</span><span class="n">setLine</span><span class="p">(</span><span class="n">qlineF</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_line_under</span> <span class="o">=</span> <span class="n">QGraphicsLineItem</span><span class="p">(</span><span class="n">qlineF</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_line_under</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QPen</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="s2">&quot;red&quot;</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Qt</span><span class="o">.</span><span class="n">PenStyle</span><span class="o">.</span><span class="n">SolidLine</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="o">.</span><span class="n">addToGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_line_under</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_line</span> <span class="o">=</span> <span class="n">QGraphicsLineItem</span><span class="p">(</span><span class="n">qlineF</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_line</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QPen</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="s2">&quot;black&quot;</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Qt</span><span class="o">.</span><span class="n">PenStyle</span><span class="o">.</span><span class="n">DotLine</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="o">.</span><span class="n">addToGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_line</span><span class="p">)</span>


<span class="c1">#==============================================================================</span>

<span class="k">class</span> <span class="nc">Fractal_MessageBox</span><span class="p">(</span><span class="n">QMessageBox</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>            
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;QLabel{min-width: 700px;}&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">resizeEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">resizeEvent</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="n">details_box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findChild</span><span class="p">(</span><span class="n">QTextEdit</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">details_box</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">details_box</span><span class="o">.</span><span class="n">setFixedHeight</span><span class="p">(</span><span class="n">details_box</span><span class="o">.</span><span class="n">sizeHint</span><span class="p">()</span><span class="o">.</span><span class="n">height</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">result</span>

<span class="k">class</span> <span class="nc">Fractal_cmap_choser</span><span class="p">(</span><span class="n">QDialog</span><span class="p">):</span>
    
    <span class="n">model_changerequest</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="nb">object</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>            
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Chose a colormap ...&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;QLabel{min-width: 700px;}&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmap_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fs</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">cmap_register</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        
        <span class="n">cmap_combo</span> <span class="o">=</span> <span class="n">QComboBox</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">cmap_combo</span><span class="o">.</span><span class="n">addItems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap_list</span><span class="p">)</span>
        <span class="n">cmap_combo</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">cmap_combo</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="n">COMBO_BOX_CSS</span><span class="p">)</span>
        <span class="n">cmap_combo</span><span class="o">.</span><span class="n">currentTextChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_combo_event</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">cmap_name</span> <span class="o">=</span> <span class="n">cmap_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cmap0</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">cmap_register</span><span class="p">[</span><span class="n">cmap_name</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span> <span class="o">=</span> <span class="n">cmap</span> <span class="o">=</span> <span class="n">Qobject_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmap0</span><span class="p">,</span> <span class="n">minwidth</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

        <span class="n">push</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Push to parameter&quot;</span><span class="p">)</span>
        <span class="n">push</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">push_to_param</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">()</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">cmap_combo</span><span class="p">)</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">push</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
        
        <span class="c1"># Signal / slot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_changerequest</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                <span class="n">parent</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">model_changerequest_slot</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cmap_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">fs</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">cmap_register</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap_name</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">push_to_param</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Try to push to a colormap param if there is one &quot;&quot;&quot;</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">guitemplates</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span><span class="o">.</span><span class="n">_gui</span><span class="o">.</span><span class="n">_func</span>
        <span class="p">)</span>
        
        <span class="n">cmap_params_index</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i_param</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sign</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">annotation</span> <span class="ow">is</span> <span class="n">fs</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Fractal_colormap</span><span class="p">:</span>
                <span class="n">cmap_params_index</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">i_param</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmap_params_index</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No fs.colors.Fractal_colormap parameter&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmap_params_index</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">i_param</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">cmap_params_index</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cmap_params_index</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">param</span><span class="p">,</span> <span class="n">ok</span> <span class="o">=</span> <span class="n">QInputDialog</span><span class="o">.</span><span class="n">getItem</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Select parameter&quot;</span><span class="p">,</span> 
                <span class="s2">&quot;available parameters&quot;</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">False</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">ok</span> <span class="ow">and</span> <span class="n">param</span><span class="p">:</span>
                 <span class="n">i_param</span> <span class="o">=</span> <span class="n">cmap_params_index</span><span class="p">[</span><span class="n">param</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model_changerequest</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span>
            <span class="p">(</span><span class="s2">&quot;func&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">i_param</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">)),</span>
            <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap_parameter</span><span class="p">)</span> <span class="c1"># We copy to make it editable</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">on_combo_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmap_name</span> <span class="o">=</span> <span class="n">event</span>
        <span class="n">new_cmap</span> <span class="o">=</span> <span class="n">Qobject_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fs</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">cmap_register</span><span class="p">[</span><span class="n">event</span><span class="p">],</span>
                                <span class="n">minwidth</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">replaceWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span> <span class="n">new_cmap</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span> <span class="o">=</span> <span class="n">new_cmap</span>
        


<span class="k">class</span> <span class="nc">Fractal_MainWindow</span><span class="p">(</span><span class="n">QMainWindow</span><span class="p">):</span>
    
    <span class="n">model_changerequest</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="nb">object</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gui</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="n">MAIN_WINDOW_CSS</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_model</span><span class="p">(</span><span class="n">gui</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_menubar</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fractashades </span><span class="si">{</span><span class="n">fs</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fs</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">output_context</span><span class="p">[</span><span class="s2">&quot;doc&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># Needed for github build where QT_QPA_PLATFORM=offscreen</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setMinimumSize</span><span class="p">(</span><span class="mi">1200</span><span class="p">,</span> <span class="mi">744</span> <span class="o">-</span> <span class="mi">24</span><span class="p">)</span>
        
        <span class="c1"># Signal / slot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_changerequest</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">model_changerequest_slot</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_menubar</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
      <span class="n">bar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">menuBar</span><span class="p">()</span>

      <span class="n">tools</span> <span class="o">=</span> <span class="n">bar</span><span class="o">.</span><span class="n">addMenu</span><span class="p">(</span><span class="s2">&quot;Tools&quot;</span><span class="p">)</span>
      <span class="n">layers_data</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span><span class="s1">&#39;View Layers data&#39;</span><span class="p">,</span> <span class="n">tools</span><span class="p">)</span>
      <span class="n">clear_cache</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span><span class="s1">&#39;Clear calculation cache&#39;</span><span class="p">,</span> <span class="n">tools</span><span class="p">)</span>
      <span class="n">png_info</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span><span class="s2">&quot;Show png info&quot;</span><span class="p">,</span> <span class="n">tools</span><span class="p">)</span>
      <span class="n">tools</span><span class="o">.</span><span class="n">addActions</span><span class="p">((</span><span class="n">layers_data</span><span class="p">,</span> <span class="n">clear_cache</span><span class="p">,</span> <span class="n">png_info</span><span class="p">))</span>
      <span class="n">tools</span><span class="o">.</span><span class="n">triggered</span><span class="p">[</span><span class="n">QAction</span><span class="p">]</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">actiontrig</span><span class="p">)</span>
      
      <span class="n">cmap</span> <span class="o">=</span> <span class="n">bar</span><span class="o">.</span><span class="n">addMenu</span><span class="p">(</span><span class="s2">&quot;Colormaps&quot;</span><span class="p">)</span>
      <span class="n">png_cbar</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span><span class="s1">&#39;Colormap from png image&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="p">)</span>
      <span class="n">template_cbar</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span><span class="s1">&#39;Colormap from templates&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="p">)</span>
      <span class="n">save_cmap_cbar</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span><span class="s1">&#39;Save cmap (.cmap)&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="p">)</span>
      <span class="n">load_cmap_cbar</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span><span class="s1">&#39;Load cmap (.cmap)&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="p">)</span>
      <span class="n">cmap</span><span class="o">.</span><span class="n">addActions</span><span class="p">((</span><span class="n">png_cbar</span><span class="p">,</span> <span class="n">template_cbar</span><span class="p">,</span> <span class="n">save_cmap_cbar</span><span class="p">,</span>
                       <span class="n">load_cmap_cbar</span><span class="p">))</span>
      <span class="n">cmap</span><span class="o">.</span><span class="n">triggered</span><span class="p">[</span><span class="n">QAction</span><span class="p">]</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">actiontrig</span><span class="p">)</span>


      <span class="n">movie</span> <span class="o">=</span> <span class="n">bar</span><span class="o">.</span><span class="n">addMenu</span><span class="p">(</span><span class="s2">&quot;Movie&quot;</span><span class="p">)</span>
      <span class="n">movie_template</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span><span class="s1">&#39;Movie making template&#39;</span><span class="p">,</span> <span class="n">movie</span><span class="p">)</span>
      <span class="n">movie</span><span class="o">.</span><span class="n">addActions</span><span class="p">((</span><span class="n">movie_template</span><span class="p">,))</span>
      <span class="n">movie</span><span class="o">.</span><span class="n">triggered</span><span class="p">[</span><span class="n">QAction</span><span class="p">]</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">actiontrig</span><span class="p">)</span>

      <span class="n">about</span> <span class="o">=</span> <span class="n">bar</span><span class="o">.</span><span class="n">addMenu</span><span class="p">(</span><span class="s2">&quot;About&quot;</span><span class="p">)</span>
      <span class="n">license_txt</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span><span class="s1">&#39;License&#39;</span><span class="p">,</span> <span class="n">about</span><span class="p">)</span>
      <span class="n">about</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">license_txt</span><span class="p">)</span>
      <span class="n">about</span><span class="o">.</span><span class="n">triggered</span><span class="p">[</span><span class="n">QAction</span><span class="p">]</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">actiontrig</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">actiontrig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;  Dispatch the action to the matching method</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">action</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">txt</span> <span class="o">==</span> <span class="s2">&quot;View Layers data&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">layers_data</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">txt</span> <span class="o">==</span> <span class="s2">&quot;Clear calculation cache&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear_cache</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">txt</span> <span class="o">==</span> <span class="s2">&quot;Show png info&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">show_png_info</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">txt</span> <span class="o">==</span> <span class="s2">&quot;Colormap from png image&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cmap_from_png</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">txt</span> <span class="o">==</span> <span class="s2">&quot;Colormap from templates&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cmap_from_template</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">txt</span> <span class="o">==</span> <span class="s2">&quot;Save cmap (.cmap)&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_cmap</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">txt</span> <span class="o">==</span> <span class="s2">&quot;Load cmap (.cmap)&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_cmap</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">txt</span> <span class="o">==</span> <span class="s2">&quot;License&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">show_license</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">txt</span> <span class="o">==</span> <span class="s2">&quot;Movie making template&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">show_movie_template</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unknow actiontrig&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">show_license</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Displays the program license</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fs_resources</span> <span class="o">=</span> <span class="n">importlib_resources</span><span class="o">.</span><span class="n">files</span><span class="p">(</span><span class="s2">&quot;fractalshades&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">importlib_resources</span><span class="o">.</span><span class="n">as_file</span><span class="p">(</span>
            <span class="n">fs_resources</span> <span class="o">/</span> <span class="s2">&quot;data&quot;</span> <span class="o">/</span> <span class="s2">&quot;LICENSE.txt&quot;</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">license_file</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">license_file</span><span class="o">.</span><span class="n">resolve</span><span class="p">()))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">license_str</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="n">Fractal_MessageBox</span><span class="p">()</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Fractalshades &quot;</span> <span class="o">+</span> <span class="n">fs</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">license_str</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">setInformativeText</span><span class="p">(</span><span class="n">license_str</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">setDetailedText</span><span class="p">(</span><span class="n">license_str</span><span class="p">)</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">show_movie_template</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_func_wget</span><span class="o">.</span><span class="n">show_script</span><span class="p">(</span><span class="n">movie</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">gui_file_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;open&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load a file, browsing from the __main__ directory </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">__main__</span>
            <span class="n">script_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__main__</span><span class="o">.</span><span class="vm">__file__</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
            <span class="n">script_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;open&quot;</span><span class="p">:</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">QFileDialog</span><span class="o">.</span><span class="n">getOpenFileName</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="n">directory</span><span class="o">=</span><span class="n">script_dir</span><span class="p">,</span>
                    <span class="n">caption</span><span class="o">=</span><span class="s2">&quot;Select File&quot;</span><span class="p">,</span>
                    <span class="nb">filter</span><span class="o">=</span><span class="n">_filter</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;save&quot;</span><span class="p">:</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">QFileDialog</span><span class="o">.</span><span class="n">getSaveFileName</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="n">directory</span><span class="o">=</span><span class="n">script_dir</span><span class="p">,</span>
                    <span class="n">caption</span><span class="o">=</span><span class="s2">&quot;Save File&quot;</span><span class="p">,</span>
                    <span class="nb">filter</span><span class="o">=</span><span class="n">_filter</span>
            <span class="p">)</span>
            
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">file_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">file_path</span>


    <span class="k">def</span> <span class="nf">show_png_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads an image file and displays the associated tag info</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gui_file_path</span><span class="p">(</span><span class="n">_filter</span><span class="o">=</span><span class="s2">&quot;Images (*.png)&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file_path</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">with</span> <span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">im</span><span class="p">:</span>
            <span class="n">png_info</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">info</span>
        <span class="n">data_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">png_info</span><span class="p">)</span>
        <span class="n">info</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">png_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">info</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">Fractal_MessageBox</span><span class="p">()</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Image metadata&quot;</span><span class="p">)</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">setInformativeText</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of fields found: </span><span class="si">{</span><span class="n">data_len</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">setDetailedText</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">cmap_from_png</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gui_file_path</span><span class="p">(</span><span class="n">_filter</span><span class="o">=</span><span class="s2">&quot;Images (*.png)&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file_path</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">image_display</span> <span class="o">=</span> <span class="n">Cmap_Image_widget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
        <span class="n">image_display</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">cmap_from_template</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Dialog to chose a cmap &quot;&quot;&quot;</span>
        <span class="n">choser</span> <span class="o">=</span> <span class="n">Fractal_cmap_choser</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">choser</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">clear_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">func_submodel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_register</span><span class="p">((</span><span class="s2">&quot;func&quot;</span><span class="p">,))</span>
        <span class="n">fractal</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">func_submodel</span><span class="o">.</span><span class="n">getkwargs</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="n">fractal</span><span class="o">.</span><span class="n">clean_up</span><span class="p">()</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">Fractal_MessageBox</span><span class="p">()</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Cache cleared&quot;</span><span class="p">)</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Directory :&quot;</span><span class="p">)</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">setInformativeText</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fractal</span><span class="o">.</span><span class="n">directory</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">layers_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; display in GUI the file with layers info&quot;&quot;&quot;</span>
        <span class="n">func_submodel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_register</span><span class="p">((</span><span class="s2">&quot;func&quot;</span><span class="p">,))</span>
        <span class="n">fractal</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">func_submodel</span><span class="o">.</span><span class="n">getkwargs</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="n">txt_report_path</span> <span class="o">=</span> <span class="n">fractal</span><span class="o">.</span><span class="n">txt_report_path</span>
        <span class="n">txt_report_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">txt_report_path</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">txt_report_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">report</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="n">ce</span> <span class="o">=</span> <span class="n">Fractal_code_editor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">ce</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>
        <span class="n">ce</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Layers info [./</span><span class="si">{</span><span class="n">txt_report_file</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="n">ce</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">save_cmap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Select one of the parameters of type Colormap, and save its as</span>
<span class="sd">        a .cmap file&quot;&quot;&quot;</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chose_cmap_param</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cmap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gui_file_path</span><span class="p">(</span>
                    <span class="n">_filter</span><span class="o">=</span><span class="s2">&quot;Colormap (*.cmap)&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;save&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">file_path</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="k">return</span> 

            <span class="n">root</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ext</span> <span class="o">!=</span> <span class="s2">&quot;cmap&quot;</span><span class="p">:</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="n">root</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="s2">&quot;cmap&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Changed cmap save file to: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">cmap</span><span class="o">.</span><span class="n">save_as_pickle</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">load_cmap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Load a Colormap from a .cmap file, and push it to one of the</span>
<span class="sd">        parameters &quot;&quot;&quot;</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gui_file_path</span><span class="p">(</span><span class="n">_filter</span><span class="o">=</span><span class="s2">&quot;Colormap (*.cmap)&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file_path</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">return</span> 

        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chose_cmap_param</span><span class="p">(</span><span class="n">with_val</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Fractal_colormap</span><span class="o">.</span><span class="n">load_as_pickle</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_changerequest</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">cmap</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">chose_cmap_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_val</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the model-evel key associated with one of the </span>
<span class="sd">        cmap parameters (user can chose if there are multiple)</span>
<span class="sd">        + its current value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">guitemplates</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_gui</span><span class="o">.</span><span class="n">_func</span><span class="p">)</span>

        <span class="n">cmap_params_index</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i_param</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sign</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">annotation</span> <span class="ow">is</span> <span class="n">fs</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Fractal_colormap</span><span class="p">:</span>
                <span class="n">cmap_params_index</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">i_param</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmap_params_index</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No fs.colors.Fractal_colormap parameter&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmap_params_index</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">i_param</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">cmap_params_index</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cmap_params_index</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">param</span><span class="p">,</span> <span class="n">ok</span> <span class="o">=</span> <span class="n">QInputDialog</span><span class="o">.</span><span class="n">getItem</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Select parameter&quot;</span><span class="p">,</span> 
                <span class="s2">&quot;available parameters&quot;</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">False</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">ok</span> <span class="ow">and</span> <span class="n">param</span><span class="p">:</span>
                 <span class="n">i_param</span> <span class="o">=</span> <span class="n">cmap_params_index</span><span class="p">[</span><span class="n">param</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">with_val</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;func&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">i_param</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">with_val</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">key</span>

        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span>


    <span class="k">def</span> <span class="nf">build_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gui</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gui</span> <span class="o">=</span> <span class="n">gui</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">()</span>
        <span class="c1"># Adds the submodels</span>
        <span class="n">model</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
            <span class="n">Func_submodel</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;func&quot;</span><span class="p">,),</span> <span class="n">gui</span><span class="o">.</span><span class="n">_func</span><span class="p">,</span> <span class="n">dps_var</span><span class="o">=</span><span class="n">gui</span><span class="o">.</span><span class="n">_dps</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;func&quot;</span><span class="p">,)</span>
        <span class="p">)</span>
        <span class="c1"># Adds the presenters - Note</span>
        <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;fractal&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;func&quot;</span><span class="p">,</span> <span class="n">gui</span><span class="o">.</span><span class="n">_fractal</span><span class="p">),</span>
            <span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;func&quot;</span><span class="p">,</span> <span class="n">gui</span><span class="o">.</span><span class="n">_image</span><span class="p">),</span>
            <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;func&quot;</span><span class="p">,</span> <span class="n">gui</span><span class="o">.</span><span class="n">_x</span><span class="p">),</span>
            <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;func&quot;</span><span class="p">,</span> <span class="n">gui</span><span class="o">.</span><span class="n">_y</span><span class="p">),</span>
            <span class="s2">&quot;dx&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;func&quot;</span><span class="p">,</span> <span class="n">gui</span><span class="o">.</span><span class="n">_dx</span><span class="p">),</span>
            <span class="s2">&quot;xy_ratio&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;func&quot;</span><span class="p">,</span> <span class="n">gui</span><span class="o">.</span><span class="n">_xy_ratio</span><span class="p">),</span>
            <span class="s2">&quot;theta_deg&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;func&quot;</span><span class="p">,</span> <span class="n">gui</span><span class="o">.</span><span class="n">_theta_deg</span><span class="p">),</span>
            <span class="s2">&quot;dps&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;func&quot;</span><span class="p">,</span> <span class="n">gui</span><span class="o">.</span><span class="n">_dps</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="c1"># mapping other parameters (skew, ...):</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">gui</span><span class="o">.</span><span class="n">other_parameters</span><span class="p">:</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">param</span>
            <span class="n">mapping</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;func&quot;</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">gui</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>

        <span class="n">model</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
            <span class="n">Presenter</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">mapping</span><span class="p">),</span> <span class="n">register_key</span><span class="o">=</span><span class="s2">&quot;image&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">layout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_status_bar</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_image_wget</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_func_wget</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_image_status</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">sizeHint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QSize</span><span class="p">(</span><span class="mi">1200</span><span class="p">,</span> <span class="mi">800</span><span class="p">)</span> 
    
    <span class="k">def</span> <span class="nf">add_image_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addDockWidget</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">DockWidgetArea</span><span class="o">.</span><span class="n">LeftDockWidgetArea</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">centralWidget</span><span class="p">()</span><span class="o">.</span><span class="n">image_doc_widget</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_func_wget</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">action_setting</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;image_updated&quot;</span><span class="p">,</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">from_register</span><span class="p">(</span><span class="s2">&quot;image&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">_mapping</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">func_wget</span> <span class="o">=</span> <span class="n">Action_func_widget</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">from_register</span><span class="p">((</span><span class="s2">&quot;func&quot;</span><span class="p">,)),</span>
            <span class="n">action_setting</span><span class="p">,</span>
            <span class="n">callback</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">may_interrupt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">locks_navigation</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">dock_widget</span> <span class="o">=</span> <span class="n">QDockWidget</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">Qt</span><span class="o">.</span><span class="n">WindowType</span><span class="o">.</span><span class="n">Window</span><span class="p">)</span>
        <span class="n">dock_widget</span><span class="o">.</span><span class="n">setWidget</span><span class="p">(</span><span class="n">func_wget</span><span class="p">)</span>
        <span class="c1"># Not closable :</span>
        <span class="n">dock_widget</span><span class="o">.</span><span class="n">setFeatures</span><span class="p">(</span>
            <span class="n">QDockWidget</span><span class="o">.</span><span class="n">DockWidgetFeature</span><span class="o">.</span><span class="n">DockWidgetFloatable</span>
            <span class="o">|</span> <span class="n">QDockWidget</span><span class="o">.</span><span class="n">DockWidgetFeature</span><span class="o">.</span><span class="n">DockWidgetMovable</span>
        <span class="p">)</span>
        <span class="n">dock_widget</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Parameters&quot;</span><span class="p">)</span>
        <span class="n">dock_widget</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="n">DOCK_WIDGET_CSS</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addDockWidget</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">DockWidgetArea</span><span class="o">.</span><span class="n">LeftDockWidgetArea</span><span class="p">,</span> <span class="n">dock_widget</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_func_wget</span> <span class="o">=</span> <span class="n">func_wget</span>
        
        <span class="k">if</span> <span class="n">fs</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">output_context</span><span class="p">[</span><span class="s2">&quot;doc&quot;</span><span class="p">]:</span>
            <span class="c1"># We are building the doc we need an image</span>
            <span class="n">func_wget</span><span class="o">.</span><span class="n">run_func</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">add_status_bar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># the status bar need access to the fractal object, which will be</span>
        <span class="c1"># provided through the func model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_bar</span> <span class="o">=</span> <span class="n">Calc_status_bar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">from_register</span><span class="p">((</span><span class="s2">&quot;func&quot;</span><span class="p">,)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setStatusBar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status_bar</span><span class="p">)</span>

    <span class="nd">@pyqtSlot</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">func_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func_widget</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; A simple callback when the main computation is finished &quot;&quot;&quot;</span>
        <span class="c1"># output gui-image (for documentation)</span>
        <span class="k">if</span> <span class="n">fs</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">output_context</span><span class="p">[</span><span class="s2">&quot;doc&quot;</span><span class="p">]:</span> 
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grab</span><span class="p">()</span>
            <span class="n">fs</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">add_figure</span><span class="p">(</span><span class="n">_Pixmap_figure</span><span class="p">(</span><span class="n">img</span><span class="p">))</span>
            <span class="n">QApplication</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>

    <span class="nd">@pyqtSlot</span><span class="p">(</span><span class="ne">Exception</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">on_error_in_thread</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; A simple callback when error occured in computation computation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">exc</span>

    <span class="k">def</span> <span class="nf">add_image_wget</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">mw</span> <span class="o">=</span> <span class="n">Image_widget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_register</span><span class="p">(</span><span class="s2">&quot;image&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setCentralWidget</span><span class="p">(</span><span class="n">mw</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">from_register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">register_key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">_register</span><span class="p">[</span><span class="n">register_key</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">excepthook</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Handling GUI Exceptions&quot;&quot;&quot;</span>
    <span class="n">exc_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">QMessageBox</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;GUI Error&#39;</span><span class="p">,</span> <span class="n">exc_str</span><span class="p">)</span>


<div class="viewcode-block" id="Fractal_GUI">
<a class="viewcode-back" href="../../../API/GUI.html#fractalshades.gui.guimodel.Fractal_GUI">[docs]</a>
<span class="k">class</span> <span class="nc">Fractal_GUI</span><span class="p">:</span>
<div class="viewcode-block" id="Fractal_GUI.__init__">
<a class="viewcode-back" href="../../../API/GUI.html#fractalshades.gui.guimodel.Fractal_GUI.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Parameters</span>
<span class="sd">----------</span>
<span class="sd">func : callable with signature (`fs.Fractal`, ``**kwargs`` ). </span>
<span class="sd">    The function definition shall provide &#39;type hints&#39; that will be used by the</span>
<span class="sd">    the GUI to select / customize the appropriate editor.</span>
<span class="sd">    Each parameter will be displayed interactively and will be editable.</span>
<span class="sd">    The editor might be a simple text box, or for more complex objects</span>
<span class="sd">    a full pop-up or a dockable window.</span>

<span class="sd">    The first parameter shall be a `fractalshades.Fractal` object, and its name</span>
<span class="sd">    shall be &quot;fractal&quot;.</span>
<span class="sd">    It is also partially editable: the parameters from</span>
<span class="sd">    the __init__ method will be user-tunable (it is not possible to change</span>
<span class="sd">    the fractal type or the base directory during a GUI interactive session)</span>

<span class="sd">Notes</span>
<span class="sd">-----     </span>

<span class="sd">Theses notes give further details regarding the definition of the `func`</span>
<span class="sd">parameter</span>

<span class="sd">.. note::</span>

<span class="sd">    Regarding ``Type hints`` in Python, for a full specification, please see</span>
<span class="sd">    PEP_484_. For a simplified introduction to type hints, see PEP_483_.</span>
<span class="sd">    Fractalshades only support a subset of these, details below.</span>

<span class="sd">    .. _PEP_484: https://www.python.org/dev/peps/pep-0484/</span>
<span class="sd">    .. _PEP_483: https://www.python.org/dev/peps/pep-0483/</span>

<span class="sd">.. note::</span>
<span class="sd">    </span>
<span class="sd">    Currently the following parameters types are supported :</span>
<span class="sd">        - `float`</span>
<span class="sd">        - `int`</span>
<span class="sd">        - `bool`</span>
<span class="sd">        - `mpmath.mpf` (arbitrary precision floating point)</span>
<span class="sd">        - `fs.colors.Color=(0., 0., 1.)` (RGB color)</span>
<span class="sd">        - `fs.colors.Color=(0., 0., 1., 0)` (RGBA color)</span>
<span class="sd">        - `fs.numpy_utils.Numpy_expr` (defines a numpy function from string)</span>
<span class="sd">        - `fs.Fractal` subclasses</span>
<span class="sd">        - `fs.colors.Fractal_colormap`</span>
<span class="sd">        - `fs.colors.Blinn_lighting`</span>
<span class="sd">        - `fs.gui.separator` (used to group a set of parameters under a title)</span>
<span class="sd">        - `fs.gui.collapsible_separator` (same as above, collapsible)</span>

<span class="sd">    A parameter that the user will chose among a list of discrete values can</span>
<span class="sd">    be represented by a `typing.Literal` :</span>

<span class="sd">    ::</span>

<span class="sd">        listed: typing.Literal[&quot;a&quot;, &quot;b&quot;, &quot;c&quot;, 1, None]=&quot;c&quot;</span>
<span class="sd">    </span>
<span class="sd">    Also, `typing.Union` or `typing.Optional` derived of supported  base types</span>
<span class="sd">    are supported (in this case a combo box to chose one type among</span>
<span class="sd">    those authorized be available):</span>
<span class="sd">    </span>
<span class="sd">    ::</span>

<span class="sd">        typing.Union[int, float, str]</span>
<span class="sd">        typing.Optional[float]</span>

<span class="sd">.. note::</span>
<span class="sd">    </span>
<span class="sd">    An example of a valid ``func`` parameter signature is show below:</span>
<span class="sd">    </span>
<span class="sd">    ::</span>
<span class="sd">        </span>
<span class="sd">        import typing</span>
<span class="sd">        import fractalshades.models as fsm</span>

<span class="sd">        def func(</span>
<span class="sd">            fractal: fsm.Perturbation_mandelbrot=fractal,</span>
<span class="sd">            calc_name: str=calc_name,</span>
<span class="sd">            _1: fsgui.separator=&quot;Zoom parameters&quot;,</span>
<span class="sd">            x: mpmath.mpf=x,</span>
<span class="sd">            y: mpmath.mpf=y,</span>
<span class="sd">            dx: mpmath.mpf=dx,</span>
<span class="sd">            xy_ratio: float=xy_ratio,</span>
<span class="sd">            dps: int= dps,</span>
<span class="sd">            _2: fsgui.collapsible_separator=&quot;Calculation parameters&quot;,</span>
<span class="sd">            max_iter: int=max_iter,</span>
<span class="sd">            optional_float: typing.Optional[float]=3.14159,</span>
<span class="sd">            choices_str: typing.Literal[&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]=&quot;c&quot;,</span>
<span class="sd">            nx: int=nx,</span>
<span class="sd">            interior_detect: bool=interior_detect,</span>
<span class="sd">            interior_color: QtGui.QColor=(0., 0., 1.),</span>
<span class="sd">            transparent_color: QtGui.QColor=(0., 0., 1., 0.),</span>
<span class="sd">            probes_zmax: float=probes_zmax,</span>
<span class="sd">            epsilon_stationnary: float=epsilon_stationnary,</span>
<span class="sd">            colormap: fs.colors.Fractal_colormap=colormap</span>
<span class="sd">            func: fs.numpy_utils.Numpy_expr = (</span>
<span class="sd">                fs.numpy_utils.Numpy_expr(&quot;x&quot;, &quot;np.log(x)&quot;)</span>
<span class="sd">            ),</span>
<span class="sd">        ):</span>

<span class="sd">&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_func</span> <span class="o">=</span> <span class="n">func</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">guitemplates</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="n">param_names</span> <span class="o">=</span> <span class="n">sign</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">param0</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">param_names</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fractal</span> <span class="o">=</span> <span class="n">param0</span>

        <span class="k">if</span> <span class="n">param0</span> <span class="o">!=</span> <span class="s2">&quot;fractal&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Expected a first parameters named fractal, found: </span><span class="si">{</span><span class="n">param0</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">fs</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">guitemplates</span><span class="o">.</span><span class="n">GUItemplate</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connect_image</span><span class="p">(</span><span class="o">**</span><span class="n">func</span><span class="o">.</span><span class="n">connect_image_params</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connect_mouse</span><span class="p">(</span><span class="o">**</span><span class="n">func</span><span class="o">.</span><span class="n">connect_mouse_params</span><span class="p">)</span></div>


<div class="viewcode-block" id="Fractal_GUI.connect_image">
<a class="viewcode-back" href="../../../API/GUI.html#fractalshades.gui.guimodel.Fractal_GUI.connect_image">[docs]</a>
    <span class="k">def</span> <span class="nf">connect_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_param</span><span class="o">=</span><span class="s2">&quot;calc_name&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Associate a image file with the GUI main diplay</span>

<span class="sd">Parameters</span>
<span class="sd">---------- </span>
<span class="sd">image_param: str</span>
<span class="sd">    Name of the image file to display. This image file shall be created by the</span>
<span class="sd">    function ``func`` in the same directory as the main script.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_image</span> <span class="o">=</span> <span class="n">image_param</span></div>


<div class="viewcode-block" id="Fractal_GUI.connect_mouse">
<a class="viewcode-back" href="../../../API/GUI.html#fractalshades.gui.guimodel.Fractal_GUI.connect_mouse">[docs]</a>
    <span class="k">def</span> <span class="nf">connect_mouse</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="s2">&quot;dx&quot;</span><span class="p">,</span> <span class="n">nx</span><span class="o">=</span><span class="s2">&quot;nx&quot;</span><span class="p">,</span> <span class="n">xy_ratio</span><span class="o">=</span><span class="s2">&quot;xy_ratio&quot;</span><span class="p">,</span>
        <span class="n">theta_deg</span><span class="o">=</span><span class="s2">&quot;theta_deg&quot;</span><span class="p">,</span> <span class="n">dps</span><span class="o">=</span><span class="s2">&quot;dps&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Binds some parameters of the ``func`` passed to the</span>
<span class="sd">`fractalshades.gui.Fractal_GUI` constructor with GUI mouse events.</span>

<span class="sd">Parameters</span>
<span class="sd">---------- </span>
<span class="sd">x: str</span>
<span class="sd">    Name of the parameter for the x-axis center of the image</span>
<span class="sd">y: str</span>
<span class="sd">    Name of the parameter for the y-axis center of the image</span>
<span class="sd">dx: str</span>
<span class="sd">    Name of the parameter for the x-axis width of the image</span>
<span class="sd">nx: str</span>
<span class="sd">    Name of the parameter for the x-axis width of the image</span>
<span class="sd">xy_ratio: str</span>
<span class="sd">    Name of the parameter for the ratio width / height of the image</span>
<span class="sd">dps: str | None</span>
<span class="sd">    Name of the parameter for the precision in base-10 digits (mpmath arbitrary</span>
<span class="sd">    precision). If not using arbitrary precision, it is NEEDED to pass None.</span>
<span class="sd">theta_deg: str</span>
<span class="sd">    Name of the parameter for the image rotation angle in degree.</span>
<span class="sd">other_parameters: dict</span>
<span class="sd">    Pairs of (key, value) for additionnal parameters (skew, ...)</span>
<span class="sd">&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nx</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">nx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xy_ratio</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dps</span> <span class="o">=</span> <span class="n">xy_ratio</span><span class="p">,</span> <span class="n">dps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_theta_deg</span> <span class="o">=</span> <span class="n">theta_deg</span>

        <span class="c1"># Other parameters: skew, ...</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">key</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">other_parameters</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span></div>



<div class="viewcode-block" id="Fractal_GUI.show">
<a class="viewcode-back" href="../../../API/GUI.html#fractalshades.gui.guimodel.Fractal_GUI.show">[docs]</a>
    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Launches the GUI mainloop.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">getapp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mainwin</span> <span class="o">=</span> <span class="n">Fractal_MainWindow</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mainwin</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">fs</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">output_context</span><span class="p">[</span><span class="s2">&quot;gui_iter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">excepthook</span> <span class="o">=</span> <span class="n">excepthook</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">app</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">fs</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">output_context</span><span class="p">[</span><span class="s2">&quot;gui_iter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">excepthook</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">__excepthook__</span></div>
</div>

</pre></div>

           </div>
          </div>
<div class="ribbon">
  <a href="https://github.com/GBillotey/Fractalshades">Fork me on GitHub</a>
</div>

          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Fractalshades development team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 
<style>
  .wy-nav-content { max-width: 1250px !important; }
</style>


</body>
</html>